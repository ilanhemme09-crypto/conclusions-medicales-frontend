<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conclusions M√©dicales</title>
    <style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: Arial, sans-serif; background: #1a2332; color: #e0e0e0; padding: 20px; }
.container { max-width: 1600px; margin: 0 auto; display: grid; grid-template-columns: 400px 1fr; gap: 20px; }

/* SIDEBAR ROUGE */
.sidebar { background: linear-gradient(135deg, #8b1538 0%, #5a0f26 100%); border-radius: 12px; padding: 25px; border: 3px solid #c41e3a; }
.sidebar-title { font-size: 20px; font-weight: bold; color: white; margin-bottom: 20px; }
.section-title { font-size: 14px; font-weight: bold; color: #6ba3ff; margin: 20px 0 10px 0; text-transform: uppercase; }
.api-status { padding: 10px; border-radius: 6px; margin-bottom: 20px; font-size: 13px; text-align: center; }
.api-status.connected { background: #1e4620; color: #4ade80; border: 1px solid #4ade80; }
.api-status.disconnected { background: #4a1f1f; color: #ef4444; border: 1px solid #ef4444; }

/* CAT√âGORIES */
.categories-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
.category-btn { padding: 15px; background: #2d3f54; border: 2px solid #3d5571; border-radius: 8px; color: white; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.3s; }
.category-btn:hover { background: #3d5571; }
.category-btn.active { background: #5a7ba6; border-color: #6ba3ff; }

/* MOTIFS SOUS CAT√âGORIE */
.motifs-sous-categorie { display: none; margin: 10px 0 10px 10px; padding: 10px; background: rgba(45,63,84,0.3); border-left: 3px solid #6ba3ff; border-radius: 4px; }
.motifs-sous-categorie.active { display: block; }
.motif-btn { width: 100%; padding: 10px; margin-bottom: 6px; background: #2d3f54; border: 2px solid #3d5571; border-radius: 6px; color: white; font-size: 13px; cursor: pointer; text-align: left; transition: all 0.3s; }
.motif-btn:hover { background: #3d5571; }
.motif-btn.principal { background: #16a34a; border-color: #22c55e; font-weight: bold; }
.motif-btn.secondaire { background: #3d5571; border-color: #6ba3ff; }

/* BOUTON G√âN√âRER */
.generate-btn { width: 100%; padding: 15px; background: #16a34a; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin: 10px 0; transition: all 0.3s; }
.generate-btn:disabled { opacity: 0.5; cursor: not-allowed; }
.generate-btn:hover:not(:disabled) { background: #22c55e; }

/* MODULES */
.module { background: transparent; border: 2px solid #4a90e2; border-radius: 12px; padding: 25px; margin-bottom: 20px; position: relative; }
.module-header { font-size: 18px; font-weight: bold; color: #6ba3ff; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
.module-content { color: #e0e0e0; font-size: 15px; }
.module-line { display: block; margin-bottom: 8px; line-height: 1.6; }

/* BOUTON BULLE (DRAPEAU ROUGE) */
.bulle-btn { padding: 8px 16px; background: #ea580c; border: 2px solid #f97316; border-radius: 6px; color: white; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.3s; display: flex; align-items: center; gap: 6px; }
.bulle-btn:hover { background: #f97316; }

/* CONDUITE √Ä TENIR - LIGNES AVEC ACTIONS */
.conduite-line { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; padding: 10px; background: rgba(45,63,84,0.3); border-radius: 6px; }
.conduite-number { min-width: 35px; font-weight: bold; color: #6ba3ff; font-size: 16px; }
.conduite-text { flex: 1; color: #e0e0e0; }
.conduite-actions { display: flex; gap: 5px; }
.action-icon { width: 32px; height: 32px; border-radius: 4px; border: none; cursor: pointer; font-size: 16px; transition: all 0.2s; }
.action-up { background: #3b82f6; color: white; }
.action-down { background: #3b82f6; color: white; }
.action-delete { background: #ef4444; color: white; }
.action-icon:hover { transform: scale(1.1); }

/* ORDONNANCES */
.ordonnances-section { margin-top: 20px; padding-top: 20px; border-top: 2px solid #4a90e2; }
.ordo-btn { display: inline-block; padding: 10px 20px; background: #2563eb; color: white; border-radius: 6px; margin: 5px; cursor: pointer; font-size: 14px; transition: all 0.3s; }
.ordo-btn:hover { background: #1d4ed8; }
.ordo-btn.all { background: #16a34a; }
.ordo-btn.all:hover { background: #15803d; }
.ordo-tag { display: inline-block; padding: 6px 14px; background: #16a34a; color: white; border-radius: 15px; margin: 0 8px; font-size: 12px; font-weight: 500; }

/* CODES CIM */
.codes-section { background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%); border: 2px solid #8b5cf6; border-radius: 12px; padding: 20px; margin-top: 20px; }
.codes-section h3 { color: white; margin-bottom: 15px; }
.code-item { background: rgba(255,255,255,0.1); padding: 10px; border-radius: 6px; margin-bottom: 10px; color: white; }

/* XXXX */
.xxxx { background: #fbbf24; padding: 3px 8px; border-radius: 4px; cursor: pointer; border: 2px dashed #f59e0b; color: #1a2332; font-weight: bold; display: inline-block; }
.xxxx:hover { background: #f59e0b; color: white; }

/* MODALS */
.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; padding: 20px; }
.modal.active { display: flex; }
.modal-content { background: #2d3f54; border: 2px solid #4a90e2; border-radius: 12px; padding: 30px; max-width: 900px; width: 100%; max-height: 85vh; overflow-y: auto; color: white; }
.modal-header { font-size: 20px; font-weight: bold; margin-bottom: 20px; color: #6ba3ff; display: flex; justify-content: space-between; align-items: center; }
.modal-close { cursor: pointer; font-size: 28px; color: #ef4444; }

/* MODAL BULLE (ORANGE) */
.modal-bulle { background: #ea580c; border: 3px solid #f97316; }
.modal-bulle .modal-header { color: white; }
.bulle-item { background: rgba(0,0,0,0.3); padding: 12px; margin-bottom: 10px; border-radius: 6px; border-left: 3px solid #fbbf24; }

/* FILTRES ORDONNANCES */
.ordo-filters { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
.ordo-filter label { font-weight: bold; color: #6ba3ff; font-size: 14px; margin-bottom: 6px; display: block; }
.ordo-filter select { width: 100%; padding: 10px; background: #1a2332; border: 2px solid #4a90e2; border-radius: 6px; color: white; font-size: 14px; }

/* LISTE ORDONNANCES */
.ordo-item { background: #1a2332; border: 2px solid #4a90e2; border-radius: 8px; padding: 15px; cursor: pointer; margin-bottom: 10px; transition: all 0.3s; }
.ordo-item:hover { border-color: #6ba3ff; background: #243447; }
.ordo-item-header { font-weight: bold; color: #6ba3ff; margin-bottom: 8px; }
.ordo-item-content { color: #a0a0a0; font-size: 13px; }

/* PROPOSITIONS */
.proposition-chips { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; }
.chip { padding: 10px 20px; background: #4a5568; border-radius: 20px; cursor: pointer; transition: all 0.3s; }
.chip:hover { background: #16a34a; }
.modal-input { width: 100%; padding: 12px; background: #1a2332; border: 2px solid #4a90e2; border-radius: 6px; color: white; font-size: 14px; margin-bottom: 15px; }
.modal-buttons { display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px; }
.modal-btn { padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; }
.modal-btn-primary { background: #16a34a; color: white; }
.modal-btn-secondary { background: #4a5568; color: white; }

/* FLOATING ACTIONS */
.floating-actions { position: fixed; bottom: 30px; right: 30px; display: flex; gap: 10px; }
.action-btn { width: 56px; height: 56px; border-radius: 50%; border: 2px solid #16a34a; background: #16a34a; color: white; font-size: 20px; cursor: pointer; transition: all 0.3s; }
.action-btn:hover { transform: translateY(-2px); }
.action-btn.secondary { background: #6b7280; border-color: #6b7280; }

.empty-state { text-align: center; padding: 80px 20px; color: #6b7280; }
.toast { position: fixed; bottom: 20px; right: 20px; background: #1a2332; border: 2px solid #4a90e2; color: white; padding: 16px 24px; border-radius: 8px; z-index: 2000; animation: slideIn 0.3s; }
@keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-title">üìã S√©lection</div>
            <div id="apiStatus" class="api-status disconnected">‚ùå D√©connect√©</div>
            
            <button id="generateBtnTop" class="generate-btn" disabled>üîÑ G√©n√©rer</button>
            
            <div class="section-title">Cat√©gorie Principale</div>
            <div class="categories-grid" id="categoriesGrid"></div>
            <div id="motifsContainer"></div>
            
            <div id="secondarySection" style="display:none;">
                <div class="section-title">Cat√©gories Secondaires</div>
                <div class="categories-grid" id="categoriesSecondaryGrid"></div>
                <div id="motifsSecondaryContainer"></div>
            </div>
            
            <button id="generateBtnBottom" class="generate-btn" disabled>üîÑ G√©n√©rer</button>
        </div>

        <div id="resultContainer">
            <div class="empty-state">
                <div style="font-size: 64px; margin-bottom: 20px;">üìù</div>
                <h3>Aucune conclusion g√©n√©r√©e</h3>
                <p>S√©lectionnez un motif principal et cliquez sur "G√©n√©rer"</p>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="xxxxModal" class="modal"></div>
    <div id="bulleModal" class="modal"></div>
    <div id="ordoModal" class="modal"></div>
    <div id="allOrdosModal" class="modal"></div>

    <div class="floating-actions" style="display:none;" id="floatingActions">
        <button class="action-btn secondary" onclick="resetAll()">üîÑ</button>
        <button class="action-btn" onclick="copyAll()">üìã</button>
    </div>

    <script>
const API_URL = 'https://conclusions-medicales-api-1oa1.onrender.com';
let state = { categories: [], motifPrincipal: null, motifsSecondaires: [], conclusion: null, conduiteLines: [], allOrdos: [] };

document.addEventListener('DOMContentLoaded', () => {
    checkAPI();
    loadCategories();
    document.getElementById('generateBtnTop').addEventListener('click', generate);
    document.getElementById('generateBtnBottom').addEventListener('click', generate);
});

async function checkAPI() {
    try {
        const r = await fetch(`${API_URL}/health`);
        const d = await r.json();
        const s = document.getElementById('apiStatus');
        if (d.status === 'healthy') {
            s.className = 'api-status connected';
            s.innerHTML = '‚úÖ Connect√©';
        }
    } catch(e) { }
}

async function loadCategories() {
    try {
        const r = await fetch(`${API_URL}/categories`);
        state.categories = await r.json();
        renderCategories();
    } catch(e) { }
}

function renderCategories() {
    const html = state.categories.map(c => `
        <button class="category-btn" onclick="toggleCategory('${c.table_name}','${c.nom}',this,'primary')">
            ${c.nom}
        </button>
        <div id="motifs-${c.table_name}" class="motifs-sous-categorie"></div>
    `).join('');
    
    document.getElementById('categoriesGrid').innerHTML = html;
    document.getElementById('categoriesSecondaryGrid').innerHTML = state.categories.map(c => `
        <button class="category-btn" onclick="toggleCategory('${c.table_name}','${c.nom}',this,'secondary')">
            ${c.nom}
        </button>
        <div id="motifs-sec-${c.table_name}" class="motifs-sous-categorie"></div>
    `).join('');
}

async function toggleCategory(table, nom, btn, type) {
    const container = document.getElementById(type === 'primary' ? `motifs-${table}` : `motifs-sec-${table}`);
    const wasActive = container.classList.contains('active');
    
    if (wasActive) {
        container.classList.remove('active');
        btn.classList.remove('active');
    } else {
        btn.classList.add('active');
        container.classList.add('active');
        
        if (!container.innerHTML) {
            const r = await fetch(`${API_URL}/motifs/${table}`);
            const motifs = await r.json();
            container.innerHTML = motifs.map(m => `
                <button class="motif-btn" onclick="selectMotif('${table}','${m.id}','${m.nom_motif.replace(/'/g,"\\'")}','${type}',this)">
                    ${m.nom_motif}
                </button>
            `).join('');
        }
    }
    
    if (type === 'primary') {
        document.getElementById('secondarySection').style.display = 'block';
    }
}

function selectMotif(table, id, nom, type, btn) {
    if (type === 'primary') {
        document.querySelectorAll('.motif-btn.principal').forEach(b => b.classList.remove('principal'));
        state.motifPrincipal = {table, id, nom};
        btn.classList.add('principal');
        document.getElementById('generateBtnTop').disabled = false;
        document.getElementById('generateBtnBottom').disabled = false;
    } else {
        if (btn.classList.contains('secondaire')) {
            btn.classList.remove('secondaire');
            state.motifsSecondaires = state.motifsSecondaires.filter(m => m.id !== id);
        } else {
            btn.classList.add('secondaire');
            state.motifsSecondaires.push({table, id, nom});
        }
    }
    toast(type === 'primary' ? `Motif principal: ${nom}` : `Motif secondaire modifi√©`);
}

async function generate() {
    if (!state.motifPrincipal) return;
    
    toast('‚è≥ G√©n√©ration...');
    
    try {
        const r = await fetch(`${API_URL}/fusion`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                table_principale: state.motifPrincipal.table,
                motif_principal_id: state.motifPrincipal.id,
                motifs_secondaires: state.motifsSecondaires
            })
        });
        
        state.conclusion = await r.json();
        renderConclusion();
        toast('‚úÖ G√©n√©r√© !');
        document.getElementById('floatingActions').style.display = 'flex';
    } catch(e) {
        toast('‚ùå Erreur', 'error');
    }
}

function renderConclusion() {
    let html = '';
    
    state.conclusion.modules.forEach(m => {
        const lines = m.contenu.split('\n').filter(l => l.trim());
        
        let content = '';
        
        if (m.type === 'conduite_tenir') {
            state.conduiteLines = lines.map((line, i) => ({id: Date.now() + i, text: line}));
            content = renderConduiteLines();
        } else {
            content = lines.map(line => {
                let l = line.replace(/XXXX/g, '<span class="xxxx" onclick="openXXXX(this,[])">XXXX</span>');
                return `<span class="module-line">${l}</span>`;
            }).join('');
        }
        
        const bulleBtn = m.bulles && m.bulles.length > 0 
            ? `<button class="bulle-btn" onclick='showBulles(${JSON.stringify(m.bulles)})'>üí° Drapeaux rouges</button>`
            : '';
        
        html += `<div class="module">
            <div class="module-header">
                <span>${m.icon} ${m.titre}</span>
                ${bulleBtn}
            </div>
            <div class="module-content" contenteditable="${m.type !== 'conduite_tenir'}">${content}</div>
            ${m.type === 'conduite_tenir' ? renderOrdonnances() : ''}
        </div>`;
    });
    
    if (state.conclusion.codes_ccam && state.conclusion.codes_ccam.length > 0) {
        html += `<div class="codes-section">
            <h3>üìä Suggestion CIM-10</h3>
            ${state.conclusion.codes_ccam.map(c => `<div class="code-item"><strong>${c.code}</strong> : ${c.libelle}</div>`).join('')}
        </div>`;
    }
    
    document.getElementById('resultContainer').innerHTML = html;
}

function renderConduiteLines() {
    return state.conduiteLines.map((line, idx) => `
        <div class="conduite-line">
            <div class="conduite-number">${idx + 1}.</div>
            <div class="conduite-text">${line.text.replace(/XXXX/g, '<span class="xxxx" onclick="openXXXX(this,[])">XXXX</span>')}</div>
            <div class="conduite-actions">
                <button class="action-icon action-up" onclick="moveUp(${idx})">‚Üë</button>
                <button class="action-icon action-down" onclick="moveDown(${idx})">‚Üì</button>
                <button class="action-icon action-delete" onclick="deleteLine(${idx})">üóë</button>
            </div>
        </div>
    `).join('');
}

function moveUp(idx) {
    if (idx === 0) return;
    [state.conduiteLines[idx], state.conduiteLines[idx-1]] = [state.conduiteLines[idx-1], state.conduiteLines[idx]];
    renderConclusion();
}

function moveDown(idx) {
    if (idx === state.conduiteLines.length - 1) return;
    [state.conduiteLines[idx], state.conduiteLines[idx+1]] = [state.conduiteLines[idx+1], state.conduiteLines[idx]];
    renderConclusion();
}

function deleteLine(idx) {
    state.conduiteLines.splice(idx, 1);
    renderConclusion();
}

function renderOrdonnances() {
    if (!state.conclusion.ordonnances || state.conclusion.ordonnances.length === 0) return '';
    
    return `<div class="ordonnances-section">
        <strong>üíä Ordonnances disponibles</strong><br>
        <button class="ordo-btn all" onclick="loadAllOrdos()">üìã Toutes Les Ordonnances Disponibles</button>
        ${state.conclusion.ordonnances.map((o,i) => `<button class="ordo-btn" onclick="showOrdo(${i})">${o.titre}</button>`).join('')}
    </div>`;
}

function showBulles(bulles) {
    document.getElementById('bulleModal').innerHTML = `<div class="modal-content modal-bulle">
        <div class="modal-header">
            <span>‚ö†Ô∏è Drapeaux rouges</span>
            <span class="modal-close" onclick="closeModal('bulleModal')">√ó</span>
        </div>
        ${bulles.map(b => `<div class="bulle-item"><strong>- ${b.nom}</strong><br>${b.contenu}</div>`).join('')}
    </div>`;
    document.getElementById('bulleModal').classList.add('active');
}

function showOrdo(idx) {
    const o = state.conclusion.ordonnances[idx];
    let content = o.contenu.replace(/XXXX/g, '<span class="xxxx" onclick="openXXXX(this,[])">XXXX</span>');
    
    document.getElementById('ordoModal').innerHTML = `<div class="modal-content">
        <div class="modal-header">
            <span>${o.titre}</span>
            <span class="modal-close" onclick="closeModal('ordoModal')">√ó</span>
        </div>
        <div style="white-space:pre-wrap;line-height:1.8;">${content}</div>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-secondary" onclick="closeModal('ordoModal')">Fermer</button>
            <button class="modal-btn modal-btn-primary" onclick="copy('${o.contenu.replace(/'/g,"\\'")}')">üìã Copier</button>
        </div>
    </div>`;
    document.getElementById('ordoModal').classList.add('active');
}

async function loadAllOrdos() {
    toast('‚è≥ Chargement...');
    state.allOrdos = [];
    
    for (const cat of state.categories) {
        const r = await fetch(`${API_URL}/motifs/${cat.table_name}`);
        const motifs = await r.json();
        
        for (const m of motifs) {
            const mr = await fetch(`${API_URL}/fusion`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    table_principale: cat.table_name,
                    motif_principal_id: m.id,
                    motifs_secondaires: []
                })
            });
            
            const md = await mr.json();
            
            if (md.ordonnances) {
                md.ordonnances.forEach(o => {
                    state.allOrdos.push({
                        cat: cat.nom,
                        catId: cat.table_name,
                        motif: m.nom_motif,
                        motifId: m.id,
                        ordo: o
                    });
                });
            }
        }
    }
    
    renderAllOrdos();
    toast('‚úÖ Charg√©');
}

function renderAllOrdos() {
    const cats = [...new Set(state.allOrdos.map(o => o.cat))];
    
    document.getElementById('allOrdosModal').innerHTML = `<div class="modal-content">
        <div class="modal-header">
            <span>üìã Toutes les Ordonnances</span>
            <span class="modal-close" onclick="closeModal('allOrdosModal')">√ó</span>
        </div>
        <div class="ordo-filters">
            <div class="ordo-filter">
                <label>Cat√©gorie</label>
                <select id="catFilter" onchange="filterOrdos()">
                    <option value="">Toutes</option>
                    ${cats.map(c => `<option value="${c}">${c}</option>`).join('')}
                </select>
            </div>
            <div class="ordo-filter">
                <label>Motif</label>
                <select id="motifFilter" onchange="filterOrdos()">
                    <option value="">Tous</option>
                </select>
            </div>
        </div>
        <div id="ordosList"></div>
    </div>`;
    
    filterOrdos();
    document.getElementById('allOrdosModal').classList.add('active');
}

function filterOrdos() {
    const cat = document.getElementById('catFilter').value;
    const motif = document.getElementById('motifFilter').value;
    
    let filtered = state.allOrdos;
    
    if (cat) {
        filtered = filtered.filter(o => o.cat === cat);
        const motifs = [...new Set(filtered.map(o => o.motif))];
        document.getElementById('motifFilter').innerHTML = 
            '<option value="">Tous</option>' +
            motifs.map(m => `<option value="${m}">${m}</option>`).join('');
    }
    
    if (motif) filtered = filtered.filter(o => o.motif === motif);
    
    document.getElementById('ordosList').innerHTML = filtered.map((o, i) => `
        <div class="ordo-item" onclick="openOrdoFromList(${i},'${cat}','${motif}')">
            <div class="ordo-item-header">${o.ordo.titre} - ${o.motif} (${o.cat})</div>
            <div class="ordo-item-content">${o.ordo.contenu.substring(0,100)}...</div>
        </div>
    `).join('');
}

function openOrdoFromList(idx, cat, motif) {
    let filtered = state.allOrdos;
    if (cat) filtered = filtered.filter(o => o.cat === cat);
    if (motif) filtered = filtered.filter(o => o.motif === motif);
    
    const o = filtered[idx].ordo;
    let content = o.contenu.replace(/XXXX/g, '<span class="xxxx" onclick="openXXXX(this,[])">XXXX</span>');
    
    closeModal('allOrdosModal');
    
    document.getElementById('ordoModal').innerHTML = `<div class="modal-content">
        <div class="modal-header">
            <span>${o.titre}</span>
            <span class="modal-close" onclick="closeModal('ordoModal')">√ó</span>
        </div>
        <div style="white-space:pre-wrap;line-height:1.8;">${content}</div>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-secondary" onclick="closeModal('ordoModal')">Fermer</button>
            <button class="modal-btn modal-btn-primary" onclick="copy('${o.contenu.replace(/'/g,"\\'")}')">üìã Copier</button>
        </div>
    </div>`;
    document.getElementById('ordoModal').classList.add('active');
}

function openXXXX(el, props) {
    document.getElementById('xxxxModal').innerHTML = `<div class="modal-content">
        <div class="modal-header">
            <span>Remplir le champ</span>
            <span class="modal-close" onclick="closeModal('xxxxModal')">√ó</span>
        </div>
        ${props.length > 0 ? `<div class="proposition-chips">
            ${props.map(p => `<span class="chip" onclick="document.getElementById('xxxxInput').value='${p}'">${p}</span>`).join('')}
        </div>` : ''}
        <input type="text" id="xxxxInput" class="modal-input" placeholder="Entrez...">
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-secondary" onclick="closeModal('xxxxModal')">Annuler</button>
            <button class="modal-btn modal-btn-primary" onclick="validateXXXX('${el.id}')">‚úì Valider</button>
        </div>
    </div>`;
    el.id = 'xxxx-' + Date.now();
    document.getElementById('xxxxModal').classList.add('active');
}

function validateXXXX(id) {
    const val = document.getElementById('xxxxInput').value;
    if (val) {
        const el = document.getElementById(id);
        if (el) {
            el.textContent = val;
            el.classList.remove('xxxx');
            el.style.background = 'transparent';
            el.style.border = 'none';
        }
    }
    closeModal('xxxxModal');
}

function closeModal(id) {
    document.getElementById(id).classList.remove('active');
}

function copy(text) {
    navigator.clipboard.writeText(text);
    toast('‚úÖ Copi√© !');
}

function copyAll() {
    if (!state.conclusion) return;
    let text = '';
    state.conclusion.modules.forEach(m => text += `${m.titre}\n\n${m.contenu}\n\n`);
    copy(text);
}

function resetAll() {
    state = { categories: state.categories, motifPrincipal: null, motifsSecondaires: [], conclusion: null, conduiteLines: [], allOrdos: [] };
    document.querySelectorAll('.category-btn, .motif-btn').forEach(b => b.classList.remove('active', 'principal', 'secondaire'));
    document.querySelectorAll('.motifs-sous-categorie').forEach(m => m.classList.remove('active'));
    document.getElementById('generateBtnTop').disabled = true;
    document.getElementById('generateBtnBottom').disabled = true;
    document.getElementById('floatingActions').style.display = 'none';
    document.getElementById('secondarySection').style.display = 'none';
    document.getElementById('resultContainer').innerHTML = '<div class="empty-state"><div style="font-size:64px;margin-bottom:20px;">üìù</div><h3>Aucune conclusion g√©n√©r√©e</h3></div>';
    toast('üîÑ R√©initialis√©');
}

function toast(msg, type='info') {
    const t = document.createElement('div');
    t.className = 'toast';
    t.textContent = msg;
    if (type === 'error') t.style.borderColor = '#ef4444';
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 3000);
}

window.onclick = e => { if (e.target.classList.contains('modal')) e.target.classList.remove('active'); };
    </script>
</body>
</html>
