<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Conclusions M√©dicales</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:system-ui,-apple-system,sans-serif;background:#1a202c;color:#e2e8f0;min-height:100vh;padding:20px;}
.container{max-width:1400px;margin:0 auto;display:grid;grid-template-columns:350px 1fr;gap:20px;}
.sidebar{background:#2d3748;padding:20px;border-radius:8px;height:fit-content;position:sticky;top:20px;}
.main{background:#2d3748;padding:30px;border-radius:8px;}
h1,h2,h3{margin-bottom:15px;}
.status{padding:12px;border-radius:6px;margin-bottom:20px;text-align:center;font-weight:600;}
.status.connected{background:#38a169;color:white;}
.status.disconnected{background:#e53e3e;color:white;}
button{background:#4299e1;color:white;border:none;padding:12px 24px;border-radius:6px;cursor:pointer;font-size:16px;width:100%;margin-bottom:10px;transition:all 0.2s;}
button:hover{background:#3182ce;}
button:disabled{background:#4a5568;cursor:not-allowed;}
.category-btn,.motif-btn{background:#4a5568;margin:5px 0;}
.category-btn.selected,.motif-btn.selected{background:#805ad5;}
.module{background:#1a202c;padding:20px;margin:15px 0;border-radius:6px;border-left:4px solid #4299e1;}
.module h3{color:#63b3ed;margin-bottom:12px;}
.line{margin:8px 0;line-height:1.6;}
.xxxx{background:#ecc94b;color:#1a202c;padding:2px 6px;border-radius:3px;font-weight:600;cursor:pointer;}
.alt{color:#9f7aea;cursor:pointer;border-bottom:2px dotted #9f7aea;}
.comment{color:#718096;font-style:italic;}
.delete{text-decoration:line-through;color:#718096;}
.toast{position:fixed;top:20px;right:20px;background:#2d3748;padding:15px 20px;border-radius:6px;box-shadow:0 4px 12px rgba(0,0,0,0.3);z-index:1000;animation:slideIn 0.3s;}
@keyframes slideIn{from{transform:translateX(400px);opacity:0;}to{transform:translateX(0);opacity:1;}}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:999;align-items:center;justify-content:center;}
.modal.active{display:flex;}
.modal-content{background:#2d3748;padding:30px;border-radius:8px;max-width:500px;width:90%;}
.modal-content h3{margin-bottom:15px;color:#63b3ed;}
.modal-content button{margin-top:10px;}
</style>
</head>
<body>
<div class="container">
<div class="sidebar">
<h2>üìã S√©lection</h2>
<div id="status" class="status disconnected">‚ö†Ô∏è D√©connect√©</div>
<button id="generateBtn" disabled>üîÑ G√©n√©rer</button>
<h3>CAT√âGORIE PRINCIPALE</h3>
<div id="categoriesContainer"></div>
</div>
<div class="main">
<h1>üìÑ Conclusion M√©dicale</h1>
<div id="output">
<p style="text-align:center;color:#718096;margin-top:100px;">Aucune conclusion g√©n√©r√©e<br>S√©lectionnez un motif principal et cliquez sur "G√©n√©rer"</p>
</div>
</div>
</div>
<div id="modal" class="modal">
<div class="modal-content">
<h3 id="modalTitle"></h3>
<div id="modalBody"></div>
<button onclick="document.getElementById('modal').classList.remove('active')">Fermer</button>
</div>
</div>
<div style="position:fixed;bottom:8px;left:8px;font-size:9px;color:#666;opacity:0.5;font-family:monospace;z-index:9999;">STABLE</div>
<script>
const API_URL='https://conclusions-medicales-api-1oa1.onrender.com';
const state={connected:false,categories:[],motifs:[],selectedCategory:null,selectedMotif:null};

async function init(){
try{
const r=await fetch(`${API_URL}/health`);
if(!r.ok)throw new Error();
state.connected=true;
document.getElementById('status').className='status connected';
document.getElementById('status').textContent='‚úì Connect√©';
await loadCategories();
}catch(e){
console.error('Connexion √©chou√©e',e);
toast('‚ùå Erreur de connexion');
}}

async function loadCategories(){
try{
const r=await fetch(`${API_URL}/categories`);
const data=await r.json();
state.categories=data.categories||[];
renderCategories();
}catch(e){
console.error('Erreur cat√©gories',e);
}}

function renderCategories(){
const c=document.getElementById('categoriesContainer');
c.innerHTML='';
state.categories.forEach(cat=>{
const btn=document.createElement('button');
btn.className='category-btn';
btn.textContent=cat.nom;
btn.onclick=()=>selectCategory(cat);
c.appendChild(btn);
});
}

async function selectCategory(cat){
state.selectedCategory=cat;
state.selectedMotif=null;
document.querySelectorAll('.category-btn').forEach(b=>b.classList.remove('selected'));
event.target.classList.add('selected');
await loadMotifs(cat.table_name);
}

async function loadMotifs(table){
try{
const r=await fetch(`${API_URL}/motifs/${table}`);
const data=await r.json();
state.motifs=data.motifs||[];
showMotifSelector();
}catch(e){
console.error('Erreur motifs',e);
}}

function showMotifSelector(){
const modal=document.getElementById('modal');
const title=document.getElementById('modalTitle');
const body=document.getElementById('modalBody');
title.textContent=`S√©lectionner un motif - ${state.selectedCategory.nom}`;
body.innerHTML='';
state.motifs.forEach(m=>{
const btn=document.createElement('button');
btn.className='motif-btn';
btn.textContent=m.nom_motif;
btn.onclick=()=>{
state.selectedMotif=m;
modal.classList.remove('active');
document.getElementById('generateBtn').disabled=false;
toast(`‚úì Motif: ${m.nom_motif}`);
};
body.appendChild(btn);
});
modal.classList.add('active');
}

async function generate(){
if(!state.selectedMotif)return;
toast('‚è≥ G√©n√©ration...');
try{
const r=await fetch(`${API_URL}/fusion`,{
method:'POST',
headers:{'Content-Type':'application/json'},
body:JSON.stringify({
table_principale:state.selectedCategory.table_name,
motif_principal_id:state.selectedMotif.id,
motifs_secondaires:[],
mode:'conclusion'
})
});
if(!r.ok)throw new Error('Erreur API');
const data=await r.json();
renderConclusion(data);
toast('‚úì G√©n√©r√©');
}catch(e){
console.error('Erreur',e);
toast('‚ùå Erreur g√©n√©ration');
}}

function renderConclusion(data){
const o=document.getElementById('output');
o.innerHTML='';
data.modules.forEach(m=>{
const div=document.createElement('div');
div.className='module';
const h3=document.createElement('h3');
h3.textContent=m.titre;
div.appendChild(h3);
if(m.sections){
m.sections.forEach(s=>{
const sh=document.createElement('h4');
sh.textContent=s.titre;
sh.style.color='#90cdf4';
sh.style.marginTop='10px';
div.appendChild(sh);
renderLines(s.lignes,div);
});
}else{
renderLines(m.lignes,div);
}
o.appendChild(div);
});
}

function renderLines(lignes,container){
let currentLine=null;
lignes.forEach(el=>{
if(el.newline||!currentLine){
currentLine=document.createElement('div');
currentLine.className='line';
container.appendChild(currentLine);
}
const span=document.createElement('span');
span.textContent=el.texte;
if(el.commentaire)span.className='comment';
if(el.deletable)span.className='delete';
if(el.texte==='XXXX')span.className='xxxx';
if(el.alternative){
span.className='alt';
span.onclick=()=>showAlternatives(el.alternative.alternatives);
}
currentLine.appendChild(span);
});
}

function showAlternatives(alts){
const modal=document.getElementById('modal');
const title=document.getElementById('modalTitle');
const body=document.getElementById('modalBody');
title.textContent='Alternatives';
body.innerHTML='';
alts.forEach(a=>{
const btn=document.createElement('button');
btn.textContent=a;
btn.onclick=()=>{
navigator.clipboard.writeText(a);
toast('‚úì Copi√©: '+a);
modal.classList.remove('active');
};
body.appendChild(btn);
});
modal.classList.add('active');
}

function toast(msg){
const t=document.createElement('div');
t.className='toast';
t.textContent=msg;
document.body.appendChild(t);
setTimeout(()=>t.remove(),3000);
}

document.getElementById('generateBtn').onclick=generate;
window.addEventListener('click',e=>{
if(e.target.classList.contains('modal'))e.target.classList.remove('active');
});
init();
</script>
</body>
</html>
