<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Conclusions M√©dicales v4.3.0</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;background:#1a2332;color:#e2e8f0;padding:20px}
.container{max-width:1800px;margin:0 auto;display:grid;grid-template-columns:380px 1fr;gap:24px}
.sidebar{background:linear-gradient(135deg,#7f1d1d 0%,#450a0a 100%);border-radius:16px;padding:24px;border:2px solid #991b1b;box-shadow:0 10px 40px rgba(0,0,0,0.4)}
.sidebar-title{font-size:22px;font-weight:700;color:white;margin-bottom:20px;letter-spacing:-0.5px}
.section-title{font-size:13px;font-weight:600;color:#60a5fa;margin:20px 0 12px;text-transform:uppercase;letter-spacing:0.5px}
.api-status{padding:12px;border-radius:8px;margin-bottom:20px;font-size:13px;text-align:center;font-weight:600}
.api-status.connected{background:#065f46;color:#34d399;border:1px solid #059669}
.api-status.disconnected{background:#7f1d1d;color:#fca5a5;border:1px solid #dc2626}
.categories-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
.category-btn{padding:14px;background:#1e293b;border:2px solid #334155;border-radius:8px;color:#e2e8f0;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s}
.category-btn:hover{background:#334155;border-color:#475569}
.category-btn.active{background:#1e40af;border-color:#3b82f6;color:white}
.motif-selection-main{background:rgba(6,95,70,0.2);padding:12px;border-radius:8px;border:2px solid #059669;margin-bottom:12px}
.motif-selection-secondary{background:rgba(30,64,175,0.2);padding:12px;border-radius:8px;border:2px solid #3b82f6;margin-bottom:12px}
.motif-selection-title{font-size:11px;font-weight:700;color:#60a5fa;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px}
.motifs-list{display:none;margin:6px 0 12px;padding:10px;background:rgba(30,41,59,0.5);border-left:3px solid #3b82f6;border-radius:6px}
.motifs-list.active{display:block}
.motif-btn{width:100%;padding:10px;margin-bottom:6px;background:#1e293b;border:2px solid #334155;border-radius:6px;color:#e2e8f0;font-size:12px;font-weight:500;cursor:pointer;text-align:left;transition:all .2s}
.motif-btn:hover{background:#334155}
.motif-btn.principal{background:#065f46;border-color:#059669;color:#6ee7b7;font-weight:600}
.motif-btn.secondaire{background:#1e40af;border-color:#3b82f6;color:#93c5fd;font-weight:600}
.generate-btn{width:100%;padding:16px;background:#059669;color:white;border:none;border-radius:10px;font-size:15px;font-weight:700;cursor:pointer;margin:12px 0;transition:all .2s;box-shadow:0 4px 12px rgba(5,150,105,0.3)}
.generate-btn:disabled{opacity:.4;cursor:not-allowed}
.generate-btn:hover:not(:disabled){background:#047857;transform:translateY(-1px);box-shadow:0 6px 16px rgba(5,150,105,0.4)}
.module{background:transparent;border:2px dashed #475569;border-radius:12px;padding:28px;margin-bottom:20px;transition:all .3s;position:relative}
.module:hover{border-color:#3b82f6;border-style:solid}
.module-content:hover{border-color:#60a5fa!important;border-style:solid!important;box-shadow:0 0 20px rgba(59,130,246,0.5)!important}
.module-header{font-size:17px;font-weight:700;color:#60a5fa;margin-bottom:20px;display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:12px;letter-spacing:-0.3px}
.module-title{flex:1}
.module-title .icon{display:inline}
.module-copy-btn{padding:8px 16px;background:#059669;color:white;border:none;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;transition:all .2s}
.module-copy-btn:hover{background:#047857;transform:translateY(-1px)}
.bulles-container{display:flex;flex-wrap:wrap;gap:8px}
.bulle-btn{padding:8px 16px;background:#ea580c;border:2px solid #f97316;border-radius:8px;color:white;cursor:pointer;font-size:12px;font-weight:600;transition:all .2s;display:inline-flex;align-items:center;gap:6px}
.bulle-btn:hover{background:#c2410c;transform:translateY(-2px);box-shadow:0 4px 12px rgba(234,88,12,0.4)}
.module-content{color:#cbd5e1;font-size:14px;line-height:1.7;border:2px dashed transparent;border-radius:8px;padding:16px;transition:all .3s}
.hdm-section{margin-bottom:24px;position:relative;padding-top:28px}
.hdm-section-content{padding:16px;background:rgba(15,23,42,0.3);border-radius:8px;border-left:3px solid #3b82f6}
.hdm-section-title{position:absolute;top:0;left:0;font-size:11px;font-style:italic;color:#60a5fa;font-weight:500;margin-bottom:0}
.module-line{display:block;margin-bottom:10px;line-height:1.6}
.conduite-line{display:flex;align-items:center;gap:16px;margin-bottom:12px;padding:14px;background:#0f172a;border:1px solid #334155;border-radius:10px;transition:all .2s}
.conduite-line:hover{background:#1e293b;border-color:#475569}
.conduite-number{width:38px;height:38px;min-width:38px;background:#1e40af;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;color:white;font-size:15px;flex-shrink:0}
.conduite-text{flex:1;color:#cbd5e1;line-height:1.6;font-size:14px}
.conduite-add-line{display:flex;gap:12px;margin-top:16px;padding:14px;background:#0f172a;border:2px dashed #3b82f6;border-radius:10px;align-items:center}
.conduite-input{flex:1;padding:12px;background:#1e293b;border:2px solid #334155;border-radius:8px;color:white;font-size:14px;font-weight:500}
.conduite-input:focus{outline:none;border-color:#3b82f6}
.conduite-add-btn{padding:12px 24px;background:#059669;color:white;border:none;border-radius:8px;font-size:14px;font-weight:700;cursor:pointer;transition:all .2s}
.conduite-add-btn:hover{background:#047857;transform:translateY(-1px)}
.conduite-actions{display:flex;gap:6px;flex-shrink:0}
.action-icon{width:36px;height:36px;border-radius:8px;border:none;cursor:pointer;font-size:16px;font-weight:700;transition:all .2s;color:white}
.action-up{background:#1e40af}
.action-up:hover{background:#1e3a8a;transform:translateY(-2px)}
.action-down{background:#1e40af}
.action-down:hover{background:#1e3a8a;transform:translateY(-2px)}
.action-delete{background:#dc2626}
.action-delete:hover{background:#b91c1c;transform:scale(1.05)}
.ordonnances-section{margin-top:24px;padding-top:24px;border-top:2px solid #334155}
.ordo-btn{display:inline-block;padding:10px 20px;background:#1e40af;color:white;border-radius:8px;margin:6px;cursor:pointer;font-size:13px;font-weight:600;transition:all .2s;border:none}
.ordo-btn:hover{background:#1e3a8a;transform:translateY(-1px)}
.ordo-btn.all{background:#059669}
.ordo-btn.all:hover{background:#047857}
.codes-section{background:transparent;border:none;margin-top:30px;box-shadow:none;animation:none;text-align:center}
.codes-section h3{display:none}
.code-item{background:linear-gradient(135deg,#7c3aed 0%,#6d28d9 100%);padding:24px 32px;border-radius:16px;margin:0 auto;max-width:800px;color:white;font-weight:600;border:3px solid #a855f7;transition:all .2s;box-shadow:0 0 40px rgba(124,58,237,0.8),0 0 80px rgba(124,58,237,0.4);animation:cimGlow 2s ease-in-out infinite}
.code-item::before{content:'üìä';font-size:28px;margin-right:12px}
.code-item strong{font-size:17px;display:block;margin-bottom:8px;color:#fff}
@keyframes cimGlow{0%,100%{box-shadow:0 0 40px rgba(124,58,237,0.8),0 0 80px rgba(124,58,237,0.4)}50%{box-shadow:0 0 60px rgba(124,58,237,1),0 0 120px rgba(124,58,237,0.6)}}
.xxxx{background:#fbbf24;padding:1px 4px;border-radius:3px;cursor:pointer;border:1px solid #f59e0b;color:#78350f;font-weight:700;display:inline-block;transition:all .2s;font-size:13px}
.xxxx:hover{background:#f59e0b;color:white;transform:scale(1.05)}
.alternative{color:#a855f7;font-weight:600;display:inline;cursor:pointer;transition:all .2s}
.alternative:hover{color:#9333ea;text-decoration:underline}
.comment{color:#94a3b8;font-size:11px;font-style:italic;display:inline-block;user-select:none;pointer-events:none;opacity:0.7}
.deletable{color:#dc2626;font-weight:600;display:inline;cursor:pointer;transition:all .2s}
.deletable:hover{color:#b91c1c;text-decoration:line-through}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:1000;justify-content:center;align-items:center;padding:20px;backdrop-filter:blur(4px)}
.modal.active{display:flex}
.modal-content{background:#1e293b;border:2px solid #3b82f6;border-radius:16px;padding:32px;max-width:900px;width:100%;max-height:85vh;overflow-y:auto;color:white;box-shadow:0 20px 60px rgba(0,0,0,0.5)}
.modal-header{font-size:20px;font-weight:700;margin-bottom:24px;color:#60a5fa;display:flex;justify-content:space-between;align-items:center}
.modal-close{cursor:pointer;font-size:28px;color:#ef4444;transition:all .2s}
.modal-close:hover{color:#dc2626;transform:rotate(90deg)}
.modal-bulle{background:#ea580c;border:3px solid #f97316}
.modal-bulle .modal-header{color:white}
.bulle-content{background:rgba(0,0,0,0.3);padding:18px;border-radius:10px;color:white;line-height:1.8;white-space:pre-wrap}
#xxxxModal,#alternativeModal{z-index:2000!important}
.proposition-chips{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:18px}
.chip{padding:10px 18px;background:#334155;border:2px solid #475569;border-radius:20px;cursor:pointer;transition:all .2s;font-weight:600;font-size:13px}
.chip:hover{background:#059669;border-color:#10b981;color:white;transform:translateY(-2px)}
.ordo-filters{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:28px}
.ordo-filter label{font-weight:600;color:#60a5fa;font-size:13px;margin-bottom:8px;display:block;letter-spacing:0.3px}
.ordo-filter select{width:100%;padding:12px;background:#0f172a;border:2px solid #334155;border-radius:8px;color:white;font-size:14px;font-weight:500}
.ordo-item{background:#0f172a;border:2px solid #334155;border-radius:10px;padding:16px;cursor:pointer;margin-bottom:12px;transition:all .2s}
.ordo-item:hover{border-color:#3b82f6;background:#1e293b;transform:translateX(4px)}
.ordo-item-header{font-weight:600;color:#60a5fa;margin-bottom:8px}
.modal-input{width:100%;padding:14px;background:#0f172a;border:2px solid #334155;border-radius:8px;color:white;font-size:14px;font-weight:500;margin-bottom:18px}
.modal-input:focus{outline:none;border-color:#3b82f6}
.modal-buttons{display:flex;gap:12px;justify-content:flex-end;margin-top:18px}
.modal-btn{padding:12px 24px;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:700;transition:all .2s}
.modal-btn-primary{background:#059669;color:white}
.modal-btn-primary:hover{background:#047857;transform:translateY(-1px)}
.modal-btn-secondary{background:#475569;color:white}
.modal-btn-secondary:hover{background:#334155}
.mode-selection{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-top:20px}
.mode-btn{padding:20px;background:#1e293b;border:3px solid #334155;border-radius:12px;color:#e2e8f0;font-size:14px;font-weight:700;cursor:pointer;text-align:center;transition:all .2s}
.mode-btn:hover{border-color:#3b82f6;background:#334155;transform:translateY(-2px)}
.mode-btn-icon{font-size:32px;margin-bottom:10px}
.split-view{display:grid;grid-template-columns:1fr 1fr;gap:24px}
.split-panel{background:#1e293b;border-radius:16px;padding:24px;border:2px solid #334155}
.split-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:16px;border-bottom:2px solid #334155}
.split-title{font-size:18px;font-weight:700;color:#60a5fa}
.copy-btn{padding:10px 20px;background:#059669;color:white;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s}
.copy-btn:hover{background:#047857;transform:translateY(-1px)}
.floating-actions{position:fixed;bottom:30px;right:30px;display:flex;gap:12px}
.action-btn{width:56px;height:56px;border-radius:50%;border:2px solid #059669;background:#059669;color:white;font-size:22px;cursor:pointer;transition:all .2s;box-shadow:0 6px 20px rgba(5,150,105,0.4)}
.action-btn:hover{transform:translateY(-3px);box-shadow:0 8px 24px rgba(5,150,105,0.5)}
.action-btn.secondary{background:#64748b;border-color:#64748b}
.empty-state{text-align:center;padding:80px 20px;color:#64748b}
.toast{position:fixed;bottom:20px;right:20px;background:#1e293b;border:2px solid #3b82f6;color:white;padding:16px 24px;border-radius:10px;z-index:3000;animation:slideIn .3s;font-weight:600;box-shadow:0 10px 30px rgba(0,0,0,0.5)}
@keyframes slideIn{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}
</style>
</head>
<body>
<div class="container">
<div class="sidebar">
<div class="sidebar-title">üìã S√©lection</div>
<div id="apiStatus" class="api-status disconnected">‚ùå D√©connect√©</div>
<button id="generateTop" class="generate-btn" disabled>üîÑ G√©n√©rer</button>
<div class="section-title">Cat√©gorie Principale</div>
<div class="motif-selection-main" style="display:none" id="mainSelectionBox">
<div class="motif-selection-title">Motif Principal S√©lectionn√©</div>
<div id="mainSelectionText"></div>
</div>
<div class="categories-grid" id="categoriesGrid"></div>
<div id="motifsMainContainer"></div>
<div id="secondarySection" style="display:none">
<div class="section-title">Cat√©gories Secondaires</div>
<div class="motif-selection-secondary" style="display:none" id="secondarySelectionBox">
<div class="motif-selection-title">Motifs Secondaires S√©lectionn√©s</div>
<div id="secondarySelectionText"></div>
</div>
<div class="categories-grid" id="categoriesSecondaryGrid"></div>
<div id="motifsSecondaryContainer"></div>
</div>
<button id="generateBottom" class="generate-btn" disabled>üîÑ G√©n√©rer</button>
</div>
<div id="resultContainer">
<div class="empty-state">
<div style="font-size:64px;margin-bottom:20px">üìù</div>
<h3>Aucune conclusion g√©n√©r√©e</h3>
<p>S√©lectionnez un motif principal et cliquez sur "G√©n√©rer"</p>
</div>
</div>
</div>

<div id="modeSelectionModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<span>Choisissez le type de document</span>
<span class="modal-close" onclick="closeModal('modeSelectionModal')">√ó</span>
</div>
<div class="mode-selection">
<div class="mode-btn" onclick="selectMode('examen')">
<div class="mode-btn-icon">ü©∫</div>
<div>EXAMEN TYPE</div>
</div>
<div class="mode-btn" onclick="selectMode('conclusion')">
<div class="mode-btn-icon">üìã</div>
<div>CONCLUSION TYPE</div>
</div>
<div class="mode-btn" onclick="selectMode('examen_conclusion')">
<div class="mode-btn-icon">üìã+ü©∫</div>
<div>EXAMEN + CONCLUSION</div>
</div>
</div>
</div>
</div>

<div id="xxxxModal" class="modal"></div>
<div id="alternativeModal" class="modal"></div>
<div id="bulleModal" class="modal"></div>
<div id="ordoModal" class="modal"></div>
<div id="allOrdosModal" class="modal"></div>
<div class="floating-actions" style="display:none" id="floatingActions">
<button class="action-btn secondary" onclick="resetAll()">üîÑ</button>
<button class="action-btn" onclick="copyAll()">üìã</button>
</div>

<script>
const API_URL='https://conclusions-medicales-api-1oa1.onrender.com';
let state={categories:[],motifPrincipal:null,motifsSecondaires:[],conclusion:null,conduiteLines:[],allOrdonnances:[],currentMode:null,currentBulles:[]};

document.addEventListener('DOMContentLoaded',()=>{
checkAPI();
loadCategories();
document.getElementById('generateTop').onclick=showModeSelection;
document.getElementById('generateBottom').onclick=showModeSelection;
});

async function checkAPI(){
try{
const r=await fetch(`${API_URL}/health`);
const d=await r.json();
const s=document.getElementById('apiStatus');
if(d.status==='healthy'){
s.className='api-status connected';
s.textContent='‚úÖ Connect√©';
}
}catch(e){console.error('Erreur API:',e);}
}

async function loadCategories(){
try{
const r=await fetch(`${API_URL}/categories`);
state.categories=await r.json();
renderCategories();
}catch(e){console.error('Erreur cat√©gories:',e);}
}

function renderCategories(){
const mainHtml=state.categories.map(cat=>`
<button class="category-btn" onclick="toggleCategory('${cat.table_name}','${cat.nom}',this,'main')">
${cat.nom}
</button>
<div id="motifs-main-${cat.table_name}" class="motifs-list"></div>
`).join('');

const secHtml=state.categories.map(cat=>`
<button class="category-btn" onclick="toggleCategory('${cat.table_name}','${cat.nom}',this,'secondary')">
${cat.nom}
</button>
<div id="motifs-sec-${cat.table_name}" class="motifs-list"></div>
`).join('');

document.getElementById('categoriesGrid').innerHTML=mainHtml;
document.getElementById('categoriesSecondaryGrid').innerHTML=secHtml;
}

async function toggleCategory(tableName,nomCategorie,btnElement,type){
const containerId=type==='main'?`motifs-main-${tableName}`:`motifs-sec-${tableName}`;
const container=document.getElementById(containerId);
const isActive=container.classList.contains('active');

if(isActive){
container.classList.remove('active');
btnElement.classList.remove('active');
}else{
btnElement.classList.add('active');
container.classList.add('active');

if(!container.innerHTML){
try{
const r=await fetch(`${API_URL}/motifs/${tableName}`);
const motifs=await r.json();
container.innerHTML=motifs.map(motif=>`
<button class="motif-btn" onclick="selectMotif('${tableName}','${motif.id}','${motif.nom_motif.replace(/'/g,"\\'")}','${type}',this)">
${motif.nom_motif}
</button>
`).join('');
}catch(e){console.error('Erreur motifs:',e);}
}
}

if(type==='main'){
document.getElementById('secondarySection').style.display='block';
}
}

function updateSelectionDisplay(){
if(state.motifPrincipal){
document.getElementById('mainSelectionBox').style.display='block';
document.getElementById('mainSelectionText').textContent=state.motifPrincipal.nom;
}else{
document.getElementById('mainSelectionBox').style.display='none';
}

if(state.motifsSecondaires.length>0){
document.getElementById('secondarySelectionBox').style.display='block';
document.getElementById('secondarySelectionText').innerHTML=state.motifsSecondaires.map(m=>`<div style="margin-bottom:4px">‚Ä¢ ${m.nom}</div>`).join('');
}else{
document.getElementById('secondarySelectionBox').style.display='none';
}
}

function selectMotif(tableName,motifId,nomMotif,type,btnElement){
if(type==='main'){
document.querySelectorAll('.motif-btn.principal').forEach(btn=>btn.classList.remove('principal'));
state.motifPrincipal={table:tableName,id:motifId,nom:nomMotif};
btnElement.classList.add('principal');
document.getElementById('generateTop').disabled=false;
document.getElementById('generateBottom').disabled=false;
toast(`‚úì Motif principal: ${nomMotif}`);
}else{
if(btnElement.classList.contains('secondaire')){
btnElement.classList.remove('secondaire');
state.motifsSecondaires=state.motifsSecondaires.filter(m=>m.id!==motifId);
toast('‚úó Retir√©');
}else{
btnElement.classList.add('secondaire');
state.motifsSecondaires.push({table:tableName,id:motifId,nom:nomMotif});
toast(`‚úì Secondaire: ${nomMotif}`);
}
}
updateSelectionDisplay();
}

function showModeSelection(){
if(!state.motifPrincipal){
toast('‚ö†Ô∏è S√©lectionnez un motif principal','error');
return;
}
document.getElementById('modeSelectionModal').classList.add('active');
}

async function selectMode(mode){
state.currentMode=mode;
closeModal('modeSelectionModal');
await generateConclusion(mode);
}

async function generateConclusion(mode){
if(!state.motifPrincipal){
toast('‚ö†Ô∏è S√©lectionnez un motif principal','error');
return;
}

toast('‚è≥ G√©n√©ration...');

try{
const r=await fetch(`${API_URL}/fusion`,{
method:'POST',
headers:{'Content-Type':'application/json'},
body:JSON.stringify({
table_principale:state.motifPrincipal.table,
motif_principal_id:state.motifPrincipal.id,
motifs_secondaires:state.motifsSecondaires,
mode:mode
})
});

if(!r.ok){
const errorText=await r.text();
console.error('Erreur API:',errorText);
throw new Error('Erreur API');
}

state.conclusion=await r.json();
console.log('Conclusion re√ßue:',state.conclusion);
renderConclusion(mode);
toast('‚úÖ G√©n√©r√© !');
document.getElementById('floatingActions').style.display='flex';
}catch(e){
toast('‚ùå Erreur: '+e.message,'error');
console.error('Erreur compl√®te:',e);
}
}

function renderBullesHtml(bulles){
if(!bulles||!Array.isArray(bulles)||bulles.length===0)return'';
let html='';
bulles.forEach((bulle,idx)=>{
if(bulle&&bulle.titre){
const globalIdx=state.currentBulles.length;
state.currentBulles.push(bulle);
html+=`<button class="bulle-btn" onclick="showBulleByIndex(${globalIdx})">üí° ${bulle.titre}</button>`;
}
});
return html?`<div class="bulles-container">${html}</div>`:'';
}

function renderConclusion(mode){
if(mode==='examen_conclusion'){
renderSplitView();
}else{
renderSingleView(mode);
}
}

function renderSingleView(mode){
let html='';
state.currentBulles=[];

if(!state.conclusion||!state.conclusion.modules){
toast('‚ùå Donn√©es invalides','error');
return;
}

state.conclusion.modules.forEach((module,moduleIdx)=>{
let content='';

if(module.type==='conduite_tenir'){
state.conduiteLines=(module.lignes||[]).map((ligne,i)=>({
id:Date.now()+i,
text:ligne.texte||'',
proposition:ligne.proposition,
alternative:ligne.alternative,
commentaire:ligne.commentaire,
deletable:ligne.deletable
}));
content=renderConduiteATenir();
}else if(module.type==='hdm'){
content=renderHDM(module);
}else{
// Grouper √©l√©ments inline
let currentLineHtml='';
const renderedLines=[];

(module.lignes||[]).forEach((ligne,idx)=>{
if(!ligne)return;

const ligneHtml=renderLigne(ligne);
if(!ligneHtml)return;

currentLineHtml+=ligneHtml;

const isLast=(idx===module.lignes.length-1);
const nextIsNewLine=!isLast&&module.lignes[idx+1]&&module.lignes[idx+1].newline;

if(isLast||nextIsNewLine){
if(currentLineHtml.trim()){
renderedLines.push(`<div class="module-line">${currentLineHtml}</div>`);
}
currentLineHtml='';
}
});

if(currentLineHtml.trim()){
renderedLines.push(`<div class="module-line">${currentLineHtml}</div>`);
}

content=renderedLines.join('');
}

const bullesHtml=renderBullesHtml(module.bulles);

const copyBtn=mode==='examen'||module.type==='hdm'||module.type.startsWith('examen_')?
`<button class="module-copy-btn" onclick="copyModule('${module.type}')">üìã Copier</button>`:'';

const isEditable=module.type!=='conduite_tenir';

html+=`
<div class="module" data-module-type="${module.type}">
<div class="module-header">
<span class="module-title"><span class="icon">${module.icon||''}</span> ${module.titre||''}</span>
${copyBtn}
${bullesHtml}
</div>
<div class="module-content" data-module-content="${module.type}" contenteditable="${isEditable}">
${content}
</div>
${module.type==='conduite_tenir'?renderOrdonnancesSection():''}
</div>
`;
});

if(state.conclusion.codes_cim&&state.conclusion.codes_cim.length>0){
const codesText=state.conclusion.codes_cim.map(c=>`${c.code||''} - ${c.libelle||''}`).join('<br>');
html+=`
<div class="codes-section">
<div class="code-item"><strong>Suggestion CIM-10</strong>${codesText}</div>
</div>
`;
}

document.getElementById('resultContainer').innerHTML=html;
}

function renderHDM(module){
if(!module.sections||!Array.isArray(module.sections))return'';

console.log('[HDM] Rendering HDM module');

return module.sections.map(section=>{
if(!section.lignes||section.lignes.length===0)return'';

console.log(`[HDM] Section "${section.titre}" avec ${section.lignes.length} lignes`);

// Grouper les lignes par phrase
let currentLineHtml='';
const renderedLines=[];

section.lignes.forEach((ligne,idx)=>{
if(!ligne)return;

console.log(`[HDM] Ligne ${idx}:`, ligne);

const ligneHtml=renderLigne(ligne);

console.log(`[HDM] Ligne ${idx} rendu: "${ligneHtml.substring(0,50)}..."`);

if(!ligneHtml)return;

// Ajouter l'√©l√©ment √† la ligne courante
currentLineHtml+=ligneHtml;

const isLast=(idx===section.lignes.length-1);
const nextIsNewLine=!isLast&&section.lignes[idx+1]&&section.lignes[idx+1].newline;

if(isLast||nextIsNewLine){
if(currentLineHtml.trim()){
renderedLines.push(`<div class="module-line">${currentLineHtml}</div>`);
console.log(`[HDM] Ajout ligne HTML (${currentLineHtml.length} chars)`);
}
currentLineHtml='';
}
});

// Ligne restante
if(currentLineHtml.trim()){
renderedLines.push(`<div class="module-line">${currentLineHtml}</div>`);
console.log('[HDM] Ajout ligne restante');
}

const lignesHtml=renderedLines.join('');
if(!lignesHtml)return'';

console.log(`[HDM] Total lignes rendues: ${renderedLines.length}`);

return `
<div class="hdm-section">
<div class="hdm-section-title">${section.titre||''}</div>
<div class="hdm-section-content">
${lignesHtml}
</div>
</div>
`;
}).filter(s=>s).join('');
}

function renderSplitView(){
state.currentBulles=[];

if(!state.conclusion||!state.conclusion.modules){
toast('‚ùå Donn√©es invalides','error');
return;
}

const examenModules=state.conclusion.modules.filter(m=>
m.type==='hdm'||m.type.startsWith('examen_')
);
const conclusionModules=state.conclusion.modules.filter(m=>
!m.type.startsWith('examen_')&&m.type!=='hdm'
);

let examenHtml='';
examenModules.forEach(module=>{
let content='';
if(module.type==='hdm'){
content=renderHDM(module);
}else{
let currentLineHtml='';
const renderedLines=[];

(module.lignes||[]).forEach((ligne,idx)=>{
if(!ligne)return;
const ligneHtml=renderLigne(ligne);
if(!ligneHtml)return;

currentLineHtml+=ligneHtml;

const isLast=(idx===module.lignes.length-1);
const nextIsNewLine=!isLast&&module.lignes[idx+1]&&module.lignes[idx+1].newline;

if(isLast||nextIsNewLine){
if(currentLineHtml.trim()){
renderedLines.push(`<div class="module-line">${currentLineHtml}</div>`);
}
currentLineHtml='';
}
});

if(currentLineHtml.trim()){
renderedLines.push(`<div class="module-line">${currentLineHtml}</div>`);
}

content=renderedLines.join('');
}

const bullesHtml=renderBullesHtml(module.bulles);
const copyBtn=`<button class="module-copy-btn" onclick="copyModule('${module.type}')">üìã Copier</button>`;

const isEditable=true;

examenHtml+=`
<div class="module" data-module-type="${module.type}">
<div class="module-header">
<span class="module-title"><span class="icon">${module.icon||''}</span> ${module.titre||''}</span>
${copyBtn}
${bullesHtml}
</div>
<div class="module-content" data-module-content="${module.type}" contenteditable="${isEditable}">
${content}
</div>
</div>
`;
});

let conclusionHtml='';
conclusionModules.forEach(module=>{
let content='';

if(module.type==='conduite_tenir'){
state.conduiteLines=(module.lignes||[]).map((ligne,i)=>({
id:Date.now()+i,
text:ligne.texte||'',
proposition:ligne.proposition,
alternative:ligne.alternative,
commentaire:ligne.commentaire,
deletable:ligne.deletable
}));
content=renderConduiteATenir();
}else{
let currentLineHtml='';
const renderedLines=[];

(module.lignes||[]).forEach((ligne,idx)=>{
if(!ligne)return;
const ligneHtml=renderLigne(ligne);
if(!ligneHtml)return;

currentLineHtml+=ligneHtml;

const isLast=(idx===module.lignes.length-1);
const nextIsNewLine=!isLast&&module.lignes[idx+1]&&module.lignes[idx+1].newline;

if(isLast||nextIsNewLine){
if(currentLineHtml.trim()){
renderedLines.push(`<div class="module-line">${currentLineHtml}</div>`);
}
currentLineHtml='';
}
});

if(currentLineHtml.trim()){
renderedLines.push(`<div class="module-line">${currentLineHtml}</div>`);
}

content=renderedLines.join('');
}

const bullesHtml=renderBullesHtml(module.bulles);

conclusionHtml+=`
<div class="module" data-module-type="${module.type}">
<div class="module-header">
<span class="module-title"><span class="icon">${module.icon||''}</span> ${module.titre||''}</span>
${bullesHtml}
</div>
<div class="module-content" data-module-content="${module.type}" contenteditable="${module.type!=='conduite_tenir'}">
${content}
</div>
${module.type==='conduite_tenir'?renderOrdonnancesSection():''}
</div>
`;
});

if(state.conclusion.codes_cim&&state.conclusion.codes_cim.length>0){
const codesText=state.conclusion.codes_cim.map(c=>`${c.code||''} - ${c.libelle||''}`).join('<br>');
conclusionHtml+=`
<div class="codes-section">
<div class="code-item"><strong>Suggestion CIM-10</strong>${codesText}</div>
</div>
`;
}

const splitHtml=`
<div class="split-view">
<div class="split-panel">
<div class="split-header">
<span class="split-title">ü©∫ EXAMEN TYPE</span>
<button class="copy-btn" onclick="copyExamen()">üìã Copier</button>
</div>
<div id="examenContent">${examenHtml}</div>
</div>
<div class="split-panel">
<div class="split-header">
<span class="split-title">üìã CONCLUSION TYPE</span>
<button class="copy-btn" onclick="copyConclusion()">üìã Copier</button>
</div>
<div id="conclusionContent">${conclusionHtml}</div>
</div>
</div>
`;

document.getElementById('resultContainer').innerHTML=splitHtml;
}

function renderLigne(ligne){
if(!ligne)return'';

let texte=ligne.texte||'';
if(!texte)return'';

// G√©rer les diff√©rents types d'√©l√©ments
if(ligne.commentaire){
return `<span class="comment">${texte}</span>`;
}

if(ligne.deletable){
const id='del-'+Date.now()+Math.random();
return `<span class="deletable" id="${id}" onclick="deleteText('${id}')">${texte}</span>`;
}

if(texte==='XXXX'){
const props=ligne.proposition&&ligne.proposition.suggestions?ligne.proposition.suggestions:[];
const propsJson=JSON.stringify(props).replace(/'/g,'&#39;');
return `<span class="xxxx" data-props='${propsJson}' onclick="openXXXXModal(this)">XXXX</span>`;
}

if(ligne.alternative&&ligne.alternative.alternatives){
const alts=ligne.alternative.alternatives;
const altsJson=JSON.stringify(alts).replace(/'/g,'&#39;');
return `<span class="alternative" data-alts='${altsJson}' onclick="openAlternativeModal(this)">${texte}</span>`;
}

// Texte normal
return texte;
}

function deleteText(elementId){
const element=document.getElementById(elementId);
if(element){
element.remove();
toast('‚úì Texte supprim√©');
}
}

function renderConduiteATenir(){
return state.conduiteLines.map((line,idx)=>{
let text=line.text||'';
text=text.replace(/XXXX/g,'<span class="xxxx" onclick="openXXXXModal(this)">XXXX</span>');
return `
<div class="conduite-line" data-line-idx="${idx}">
<div class="conduite-number">${idx+1}</div>
<div class="conduite-text" contenteditable="true" onblur="updateConduiteLineText(${idx},this.innerText)">${text}</div>
<div class="conduite-actions">
<button class="action-icon action-up" onclick="moveLineUp(${idx})">‚Üë</button>
<button class="action-icon action-down" onclick="moveLineDown(${idx})">‚Üì</button>
<button class="action-icon action-delete" onclick="deleteLine(${idx})">üóë</button>
</div>
</div>
`;
}).join('')+`
<div class="conduite-add-line">
<input type="text" id="newConduiteLineInput" class="conduite-input" placeholder="‚ûï Ajouter une ligne..." onkeypress="if(event.key==='Enter')addNewConduiteLine()">
<button class="conduite-add-btn" onclick="addNewConduiteLine()">‚úì Ajouter</button>
</div>
`;
}

function moveLineUp(idx){
if(idx===0)return;
[state.conduiteLines[idx],state.conduiteLines[idx-1]]=[state.conduiteLines[idx-1],state.conduiteLines[idx]];

// Re-render uniquement le module conduite
const conduiteModule=document.querySelector('[data-module-type="conduite_tenir"] .module-content');
if(conduiteModule){
conduiteModule.innerHTML=renderConduiteATenir();
}
}

function moveLineDown(idx){
if(idx===state.conduiteLines.length-1)return;
[state.conduiteLines[idx],state.conduiteLines[idx+1]]=[state.conduiteLines[idx+1],state.conduiteLines[idx]];

// Re-render uniquement le module conduite
const conduiteModule=document.querySelector('[data-module-type="conduite_tenir"] .module-content');
if(conduiteModule){
conduiteModule.innerHTML=renderConduiteATenir();
}
}

function deleteLine(idx){
if(idx<0||idx>=state.conduiteLines.length)return;
state.conduiteLines.splice(idx,1);

// Re-render uniquement le module conduite
const conduiteModule=document.querySelector('[data-module-type="conduite_tenir"] .module-content');
if(conduiteModule){
conduiteModule.innerHTML=renderConduiteATenir();
}

toast('‚úì Ligne supprim√©e');
}

function updateConduiteLineText(idx,newText){
if(idx>=0&&idx<state.conduiteLines.length){
state.conduiteLines[idx].text=newText.trim();
}
}

function addNewConduiteLine(){
const input=document.getElementById('newConduiteLineInput');
const text=input.value.trim();

if(!text){
toast('‚ö†Ô∏è Entrez du texte','error');
return;
}

// Ajouter la nouvelle ligne
state.conduiteLines.push({
id:Date.now(),
text:text,
proposition:null,
alternative:null,
commentaire:null,
deletable:false
});

// Re-render
const conduiteModule=document.querySelector('[data-module-type="conduite_tenir"] .module-content');
if(conduiteModule){
conduiteModule.innerHTML=renderConduiteATenir();
}

// R√©initialiser l'input
input.value='';
toast('‚úì Ligne ajout√©e');
}

function renderOrdonnancesSection(){
if(!state.conclusion.ordonnances||state.conclusion.ordonnances.length===0)return'';

return`
<div class="ordonnances-section">
<strong>üíä Ordonnances disponibles</strong><br>
<button class="ordo-btn all" onclick="loadAllOrdonnances()">üìã Toutes Les Ordonnances Disponibles</button>
${state.conclusion.ordonnances.map((ordo,i)=>`
<button class="ordo-btn" onclick="showOrdonnance(${i})">${ordo.titre||'Ordonnance'}</button>
`).join('')}
</div>
`;
}

function showOrdonnance(idx){
const ordo=state.conclusion.ordonnances[idx];
if(!ordo)return;

let currentLineHtml='';
const renderedLines=[];

(ordo.lignes||[]).forEach((ligne,i)=>{
if(!ligne)return;
const ligneHtml=renderLigne(ligne);
if(!ligneHtml)return;

currentLineHtml+=ligneHtml;

const isLast=(i===ordo.lignes.length-1);
const nextIsNewLine=!isLast&&ordo.lignes[i+1]&&ordo.lignes[i+1].newline;

if(isLast||nextIsNewLine){
if(currentLineHtml.trim()){
renderedLines.push(`<div class="module-line">${currentLineHtml}</div>`);
}
currentLineHtml='';
}
});

if(currentLineHtml.trim()){
renderedLines.push(`<div class="module-line">${currentLineHtml}</div>`);
}

const content=renderedLines.join('');

document.getElementById('ordoModal').innerHTML=`
<div class="modal-content">
<div class="modal-header">
<span>${ordo.titre||'Ordonnance'}</span>
<span class="modal-close" onclick="closeModal('ordoModal')">√ó</span>
</div>
<div>${content}</div>
<div class="modal-buttons">
<button class="modal-btn modal-btn-secondary" onclick="closeModal('ordoModal')">Fermer</button>
<button class="modal-btn modal-btn-primary" onclick="copyOrdonnance(${idx})">üìã Copier</button>
</div>
</div>
`;
document.getElementById('ordoModal').classList.add('active');
}

function copyOrdonnance(idx){
const ordo=state.conclusion.ordonnances[idx];
if(!ordo||!ordo.lignes)return;
const text=ordo.lignes.filter(l=>!l.commentaire).map(l=>l.texte||'').join('\n');
copyText(text);
}

async function loadAllOrdonnances(){
toast('‚è≥ Chargement...');
state.allOrdonnances=[];

try{
for(const cat of state.categories){
try{
const mr=await fetch(`${API_URL}/motifs/${cat.table_name}`);
if(!mr.ok){
console.error(`Erreur cat√©gorie ${cat.nom}`);
continue;
}
const motifs=await mr.json();

for(const motif of motifs){
try{
const fr=await fetch(`${API_URL}/fusion`,{
method:'POST',
headers:{'Content-Type':'application/json'},
body:JSON.stringify({
table_principale:cat.table_name,
motif_principal_id:motif.id,
motifs_secondaires:[],
mode:'conclusion'
})
});

if(!fr.ok){
console.error(`Erreur motif ${motif.nom_motif}`);
continue;
}

const fd=await fr.json();

if(fd.ordonnances&&Array.isArray(fd.ordonnances)){
fd.ordonnances.forEach(ordo=>{
state.allOrdonnances.push({
categorie:cat.nom,
motif:motif.nom_motif,
ordonnance:ordo
});
});
}
}catch(err){
console.error(`Erreur motif ${motif.nom_motif}:`,err);
}
}
}catch(err){
console.error(`Erreur cat√©gorie ${cat.nom}:`,err);
}
}

if(state.allOrdonnances.length===0){
toast('‚ùå Aucune ordonnance trouv√©e','error');
return;
}

renderAllOrdonnances();
toast('‚úÖ Charg√©');
}catch(e){
toast('‚ùå Erreur: '+e.message,'error');
console.error('Erreur loadAllOrdonnances:',e);
}
}

function renderAllOrdonnances(){
const categories=[...new Set(state.allOrdonnances.map(o=>o.categorie))];

document.getElementById('allOrdosModal').innerHTML=`
<div class="modal-content">
<div class="modal-header">
<span>üìã Toutes les Ordonnances</span>
<span class="modal-close" onclick="closeModal('allOrdosModal')">√ó</span>
</div>
<div class="ordo-filters">
<div class="ordo-filter">
<label>Cat√©gorie</label>
<select id="catFilter" onchange="filterAllOrdonnances()">
<option value="">Toutes</option>
${categories.map(c=>`<option value="${c}">${c}</option>`).join('')}
</select>
</div>
<div class="ordo-filter">
<label>Motif</label>
<select id="motifFilter" onchange="filterAllOrdonnances()">
<option value="">Tous</option>
</select>
</div>
</div>
<div id="ordosList"></div>
</div>
`;

filterAllOrdonnances();
document.getElementById('allOrdosModal').classList.add('active');
}

function filterAllOrdonnances(){
const catFilter=document.getElementById('catFilter').value;
const motifFilter=document.getElementById('motifFilter').value;

let filtered=state.allOrdonnances;

if(catFilter){
filtered=filtered.filter(o=>o.categorie===catFilter);
const motifs=[...new Set(filtered.map(o=>o.motif))];
document.getElementById('motifFilter').innerHTML=
'<option value="">Tous</option>'+
motifs.map(m=>`<option value="${m}">${m}</option>`).join('');
}else{
document.getElementById('motifFilter').innerHTML='<option value="">Tous</option>';
}

if(motifFilter)filtered=filtered.filter(o=>o.motif===motifFilter);

document.getElementById('ordosList').innerHTML=filtered.map((item,idx)=>`
<div class="ordo-item" onclick="openOrdonnanceFromList(${idx},'${catFilter}','${motifFilter}')">
<div class="ordo-item-header">${item.ordonnance.titre||'Ordonnance'} - ${item.motif} (${item.categorie})</div>
</div>
`).join('');
}

function openOrdonnanceFromList(idx,catFilter,motifFilter){
let filtered=state.allOrdonnances;
if(catFilter)filtered=filtered.filter(o=>o.categorie===catFilter);
if(motifFilter)filtered=filtered.filter(o=>o.motif===motifFilter);

const item=filtered[idx];
if(!item||!item.ordonnance)return;

const content=(item.ordonnance.lignes||[]).map(ligne=>{
if(!ligne||!ligne.texte)return'';
return renderLigne(ligne);
}).join('');

closeModal('allOrdosModal');

const textToCopy=(item.ordonnance.lignes||[]).filter(l=>!l.commentaire).map(l=>l.texte||'').join('\\n').replace(/'/g,"\\'");

document.getElementById('ordoModal').innerHTML=`
<div class="modal-content">
<div class="modal-header">
<span>${item.ordonnance.titre||'Ordonnance'}</span>
<span class="modal-close" onclick="closeModal('ordoModal')">√ó</span>
</div>
<div>${content}</div>
<div class="modal-buttons">
<button class="modal-btn modal-btn-secondary" onclick="closeModal('ordoModal')">Fermer</button>
<button class="modal-btn modal-btn-primary" onclick="copyText('${textToCopy}')">üìã Copier</button>
</div>
</div>
`;
document.getElementById('ordoModal').classList.add('active');
}

function showBulleByIndex(idx){
const bulle=state.currentBulles[idx];
if(!bulle){
console.error('Bulle non trouv√©e:',idx);
return;
}
document.getElementById('bulleModal').innerHTML=`
<div class="modal-content modal-bulle">
<div class="modal-header">
<span>üí° ${bulle.titre||'Info'}</span>
<span class="modal-close" onclick="closeModal('bulleModal')">√ó</span>
</div>
<div class="bulle-content">${bulle.contenu||''}</div>
</div>
`;
document.getElementById('bulleModal').classList.add('active');
}

function openXXXXModal(element){
element.id='xxxx-'+Date.now();

let propositions=[];
try{
const propsAttr=element.getAttribute('data-props');
if(propsAttr){
propositions=JSON.parse(propsAttr);
}
}catch(e){
console.error('Erreur parse props:',e);
}

const chipsHtml=propositions&&propositions.length>0?`
<div class="proposition-chips">
${propositions.map(p=>`
<div class="chip" onclick="fillXXXX('${element.id}','${(p||'').replace(/'/g,"\\'")}')">${p||''}</div>
`).join('')}
</div>
`:'';

document.getElementById('xxxxModal').innerHTML=`
<div class="modal-content">
<div class="modal-header">
<span>Remplir le champ</span>
<span class="modal-close" onclick="closeModal('xxxxModal')">√ó</span>
</div>
${chipsHtml}
<input type="text" id="xxxxInput" class="modal-input" placeholder="Entrez..." onkeypress="if(event.key==='Enter')validateXXXX('${element.id}')">
<div class="modal-buttons">
<button class="modal-btn modal-btn-secondary" onclick="closeModal('xxxxModal')">Annuler</button>
<button class="modal-btn modal-btn-primary" onclick="validateXXXX('${element.id}')">‚úì Valider</button>
</div>
</div>
`;
document.getElementById('xxxxModal').classList.add('active');
setTimeout(()=>document.getElementById('xxxxInput').focus(),100);
}

function fillXXXX(elementId,value){
document.getElementById('xxxxInput').value=value;
}

function validateXXXX(elementId){
const value=document.getElementById('xxxxInput').value.trim();
if(value){
const element=document.getElementById(elementId);
if(element){
element.textContent=value;
element.classList.remove('xxxx');
element.style.background='transparent';
element.style.border='none';
element.style.color='#cbd5e1';
element.style.fontWeight='normal';
element.onclick=null;
element.removeAttribute('data-props');
}
}
closeModal('xxxxModal');
}

function openAlternativeModal(element){
element.id='alt-'+Date.now();

let alternatives=[];
try{
const altsAttr=element.getAttribute('data-alts');
if(altsAttr){
alternatives=JSON.parse(altsAttr);
}
}catch(e){
console.error('Erreur parse alternatives:',e);
}

// Afficher uniquement les alternatives APR√àS la premi√®re (qui est d√©j√† affich√©e)
const autresAlternatives=alternatives.slice(1);

const chipsHtml=autresAlternatives&&autresAlternatives.length>0?`
<div class="proposition-chips">
${autresAlternatives.map((a,idx)=>`
<div class="chip" onclick="fillAlternative('${element.id}','${(a||'').replace(/'/g,"\\'")}')">${a||''}</div>
`).join('')}
</div>
`:'';

document.getElementById('alternativeModal').innerHTML=`
<div class="modal-content">
<div class="modal-header">
<span>Choisir une alternative</span>
<span class="modal-close" onclick="closeModal('alternativeModal')">√ó</span>
</div>
${chipsHtml}
<input type="text" id="alternativeInput" class="modal-input" placeholder="Ou entrez votre texte..." onkeypress="if(event.key==='Enter')validateAlternative('${element.id}')">
<div class="modal-buttons">
<button class="modal-btn modal-btn-secondary" onclick="closeModal('alternativeModal')">Annuler</button>
<button class="modal-btn modal-btn-primary" onclick="validateAlternative('${element.id}')">‚úì Valider</button>
</div>
</div>
`;
document.getElementById('alternativeModal').classList.add('active');
setTimeout(()=>document.getElementById('alternativeInput').focus(),100);
}

function fillAlternative(elementId,value){
// Remplir le champ
document.getElementById('alternativeInput').value=value;
// Ou directement valider
const element=document.getElementById(elementId);
if(element){
element.textContent=value;
element.classList.remove('alternative');
element.style.background='transparent';
element.style.border='none';
element.style.color='#cbd5e1';
element.style.fontWeight='normal';
element.onclick=null;
element.removeAttribute('data-alts');
}
closeModal('alternativeModal');
}

function validateAlternative(elementId){
const value=document.getElementById('alternativeInput').value.trim();
if(value){
const element=document.getElementById(elementId);
if(element){
// Remplacer le texte et retirer le style alternatif
element.textContent=value;
element.classList.remove('alternative');
element.style.background='transparent';
element.style.border='none';
element.style.color='#cbd5e1';
element.style.fontWeight='normal';
element.onclick=null;
element.removeAttribute('data-alts');
}
}
closeModal('alternativeModal');
}

function closeModal(modalId){
document.getElementById(modalId).classList.remove('active');
}

function copyText(text){
navigator.clipboard.writeText(text);
toast('‚úÖ Copi√© !');
}

function copyModule(moduleType){
const moduleDiv=document.querySelector(`[data-module-content="${moduleType}"]`);
if(!moduleDiv)return;

const clone=moduleDiv.cloneNode(true);

clone.querySelectorAll('.comment').forEach(el=>el.remove());
clone.querySelectorAll('.icon').forEach(el=>el.remove());
clone.querySelectorAll('.hdm-section-title').forEach(el=>el.remove());

const text=clone.innerText;
copyText(text);
}

function copyExamen(){
const examenDiv=document.getElementById('examenContent');
if(!examenDiv)return;

const clone=examenDiv.cloneNode(true);
clone.querySelectorAll('.comment').forEach(el=>el.remove());
clone.querySelectorAll('.icon').forEach(el=>el.remove());
clone.querySelectorAll('.module-header').forEach(el=>el.remove());
clone.querySelectorAll('.hdm-section-title').forEach(el=>el.remove());

const text=clone.innerText;
copyText(text);
}

function copyConclusion(){
const conclusionDiv=document.getElementById('conclusionContent');
if(!conclusionDiv)return;

const clone=conclusionDiv.cloneNode(true);
clone.querySelectorAll('.comment').forEach(el=>el.remove());
clone.querySelectorAll('.icon').forEach(el=>el.remove());

const text=clone.innerText;
copyText(text);
}

function copyAll(){
if(!state.conclusion)return;
let text='';
state.conclusion.modules.forEach(module=>{
const lines=(module.lignes||[]).filter(l=>!l.commentaire).map(l=>l.texte||'').join('\n');
text+=`${lines}\n\n`;
});
copyText(text);
}

function resetAll(){
state={categories:state.categories,motifPrincipal:null,motifsSecondaires:[],conclusion:null,conduiteLines:[],allOrdonnances:[],currentMode:null,currentBulles:[]};
document.querySelectorAll('.category-btn,.motif-btn').forEach(btn=>btn.classList.remove('active','principal','secondaire'));
document.querySelectorAll('.motifs-list').forEach(list=>list.classList.remove('active'));
document.getElementById('generateTop').disabled=true;
document.getElementById('generateBottom').disabled=true;
document.getElementById('floatingActions').style.display='none';
document.getElementById('secondarySection').style.display='none';
document.getElementById('mainSelectionBox').style.display='none';
document.getElementById('secondarySelectionBox').style.display='none';
document.getElementById('resultContainer').innerHTML='<div class="empty-state"><div style="font-size:64px;margin-bottom:20px">üìù</div><h3>Aucune conclusion g√©n√©r√©e</h3><p>S√©lectionnez un motif principal et cliquez sur "G√©n√©rer"</p></div>';
toast('üîÑ R√©initialis√©');
}

function toast(message,type='info'){
const toastEl=document.createElement('div');
toastEl.className='toast';
toastEl.textContent=message;
if(type==='error')toastEl.style.borderColor='#dc2626';
document.body.appendChild(toastEl);
setTimeout(()=>toastEl.remove(),3000);
}

window.addEventListener('click',(e)=>{
if(e.target.classList.contains('modal'))e.target.classList.remove('active');
});
</script>
</body>
</html>
