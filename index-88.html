<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Conclusions MÃ©dicales v5.4.21</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
:root{
--bg-body:#0a1520;
--bg-sidebar:linear-gradient(170deg,#000508 0%,#001018 15%,#002535 35%,#003545 50%,#002535 70%,#001018 85%,#000508 100%);
--bg-main:#0a1825;
--bg-module:#0d2535;
--bg-card:#0a1520;
--bg-panel:#0d2535;
--border-primary:#00d4ff;
--border-secondary:#0891b2;
--border-accent:#06b6d4;
--border-panel:#00d4ff;
--text-primary:#cffafe;
--text-secondary:#67e8f9;
--text-accent:#00d4ff;
--text-title:#22d3ee;
--text-heading:#a5f3fc;
--shadow-primary:rgba(0,212,255,0.4);
--shadow-glow:0 0 40px rgba(0,212,255,0.2),0 0 80px rgba(6,182,212,0.15);
--shadow-panel:0 0 20px rgba(0,212,255,0.5),0 0 40px rgba(0,212,255,0.25);
--btn-bg:#0d2535;
--btn-border:#155e75;
--btn-active-bg:#0e7490;
--btn-active-border:#06b6d4;
--module-border:#164e63;
--module-header-bg:linear-gradient(135deg,#164e63 0%,#0a1520 100%);
--module-icon-color:#22d3ee;
--chip-bg:#0d2535;
--chip-border:#155e75;
--chip-hover-bg:#0e7490;
--chip-hover-border:#06b6d4;
--line-bg:#0a1520;
--line-border:#0d2535;
--line-hover-border:#06b6d4;
}
[data-theme="sober"]{
--bg-body:#f8fafc;
--bg-sidebar:linear-gradient(170deg,#ffffff 0%,#f8fafc 50%,#f1f5f9 100%);
--bg-main:#ffffff;
--bg-module:#f8fafc;
--bg-card:#f1f5f9;
--bg-panel:#ffffff;
--border-primary:#3b82f6;
--border-secondary:#60a5fa;
--border-accent:#2563eb;
--border-panel:#3b82f6;
--text-primary:#0f172a;
--text-secondary:#334155;
--text-accent:#1d4ed8;
--text-title:#1e40af;
--text-heading:#1e3a8a;
--shadow-primary:rgba(59,130,246,0.15);
--shadow-glow:0 4px 20px rgba(59,130,246,0.08);
--shadow-panel:0 4px 20px rgba(59,130,246,0.15);
--btn-bg:#e2e8f0;
--btn-border:#cbd5e1;
--btn-active-bg:#2563eb;
--btn-active-border:#3b82f6;
--module-border:#cbd5e1;
--module-header-bg:linear-gradient(135deg,#f1f5f9 0%,#e2e8f0 100%);
--module-icon-color:#2563eb;
--chip-bg:#e2e8f0;
--chip-border:#cbd5e1;
--chip-hover-bg:#dbeafe;
--chip-hover-border:#3b82f6;
--line-bg:#ffffff;
--line-border:#cbd5e1;
--line-hover-border:#3b82f6;
}
[data-theme="red"]{
--bg-body:#1a0f0f;
--bg-sidebar:linear-gradient(170deg,#000000 0%,#1a0505 15%,#2d0a0a 35%,#3d1010 50%,#2d0a0a 70%,#1a0505 85%,#000000 100%);
--bg-main:#150a0a;
--bg-module:#2d1515;
--bg-card:#1a0f0f;
--bg-panel:#2d1515;
--border-primary:#ef4444;
--border-secondary:#f87171;
--border-accent:#dc2626;
--border-panel:#ef4444;
--text-primary:#fecaca;
--text-secondary:#fca5a5;
--text-accent:#ef4444;
--text-title:#f87171;
--text-heading:#fca5a5;
--shadow-primary:rgba(239,68,68,0.3);
--shadow-glow:0 0 40px rgba(239,68,68,0.2),0 0 80px rgba(220,38,38,0.1);
--shadow-panel:0 0 15px rgba(239,68,68,0.4),0 0 30px rgba(239,68,68,0.2);
--btn-bg:#2d1515;
--btn-border:#7f1d1d;
--btn-active-bg:#991b1b;
--btn-active-border:#ef4444;
--module-border:#7f1d1d;
--module-header-bg:linear-gradient(135deg,#450a0a 0%,#1a0505 100%);
--module-icon-color:#f87171;
--chip-bg:#2d1515;
--chip-border:#7f1d1d;
--chip-hover-bg:#991b1b;
--chip-hover-border:#ef4444;
--line-bg:#1a0f0f;
--line-border:#2d1515;
--line-hover-border:#ef4444;
}
[data-theme="violet"]{
--bg-body:#150f1f;
--bg-sidebar:linear-gradient(170deg,#000000 0%,#0d0517 15%,#1a0a2e 35%,#2d1548 50%,#1a0a2e 70%,#0d0517 85%,#000000 100%);
--bg-main:#0f0a18;
--bg-module:#1f1635;
--bg-card:#150f1f;
--bg-panel:#1f1635;
--border-primary:#a855f7;
--border-secondary:#c084fc;
--border-accent:#9333ea;
--border-panel:#a855f7;
--text-primary:#e9d5ff;
--text-secondary:#d8b4fe;
--text-accent:#a855f7;
--text-title:#c084fc;
--text-heading:#d8b4fe;
--shadow-primary:rgba(168,85,247,0.3);
--shadow-glow:0 0 40px rgba(168,85,247,0.2),0 0 80px rgba(147,51,234,0.1);
--shadow-panel:0 0 15px rgba(168,85,247,0.4),0 0 30px rgba(168,85,247,0.2);
--btn-bg:#1f1635;
--btn-border:#581c87;
--btn-active-bg:#7e22ce;
--btn-active-border:#a855f7;
--module-border:#581c87;
--module-header-bg:linear-gradient(135deg,#3b0764 0%,#1e1b4b 100%);
--module-icon-color:#c084fc;
--chip-bg:#1f1635;
--chip-border:#581c87;
--chip-hover-bg:#7e22ce;
--chip-hover-border:#a855f7;
--line-bg:#150f1f;
--line-border:#1f1635;
--line-hover-border:#a855f7;
}
[data-theme="orange"]{
--bg-body:#1a140a;
--bg-sidebar:linear-gradient(170deg,#000000 0%,#1a0f05 15%,#2d1a0a 35%,#3d2510 50%,#2d1a0a 70%,#1a0f05 85%,#000000 100%);
--bg-main:#150f05;
--bg-module:#2d2015;
--bg-card:#1a140a;
--bg-panel:#2d2015;
--border-primary:#f59e0b;
--border-secondary:#fbbf24;
--border-accent:#d97706;
--border-panel:#f59e0b;
--text-primary:#fef3c7;
--text-secondary:#fde68a;
--text-accent:#f59e0b;
--text-title:#fbbf24;
--text-heading:#fde68a;
--shadow-primary:rgba(245,158,11,0.3);
--shadow-glow:0 0 40px rgba(245,158,11,0.2),0 0 80px rgba(217,119,6,0.1);
--shadow-panel:0 0 15px rgba(245,158,11,0.4),0 0 30px rgba(245,158,11,0.2);
--btn-bg:#2d2015;
--btn-border:#92400e;
--btn-active-bg:#b45309;
--btn-active-border:#f59e0b;
--module-border:#92400e;
--module-header-bg:linear-gradient(135deg,#78350f 0%,#451a03 100%);
--module-icon-color:#fbbf24;
--chip-bg:#2d2015;
--chip-border:#92400e;
--chip-hover-bg:#b45309;
--chip-hover-border:#f59e0b;
--line-bg:#1a140a;
--line-border:#2d2015;
--line-hover-border:#f59e0b;
}
[data-theme="green"]{
--bg-body:#0a1510;
--bg-sidebar:linear-gradient(170deg,#000000 0%,#051a0a 15%,#0a2d15 35%,#103d20 50%,#0a2d15 70%,#051a0a 85%,#000000 100%);
--bg-main:#051008;
--bg-module:#152d1a;
--bg-card:#0a1510;
--bg-panel:#152d1a;
--border-primary:#22c55e;
--border-secondary:#4ade80;
--border-accent:#facc15;
--border-panel:#22c55e;
--text-primary:#dcfce7;
--text-secondary:#bbf7d0;
--text-accent:#22c55e;
--text-title:#fde047;
--text-heading:#4ade80;
--shadow-primary:rgba(34,197,94,0.3);
--shadow-glow:0 0 40px rgba(34,197,94,0.2),0 0 80px rgba(250,204,21,0.1);
--shadow-panel:0 0 15px rgba(34,197,94,0.4),0 0 30px rgba(250,204,21,0.2);
--btn-bg:#152d1a;
--btn-border:#166534;
--btn-active-bg:#15803d;
--btn-active-border:#22c55e;
--module-border:#166534;
--module-header-bg:linear-gradient(135deg,#14532d 0%,#052e16 100%);
--module-icon-color:#4ade80;
--chip-bg:#152d1a;
--chip-border:#166534;
--chip-hover-bg:#15803d;
--chip-hover-border:#22c55e;
--line-bg:#0a1510;
--line-border:#152d1a;
--line-hover-border:#22c55e;
}
[data-theme="pastel"]{
--bg-body:#fdf4ff;
--bg-sidebar:linear-gradient(170deg,#fce7f3 0%,#fbcfe8 15%,#f5d0fe 35%,#e9d5ff 50%,#ddd6fe 70%,#c7d2fe 85%,#bfdbfe 100%);
--bg-main:#fefefe;
--bg-module:#fdf4ff;
--bg-card:#fef7ff;
--bg-panel:#fdf4ff;
--border-primary:#e879f9;
--border-secondary:#f0abfc;
--border-accent:#d946ef;
--border-panel:#e879f9;
--text-primary:#701a75;
--text-secondary:#86198f;
--text-accent:#c026d3;
--text-title:#a21caf;
--text-heading:#86198f;
--shadow-primary:rgba(232,121,249,0.25);
--shadow-glow:0 4px 20px rgba(232,121,249,0.15);
--shadow-panel:0 4px 25px rgba(232,121,249,0.2);
--btn-bg:#fdf4ff;
--btn-border:#f5d0fe;
--btn-active-bg:#c026d3;
--btn-active-border:#e879f9;
--module-border:#f5d0fe;
--module-header-bg:linear-gradient(135deg,#fae8ff 0%,#f5d0fe 100%);
--module-icon-color:#d946ef;
--chip-bg:#fdf4ff;
--chip-border:#f5d0fe;
--chip-hover-bg:#f0abfc;
--chip-hover-border:#e879f9;
--line-bg:#fefefe;
--line-border:#fdf4ff;
--line-hover-border:#e879f9;
}
[data-theme="classic"]{
--bg-body:#1e293b;
--bg-sidebar:linear-gradient(170deg,#0f172a 0%,#1e293b 50%,#334155 100%);
--bg-main:#1e293b;
--bg-module:#334155;
--bg-card:#1e293b;
--bg-panel:#334155;
--border-primary:#64748b;
--border-secondary:#94a3b8;
--border-accent:#475569;
--border-panel:#64748b;
--text-primary:#e2e8f0;
--text-secondary:#cbd5e1;
--text-accent:#94a3b8;
--text-title:#f1f5f9;
--text-heading:#e2e8f0;
--shadow-primary:rgba(100,116,139,0.2);
--shadow-glow:0 4px 20px rgba(100,116,139,0.1);
--shadow-panel:0 4px 20px rgba(100,116,139,0.2);
--btn-bg:#334155;
--btn-border:#475569;
--btn-active-bg:#475569;
--btn-active-border:#64748b;
--module-border:#475569;
--module-header-bg:linear-gradient(135deg,#334155 0%,#1e293b 100%);
--module-icon-color:#94a3b8;
--chip-bg:#334155;
--chip-border:#475569;
--chip-hover-bg:#475569;
--chip-hover-border:#64748b;
--line-bg:#1e293b;
--line-border:#334155;
--line-hover-border:#64748b;
}
[data-theme="ocean"]{
--bg-body:#0c1929;
--bg-sidebar:linear-gradient(170deg,#000000 0%,#0a1628 15%,#0f2744 35%,#164e63 50%,#0f2744 70%,#0a1628 85%,#000000 100%);
--bg-main:#0a1525;
--bg-module:#0f2744;
--bg-card:#0c1929;
--bg-panel:#0f2744;
--border-primary:#06b6d4;
--border-secondary:#22d3ee;
--border-accent:#0891b2;
--border-panel:#06b6d4;
--text-primary:#cffafe;
--text-secondary:#a5f3fc;
--text-accent:#06b6d4;
--text-title:#22d3ee;
--text-heading:#67e8f9;
--shadow-primary:rgba(6,182,212,0.3);
--shadow-glow:0 0 40px rgba(6,182,212,0.2),0 0 80px rgba(8,145,178,0.1);
--shadow-panel:0 0 15px rgba(6,182,212,0.4),0 0 30px rgba(6,182,212,0.2);
--btn-bg:#0f2744;
--btn-border:#155e75;
--btn-active-bg:#0e7490;
--btn-active-border:#06b6d4;
--module-border:#155e75;
--module-header-bg:linear-gradient(135deg,#164e63 0%,#083344 100%);
--module-icon-color:#22d3ee;
--chip-bg:#0f2744;
--chip-border:#155e75;
--chip-hover-bg:#0e7490;
--chip-hover-border:#06b6d4;
--line-bg:#0c1929;
--line-border:#0f2744;
--line-hover-border:#06b6d4;
}
[data-theme="midnight"]{
--bg-body:#0f0f1a;
--bg-sidebar:linear-gradient(170deg,#000000 0%,#05051a 15%,#0a0a2e 35%,#0f0f4d 50%,#0a0a2e 70%,#05051a 85%,#000000 100%);
--bg-main:#0a0a15;
--bg-module:#151530;
--bg-card:#0f0f1a;
--bg-panel:#151530;
--border-primary:#6366f1;
--border-secondary:#818cf8;
--border-accent:#4f46e5;
--border-panel:#6366f1;
--text-primary:#e0e7ff;
--text-secondary:#c7d2fe;
--text-accent:#6366f1;
--text-title:#a5b4fc;
--text-heading:#818cf8;
--shadow-primary:rgba(99,102,241,0.3);
--shadow-glow:0 0 40px rgba(99,102,241,0.2),0 0 80px rgba(79,70,229,0.1);
--shadow-panel:0 0 15px rgba(99,102,241,0.4),0 0 30px rgba(99,102,241,0.2);
--btn-bg:#151530;
--btn-border:#3730a3;
--btn-active-bg:#4338ca;
--btn-active-border:#6366f1;
--module-border:#3730a3;
--module-header-bg:linear-gradient(135deg,#1e1b4b 0%,#0f0f2d 100%);
--module-icon-color:#818cf8;
--chip-bg:#151530;
--chip-border:#3730a3;
--chip-hover-bg:#4338ca;
--chip-hover-border:#6366f1;
--line-bg:#0f0f1a;
--line-border:#151530;
--line-hover-border:#6366f1;
}
[data-theme="nebula"]{
--bg-body:#0f0a1a;
--bg-sidebar:linear-gradient(170deg,#05000f 0%,#1a0530 15%,#350a55 35%,#5c1a7a 50%,#8b2a8f 60%,#c44088 70%,#e84a8a 80%,#5c1a7a 90%,#1a0530 100%);
--bg-main:#150a25;
--bg-module:#251540;
--bg-card:#1a0f2a;
--bg-panel:#251540;
--border-primary:#e879f9;
--border-secondary:#f472b6;
--border-accent:#c026d3;
--border-panel:#e879f9;
--text-primary:#fce7f3;
--text-secondary:#f9a8d4;
--text-accent:#e879f9;
--text-title:#f472b6;
--text-heading:#fbcfe8;
--shadow-primary:rgba(232,121,249,0.4);
--shadow-glow:0 0 40px rgba(232,121,249,0.25),0 0 80px rgba(192,38,211,0.15);
--shadow-panel:0 0 20px rgba(232,121,249,0.5),0 0 40px rgba(244,114,182,0.3);
--btn-bg:#251540;
--btn-border:#86198f;
--btn-active-bg:#a21caf;
--btn-active-border:#e879f9;
--module-border:#701a75;
--module-header-bg:linear-gradient(135deg,#86198f 0%,#3b0764 100%);
--module-icon-color:#f472b6;
--chip-bg:#251540;
--chip-border:#86198f;
--chip-hover-bg:#a21caf;
--chip-hover-border:#e879f9;
--line-bg:#1a0f2a;
--line-border:#251540;
--line-hover-border:#e879f9;
}
[data-theme="violet2"]{
--bg-body:#1a1528;
--bg-sidebar:linear-gradient(170deg,#0a0812 0%,#1a1530 15%,#2d2550 35%,#3d3570 50%,#2d2550 70%,#1a1530 85%,#0a0812 100%);
--bg-main:#15122a;
--bg-module:#252040;
--bg-card:#1a1528;
--bg-panel:#252040;
--border-primary:#8b5cf6;
--border-secondary:#a78bfa;
--border-accent:#7c3aed;
--border-panel:#8b5cf6;
--text-primary:#ede9fe;
--text-secondary:#c4b5fd;
--text-accent:#8b5cf6;
--text-title:#a78bfa;
--text-heading:#ddd6fe;
--shadow-primary:rgba(139,92,246,0.35);
--shadow-glow:0 0 40px rgba(139,92,246,0.2),0 0 80px rgba(124,58,237,0.1);
--shadow-panel:0 0 20px rgba(139,92,246,0.4),0 0 40px rgba(139,92,246,0.2);
--btn-bg:#252040;
--btn-border:#5b21b6;
--btn-active-bg:#6d28d9;
--btn-active-border:#8b5cf6;
--module-border:#4c1d95;
--module-header-bg:linear-gradient(135deg,#5b21b6 0%,#2e1065 100%);
--module-icon-color:#a78bfa;
--chip-bg:#252040;
--chip-border:#5b21b6;
--chip-hover-bg:#6d28d9;
--chip-hover-border:#8b5cf6;
--line-bg:#1a1528;
--line-border:#252040;
--line-hover-border:#8b5cf6;
}
[data-theme="median"]{
--bg-body:#fefce8;
--bg-sidebar:linear-gradient(170deg,#ffffff 0%,#fefce8 15%,#fef9c3 35%,#fef08a 50%,#fef9c3 70%,#fefce8 85%,#ffffff 100%);
--bg-main:#fffef5;
--bg-module:#fef9c3;
--bg-card:#fefce8;
--bg-panel:#fef9c3;
--border-primary:#84cc16;
--border-secondary:#a3e635;
--border-accent:#65a30d;
--border-panel:#84cc16;
--text-primary:#365314;
--text-secondary:#3f6212;
--text-accent:#84cc16;
--text-title:#65a30d;
--text-heading:#4d7c0f;
--shadow-primary:rgba(132,204,22,0.2);
--shadow-glow:0 4px 20px rgba(132,204,22,0.1);
--shadow-panel:0 4px 20px rgba(132,204,22,0.15);
--btn-bg:#fef9c3;
--btn-border:#bef264;
--btn-active-bg:#84cc16;
--btn-active-border:#65a30d;
--module-border:#bef264;
--module-header-bg:linear-gradient(135deg,#ecfccb 0%,#fef9c3 100%);
--module-icon-color:#65a30d;
--chip-bg:#fef9c3;
--chip-border:#bef264;
--chip-hover-bg:#ecfccb;
--chip-hover-border:#84cc16;
--line-bg:#fffef5;
--line-border:#fef9c3;
--line-hover-border:#84cc16;
}
[data-theme="paper"]{
--bg-body:#faf7f5;
--bg-sidebar:linear-gradient(170deg,#ffffff 0%,#faf7f5 15%,#f5f0eb 35%,#ebe5df 50%,#f5f0eb 70%,#faf7f5 85%,#ffffff 100%);
--bg-main:#fefdfb;
--bg-module:#f5f0eb;
--bg-card:#faf7f5;
--bg-panel:#f5f0eb;
--border-primary:#78716c;
--border-secondary:#a8a29e;
--border-accent:#57534e;
--border-panel:#78716c;
--text-primary:#1c1917;
--text-secondary:#44403c;
--text-accent:#57534e;
--text-title:#292524;
--text-heading:#44403c;
--shadow-primary:rgba(120,113,108,0.2);
--shadow-glow:0 4px 20px rgba(120,113,108,0.1);
--shadow-panel:0 4px 20px rgba(120,113,108,0.15);
--btn-bg:#f5f0eb;
--btn-border:#d6d3d1;
--btn-active-bg:#78716c;
--btn-active-border:#57534e;
--module-border:#d6d3d1;
--module-header-bg:linear-gradient(135deg,#e7e5e4 0%,#f5f5f4 100%);
--module-icon-color:#57534e;
--chip-bg:#f5f0eb;
--chip-border:#d6d3d1;
--chip-hover-bg:#e7e5e4;
--chip-hover-border:#78716c;
--line-bg:#fefdfb;
--line-border:#f5f0eb;
--line-hover-border:#78716c;
}
[data-theme="fence"]{
--bg-body:#f0fdfa;
--bg-sidebar:linear-gradient(170deg,#ffffff 0%,#f0fdfa 15%,#ccfbf1 35%,#99f6e4 50%,#ccfbf1 70%,#f0fdfa 85%,#ffffff 100%);
--bg-main:#f7fffe;
--bg-module:#ccfbf1;
--bg-card:#f0fdfa;
--bg-panel:#ccfbf1;
--border-primary:#0d9488;
--border-secondary:#14b8a6;
--border-accent:#0f766e;
--border-panel:#0d9488;
--text-primary:#134e4a;
--text-secondary:#115e59;
--text-accent:#0d9488;
--text-title:#0f766e;
--text-heading:#115e59;
--shadow-primary:rgba(13,148,136,0.2);
--shadow-glow:0 4px 20px rgba(13,148,136,0.1);
--shadow-panel:0 4px 20px rgba(13,148,136,0.15);
--btn-bg:#ccfbf1;
--btn-border:#5eead4;
--btn-active-bg:#0d9488;
--btn-active-border:#0f766e;
--module-border:#5eead4;
--module-header-bg:linear-gradient(135deg,#99f6e4 0%,#ccfbf1 100%);
--module-icon-color:#0f766e;
--chip-bg:#ccfbf1;
--chip-border:#5eead4;
--chip-hover-bg:#99f6e4;
--chip-hover-border:#0d9488;
--line-bg:#f7fffe;
--line-border:#ccfbf1;
--line-hover-border:#0d9488;
}
[data-theme="wake"]{
--bg-body:#f0f9ff;
--bg-sidebar:linear-gradient(170deg,#ffffff 0%,#f0f9ff 15%,#e0f2fe 35%,#bae6fd 50%,#e0f2fe 70%,#f0f9ff 85%,#ffffff 100%);
--bg-main:#f8fcff;
--bg-module:#e0f2fe;
--bg-card:#f0f9ff;
--bg-panel:#e0f2fe;
--border-primary:#0284c7;
--border-secondary:#0ea5e9;
--border-accent:#0369a1;
--border-panel:#0284c7;
--text-primary:#0c4a6e;
--text-secondary:#075985;
--text-accent:#0284c7;
--text-title:#0369a1;
--text-heading:#075985;
--shadow-primary:rgba(2,132,199,0.2);
--shadow-glow:0 4px 20px rgba(2,132,199,0.1);
--shadow-panel:0 4px 20px rgba(2,132,199,0.15);
--btn-bg:#e0f2fe;
--btn-border:#7dd3fc;
--btn-active-bg:#0284c7;
--btn-active-border:#0369a1;
--module-border:#7dd3fc;
--module-header-bg:linear-gradient(135deg,#bae6fd 0%,#e0f2fe 100%);
--module-icon-color:#0369a1;
--chip-bg:#e0f2fe;
--chip-border:#7dd3fc;
--chip-hover-bg:#bae6fd;
--chip-hover-border:#0284c7;
--line-bg:#f8fcff;
--line-border:#e0f2fe;
--line-hover-border:#0284c7;
}
[data-theme="aspect"]{
--bg-body:#f0fdf4;
--bg-sidebar:linear-gradient(170deg,#ffffff 0%,#f0fdf4 15%,#dcfce7 35%,#bbf7d0 50%,#dcfce7 70%,#f0fdf4 85%,#ffffff 100%);
--bg-main:#f7fef9;
--bg-module:#dcfce7;
--bg-card:#f0fdf4;
--bg-panel:#dcfce7;
--border-primary:#16a34a;
--border-secondary:#22c55e;
--border-accent:#15803d;
--border-panel:#16a34a;
--text-primary:#14532d;
--text-secondary:#166534;
--text-accent:#16a34a;
--text-title:#15803d;
--text-heading:#166534;
--shadow-primary:rgba(22,163,74,0.2);
--shadow-glow:0 4px 20px rgba(22,163,74,0.1);
--shadow-panel:0 4px 20px rgba(22,163,74,0.15);
--btn-bg:#dcfce7;
--btn-border:#86efac;
--btn-active-bg:#16a34a;
--btn-active-border:#15803d;
--module-border:#86efac;
--module-header-bg:linear-gradient(135deg,#bbf7d0 0%,#dcfce7 100%);
--module-icon-color:#15803d;
--chip-bg:#dcfce7;
--chip-border:#86efac;
--chip-hover-bg:#bbf7d0;
--chip-hover-border:#16a34a;
--line-bg:#f7fef9;
--line-border:#dcfce7;
--line-hover-border:#16a34a;
}
[data-theme="mono"]{
--bg-body:#fafafa;
--bg-sidebar:linear-gradient(170deg,#ffffff 0%,#fafafa 15%,#f5f5f5 35%,#e5e5e5 50%,#f5f5f5 70%,#fafafa 85%,#ffffff 100%);
--bg-main:#fefefe;
--bg-module:#f5f5f5;
--bg-card:#fafafa;
--bg-panel:#f5f5f5;
--border-primary:#171717;
--border-secondary:#404040;
--border-accent:#262626;
--border-panel:#171717;
--text-primary:#0a0a0a;
--text-secondary:#404040;
--text-accent:#171717;
--text-title:#0a0a0a;
--text-heading:#262626;
--shadow-primary:rgba(0,0,0,0.15);
--shadow-glow:0 4px 20px rgba(0,0,0,0.08);
--shadow-panel:0 4px 20px rgba(0,0,0,0.12);
--btn-bg:#f5f5f5;
--btn-border:#d4d4d4;
--btn-active-bg:#171717;
--btn-active-border:#0a0a0a;
--module-border:#d4d4d4;
--module-header-bg:linear-gradient(135deg,#e5e5e5 0%,#f5f5f5 100%);
--module-icon-color:#262626;
--chip-bg:#f5f5f5;
--chip-border:#d4d4d4;
--chip-hover-bg:#e5e5e5;
--chip-hover-border:#171717;
--line-bg:#fefefe;
--line-border:#f5f5f5;
--line-hover-border:#171717;
}
[data-theme="cyber"]{
--bg-body:#ecfeff;
--bg-sidebar:linear-gradient(170deg,#ffffff 0%,#ecfeff 15%,#cffafe 35%,#a5f3fc 50%,#cffafe 70%,#ecfeff 85%,#ffffff 100%);
--bg-main:#f5feff;
--bg-module:#cffafe;
--bg-card:#ecfeff;
--bg-panel:#cffafe;
--border-primary:#0891b2;
--border-secondary:#06b6d4;
--border-accent:#0e7490;
--border-panel:#0891b2;
--text-primary:#164e63;
--text-secondary:#155e75;
--text-accent:#0891b2;
--text-title:#0e7490;
--text-heading:#155e75;
--shadow-primary:rgba(8,145,178,0.2);
--shadow-glow:0 4px 20px rgba(8,145,178,0.1);
--shadow-panel:0 4px 20px rgba(8,145,178,0.15);
--btn-bg:#cffafe;
--btn-border:#67e8f9;
--btn-active-bg:#0891b2;
--btn-active-border:#0e7490;
--module-border:#67e8f9;
--module-header-bg:linear-gradient(135deg,#a5f3fc 0%,#cffafe 100%);
--module-icon-color:#0e7490;
--chip-bg:#cffafe;
--chip-border:#67e8f9;
--chip-hover-bg:#a5f3fc;
--chip-hover-border:#0891b2;
--line-bg:#f5feff;
--line-border:#cffafe;
--line-hover-border:#0891b2;
}
[data-theme="neonpink"]{
--bg-body:#fdf4ff;
--bg-sidebar:linear-gradient(170deg,#ffffff 0%,#fdf4ff 15%,#fae8ff 35%,#f5d0fe 50%,#fae8ff 70%,#fdf4ff 85%,#ffffff 100%);
--bg-main:#fefaff;
--bg-module:#fae8ff;
--bg-card:#fdf4ff;
--bg-panel:#fae8ff;
--border-primary:#c026d3;
--border-secondary:#d946ef;
--border-accent:#a21caf;
--border-panel:#c026d3;
--text-primary:#701a75;
--text-secondary:#86198f;
--text-accent:#c026d3;
--text-title:#a21caf;
--text-heading:#86198f;
--shadow-primary:rgba(192,38,211,0.2);
--shadow-glow:0 4px 20px rgba(192,38,211,0.1);
--shadow-panel:0 4px 20px rgba(192,38,211,0.15);
--btn-bg:#fae8ff;
--btn-border:#e879f9;
--btn-active-bg:#c026d3;
--btn-active-border:#a21caf;
--module-border:#e879f9;
--module-header-bg:linear-gradient(135deg,#f5d0fe 0%,#fae8ff 100%);
--module-icon-color:#a21caf;
--chip-bg:#fae8ff;
--chip-border:#e879f9;
--chip-hover-bg:#f5d0fe;
--chip-hover-border:#c026d3;
--line-bg:#fefaff;
--line-border:#fae8ff;
--line-hover-border:#c026d3;
}
[data-theme="matrix"]{
--bg-body:#f0fdf4;
--bg-sidebar:linear-gradient(170deg,#ffffff 0%,#f0fdf4 15%,#dcfce7 35%,#bbf7d0 50%,#dcfce7 70%,#f0fdf4 85%,#ffffff 100%);
--bg-main:#f7fef9;
--bg-module:#dcfce7;
--bg-card:#f0fdf4;
--bg-panel:#dcfce7;
--border-primary:#16a34a;
--border-secondary:#22c55e;
--border-accent:#15803d;
--border-panel:#16a34a;
--text-primary:#14532d;
--text-secondary:#166534;
--text-accent:#16a34a;
--text-title:#15803d;
--text-heading:#166534;
--shadow-primary:rgba(22,163,74,0.2);
--shadow-glow:0 4px 20px rgba(22,163,74,0.1);
--shadow-panel:0 4px 20px rgba(22,163,74,0.15);
--btn-bg:#dcfce7;
--btn-border:#86efac;
--btn-active-bg:#16a34a;
--btn-active-border:#15803d;
--module-border:#86efac;
--module-header-bg:linear-gradient(135deg,#bbf7d0 0%,#dcfce7 100%);
--module-icon-color:#15803d;
--chip-bg:#dcfce7;
--chip-border:#86efac;
--chip-hover-bg:#bbf7d0;
--chip-hover-border:#16a34a;
--line-bg:#f7fef9;
--line-border:#dcfce7;
--line-hover-border:#16a34a;
}
[data-theme="aurora"]{
--bg-body:#f0fdff;
--bg-sidebar:linear-gradient(170deg,#ffffff 0%,#f0fdff 15%,#e0f7fa 35%,#b2ebf2 50%,#e0f7fa 70%,#f0fdff 85%,#ffffff 100%);
--bg-main:#f7feff;
--bg-module:#e0f7fa;
--bg-card:#f0fdff;
--bg-panel:#e0f7fa;
--border-primary:#00bcd4;
--border-secondary:#26c6da;
--border-accent:#00acc1;
--border-panel:#00bcd4;
--text-primary:#006064;
--text-secondary:#00838f;
--text-accent:#00bcd4;
--text-title:#00acc1;
--text-heading:#00838f;
--shadow-primary:rgba(0,188,212,0.2);
--shadow-glow:0 4px 20px rgba(0,188,212,0.1);
--shadow-panel:0 4px 20px rgba(0,188,212,0.15);
--btn-bg:#e0f7fa;
--btn-border:#80deea;
--btn-active-bg:#00bcd4;
--btn-active-border:#00acc1;
--module-border:#80deea;
--module-header-bg:linear-gradient(135deg,#b2ebf2 0%,#e0f7fa 100%);
--module-icon-color:#00acc1;
--chip-bg:#e0f7fa;
--chip-border:#80deea;
--chip-hover-bg:#b2ebf2;
--chip-hover-border:#00bcd4;
--line-bg:#f7feff;
--line-border:#e0f7fa;
--line-hover-border:#00bcd4;
}
[data-theme="sunset"]{
--bg-body:#fff7ed;
--bg-sidebar:linear-gradient(170deg,#ffffff 0%,#fff7ed 15%,#ffedd5 35%,#fed7aa 50%,#ffedd5 70%,#fff7ed 85%,#ffffff 100%);
--bg-main:#fffaf5;
--bg-module:#ffedd5;
--bg-card:#fff7ed;
--bg-panel:#ffedd5;
--border-primary:#ea580c;
--border-secondary:#f97316;
--border-accent:#c2410c;
--border-panel:#ea580c;
--text-primary:#7c2d12;
--text-secondary:#9a3412;
--text-accent:#ea580c;
--text-title:#c2410c;
--text-heading:#9a3412;
--shadow-primary:rgba(234,88,12,0.2);
--shadow-glow:0 4px 20px rgba(234,88,12,0.1);
--shadow-panel:0 4px 20px rgba(234,88,12,0.15);
--btn-bg:#ffedd5;
--btn-border:#fdba74;
--btn-active-bg:#ea580c;
--btn-active-border:#c2410c;
--module-border:#fdba74;
--module-header-bg:linear-gradient(135deg,#fed7aa 0%,#ffedd5 100%);
--module-icon-color:#c2410c;
--chip-bg:#ffedd5;
--chip-border:#fdba74;
--chip-hover-bg:#fed7aa;
--chip-hover-border:#ea580c;
--line-bg:#fffaf5;
--line-border:#ffedd5;
--line-hover-border:#ea580c;
}
[data-theme="clinical"]{
--bg-body:#e8f4fc;
--bg-sidebar:linear-gradient(170deg,#0c2d48 0%,#145374 25%,#1a6fa8 50%,#2196f3 75%,#145374 100%);
--bg-main:#f0f7fc;
--bg-module:#ffffff;
--bg-card:#f8fbfe;
--bg-panel:#0c2d48;
--border-primary:#2196f3;
--border-secondary:#64b5f6;
--border-accent:#1976d2;
--border-panel:#2196f3;
--text-primary:#0c2d48;
--text-secondary:#145374;
--text-accent:#1976d2;
--text-title:#1565c0;
--text-heading:#0d47a1;
--shadow-primary:rgba(33,150,243,0.3);
--shadow-glow:0 0 30px rgba(33,150,243,0.2),0 0 60px rgba(33,150,243,0.1);
--shadow-panel:0 0 25px rgba(33,150,243,0.4),0 0 50px rgba(33,150,243,0.2);
--btn-bg:#e3f2fd;
--btn-border:#2196f3;
--btn-active-bg:#1976d2;
--btn-active-border:#0d47a1;
--module-border:#90caf9;
--module-header-bg:linear-gradient(135deg,#bbdefb 0%,#e3f2fd 100%);
--module-icon-color:#1565c0;
--chip-bg:#e3f2fd;
--chip-border:#90caf9;
--chip-hover-bg:#bbdefb;
--chip-hover-border:#2196f3;
--line-bg:#f8fbfe;
--line-border:#e3f2fd;
--line-hover-border:#2196f3;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;background:var(--bg-body);color:var(--text-primary);padding:20px;transition:background .3s,color .3s}
.container{max-width:1800px;margin:0 auto;display:grid;grid-template-columns:380px 1fr;gap:24px}
.sidebar{background:var(--bg-sidebar);border-radius:16px;padding:24px;border:1px solid var(--border-primary);box-shadow:var(--shadow-glow);transition:all .3s}
.sidebar-header{display:flex;justify-content:center;align-items:center;margin-bottom:16px}
.sidebar-title{font-size:22px;font-weight:700;color:var(--text-accent);letter-spacing:-0.5px;text-shadow:0 0 15px var(--shadow-primary);transition:color .3s}
.section-title{font-size:13px;font-weight:600;color:var(--text-accent);margin:20px 0 12px;text-transform:uppercase;letter-spacing:0.5px;transition:color .3s}
.api-status{padding:10px;border-radius:8px;margin-top:16px;font-size:12px;text-align:center;font-weight:600}
.api-status.connected{background:rgba(6,95,70,0.5);color:#34d399;border:1px solid #059669}
.api-status.disconnected{background:rgba(127,29,29,0.5);color:#fca5a5;border:1px solid #dc2626}
.notice-btn-full{width:100%;padding:14px;background:linear-gradient(135deg,#450a0a 0%,#7f1d1d 100%);color:#fca5a5;border:2px solid #ef4444;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer;transition:all .3s;box-shadow:0 0 20px rgba(239,68,68,0.4),0 0 40px rgba(239,68,68,0.2);margin-bottom:8px;display:flex;align-items:center;justify-content:center;gap:8px}
.notice-btn-full:hover{background:linear-gradient(135deg,#7f1d1d 0%,#991b1b 100%);transform:translateY(-2px);box-shadow:0 0 30px rgba(239,68,68,0.6),0 0 60px rgba(239,68,68,0.3)}
.primary-zone{background:var(--bg-card);border-radius:12px;padding:16px;margin-bottom:16px;border:2px solid var(--border-primary);box-shadow:var(--shadow-glow);transition:all .3s}
.primary-zone .section-title{color:var(--text-heading);margin-top:0}
.secondary-zone{background:var(--bg-card);border-radius:12px;padding:16px;margin-bottom:16px;border:2px solid var(--border-secondary);box-shadow:var(--shadow-glow);transition:all .3s}
.secondary-zone .section-title{color:var(--text-heading);margin-top:0}
.categories-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px}
.category-btn{padding:12px 8px;background:var(--btn-bg);border:2px solid var(--btn-border);border-radius:8px;color:var(--text-primary);font-size:12px;font-weight:600;cursor:pointer;transition:all .2s;text-align:center}
.category-btn:hover{background:var(--bg-module);border-color:var(--border-secondary)}
.category-btn.active{background:var(--btn-active-bg);border-color:var(--btn-active-border);color:white}
.motifs-zone{display:none;background:var(--bg-card);border:2px solid var(--border-primary);border-radius:10px;margin-bottom:12px;overflow:hidden}
.motifs-zone.active{display:block}
.motifs-zone-header{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:var(--module-header-bg);border-bottom:1px solid var(--border-primary)}
.motifs-zone-title{font-size:13px;font-weight:700;color:var(--text-title)}
.motifs-zone-close{cursor:pointer;font-size:18px;color:var(--text-secondary);padding:2px 8px;border-radius:4px;transition:all .2s}
.motifs-zone-close:hover{background:rgba(255,255,255,0.1);color:var(--text-primary)}
.motifs-zone-content{padding:10px;max-height:280px;overflow-y:auto;display:grid;grid-template-columns:1fr 1fr;gap:6px}
.motif-btn{padding:8px 10px;background:var(--bg-card);border:1px solid var(--module-border);border-radius:6px;color:var(--text-primary);font-size:11px;font-weight:500;cursor:pointer;text-align:left;transition:all .2s}
.motif-btn:hover{background:var(--bg-module);border-color:var(--border-accent);box-shadow:0 0 10px var(--shadow-primary)}
.motif-btn.principal{background:var(--btn-active-bg);border-color:var(--border-primary);color:white;font-weight:600;box-shadow:0 0 15px var(--shadow-primary)}
.motif-btn.secondaire{background:var(--btn-active-bg);border-color:var(--border-secondary);color:white;font-weight:600;box-shadow:0 0 15px var(--shadow-primary)}
.motif-btn.motif-group{position:relative}
.motif-btn.motif-group .group-count{background:var(--border-accent);color:white;font-size:9px;padding:2px 6px;border-radius:10px;margin-left:6px;font-weight:700}
.motif-btn.motif-group.principal .group-count,.motif-btn.motif-group.secondaire .group-count{background:rgba(255,255,255,0.3)}
.motif-group-modal{max-width:500px}
.motif-group-list{padding:10px;max-height:400px;overflow-y:auto}
.motif-group-item{padding:14px 16px;margin-bottom:8px;background:var(--bg-card);border:2px solid var(--border-primary);border-radius:10px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;transition:all .2s}
.motif-group-item:hover{background:var(--bg-module);border-color:var(--border-accent);transform:translateX(5px)}
.motif-group-item-name{font-weight:600;color:var(--text-primary)}
.motif-group-item-action{font-size:11px;color:var(--text-secondary);padding:4px 10px;background:var(--bg-module);border-radius:15px}
.motif-group-item:hover .motif-group-item-action{background:var(--border-accent);color:white}
.motif-group-item.selected-principal{background:var(--btn-active-bg);border-color:var(--btn-active-border);color:white}
.motif-group-item.selected-principal .motif-group-item-name{color:white}
.motif-group-item.selected-principal .motif-group-item-action{background:rgba(255,255,255,0.2);color:white}
.motif-group-item.selected-secondary{background:var(--bg-module);border-color:var(--border-secondary)}
.motif-group-item.selected-secondary .motif-group-item-action{background:var(--border-secondary);color:white}
.motif-selection-main{background:var(--bg-card);padding:12px;border-radius:8px;border:2px solid var(--border-primary);margin-bottom:12px;box-shadow:var(--shadow-glow);transition:all .3s}
.motif-selection-secondary{background:var(--bg-card);padding:12px;border-radius:8px;border:2px solid var(--border-secondary);margin-bottom:12px;box-shadow:var(--shadow-glow);transition:all .3s}
.motif-selection-title{font-size:11px;font-weight:700;color:var(--text-accent);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;transition:color .3s}
.selected-motif-item{padding:6px 10px;background:var(--bg-panel);border-radius:6px;font-size:13px;display:flex;align-items:center;justify-content:space-between}
.selected-motif-item.principal-item{background:linear-gradient(135deg,var(--btn-active-bg),var(--btn-active-border));color:white;font-weight:600}
.generate-btn{width:100%;padding:16px;background:var(--btn-active-bg);color:white;border:2px solid var(--border-primary);border-radius:10px;font-size:15px;font-weight:700;cursor:pointer;margin:12px 0;transition:all .3s;box-shadow:0 0 30px var(--shadow-primary)}
.generate-btn:disabled{opacity:.4;cursor:not-allowed}
.generate-btn:hover:not(:disabled){border-color:var(--border-secondary);transform:translateY(-2px);box-shadow:0 0 40px var(--shadow-primary)}
.search-container{position:relative;margin:12px 0}
.search-input{width:100%;padding:12px 16px;background:var(--bg-card);border:2px solid var(--border-primary);border-radius:10px;color:var(--text-primary);font-size:14px;outline:none;transition:all .3s}
.search-input:focus{border-color:var(--border-secondary);box-shadow:0 0 20px var(--shadow-primary)}
.search-input::placeholder{color:var(--text-accent);opacity:0.7}
.search-results{position:absolute;top:100%;left:0;right:0;max-height:300px;overflow-y:auto;background:var(--bg-main);border:2px solid var(--border-primary);border-top:none;border-radius:0 0 10px 10px;z-index:100;display:none;box-shadow:0 10px 30px rgba(0,0,0,0.5)}
.search-results.active{display:block}
.search-result-item{padding:12px 16px;cursor:pointer;border-bottom:1px solid rgba(0,180,216,0.2);transition:all .2s}
.search-result-item:hover{background:rgba(0,53,102,0.5)}
.search-result-item.selected-principal{background:linear-gradient(135deg,rgba(0,53,102,0.8) 0%,rgba(0,119,182,0.6) 100%);border-left:4px solid #00b4d8}
.search-result-item.selected-secondary{background:linear-gradient(135deg,rgba(0,40,70,0.8) 0%,rgba(0,96,150,0.6) 100%);border-left:4px solid #48cae4}
.search-result-motif{color:#caf0f8;font-weight:600;font-size:13px}
.search-result-category{color:#48cae4;font-size:11px;margin-top:2px;opacity:0.8}
.reset-btn{width:100%;padding:14px;background:var(--bg-module);color:var(--text-primary);border:2px solid var(--border-secondary);border-radius:10px;font-size:14px;font-weight:700;cursor:pointer;margin-top:8px;transition:all .3s;box-shadow:0 0 15px var(--shadow-primary)}
.reset-btn:hover{background:var(--btn-active-bg);color:white;transform:translateY(-2px);box-shadow:0 0 25px var(--shadow-primary)}
.module{background:transparent;border:2px dashed var(--module-border);border-radius:12px;padding:28px;margin-bottom:20px;transition:all .3s;position:relative}
.module-note{border-style:solid;border-color:var(--border-secondary);background:var(--bg-card)}
.module-note-content:empty::before{content:attr(placeholder);color:var(--text-secondary);opacity:0.6;font-style:italic}
.copy-checkbox{display:flex;align-items:center;gap:8px;cursor:pointer;font-size:12px;color:var(--text-secondary);padding:6px 12px;background:var(--bg-panel);border-radius:6px;border:1px solid var(--border-secondary);transition:all .2s}
.copy-checkbox:hover{border-color:var(--border-primary);color:var(--text-primary)}
.copy-checkbox input[type="checkbox"]{width:16px;height:16px;cursor:pointer;accent-color:var(--border-primary)}
.copy-checkbox span{white-space:nowrap}
.module:hover{border-color:var(--border-accent);border-style:solid}
.module-content:hover{border-color:var(--text-title)!important;border-style:solid!important;box-shadow:0 0 20px var(--shadow-primary)!important}
.module-header{font-size:17px;font-weight:700;color:var(--text-title);margin-bottom:20px;display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:12px;letter-spacing:-0.3px;transition:color .3s;overflow:visible;position:relative;z-index:1}
.module-title{flex:1}
.module-title .icon{display:inline;color:var(--module-icon-color)}
.module-copy-btn{width:36px;height:36px;background:var(--bg-card);color:white;border:2px solid var(--border-primary);border-radius:8px;font-size:14px;cursor:pointer;transition:all .25s;display:flex;align-items:center;justify-content:center;box-shadow:0 3px 12px var(--shadow-primary);padding:0;position:relative}
.module-copy-btn:hover{transform:translateY(-2px) scale(1.05);box-shadow:0 5px 18px var(--shadow-primary)}
.module-copy-btn::after{content:attr(title);position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);background:var(--bg-card);color:var(--text-primary);padding:5px 8px;border-radius:5px;font-size:10px;font-weight:500;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity .2s;border:1px solid var(--module-border)}
.module-copy-btn:hover::after{opacity:1}
.module-delete-btn{width:36px;height:36px;background:var(--bg-card);color:#f87171;border:2px solid #dc2626;border-radius:8px;font-size:16px;cursor:pointer;transition:all .25s;display:flex;align-items:center;justify-content:center;box-shadow:0 3px 12px rgba(220,38,38,0.2);padding:0;position:relative}
.module-delete-btn:hover{transform:translateY(-2px) scale(1.05);box-shadow:0 5px 18px rgba(220,38,38,0.4);background:#dc2626;color:white}
.module-delete-btn::after{content:attr(title);position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);background:var(--bg-card);color:var(--text-primary);padding:5px 8px;border-radius:5px;font-size:10px;font-weight:500;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity .2s;border:1px solid var(--module-border)}
.module-delete-btn:hover::after{opacity:1}
.module-alt-btn{width:36px;height:36px;background:var(--bg-card);color:#8b5cf6;border:2px solid #8b5cf6;border-radius:8px;font-size:14px;cursor:pointer;transition:all .25s;display:flex;align-items:center;justify-content:center;box-shadow:0 3px 12px rgba(139,92,246,0.2);padding:0;position:relative}
.module-alt-btn:hover{transform:translateY(-2px) scale(1.05);box-shadow:0 5px 18px rgba(139,92,246,0.4);background:#8b5cf6;color:white}
.module-alt-btn::after{content:attr(title);position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);background:var(--bg-card);color:var(--text-primary);padding:5px 8px;border-radius:5px;font-size:10px;font-weight:500;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity .2s;border:1px solid var(--module-border)}
.module-alt-btn:hover::after{opacity:1}
.module-alt-btn.has-alternatives{border-color:#10b981;color:#10b981;animation:pulseAlt 2s infinite}
.module-alt-btn.has-alternatives:hover{background:#10b981;color:white}
@keyframes pulseAlt{0%,100%{box-shadow:0 0 0 0 rgba(16,185,129,0.4)}50%{box-shadow:0 0 0 8px rgba(16,185,129,0)}}
.modal-alternatives{max-width:700px}
.alternatives-list{max-height:400px;overflow-y:auto;padding:10px}
.alternative-item{padding:16px;margin-bottom:12px;background:var(--bg-card);border:2px solid var(--border-primary);border-radius:10px;cursor:pointer;transition:all .2s}
.alternative-item:hover{background:var(--bg-module);border-color:var(--border-secondary);transform:translateX(5px)}
.alternative-item-title{font-weight:700;color:var(--text-title);font-size:15px;margin-bottom:6px;display:flex;align-items:center;gap:8px}
.alternative-item-title::before{content:'ðŸ”„';font-size:14px}
.alternative-item-preview{font-size:13px;color:var(--text-secondary);line-height:1.5;max-height:60px;overflow:hidden;text-overflow:ellipsis}
.alternative-no-data{text-align:center;padding:40px;color:var(--text-secondary);font-style:italic}
.diagnostic-choice-modal{max-width:500px}
.diagnostic-choice-btns{display:flex;flex-direction:column;gap:12px;padding:20px}
.diagnostic-choice-btn{padding:20px;background:var(--bg-card);border:2px solid var(--border-primary);border-radius:12px;cursor:pointer;transition:all .2s;text-align:left}
.diagnostic-choice-btn:hover{background:var(--bg-module);border-color:var(--border-secondary);transform:scale(1.02)}
.diagnostic-choice-btn h4{color:var(--text-title);margin-bottom:8px;font-size:16px}
.diagnostic-choice-btn p{color:var(--text-secondary);font-size:13px;margin:0}
.modal-modify-modules{max-width:600px}
.modify-alts-list{display:flex;flex-direction:column;gap:12px;padding:16px;max-height:450px;overflow-y:auto}
.modify-alt-item{padding:14px 16px;background:var(--bg-card);border:2px solid var(--border-primary);border-radius:12px;transition:all .2s}
.modify-alt-item:hover{border-color:var(--border-accent)}
.modify-alt-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.modify-alt-title{font-weight:700;color:var(--text-title);font-size:15px}
.modify-alt-module{font-size:11px;color:var(--text-secondary);padding:4px 10px;background:var(--bg-module);border-radius:20px}
.modify-alt-actions{display:flex;gap:10px}
.modify-alt-btn{flex:1;padding:10px 14px;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s}
.modify-alt-add{background:rgba(16,185,129,0.15);color:#10b981;border:2px solid rgba(16,185,129,0.3)}
.modify-alt-add:hover{background:rgba(16,185,129,0.25);border-color:#10b981}
.modify-alt-replace{background:rgba(139,92,246,0.15);color:#8b5cf6;border:2px solid rgba(139,92,246,0.3)}
.modify-alt-replace:hover{background:rgba(139,92,246,0.25);border-color:#8b5cf6}
.modify-no-alts{text-align:center;padding:40px;color:var(--text-secondary)}
.modify-modules-list{display:flex;flex-direction:column;gap:8px;padding:16px;max-height:400px;overflow-y:auto}
.modify-module-item{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;background:var(--bg-card);border:2px solid var(--border-primary);border-radius:10px;cursor:pointer;transition:all .2s}
.modify-module-item.has-alts:hover{background:var(--bg-module);border-color:var(--border-accent);transform:translateX(5px)}
.modify-module-item.no-alts{opacity:0.5;cursor:not-allowed}
.modify-module-name{font-weight:600;color:var(--text-primary);font-size:14px}
.modify-module-count{font-size:12px;color:var(--text-secondary);padding:4px 10px;background:var(--bg-module);border-radius:20px}
.modify-module-item.has-alts .modify-module-count{color:#10b981;background:rgba(16,185,129,0.15)}
.module-buttons{display:flex;gap:6px;position:relative;z-index:10}
.bulles-container{display:flex;flex-wrap:wrap;gap:8px}
.bulle-btn{width:36px;height:36px;padding:0;background:linear-gradient(135deg,#1a1a1a 0%,#2d2d2d 100%);border:2px solid #f97316;border-radius:8px;color:white;cursor:pointer;font-size:14px;transition:all .25s;display:inline-flex;align-items:center;justify-content:center;box-shadow:0 3px 12px rgba(249,115,22,0.3);position:relative;z-index:10}
.bulle-btn:hover{background:linear-gradient(135deg,#2d2d2d 0%,#3d3d3d 100%);transform:translateY(-2px) scale(1.05);box-shadow:0 5px 18px rgba(249,115,22,0.5);border-color:#fb923c;z-index:500}
.bulle-btn::after{content:attr(data-title);position:absolute;top:50%;right:calc(100% + 8px);transform:translateY(-50%);background:linear-gradient(135deg,#1a1a1a 0%,#2d2d2d 100%);color:#fb923c;padding:8px 12px;border-radius:8px;font-size:12px;font-weight:600;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity .2s;border:2px solid #f97316;box-shadow:0 4px 15px rgba(249,115,22,0.4);z-index:9999}
.bulle-btn:hover::after{opacity:1}
.module-content{color:var(--text-secondary);font-size:14px;line-height:1.7;border:2px dashed transparent;border-radius:8px;padding:16px;transition:all .3s}
.hdm-section{margin-bottom:24px;position:relative;padding-top:8px}
.hdm-section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.hdm-section-content{padding:16px;background:var(--bg-card);border-radius:8px;border-left:3px solid var(--border-accent)}
.hdm-section-title{font-size:11px;font-style:italic;color:var(--text-title);font-weight:500}
.hdm-section-buttons{display:flex;align-items:center;gap:6px}
.hdm-section-alt{width:24px;height:24px;font-size:10px;padding:0;border-radius:6px}
.bulle-btn-hdm{width:24px;height:24px;padding:0;background:var(--bg-card);border:2px solid #f97316;border-radius:6px;color:#f97316;cursor:pointer;font-size:10px;transition:all .25s;display:inline-flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(249,115,22,0.2);position:relative}
.bulle-btn-hdm:hover{background:#f97316;color:white;transform:translateY(-1px);box-shadow:0 3px 12px rgba(249,115,22,0.4)}
.bulle-btn-hdm::after{content:attr(data-title);position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);background:var(--bg-card);color:#f97316;padding:5px 8px;border-radius:5px;font-size:10px;font-weight:500;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity .2s;border:1px solid #f97316;z-index:100}
.bulle-btn-hdm:hover::after{opacity:1}
.module-line{display:block;margin-bottom:10px;line-height:1.6;color:var(--text-primary)}
.conduite-line{display:flex;align-items:center;gap:16px;margin-bottom:12px;padding:14px;background:var(--line-bg);border:1px solid var(--line-border);border-radius:10px;transition:all .2s}
.conduite-line:hover{background:var(--bg-module);border-color:var(--line-hover-border)}
.conduite-number{width:38px;height:38px;min-width:38px;background:var(--btn-active-bg);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;color:white;font-size:15px;flex-shrink:0}
.conduite-text{flex:1;color:var(--text-primary);line-height:1.6;font-size:14px;transition:color .3s}
.conduite-add-line{display:flex;gap:12px;margin-top:16px;padding:14px;background:var(--bg-card);border:2px dashed var(--border-accent);border-radius:10px;align-items:center;transition:all .3s}
.conduite-input{flex:1;padding:12px;background:var(--bg-module);border:2px solid var(--module-border);border-radius:8px;color:var(--text-primary);font-size:14px;font-weight:500;transition:all .3s}
.conduite-input:focus{outline:none;border-color:var(--border-primary)}
.conduite-input::placeholder{color:var(--text-secondary)}
.conduite-add-btn{padding:12px 24px;background:#059669;color:white;border:none;border-radius:8px;font-size:14px;font-weight:700;cursor:pointer;transition:all .2s}
.conduite-add-btn:hover{background:#047857;transform:translateY(-1px)}
.conduite-actions{display:flex;gap:6px;flex-shrink:0}
.action-icon{width:36px;height:36px;border-radius:8px;border:none;cursor:pointer;font-size:16px;font-weight:700;transition:all .2s;color:white}
.action-up{background:#1e40af}
.action-up:hover{background:#1e3a8a;transform:translateY(-2px)}
.action-down{background:#1e40af}
.action-down:hover{background:#1e3a8a;transform:translateY(-2px)}
.action-delete{background:#dc2626}
.action-delete:hover{background:#b91c1c;transform:scale(1.05)}
.ordonnances-section{margin-top:24px;padding-top:24px;border-top:2px solid #334155}
.ordo-btn{width:50px;height:50px;padding:0;background:linear-gradient(135deg,#1e40af 0%,#3b82f6 100%);color:white;border-radius:12px;margin:6px;cursor:pointer;font-size:20px;transition:all .2s;border:2px solid #60a5fa;display:inline-flex;align-items:center;justify-content:center;position:relative;box-shadow:0 3px 10px rgba(59,130,246,0.3)}
.ordo-btn:hover{transform:translateY(-3px);box-shadow:0 6px 20px rgba(59,130,246,0.5)}
.ordo-btn::after{content:attr(data-title);position:absolute;top:calc(100% + 8px);left:50%;transform:translateX(-50%);background:#1e293b;color:white;padding:6px 10px;border-radius:6px;font-size:11px;font-weight:600;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity .2s;z-index:100}
.ordo-btn:hover::after{opacity:1}
.ordo-btn.all{background:linear-gradient(135deg,#ca8a04 0%,#facc15 100%);border-color:#fde047}
.ordo-btn.all:hover{box-shadow:0 6px 20px rgba(250,204,21,0.5)}
.ordo-btn.fiche{background:linear-gradient(135deg,#059669 0%,#10b981 100%);border-color:#34d399}
.ordo-btn.fiche:hover{box-shadow:0 6px 20px rgba(16,185,129,0.5)}
.ordonnances-section{display:flex;flex-wrap:wrap;align-items:center;gap:4px;margin-top:12px}
.ordo-line-checkbox{display:flex;align-items:flex-start;gap:8px;margin:4px 0}
.ordo-line-checkbox input[type="checkbox"]{width:18px;height:18px;margin-top:3px;cursor:pointer;accent-color:#ca8a04}
.ordo-line-checkbox label{flex:1;cursor:pointer}
.ordo-line{margin:4px 0}
.codes-section{background:#1e293b;border:2px solid #a855f7;border-radius:12px;padding:12px 16px;margin:20px auto 0 auto;max-width:350px;box-shadow:0 0 15px rgba(168,85,247,0.4),0 0 30px rgba(168,85,247,0.2);animation:glowCim 2s ease-in-out infinite}
.codes-section h3{color:#c4b5fd;margin-bottom:8px;font-size:13px;font-weight:600;display:flex;align-items:center;gap:6px}
.code-item{background:transparent;padding:4px 0;color:#e2e8f0;font-weight:500;font-size:13px}
@keyframes glowCim{0%,100%{box-shadow:0 0 25px rgba(168,85,247,0.5),0 0 50px rgba(168,85,247,0.3)}50%{box-shadow:0 0 35px rgba(168,85,247,0.7),0 0 70px rgba(168,85,247,0.4)}}
@keyframes glowText{0%,100%{text-shadow:0 0 10px rgba(167,139,250,0.8),0 0 20px rgba(167,139,250,0.6)}50%{text-shadow:0 0 15px rgba(167,139,250,1),0 0 30px rgba(139,92,246,0.8),0 0 40px rgba(139,92,246,0.6),0 0 50px rgba(99,102,241,0.4)}}
@keyframes glowCyan{0%,100%{text-shadow:0 0 15px rgba(0,180,216,1),0 0 30px rgba(0,180,216,0.7),0 0 45px rgba(0,119,182,0.5)}50%{text-shadow:0 0 20px rgba(72,202,228,1),0 0 40px rgba(0,180,216,1),0 0 60px rgba(0,119,182,0.8),0 0 80px rgba(0,53,102,0.5)}}
.xxxx{background:transparent;padding:0;border-radius:0;cursor:pointer;border:none;color:#ef4444;font-weight:700;display:inline;transition:all .2s}
.xxxx:hover{color:#dc2626;text-decoration:underline}

@keyframes glowAlternative{0%,100%{box-shadow:0 0 8px rgba(255,255,255,0.18),0 0 14px rgba(255,255,255,0.1)}50%{box-shadow:0 0 10px rgba(255,255,255,0.22),0 0 18px rgba(255,255,255,0.12)}}

@keyframes glowAlternativeLight{0%,100%{box-shadow:0 0 8px rgba(234,179,8,0.3),0 0 14px rgba(234,179,8,0.15)}50%{box-shadow:0 0 10px rgba(234,179,8,0.4),0 0 18px rgba(234,179,8,0.2)}}
.comment{color:#94a3b8;font-size:11px;font-style:italic;display:inline-block;user-select:none;pointer-events:none;opacity:0.7}
.deletable{color:#dc2626;font-weight:600;display:inline;cursor:pointer;transition:all .2s}
.alt-container{display:inline;position:relative}
.alt-text{color:inherit;font-weight:inherit;display:inline}
.alt-trigger{display:inline-block;width:0;height:0;border-left:5px solid transparent;border-right:5px solid transparent;border-top:8px solid #ef4444;margin-left:4px;cursor:pointer;vertical-align:middle;transition:all .2s}
.alt-trigger:hover{border-top-color:#b91c1c;transform:scale(1.3)}
.alt-dropdown{position:fixed;background:var(--bg-module);border:2px solid var(--border-accent);border-radius:12px;padding:12px;min-width:250px;max-width:400px;z-index:9999;box-shadow:0 10px 50px rgba(0,0,0,0.6);display:none}
.alt-dropdown.active{display:block}
.alt-dropdown-item{padding:10px 12px;margin:4px 0;background:var(--bg-card);border:1px solid var(--border-primary);border-radius:8px;cursor:pointer;transition:all .2s;font-size:11px;color:var(--text-primary);word-wrap:break-word;line-height:1.4;position:relative;padding-left:28px}
.alt-dropdown-item::before{content:'â—‹';position:absolute;left:10px;top:50%;transform:translateY(-50%);font-size:12px;color:var(--text-secondary)}
.alt-dropdown-item:hover{background:var(--bg-panel);border-color:var(--border-accent)}
.alt-dropdown-item.selected{background:var(--btn-active-bg);border-color:var(--border-accent);color:white}
.alt-dropdown-item.selected::before{content:'âœ“';color:white;font-weight:700}
.alt-dropdown-item.selected:hover{opacity:0.9}
.alt-item-text{display:inline}
.alt-dropdown-input{width:100%;padding:10px 12px;background:var(--bg-card);border:2px solid var(--border-primary);border-radius:8px;color:var(--text-primary);font-size:13px;margin-top:8px;box-sizing:border-box}
.alt-dropdown-input:focus{outline:none;border-color:var(--border-accent)}
.alt-dropdown-validate{width:100%;padding:10px;margin-top:8px;background:var(--btn-active-bg);color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;transition:all .2s}
.alt-dropdown-validate:hover{opacity:0.85;transform:translateY(-1px)}
.alt-dropdown-list{max-height:200px;overflow-y:auto;margin-bottom:8px;padding-right:4px;overscroll-behavior:contain}
.alt-dropdown-list::-webkit-scrollbar{width:6px}
.alt-dropdown-list::-webkit-scrollbar-track{background:var(--bg-card);border-radius:3px}
.alt-dropdown-list::-webkit-scrollbar-thumb{background:var(--border-primary);border-radius:3px}
.alt-dropdown-list::-webkit-scrollbar-thumb:hover{background:var(--border-accent)}
.xxxx-in-alt{background:transparent;color:#ef4444;padding:0;border-radius:0;cursor:pointer;font-weight:700;font-size:inherit;transition:all .2s;display:inline;text-decoration:underline;text-decoration-style:dotted;text-underline-offset:2px}
.xxxx-in-alt:hover{color:#dc2626;transform:none;text-decoration-style:solid}
.xxxx-filled{color:#10b981;font-weight:600;background:transparent;padding:0}
.alt-dropdown-item.selected .xxxx-in-alt{color:#f59e0b}
.alt-dropdown-item.selected .xxxx-filled{color:#86efac}
.xxxx-alt-modal{display:none;position:fixed;z-index:10001;min-width:250px;max-width:350px}
.xxxx-alt-modal.active{display:block}
.xxxx-alt-modal-content{background:var(--bg-module);border:2px solid var(--border-accent);border-radius:12px;padding:16px;box-shadow:0 15px 50px rgba(0,0,0,0.7),0 0 20px rgba(59,130,246,0.3)}
.xxxx-alt-modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;font-weight:700;color:var(--text-title);font-size:14px}
.xxxx-alt-modal-close{cursor:pointer;color:var(--text-secondary);font-size:20px;transition:all .2s}
.xxxx-alt-modal-close:hover{color:var(--border-accent);transform:scale(1.2)}
.xxxx-alt-chips{max-height:200px;overflow-y:auto;margin-bottom:12px}
.xxxx-alt-chip{padding:10px 12px;margin:4px 0;background:var(--bg-card);border:1px solid var(--border-primary);border-radius:8px;cursor:pointer;font-size:11px;color:var(--text-primary);transition:all .2s;line-height:1.4;position:relative;padding-left:28px}
.xxxx-alt-chip::before{content:'â—‹';position:absolute;left:10px;top:50%;transform:translateY(-50%);font-size:12px;color:var(--text-secondary)}
.xxxx-alt-chip:hover{background:var(--bg-panel);border-color:var(--border-accent)}
.xxxx-alt-chip.selected{background:var(--btn-active-bg);border-color:var(--border-accent);color:white}
.xxxx-alt-chip.selected::before{content:'âœ“';color:white;font-weight:700}
.xxxx-alt-input{width:100%;padding:10px 12px;background:var(--bg-card);border:2px solid var(--border-primary);border-radius:8px;color:var(--text-primary);font-size:13px;box-sizing:border-box}
.xxxx-alt-input:focus{outline:none;border-color:var(--border-accent)}
.xxxx-alt-validate{width:100%;padding:10px;margin-top:10px;background:var(--border-accent);color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;transition:all .2s}
.xxxx-alt-validate:hover{opacity:0.85}
.xxxx-alt-modal-content.modal-large{min-width:320px;max-width:400px}
.xxxx-alt-calendar{margin-bottom:12px}
.xxxx-alt-cal-header{font-size:12px;font-weight:600;color:var(--text-title);margin-bottom:8px;text-align:center}
.xxxx-alt-cal-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:4px;margin-bottom:8px}
.xxxx-alt-cal-day{padding:6px 4px;background:var(--bg-card);border:1px solid var(--border-primary);border-radius:6px;cursor:pointer;font-size:10px;text-align:center;color:var(--text-secondary);transition:all .2s}
.xxxx-alt-cal-day:hover{border-color:var(--border-accent);background:var(--bg-panel)}
.xxxx-alt-cal-day.today{border-color:#3b82f6;background:rgba(59,130,246,0.1)}
.xxxx-alt-cal-day.selected{background:#3b82f6;color:white;border-color:#3b82f6}
.xxxx-alt-cal-day b{font-size:13px;display:block;color:var(--text-primary)}
.xxxx-alt-cal-day.selected b{color:white}
.xxxx-alt-time-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:4px}
.xxxx-alt-time-slot{padding:6px 4px;background:var(--bg-card);border:1px solid var(--border-primary);border-radius:6px;cursor:pointer;font-size:11px;text-align:center;color:var(--text-primary);transition:all .2s}
.xxxx-alt-time-slot:hover{border-color:var(--border-accent);background:var(--bg-panel)}
.xxxx-alt-time-slot.selected{background:#10b981;color:white;border-color:#10b981}
.xxxx-popup{display:none;position:fixed;z-index:10000;min-width:280px;max-width:450px}
.xxxx-popup.active{display:block}
.xxxx-popup-content{background:var(--bg-module);border:2px solid var(--border-accent);border-radius:12px;padding:16px;box-shadow:0 15px 50px rgba(0,0,0,0.7),0 0 20px rgba(59,130,246,0.3)}
.xxxx-popup-content.popup-large{min-width:380px;max-width:500px}
.xxxx-popup-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;font-weight:700;color:var(--text-title);font-size:14px}
.xxxx-popup-close{cursor:pointer;color:var(--text-secondary);font-size:20px;transition:all .2s}
.xxxx-popup-close:hover{color:#ef4444;transform:scale(1.2)}
.xxxx-popup-chips{max-height:200px;overflow-y:auto;margin-bottom:12px}
.xxxx-popup-chip{padding:10px 12px;margin:4px 0;background:var(--bg-card);border:1px solid var(--border-primary);border-radius:8px;cursor:pointer;font-size:11px;color:var(--text-primary);transition:all .2s;line-height:1.4;position:relative;padding-left:28px}
.xxxx-popup-chip::before{content:'â—‹';position:absolute;left:10px;top:50%;transform:translateY(-50%);font-size:12px;color:var(--text-secondary)}
.xxxx-popup-chip:hover{background:var(--bg-panel);border-color:var(--border-accent)}
.xxxx-popup-chip.selected{background:var(--btn-active-bg);border-color:var(--border-accent);color:white}
.xxxx-popup-chip.selected::before{content:'âœ“';color:white;font-weight:700}
.hint-text{font-size:9px;color:#94a3b8;font-style:italic;margin-left:4px}
.selected .hint-text{color:rgba(255,255,255,0.6)}
.xxxx-popup-input{width:100%;padding:10px 12px;background:var(--bg-card);border:2px solid var(--border-primary);border-radius:8px;color:var(--text-primary);font-size:13px;box-sizing:border-box;margin-top:10px}
.xxxx-popup-input:focus{outline:none;border-color:var(--border-accent)}
.xxxx-popup-buttons{display:flex;gap:8px;margin-top:12px}
.xxxx-popup-btn{flex:1;padding:10px;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;transition:all .2s}
.xxxx-popup-btn-cancel{background:var(--bg-card);color:var(--text-secondary);border:1px solid var(--border-primary)}
.xxxx-popup-btn-cancel:hover{background:var(--bg-panel)}
.xxxx-popup-btn-validate{background:var(--border-accent);color:white}
.xxxx-popup-btn-validate:hover{opacity:0.85}
.xxxx-popup-calendar{margin-bottom:12px;background:var(--bg-card);border-radius:8px;padding:12px}
.xxxx-popup-cal-header{font-size:12px;font-weight:600;color:var(--text-title);margin-bottom:8px;text-align:center}
.xxxx-popup-cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-bottom:8px}
.xxxx-popup-cal-day{padding:6px 4px;background:var(--bg-module);border:1px solid var(--border-primary);border-radius:6px;cursor:pointer;font-size:10px;text-align:center;color:var(--text-secondary);transition:all .2s}
.xxxx-popup-cal-day:hover{border-color:var(--border-accent);background:var(--bg-panel)}
.xxxx-popup-cal-day.today{border-color:#3b82f6;background:rgba(59,130,246,0.1)}
.xxxx-popup-cal-day.selected{background:#3b82f6;color:white;border-color:#3b82f6}
.xxxx-popup-cal-day b{font-size:13px;display:block;color:var(--text-primary)}
.xxxx-popup-cal-day.selected b{color:white}
.xxxx-popup-time-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:4px}
.xxxx-popup-time-slot{padding:6px 4px;background:var(--bg-module);border:1px solid var(--border-primary);border-radius:6px;cursor:pointer;font-size:11px;text-align:center;color:var(--text-primary);transition:all .2s}
.xxxx-popup-time-slot:hover{border-color:var(--border-accent);background:var(--bg-panel)}
.xxxx-popup-time-slot.selected{background:#10b981;color:white;border-color:#10b981}
.deletable:hover{color:#b91c1c;text-decoration:line-through}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:1000;justify-content:center;align-items:center;padding:20px;backdrop-filter:blur(4px)}
.modal.active{display:flex}
.modal-content{background:var(--bg-module);border:2px solid var(--border-accent);border-radius:16px;padding:32px;max-width:900px;width:100%;max-height:85vh;overflow-y:auto;color:var(--text-primary);box-shadow:0 20px 60px rgba(0,0,0,0.5);transition:all .3s}
.modal-content-large{max-width:600px}
.modal-content.large{max-width:1100px}
.modal-header{font-size:20px;font-weight:700;margin-bottom:24px;color:var(--text-title);display:flex;justify-content:space-between;align-items:center;transition:color .3s}
.modal-close{cursor:pointer;font-size:28px;color:#ef4444;transition:all .2s}
.modal-close:hover{color:#dc2626;transform:rotate(90deg)}
.modal-bulle{background:#ffffff;border:3px solid #0ea5e9;box-shadow:0 0 30px rgba(14,165,233,0.6),0 0 60px rgba(14,165,233,0.3),0 0 100px rgba(14,165,233,0.15);max-width:1400px;width:90%}
#bulleModal{z-index:2000}
.modal-bulle .modal-header{color:#0369a1;text-shadow:0 0 10px rgba(14,165,233,0.5);border-bottom:1px solid #bae6fd}
.modal-bulle .modal-close{color:#64748b}
.modal-bulle .modal-close:hover{color:#0ea5e9}
.bulle-content{background:#f8fafc;padding:24px;border-radius:10px;color:#1e293b;line-height:1.8;font-weight:400;font-size:14px;border:1px solid #e2e8f0;overflow-y:auto;max-height:70vh}
.bulle-content p{margin-bottom:12px}
.bulle-content h2{color:#0369a1;font-size:18px;margin:20px 0 12px;padding-bottom:8px;border-bottom:2px solid #bae6fd}
.bulle-content h3{color:#0369a1;font-size:16px;margin:16px 0 10px;font-weight:600}
.bulle-content h4{color:#0369a1;font-size:14px;margin:14px 0 8px;font-weight:600}
.bulle-content ul,.bulle-content ol{margin-left:20px;margin-bottom:12px}
.bulle-content li{margin-bottom:6px}
.bulle-content a{color:#0ea5e9;text-decoration:underline}
.bulle-content strong{color:#1e40af;font-weight:700}
.bulle-content em{font-style:italic;color:#475569}
.bulle-content table{width:100%;border-collapse:collapse;margin:12px 0}
.bulle-content th,.bulle-content td{border:1px solid #e2e8f0;padding:8px 12px;text-align:left}
.bulle-content th{background:#f1f5f9;font-weight:600;color:#0369a1}
.bulle-content tr:nth-child(even){background:#f8fafc}
.bulle-content blockquote{border-left:4px solid #0ea5e9;padding-left:16px;margin:12px 0;color:#64748b;font-style:italic}
.bulle-content pre{background:#1e293b;color:#e2e8f0;padding:16px;border-radius:8px;overflow-x:auto;font-family:monospace;font-size:13px}
.bulle-content code{background:#e2e8f0;padding:2px 6px;border-radius:4px;font-family:monospace;font-size:12px}
.bulle-content img{max-width:100%;height:auto;border-radius:8px;margin:12px 0}
.bulle-content button{background:linear-gradient(135deg,#0ea5e9,#0284c7);color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600;margin:8px 4px;transition:all .2s}
.bulle-content button:hover{background:linear-gradient(135deg,#0284c7,#0369a1);transform:translateY(-2px);box-shadow:0 4px 12px rgba(14,165,233,0.4)}
.bulle-content details{background:#f1f5f9;border:1px solid #e2e8f0;border-radius:8px;margin:12px 0;overflow:hidden}
.bulle-content summary{background:#e2e8f0;padding:12px 16px;cursor:pointer;font-weight:600;color:#0369a1;list-style:none;display:flex;align-items:center;gap:8px}
.bulle-content summary::-webkit-details-marker{display:none}
.bulle-content summary::before{content:'â–¶';font-size:10px;transition:transform .2s}
.bulle-content details[open] summary::before{transform:rotate(90deg)}
.bulle-content details[open] summary{border-bottom:1px solid #e2e8f0}
.bulle-content details>div,.bulle-content details>p{padding:16px}
.bulle-content .accordion{border:1px solid #e2e8f0;border-radius:8px;margin:8px 0}
.bulle-content .accordion-header{background:#f1f5f9;padding:12px 16px;cursor:pointer;font-weight:600;color:#0369a1;display:flex;justify-content:space-between;align-items:center}
.bulle-content .accordion-header:hover{background:#e2e8f0}
.bulle-content .accordion-content{padding:16px;display:none;border-top:1px solid #e2e8f0}
.bulle-content .accordion.active .accordion-content{display:block}
.bulle-content input[type="text"],.bulle-content input[type="number"],.bulle-content select{padding:8px 12px;border:1px solid #cbd5e1;border-radius:6px;font-size:14px;margin:4px}
.bulle-content input:focus,.bulle-content select:focus{outline:none;border-color:#0ea5e9;box-shadow:0 0 0 3px rgba(14,165,233,0.2)}
.bulle-content .highlight{background:linear-gradient(135deg,#fef3c7,#fde68a);padding:16px;border-radius:8px;border-left:4px solid #f59e0b;margin:12px 0}
.bulle-content .warning{background:linear-gradient(135deg,#fee2e2,#fecaca);padding:16px;border-radius:8px;border-left:4px solid #ef4444;margin:12px 0}
.bulle-content .success{background:linear-gradient(135deg,#d1fae5,#a7f3d0);padding:16px;border-radius:8px;border-left:4px solid #10b981;margin:12px 0}
.bulle-content .info{background:linear-gradient(135deg,#dbeafe,#bfdbfe);padding:16px;border-radius:8px;border-left:4px solid #3b82f6;margin:12px 0}
#xxxxModal,#alternativeModal{z-index:2000!important}
#xxxxModal2{z-index:2500!important}
.theme-modal-content{max-width:950px}
.theme-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:8px}
.theme-option{cursor:pointer;text-align:center;padding:8px;border-radius:10px;border:2px solid #334155;transition:all .2s;background:#0f172a}
.theme-option:hover{border-color:#3b82f6;transform:translateY(-2px);box-shadow:0 6px 15px rgba(0,0,0,0.3)}
.theme-option.active{border-color:#10b981;box-shadow:0 0 15px rgba(16,185,129,0.4)}
.theme-preview{width:100%;height:45px;border-radius:6px;display:flex;overflow:hidden;border:1px solid rgba(255,255,255,0.1)}
.tp-sidebar{width:30%;height:100%}
.tp-content{width:70%;height:100%}
.theme-option span{display:block;margin-top:6px;font-size:10px;font-weight:600;color:#94a3b8}
.theme-preview-default .tp-sidebar{background:linear-gradient(180deg,#001018,#003545)}
.theme-preview-default .tp-content{background:#0a1825;border-left:2px solid #00d4ff}
.theme-preview-sober .tp-sidebar{background:#f8fafc}
.theme-preview-sober .tp-content{background:#ffffff;border-left:2px solid #3b82f6}
.theme-preview-red .tp-sidebar{background:linear-gradient(180deg,#1a0a0a,#2d1515)}
.theme-preview-red .tp-content{background:#1f1515;border-left:2px solid #ef4444}
.theme-preview-violet .tp-sidebar{background:linear-gradient(180deg,#0f0a1a,#1a1025)}
.theme-preview-violet .tp-content{background:#1a1525;border-left:2px solid #a855f7}
.theme-preview-orange .tp-sidebar{background:linear-gradient(180deg,#1a120a,#2d1f0f)}
.theme-preview-orange .tp-content{background:#1f1a15;border-left:2px solid #f59e0b}
.theme-preview-green .tp-sidebar{background:linear-gradient(180deg,#0a1a0f,#0f2518)}
.theme-preview-green .tp-content{background:#151f1a;border-left:2px solid #22c55e}
.theme-preview-pastel .tp-sidebar{background:linear-gradient(180deg,#fce7f3,#e0e7ff)}
.theme-preview-pastel .tp-content{background:#faf5ff;border-left:2px solid #c084fc}
.theme-preview-classic .tp-sidebar{background:#1e293b}
.theme-preview-classic .tp-content{background:#334155;border-left:2px solid #64748b}
.theme-preview-ocean .tp-sidebar{background:linear-gradient(180deg,#0a1628,#164e63)}
.theme-preview-ocean .tp-content{background:#0f2744;border-left:2px solid #06b6d4}
.theme-preview-midnight .tp-sidebar{background:linear-gradient(180deg,#05051a,#0f0f4d)}
.theme-preview-midnight .tp-content{background:#151530;border-left:2px solid #6366f1}
.theme-preview-nebula .tp-sidebar{background:linear-gradient(180deg,#1a0530,#c44088)}
.theme-preview-nebula .tp-content{background:#251540;border-left:2px solid #e879f9}
.theme-preview-violet2 .tp-sidebar{background:linear-gradient(180deg,#1a1530,#3d3570)}
.theme-preview-violet2 .tp-content{background:#252040;border-left:2px solid #8b5cf6}
.theme-preview-median .tp-sidebar{background:linear-gradient(180deg,#fefce8,#fef08a)}
.theme-preview-median .tp-content{background:#fef9c3;border-left:2px solid #84cc16}
.theme-preview-paper .tp-sidebar{background:linear-gradient(180deg,#faf7f5,#ebe5df)}
.theme-preview-paper .tp-content{background:#f5f0eb;border-left:2px solid #78716c}
.theme-preview-fence .tp-sidebar{background:linear-gradient(180deg,#f0fdfa,#99f6e4)}
.theme-preview-fence .tp-content{background:#ccfbf1;border-left:2px solid #0d9488}
.theme-preview-wake .tp-sidebar{background:linear-gradient(180deg,#f0f9ff,#bae6fd)}
.theme-preview-wake .tp-content{background:#e0f2fe;border-left:2px solid #0284c7}
.theme-preview-aspect .tp-sidebar{background:linear-gradient(180deg,#f0fdf4,#bbf7d0)}
.theme-preview-aspect .tp-content{background:#dcfce7;border-left:2px solid #16a34a}
.theme-preview-mono .tp-sidebar{background:linear-gradient(180deg,#fafafa,#e5e5e5)}
.theme-preview-mono .tp-content{background:#f5f5f5;border-left:2px solid #171717}
.theme-preview-cyber .tp-sidebar{background:linear-gradient(180deg,#ecfeff,#a5f3fc)}
.theme-preview-cyber .tp-content{background:#cffafe;border-left:2px solid #0891b2}
.theme-preview-neonpink .tp-sidebar{background:linear-gradient(180deg,#fdf4ff,#f5d0fe)}
.theme-preview-neonpink .tp-content{background:#fae8ff;border-left:2px solid #c026d3}
.theme-preview-matrix .tp-sidebar{background:linear-gradient(180deg,#f0fdf4,#bbf7d0)}
.theme-preview-matrix .tp-content{background:#dcfce7;border-left:2px solid #16a34a}
.theme-preview-aurora .tp-sidebar{background:linear-gradient(180deg,#f0fdff,#b2ebf2)}
.theme-preview-aurora .tp-content{background:#e0f7fa;border-left:2px solid #00bcd4}
.theme-preview-sunset .tp-sidebar{background:linear-gradient(180deg,#fff7ed,#fed7aa)}
.theme-preview-sunset .tp-content{background:#ffedd5;border-left:2px solid #ea580c}
.theme-preview-clinical .tp-sidebar{background:linear-gradient(180deg,#0c2d48,#2196f3,#0c2d48)}
.theme-preview-clinical .tp-content{background:#faf7f5;border-left:2px solid #0ea5e9}
[data-theme="clinical"] .sidebar{color:#ffffff}
[data-theme="clinical"] .sidebar .sidebar-title{color:#90caf9}
[data-theme="clinical"] .sidebar .sidebar-header h2{color:#90caf9}
[data-theme="clinical"] .sidebar .section-title{color:#bbdefb}
[data-theme="clinical"] .sidebar button{color:#0c2d48}
[data-theme="clinical"] .sidebar .search-input{background:#ffffff;color:#0c2d48;border-color:#2196f3}
[data-theme="clinical"] .sidebar .search-input::placeholder{color:#64748b}
[data-theme="clinical"] .sidebar .category-title{color:#bbdefb}
[data-theme="clinical"] .sidebar .motif-chip{background:#ffffff;border-color:#2196f3;color:#0c2d48}
[data-theme="clinical"] .sidebar .motif-chip:hover{background:#e3f2fd;border-color:#64b5f6}
[data-theme="clinical"] .sidebar .motif-chip.selected{background:#1976d2;color:#ffffff}
[data-theme="clinical"] .sidebar .notice-btn{background:#fff3e0;border-color:#ff9800;color:#e65100}
[data-theme="clinical"] .sidebar .generate-btn{background:#e3f2fd;border-color:#2196f3;color:#1565c0}
[data-theme="clinical"] .sidebar .reset-btn{background:#e3f2fd;border-color:#2196f3;color:#1565c0}
[data-theme="clinical"] .sidebar .status{background:#ffffff;border-color:#2196f3;color:#0c2d48}
[data-theme="clinical"] .sidebar .category-box{background:#ffffff;border-color:#2196f3}
[data-theme="clinical"] .sidebar .category-btn{background:#e3f2fd;border-color:#2196f3;color:#0c2d48}
[data-theme="clinical"] .sidebar .category-btn:hover{background:#bbdefb;border-color:#64b5f6}
[data-theme="clinical"] .sidebar .category-btn.active{background:#1976d2;color:#ffffff;border-color:#0d47a1}
[data-theme="clinical"] .sidebar .motif-btn{background:#ffffff;border-color:#90caf9;color:#0c2d48}
[data-theme="clinical"] .sidebar .motif-btn:hover{background:#e3f2fd;border-color:#2196f3}
[data-theme="clinical"] .sidebar .motif-btn.selected{background:#1976d2;color:#ffffff}
[data-theme="clinical"] .sidebar .motif-btn.principal{background:#1565c0;color:#ffffff}
[data-theme="clinical"] .sidebar .motif-btn.secondaire{background:#1976d2;color:#ffffff}
[data-theme="clinical"] .sidebar .motif-selection-main,[data-theme="clinical"] .sidebar .motif-selection-secondary{background:#e3f2fd;border-color:#2196f3}
[data-theme="clinical"] .sidebar .motif-selection-title{color:#1565c0}
[data-theme="clinical"] .sidebar .selected-motif-item{background:#bbdefb;color:#0c2d48}
[data-theme="clinical"] .sidebar .selected-motif-item.principal-item{background:linear-gradient(135deg,#1976d2,#0d47a1);color:white}
[data-theme="clinical"] .sidebar .selected-motif{background:#e3f2fd;border-color:#2196f3;color:#0c2d48}
[data-theme="clinical"] .sidebar .motifs-zone{background:#e3f2fd;border-color:#2196f3}
[data-theme="clinical"] .sidebar .motifs-zone-header{background:linear-gradient(135deg,#1976d2,#1565c0)}
[data-theme="clinical"] .sidebar .motifs-zone-title{color:#ffffff}
[data-theme="clinical"] .sidebar .motifs-zone-close{color:#bbdefb}
[data-theme="clinical"] .module{background:#ffffff;border-color:#90caf9}
[data-theme="clinical"] .module-note{background:#f8fbfe}
[data-theme="clinical"] .copy-checkbox{background:#e3f2fd;border-color:#90caf9;color:#1565c0}
[data-theme="clinical"] .module-content{background:#ffffff;color:#0c2d48}
[data-theme="clinical"] .module-header{color:#1565c0}
[data-theme="clinical"] .module-title{color:#1565c0}
[data-theme="clinical"] .module-line{color:#0c2d48}
[data-theme="clinical"] .hdm-section-content{background:#f8fbfe;color:#0c2d48}
[data-theme="clinical"] .hdm-section-title{color:#1565c0}
[data-theme="clinical"] .split-header{background:linear-gradient(135deg,#0c2d48,#145374);border-color:#2196f3}
[data-theme="clinical"] .split-title{color:#90caf9}
[data-theme="clinical"] .module-copy-btn{background:#e3f2fd;color:#1565c0;border-color:#2196f3}
[data-theme="clinical"] .module-delete-btn{background:#ffebee;color:#c62828;border-color:#ef5350}
[data-theme="clinical"] .bulle-btn{background:#fff3e0;border-color:#ff9800;color:#e65100}
[data-theme="clinical"] .conduite-line{background:#f8fbfe;color:#0c2d48}
[data-theme="clinical"] .conduite-text{color:#0c2d48}
[data-theme="clinical"] .xxxx{color:#1565c0}
[data-theme="clinical"] .deletable{color:#c62828}
[data-theme="clinical"] .api-status{background:#e3f2fd;color:#1565c0}

/* Fonds dÃ©gradÃ©s diffÃ©rents pour Sidebar, Examen et Conclusion par thÃ¨me */

/* Cyber - Cyan/Turquoise */
[data-theme="cyber"] .sidebar{background:linear-gradient(170deg,#ffffff 0%,#ecfeff 15%,#cffafe 50%,#a5f3fc 85%,#67e8f9 100%)}
[data-theme="cyber"] .motifs-zone{background:#e0f7fa;border-color:#00bcd4}
[data-theme="cyber"] .motifs-zone-header{background:linear-gradient(135deg,#b2ebf2,#80deea)}
[data-theme="cyber"] .motifs-zone-title{color:#006064}
[data-theme="cyber"] .split-panel-examen{background:linear-gradient(145deg,#e0f7fa 0%,#b2ebf2 50%,#80deea 100%);border-color:#00bcd4}
[data-theme="cyber"] .split-panel-conclusion{background:linear-gradient(145deg,#e1f5fe 0%,#b3e5fc 50%,#81d4fa 100%);border-color:#03a9f4}
[data-theme="cyber"] .split-panel-examen .module,[data-theme="cyber"] .split-panel-conclusion .module{background:rgba(255,255,255,0.85)}
[data-theme="cyber"] .motif-selection-main{background:linear-gradient(135deg,#b2ebf2 0%,#80deea 100%);border-color:#00acc1}
[data-theme="cyber"] .motif-selection-secondary{background:linear-gradient(135deg,#b3e5fc 0%,#81d4fa 100%);border-color:#039be5}

/* NÃ©on Rose - Rose/Fuchsia */
[data-theme="neonpink"] .sidebar{background:linear-gradient(170deg,#ffffff 0%,#fdf4ff 15%,#fae8ff 50%,#f5d0fe 85%,#e879f9 100%)}
[data-theme="neonpink"] .motifs-zone{background:#fce4ec;border-color:#ec407a}
[data-theme="neonpink"] .motifs-zone-header{background:linear-gradient(135deg,#f8bbd9,#f48fb1)}
[data-theme="neonpink"] .motifs-zone-title{color:#880e4f}
[data-theme="neonpink"] .split-panel-examen{background:linear-gradient(145deg,#fce4ec 0%,#f8bbd9 50%,#f48fb1 100%);border-color:#ec407a}
[data-theme="neonpink"] .split-panel-conclusion{background:linear-gradient(145deg,#f3e5f5 0%,#e1bee7 50%,#ce93d8 100%);border-color:#ab47bc}
[data-theme="neonpink"] .split-panel-examen .module,[data-theme="neonpink"] .split-panel-conclusion .module{background:rgba(255,255,255,0.85)}
[data-theme="neonpink"] .motif-selection-main{background:linear-gradient(135deg,#f8bbd9 0%,#f48fb1 100%);border-color:#e91e63}
[data-theme="neonpink"] .motif-selection-secondary{background:linear-gradient(135deg,#e1bee7 0%,#ce93d8 100%);border-color:#9c27b0}

/* Matrix - Vert */
[data-theme="matrix"] .sidebar{background:linear-gradient(170deg,#ffffff 0%,#f0fdf4 15%,#dcfce7 50%,#bbf7d0 85%,#86efac 100%)}
[data-theme="matrix"] .motifs-zone{background:#e8f5e9;border-color:#66bb6a}
[data-theme="matrix"] .motifs-zone-header{background:linear-gradient(135deg,#c8e6c9,#a5d6a7)}
[data-theme="matrix"] .motifs-zone-title{color:#1b5e20}
[data-theme="matrix"] .split-panel-examen{background:linear-gradient(145deg,#e8f5e9 0%,#c8e6c9 50%,#a5d6a7 100%);border-color:#66bb6a}
[data-theme="matrix"] .split-panel-conclusion{background:linear-gradient(145deg,#e0f2f1 0%,#b2dfdb 50%,#80cbc4 100%);border-color:#26a69a}
[data-theme="matrix"] .split-panel-examen .module,[data-theme="matrix"] .split-panel-conclusion .module{background:rgba(255,255,255,0.85)}
[data-theme="matrix"] .motif-selection-main{background:linear-gradient(135deg,#c8e6c9 0%,#a5d6a7 100%);border-color:#4caf50}
[data-theme="matrix"] .motif-selection-secondary{background:linear-gradient(135deg,#b2dfdb 0%,#80cbc4 100%);border-color:#009688}

/* Aurore - Vert vers Violet */
[data-theme="aurora"] .sidebar{background:linear-gradient(170deg,#ffffff 0%,#e0f7fa 15%,#b2ebf2 35%,#a7ffeb 50%,#b39ddb 75%,#9575cd 100%)}
[data-theme="aurora"] .motifs-zone{background:#e0f2f1;border-color:#26a69a}
[data-theme="aurora"] .motifs-zone-header{background:linear-gradient(135deg,#b2dfdb,#80cbc4)}
[data-theme="aurora"] .motifs-zone-title{color:#004d40}
[data-theme="aurora"] .split-panel-examen{background:linear-gradient(145deg,#e0f2f1 0%,#b2dfdb 50%,#80cbc4 100%);border-color:#26a69a}
[data-theme="aurora"] .split-panel-conclusion{background:linear-gradient(145deg,#ede7f6 0%,#d1c4e9 50%,#b39ddb 100%);border-color:#7e57c2}
[data-theme="aurora"] .split-panel-examen .module,[data-theme="aurora"] .split-panel-conclusion .module{background:rgba(255,255,255,0.85)}
[data-theme="aurora"] .motif-selection-main{background:linear-gradient(135deg,#b2dfdb 0%,#80cbc4 100%);border-color:#009688}
[data-theme="aurora"] .motif-selection-secondary{background:linear-gradient(135deg,#d1c4e9 0%,#b39ddb 100%);border-color:#673ab7}

/* CrÃ©puscule/Sunset - Orange/PÃªche */
[data-theme="sunset"] .sidebar{background:linear-gradient(170deg,#ffffff 0%,#fff7ed 15%,#ffedd5 50%,#fed7aa 85%,#fdba74 100%)}
[data-theme="sunset"] .motifs-zone{background:#fff3e0;border-color:#ffa726}
[data-theme="sunset"] .motifs-zone-header{background:linear-gradient(135deg,#ffe0b2,#ffcc80)}
[data-theme="sunset"] .motifs-zone-title{color:#e65100}
[data-theme="sunset"] .split-panel-examen{background:linear-gradient(145deg,#fff3e0 0%,#ffe0b2 50%,#ffcc80 100%);border-color:#ffa726}
[data-theme="sunset"] .split-panel-conclusion{background:linear-gradient(145deg,#fce4ec 0%,#f8bbd9 50%,#f48fb1 100%);border-color:#ec407a}
[data-theme="sunset"] .split-panel-examen .module,[data-theme="sunset"] .split-panel-conclusion .module{background:rgba(255,255,255,0.85)}
[data-theme="sunset"] .motif-selection-main{background:linear-gradient(135deg,#ffe0b2 0%,#ffcc80 100%);border-color:#ff9800}
[data-theme="sunset"] .motif-selection-secondary{background:linear-gradient(135deg,#f8bbd9 0%,#f48fb1 100%);border-color:#e91e63}

/* Clinique - Bleu mÃ©dical */
[data-theme="clinical"] .sidebar{background:linear-gradient(170deg,#0c2d48 0%,#145374 25%,#1a6fa8 50%,#2196f3 75%,#145374 100%)}
[data-theme="clinical"] .split-panel-examen{background:linear-gradient(145deg,#e3f2fd 0%,#bbdefb 50%,#90caf9 100%);border-color:#2196f3}
[data-theme="clinical"] .split-panel-conclusion{background:linear-gradient(145deg,#e8eaf6 0%,#c5cae9 50%,#9fa8da 100%);border-color:#5c6bc0}
[data-theme="clinical"] .split-panel-examen .module,[data-theme="clinical"] .split-panel-conclusion .module{background:rgba(255,255,255,0.95)}
[data-theme="clinical"] .split-panel-examen .split-title{color:#ffffff}
[data-theme="clinical"] .split-panel-conclusion .split-title{color:#ffffff}
[data-theme="clinical"] .motif-selection-main{background:linear-gradient(135deg,#bbdefb 0%,#90caf9 100%);border-color:#2196f3}
[data-theme="clinical"] .motif-selection-secondary{background:linear-gradient(135deg,#c5cae9 0%,#9fa8da 100%);border-color:#5c6bc0}

.proposition-chips{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:18px}
.chip{padding:10px 18px;background:var(--chip-bg);border:2px solid var(--chip-border);border-radius:20px;cursor:pointer;transition:all .2s;font-weight:600;font-size:13px;color:var(--text-primary)}
.chip:hover{background:var(--chip-hover-bg);border-color:var(--chip-hover-border);color:white;transform:translateY(-2px)}
.chip.selected{background:var(--btn-active-bg);border-color:var(--btn-active-border);color:white;box-shadow:0 0 10px var(--shadow-primary)}
.xxxx-in-chip{background:transparent;color:#ef4444;padding:0;border-radius:0;cursor:pointer;font-weight:700;text-decoration:underline;text-decoration-style:dotted;text-underline-offset:2px}
.xxxx-in-chip3{background:transparent;color:#f97316;padding:0;border-radius:0;cursor:pointer;font-weight:700;text-decoration:underline;text-decoration-style:dotted;text-underline-offset:2px}
.xxxx-in-chip3:hover{color:#ea580c}
.xxxx-filled-chip3{color:#22c55e;font-weight:600}
.xxxx-in-chip:hover{color:#dc2626;text-decoration-style:solid}
.xxxx-filled-chip{color:#10b981;font-weight:700}
.modal-ordos{max-width:1200px;width:95%;max-height:90vh;display:flex;flex-direction:column;background:#fdfbf7;border:3px solid #facc15;box-shadow:0 0 20px rgba(250,204,21,0.5),0 0 40px rgba(250,204,21,0.3),0 0 60px rgba(250,204,21,0.2),0 20px 60px rgba(0,0,0,0.3);border-radius:16px}
.modal-ordos .modal-header{background:linear-gradient(135deg,#854d0e 0%,#ca8a04 100%)!important;color:#fefce8;border-radius:12px 12px 0 0}
.modal-ordos .modal-close{color:#fefce8}
.modal-ordos .modal-close:hover{color:#ffffff}
.modal-header-ordos{background:linear-gradient(135deg,#854d0e 0%,#ca8a04 100%);border-radius:12px 12px 0 0;color:#fefce8}
.ordo-search-container{padding:16px 20px;background:#fef9e7;border-bottom:1px solid #fde68a}
.ordo-search-input{width:100%;padding:14px 18px;background:#ffffff;border:2px solid #facc15;border-radius:10px;color:#1c1917;font-size:15px;outline:none;transition:all .2s}
.ordo-search-input:focus{border-color:#eab308;box-shadow:0 0 20px rgba(250,204,21,0.4)}
.ordo-search-input::placeholder{color:#a1a1aa}
.ordo-filters{display:grid;grid-template-columns:1fr 1fr;gap:16px;padding:16px 20px;background:#fef9e7;border-bottom:1px solid #fde68a}
.ordo-filter label{font-weight:600;color:#854d0e;font-size:12px;margin-bottom:6px;display:block;text-transform:uppercase;letter-spacing:0.5px}
.ordo-filter select{width:100%;padding:10px 12px;background:#ffffff;border:2px solid #fde68a;border-radius:8px;color:#1c1917;font-size:14px;cursor:pointer;transition:all .2s}
.ordo-filter select:hover{border-color:#facc15}
.ordos-count{padding:12px 20px;background:#fffef7;color:#78716c;font-size:13px;border-bottom:1px solid #fde68a}
.ordos-count span{font-weight:600;color:#854d0e}
.ordos-list{flex:1;overflow-y:auto;padding:16px 20px;background:#fdfbf7}
.ordo-category-group{margin-bottom:20px}
.ordo-category-title{font-size:13px;font-weight:700;color:#854d0e;text-transform:uppercase;letter-spacing:1px;padding:8px 12px;background:linear-gradient(90deg,rgba(250,204,21,0.3) 0%,transparent 100%);border-left:3px solid #facc15;margin-bottom:10px;border-radius:0 6px 6px 0}
.ordo-category-items{display:flex;flex-direction:column;gap:8px}
.ordo-item{display:flex;align-items:center;gap:12px;background:#ffffff;border:2px solid #fde68a;border-radius:10px;padding:14px 16px;cursor:pointer;transition:all .2s}
.ordo-item:hover{border-color:#facc15;background:#fefce8;transform:translateX(4px);box-shadow:0 4px 12px rgba(250,204,21,0.3)}
.ordo-item-icon{font-size:24px;width:40px;height:40px;display:flex;align-items:center;justify-content:center;background:#fef9c3;border-radius:8px}
.ordo-item-content{flex:1;min-width:0}
.ordo-item-title{font-weight:600;color:#1c1917;font-size:14px;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ordo-item-motif{font-size:12px;color:#78716c}
.ordo-item-arrow{font-size:24px;color:#eab308;font-weight:300}
.ordo-empty{text-align:center;padding:40px;color:#78716c;font-size:15px}
.modal-ordo-detail{max-width:1350px;width:95%;background:#fdfbf7;border:3px solid #facc15;box-shadow:0 0 20px rgba(250,204,21,0.5),0 0 40px rgba(250,204,21,0.3),0 0 60px rgba(250,204,21,0.2),0 20px 60px rgba(0,0,0,0.3);border-radius:16px}
.modal-ordo-detail .modal-header{background:linear-gradient(135deg,#854d0e 0%,#ca8a04 100%);color:#fefce8;border-radius:12px 12px 0 0;border-bottom:2px solid #facc15}
.modal-ordo-detail .modal-close{color:#fefce8}
.modal-ordo-detail .modal-close:hover{color:#ffffff}
.modal-ordo-detail #ordoContent{background:#ffffff;border:1px solid #fde68a;color:#1c1917;padding:20px;line-height:1.8}
.modal-ordo-detail #ordoContent .module-line{color:#1c1917}
.modal-ordo-detail .modal-buttons{border-top:1px solid #fde68a;padding-top:16px;margin-top:16px}
.modal-ordo-detail .modal-btn-primary{background:#ca8a04;color:white}
.modal-ordo-detail .modal-btn-primary:hover{background:#a16207}
.modal-ordo-detail .modal-btn-secondary{background:#78716c;color:white}
.modal-ordo-detail .modal-btn-secondary:hover{background:#57534e}
.ordo-bulles-container{display:flex;gap:6px;margin-left:auto;margin-right:16px}
.bulle-popup-ordo{position:fixed;background:#ffffff;border:3px solid #0ea5e9;border-radius:12px;box-shadow:0 10px 40px rgba(14,165,233,0.4),0 0 20px rgba(14,165,233,0.2);z-index:2000;width:360px;max-height:400px;overflow:hidden;display:none}
.bulle-popup-ordo.active{display:block}
.bulle-popup-ordo .bulle-popup-header{background:linear-gradient(135deg,#0369a1 0%,#0ea5e9 100%);color:white;padding:12px 16px;font-weight:600;font-size:14px;display:flex;justify-content:space-between;align-items:center}
.bulle-popup-ordo .bulle-popup-close{cursor:pointer;font-size:20px;opacity:0.8;transition:opacity .2s}
.bulle-popup-ordo .bulle-popup-close:hover{opacity:1}
.bulle-popup-ordo .bulle-popup-content{padding:16px;max-height:320px;overflow-y:auto;font-size:13px;line-height:1.6;color:#1c1917}
.modal-input{width:100%;padding:14px;background:#0f172a;border:2px solid #334155;border-radius:8px;color:white;font-size:14px;font-weight:500;margin-bottom:18px}
.modal-input:focus{outline:none;border-color:#3b82f6}
.datetime-picker{display:flex;align-items:center;gap:12px;margin-bottom:16px;padding:12px;background:#0f172a;border-radius:8px;border:1px solid #334155}
.datetime-picker label{color:#94a3b8;font-size:13px;font-weight:500;min-width:50px}
.datetime-picker select{flex:1;padding:10px 12px;background:#1e293b;border:2px solid #3b82f6;border-radius:6px;color:white;font-size:14px;cursor:pointer}
.datetime-picker select:hover{border-color:#60a5fa}
.datetime-picker select:focus{outline:none;border-color:#60a5fa;box-shadow:0 0 0 3px rgba(59,130,246,0.3)}
.calendar-container{background:linear-gradient(135deg,#0f172a 0%,#1e293b 100%);border-radius:12px;padding:16px;margin-bottom:16px;border:2px solid #3b82f6;box-shadow:0 4px 20px rgba(59,130,246,0.2)}
.calendar-header{display:flex;justify-content:center;align-items:center;margin-bottom:12px;color:#60a5fa;font-weight:600;font-size:14px}
.calendar-weekdays{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-bottom:8px}
.calendar-weekday{text-align:center;font-size:11px;font-weight:600;color:#94a3b8;padding:6px 0}
.calendar-days{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
.calendar-day{text-align:center;padding:8px 4px;font-size:13px;border-radius:8px;cursor:pointer;transition:all .2s;color:#e2e8f0;background:#1e293b;border:1px solid transparent}
.calendar-day:hover{background:#3b82f6;color:white;transform:scale(1.05)}
.calendar-day.today{border-color:#3b82f6;font-weight:700}
.calendar-day.selected{background:#3b82f6;color:white;box-shadow:0 0 10px rgba(59,130,246,0.5)}
.calendar-day.other-month{color:#475569;background:#0f172a}
.time-picker-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:4px;margin-top:12px;padding-top:12px;border-top:1px solid #334155}
.time-slot{padding:6px 2px;text-align:center;font-size:11px;background:#1e293b;border:1px solid #334155;border-radius:6px;cursor:pointer;transition:all .2s;color:#e2e8f0}
.time-slot:hover{background:#3b82f6;color:white;border-color:#3b82f6}
.time-slot.selected{background:#3b82f6;color:white;box-shadow:0 0 8px rgba(59,130,246,0.4)}
.time-slot.current{border-color:#22c55e;background:#166534;color:#4ade80;font-weight:600}
.calendar-section-title{font-size:12px;color:#94a3b8;margin:12px 0 8px;font-weight:500}
.modal-buttons{display:flex;gap:12px;justify-content:flex-end;margin-top:18px}
#ordoContent{padding:20px;background:#ffffff;border-radius:8px;border:1px solid #fde68a;min-height:100px;max-height:400px;overflow-y:auto;color:#1c1917;line-height:1.8}
#ordoContent .module-line{color:#1c1917}
.modal-btn{padding:12px 24px;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:700;transition:all .2s}
.modal-btn-primary{background:#059669;color:white}
.modal-btn-primary:hover{background:#047857;transform:translateY(-1px)}
.modal-btn-secondary{background:#475569;color:white}
.modal-btn-secondary:hover{background:#334155}
.mode-selection{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:20px}
.mode-btn{padding:16px 12px;background:#1e293b;border:3px solid #334155;border-radius:12px;color:#e2e8f0;font-size:13px;font-weight:700;cursor:pointer;text-align:center;transition:all .2s}
.mode-btn:hover{border-color:#3b82f6;background:#334155;transform:translateY(-2px)}
.mode-btn-icon{font-size:28px;margin-bottom:8px}
.mode-btn.memo-btn{border-color:#f59e0b}
.mode-btn.memo-btn:hover{border-color:#fbbf24;background:rgba(245,158,11,0.2)}
.memo-content{padding:20px;background:#ffffff;border-radius:0 0 12px 12px;max-height:calc(90vh - 80px);overflow-y:auto;line-height:1.8;color:#1e293b;font-size:15px}
.memo-single{}
.memo-grid{display:grid;gap:20px;height:100%}
.memo-column{background:#f8fafc;border-radius:10px;border:2px solid #e2e8f0;overflow:hidden;display:flex;flex-direction:column}
.memo-column.memo-principal{border-color:#0066cc;box-shadow:0 0 15px rgba(0,102,204,0.2)}
.memo-column.memo-secondaire{border-color:#48cae4}
.memo-column-header{padding:12px 16px;font-weight:700;font-size:14px;border-bottom:2px solid #e2e8f0}
.memo-principal .memo-column-header{background:linear-gradient(135deg,#001a33 0%,#003366 100%);color:#ffffff;border-bottom-color:#0066cc}
.memo-secondaire .memo-column-header{background:linear-gradient(135deg,#0a2540 0%,#0d3a5c 100%);color:#caf0f8;border-bottom-color:#48cae4}
.memo-column-content{padding:16px;flex:1;overflow-y:auto;font-size:14px;line-height:1.7}
/* Styles HTML pour les mÃ©mos */
.memo-single h1,.memo-column-content h1{font-size:20px;font-weight:700;color:#0066cc;margin:0 0 16px 0;padding-bottom:8px;border-bottom:2px solid #0066cc}
.memo-single h2,.memo-column-content h2{font-size:17px;font-weight:700;color:#1e40af;margin:20px 0 12px 0;padding-bottom:6px;border-bottom:1px solid #cbd5e1}
.memo-single h3,.memo-column-content h3{font-size:15px;font-weight:700;color:#334155;margin:16px 0 8px 0}
.memo-single p,.memo-column-content p{margin:0 0 12px 0}
.memo-single b,.memo-single strong,.memo-column-content b,.memo-column-content strong{color:#1e293b;font-weight:700}
.memo-single mark,.memo-column-content mark{background:linear-gradient(120deg,#fef08a 0%,#fde047 100%);padding:2px 6px;border-radius:4px;color:#1e293b}
.memo-single ul,.memo-column-content ul{margin:8px 0 16px 0;padding-left:20px}
.memo-single li,.memo-column-content li{margin-bottom:6px;position:relative}
.memo-single .alerte,.memo-column-content .alerte{background:linear-gradient(135deg,#fef2f2 0%,#fee2e2 100%);border-left:4px solid #dc2626;padding:12px 16px;margin:12px 0;border-radius:0 8px 8px 0;color:#991b1b}
.memo-single .info,.memo-column-content .info{background:linear-gradient(135deg,#eff6ff 0%,#dbeafe 100%);border-left:4px solid #2563eb;padding:12px 16px;margin:12px 0;border-radius:0 8px 8px 0;color:#1e40af}
.memo-single .success,.memo-column-content .success{background:linear-gradient(135deg,#f0fdf4 0%,#dcfce7 100%);border-left:4px solid #16a34a;padding:12px 16px;margin:12px 0;border-radius:0 8px 8px 0;color:#166534}
.memo-single .warning,.memo-column-content .warning{background:linear-gradient(135deg,#fffbeb 0%,#fef3c7 100%);border-left:4px solid #f59e0b;padding:12px 16px;margin:12px 0;border-radius:0 8px 8px 0;color:#92400e}
.memo-single table,.memo-column-content table{width:100%;border-collapse:collapse;margin:12px 0;font-size:13px}
.memo-single th,.memo-column-content th{background:#1e40af;color:white;padding:10px 12px;text-align:left;font-weight:600}
.memo-single td,.memo-column-content td{padding:10px 12px;border-bottom:1px solid #e2e8f0}
.memo-single tr:nth-child(even),.memo-column-content tr:nth-child(even){background:#f8fafc}
.memo-single code,.memo-column-content code{background:#f1f5f9;padding:2px 6px;border-radius:4px;font-family:monospace;font-size:13px;color:#be185d}
.memo-single hr,.memo-column-content hr{border:none;height:2px;background:linear-gradient(90deg,transparent,#cbd5e1,transparent);margin:20px 0}
.memo-single a,.memo-column-content a{color:#2563eb;text-decoration:underline;font-weight:600;cursor:pointer;transition:all .2s}
.memo-single a:hover,.memo-column-content a:hover{color:#1d4ed8;text-decoration:none;background:rgba(37,99,235,0.1);padding:2px 4px;border-radius:4px}
.memo-single a:visited,.memo-column-content a:visited{color:#7c3aed}
.memo-single button,.memo-column-content button{padding:8px 16px;background:#2563eb;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;transition:all .2s}
.memo-single button:hover,.memo-column-content button:hover{background:#1d4ed8;transform:translateY(-1px)}
.memo-single .accordion-item,.memo-column-content .accordion-item{margin-bottom:12px;border-radius:8px;overflow:hidden}
.memo-single .accordion-header,.memo-column-content .accordion-header{background:linear-gradient(135deg,#001f3f 0%,#0066cc 100%);color:white;padding:16px 20px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;font-size:15px;font-weight:600;transition:all .3s;border:none;width:100%;text-align:left;box-shadow:0 2px 8px rgba(0,100,255,0.3)}
.memo-single .accordion-header:hover,.memo-column-content .accordion-header:hover{background:linear-gradient(135deg,#002a5c 0%,#0080ff 100%);box-shadow:0 4px 12px rgba(0,212,255,0.5)}
.memo-single .accordion-header::after,.memo-column-content .accordion-header::after{content:'â–¼';font-size:0.9em;transition:transform .3s;color:#00d4ff}
.memo-single .accordion-header.active::after,.memo-column-content .accordion-header.active::after{transform:rotate(180deg)}
.memo-single .accordion-content,.memo-column-content .accordion-content{max-height:0;overflow:hidden;transition:max-height .4s ease-out;background:white}
.memo-single .accordion-content.active,.memo-column-content .accordion-content.active{max-height:15000px;transition:max-height .6s ease-in}
.memo-single .accordion-body,.memo-column-content .accordion-body{padding:20px;background:white;border:1px solid #e0e0e0;border-top:none}
.memo-single .accordion-body h3,.memo-column-content .accordion-body h3{color:#0066cc;margin-top:16px;margin-bottom:10px;font-size:1.2em;border-left:4px solid #00d4ff;padding-left:12px}
.memo-single .accordion-body h4,.memo-column-content .accordion-body h4{color:#001f3f;margin-top:12px;margin-bottom:8px;font-size:1.1em}
.memo-single .highlight-box,.memo-column-content .highlight-box{background:#e6f3ff;border-left:4px solid #0066cc;padding:15px;margin:15px 0;border-radius:4px}
.memo-single .image-container,.memo-column-content .image-container{margin:20px 0;text-align:center;background:#f8f9fa;padding:15px;border-radius:8px}
.memo-single .image-container img,.memo-column-content .image-container img{max-width:100%;height:auto;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.1)}
.memo-single .header,.memo-column-content .header{background:linear-gradient(135deg,#001f3f 0%,#0a4d8c 100%);color:white;padding:15px 20px;border-bottom:3px solid #00d4ff;border-radius:8px 8px 0 0;margin:-16px -16px 16px -16px}
.memo-single .header h1,.memo-column-content .header h1{font-size:1.3em;margin:0}
.memo-single .header p,.memo-column-content .header p{font-size:0.9em;opacity:0.9;margin:5px 0 0 0}
.memo-single .content,.memo-column-content .content{padding:0}
.modal-memo{width:90vw;max-width:90vw;height:90vh;max-height:90vh;background:#ffffff;border:3px solid #0066cc;border-radius:12px;box-shadow:0 0 40px rgba(0,102,204,0.5),0 0 80px rgba(0,102,204,0.3)}
.modal-memo .modal-header{background:linear-gradient(135deg,#001a33 0%,#003366 100%);color:#ffffff;padding:20px 25px;border-radius:8px 8px 0 0;border-bottom:3px solid #0066cc;display:flex;justify-content:space-between;align-items:center}
.modal-memo .modal-header span:first-child{font-size:20px;font-weight:700;text-shadow:0 0 10px rgba(0,102,204,0.5)}
.memo-close{width:36px;height:36px;background:#dc2626;border:none;border-radius:50%;color:white;font-size:24px;font-weight:bold;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;box-shadow:0 0 10px rgba(220,38,38,0.5)}
.memo-close:hover{background:#ef4444;transform:scale(1.1);box-shadow:0 0 20px rgba(220,38,38,0.7)}
.split-view{display:grid;grid-template-columns:1fr 1fr;gap:24px}
.split-panel{background:var(--bg-panel);border-radius:16px;padding:24px;border:2px solid var(--border-panel);box-shadow:var(--shadow-panel);transition:all .3s}
.split-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:16px;border-bottom:2px solid var(--module-border)}
.split-header-actions{display:flex;gap:10px;align-items:center}
.modify-modules-btn{padding:8px 14px;background:linear-gradient(135deg,rgba(139,92,246,0.2),rgba(139,92,246,0.1));color:var(--text-primary);border:2px solid rgba(139,92,246,0.5);border-radius:10px;font-size:12px;font-weight:600;cursor:pointer;transition:all .25s;white-space:nowrap}
.modify-modules-btn:hover{background:linear-gradient(135deg,rgba(139,92,246,0.4),rgba(139,92,246,0.2));border-color:rgba(139,92,246,0.8);transform:translateY(-2px)}
.split-title{font-size:18px;font-weight:700;color:var(--text-title);transition:color .3s}
.copy-btn{width:42px;height:42px;background:var(--bg-card);color:white;border:2px solid var(--border-primary);border-radius:10px;font-size:16px;cursor:pointer;transition:all .25s;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 15px var(--shadow-primary);position:relative}
.copy-btn:hover{transform:translateY(-2px) scale(1.05);box-shadow:0 6px 20px var(--shadow-primary)}
.copy-btn::after{content:attr(title);position:absolute;bottom:calc(100% + 8px);left:50%;transform:translateX(-50%);background:var(--bg-card);color:var(--text-primary);padding:6px 10px;border-radius:6px;font-size:11px;font-weight:500;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity .2s;border:1px solid var(--module-border)}
.copy-btn:hover::after{opacity:1}
.floating-actions{position:fixed;bottom:30px;right:30px;display:flex;flex-direction:row;gap:8px;align-items:center;z-index:9000}
.floating-btn{width:48px;height:48px;border-radius:12px;border:2px solid;color:white;font-size:18px;font-weight:600;cursor:pointer;transition:all .25s;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 15px rgba(0,0,0,0.3)}
.floating-btn:hover{transform:translateY(-3px) scale(1.05);box-shadow:0 6px 20px rgba(0,0,0,0.4)}
.floating-btn span{display:none}
.floating-btn.copy-hdm{background:linear-gradient(135deg,#0f172a 0%,#1e3a5f 100%);border-color:#0ea5e9;box-shadow:0 4px 15px rgba(14,165,233,0.3)}
.floating-btn.copy-hdm:hover{box-shadow:0 6px 25px rgba(14,165,233,0.5)}
.floating-btn.copy-examen{background:linear-gradient(135deg,#0f172a 0%,#1e3a5f 100%);border-color:#3b82f6;box-shadow:0 4px 15px rgba(59,130,246,0.3)}
.floating-btn.copy-examen:hover{box-shadow:0 6px 25px rgba(59,130,246,0.5)}
.floating-btn.copy-conclusion{background:linear-gradient(135deg,#0f172a 0%,#0d3d2e 100%);border-color:#10b981;box-shadow:0 4px 15px rgba(16,185,129,0.3)}
.floating-btn.copy-conclusion:hover{box-shadow:0 6px 25px rgba(16,185,129,0.5)}
.floating-btn.open-memo{background:linear-gradient(135deg,#0f172a 0%,#3d2a0f 100%);border-color:#f59e0b;box-shadow:0 4px 15px rgba(245,158,11,0.3)}
.floating-btn.open-memo:hover{box-shadow:0 6px 25px rgba(245,158,11,0.5)}
.floating-btn.regenerate{background:linear-gradient(135deg,#0f172a 0%,#1e293b 100%);border-color:#64748b;box-shadow:0 4px 15px rgba(100,116,139,0.3)}
.floating-btn.regenerate:hover{box-shadow:0 6px 25px rgba(100,116,139,0.5)}
.floating-btn.theme-btn{background:linear-gradient(135deg,#0f172a 0%,#2d1f3d 100%);border-color:#ec4899;box-shadow:0 4px 15px rgba(236,72,153,0.3)}
.floating-btn.theme-btn:hover{box-shadow:0 6px 25px rgba(236,72,153,0.5)}
.floating-btn.calc-btn{background:linear-gradient(135deg,#0f172a 0%,#1e3a5f 100%);border-color:#8b5cf6;box-shadow:0 4px 15px rgba(139,92,246,0.3)}
.floating-btn.calc-btn:hover{box-shadow:0 6px 25px rgba(139,92,246,0.5)}
.calculator-container{padding:20px}
.calc-display{margin-bottom:16px}
.calc-display input{width:100%;padding:20px;font-size:28px;text-align:right;background:#0f172a;border:2px solid #334155;border-radius:12px;color:#e2e8f0;font-family:monospace}
.calc-buttons{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.calc-btn{padding:18px;font-size:20px;font-weight:600;border:none;border-radius:10px;cursor:pointer;transition:all .2s;background:#334155;color:#e2e8f0}
.calc-btn:hover{background:#475569;transform:scale(1.05)}
.calc-btn:active{transform:scale(0.95)}
.calc-op{background:#0ea5e9;color:white}
.calc-op:hover{background:#0284c7}
.calc-clear{background:#ef4444;color:white}
.calc-clear:hover{background:#dc2626}
.calc-equals{background:#10b981;color:white;grid-column:span 1}
.calc-equals:hover{background:#059669}
.calc-zero{grid-column:span 2}
.calc-medical{margin-top:20px;padding-top:16px;border-top:2px solid #334155}
.calc-medical-title{color:#94a3b8;font-size:12px;font-weight:600;margin-bottom:12px;text-transform:uppercase;letter-spacing:1px}
.calc-medical-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
.calc-med-btn{padding:12px;font-size:13px;font-weight:600;border:2px solid #06b6d4;border-radius:8px;cursor:pointer;transition:all .2s;background:rgba(6,182,212,0.1);color:#06b6d4}
.calc-med-btn:hover{background:rgba(6,182,212,0.2);transform:translateY(-2px)}
.calc-section{margin-top:12px;border:1px solid #334155;border-radius:8px;overflow:hidden}
.calc-section-title{background:#1e293b;padding:10px 12px;cursor:pointer;font-size:13px;font-weight:600;color:#e2e8f0;display:flex;justify-content:space-between;align-items:center;transition:background .2s}
.calc-section-title:hover{background:#334155}
.calc-toggle{font-size:10px;transition:transform .2s}
.calc-section.open .calc-toggle{transform:rotate(180deg)}
.calc-section-content{display:none;padding:12px;background:#0f172a}
.calc-section.open .calc-section-content{display:block}
.calc-form-row{margin-bottom:10px}
.calc-form-row label{font-size:12px;color:#94a3b8;display:block;margin-bottom:6px}
.calc-form-3cols{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.calc-input-group{display:flex;align-items:center;background:#1e293b;border:1px solid #334155;border-radius:6px;overflow:hidden}
.calc-input-group input{flex:1;padding:8px 10px;border:none;background:transparent;color:#e2e8f0;font-size:14px;width:100%;min-width:0}
.calc-input-group input:focus{outline:none}
.calc-input-group input::placeholder{color:#64748b}
.calc-unit{padding:8px 10px;background:#334155;color:#94a3b8;font-size:11px;font-weight:600;white-space:nowrap}
.calc-form-btn{width:100%;padding:10px;background:#10b981;border:none;border-radius:6px;color:white;font-weight:600;cursor:pointer;transition:all .2s;margin-top:8px}
.calc-form-btn:hover{background:#059669}
.calc-result{margin-top:10px;padding:10px;background:#1e293b;border-radius:6px;font-size:13px;color:#e2e8f0;text-align:center;min-height:20px}
.calc-result.success{border-left:3px solid #10b981}
.calc-result.warning{border-left:3px solid #f59e0b}
.calc-result.danger{border-left:3px solid #ef4444}
.calculator-modal{max-width:420px;background:#1e293b;max-height:90vh;overflow-y:auto}
.theme-btn-fixed{position:fixed;bottom:30px;left:30px;width:50px;height:50px;border-radius:50%;border:2px solid #ec4899;background:linear-gradient(135deg,#1e1b4b 0%,#3b0764 100%);color:white;font-size:20px;cursor:pointer;transition:all .25s;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 15px rgba(236,72,153,0.4);z-index:9000}
.theme-btn-fixed:hover{transform:scale(1.1);box-shadow:0 6px 25px rgba(236,72,153,0.6)}
.floating-btn.theme-btn:hover{box-shadow:0 6px 25px rgba(236,72,153,0.5)}
.floating-btn{position:relative}
.floating-btn::after{content:attr(title);position:absolute;bottom:calc(100% + 10px);left:50%;transform:translateX(-50%);background:#0f172a;color:#e2e8f0;padding:8px 12px;border-radius:8px;font-size:12px;font-weight:500;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity .2s,transform .2s;border:1px solid #334155;box-shadow:0 4px 12px rgba(0,0,0,0.3)}
.floating-btn:hover::after{opacity:1;transform:translateX(-50%) translateY(-2px)}
.empty-state{text-align:center;padding:80px 20px;color:#64748b}
.toast{position:fixed;bottom:20px;left:20px;background:#1e293b;border:2px solid #3b82f6;color:white;padding:16px 24px;border-radius:10px;z-index:3000;animation:slideInLeft .3s;font-weight:600;box-shadow:0 10px 30px rgba(0,0,0,0.5)}
.notice-menu{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.notice-menu-btn{padding:24px;background:var(--bg-card);border:2px solid var(--module-border);border-radius:12px;cursor:pointer;transition:all .2s;text-align:center}
.notice-menu-btn:hover{border-color:var(--border-accent);background:var(--bg-module);transform:translateY(-2px)}
.notice-menu-btn .icon{font-size:40px;margin-bottom:12px}
.notice-menu-btn .title{font-size:14px;font-weight:700;color:var(--text-title)}
.notice-content{line-height:1.8;color:#cbd5e1}
.notice-content h2{color:#60a5fa;font-size:18px;margin:24px 0 12px;padding-bottom:8px;border-bottom:2px solid #334155}
.notice-content h3{color:#f59e0b;font-size:15px;margin:20px 0 10px}
.notice-content p{margin-bottom:14px}
.notice-content ul{margin:12px 0 12px 20px}
.notice-content li{margin-bottom:8px}
.notice-content .warning-box{background:linear-gradient(135deg,#7f1d1d 0%,#991b1b 100%);border:2px solid #dc2626;border-radius:12px;padding:20px;margin:20px 0}
.notice-content .warning-box h3{color:#fecaca;margin-top:0}
.notice-content .info-box{background:#0f172a;border:2px solid #3b82f6;border-radius:12px;padding:20px;margin:20px 0}
.notice-content .objectives-box{background:linear-gradient(135deg,#065f46 0%,#047857 100%);border:2px solid #10b981;border-radius:12px;padding:20px;margin:20px 0}
.notice-content .objectives-box h2{color:#6ee7b7;margin-top:0;border:none;padding:0}
.notice-content .objectives-box ul{color:#d1fae5}
.notice-content .objectives-btn{display:block;width:100%;padding:16px 24px;background:linear-gradient(135deg,#059669 0%,#047857 100%);color:white;border:2px solid #10b981;border-radius:10px;font-size:15px;font-weight:700;cursor:pointer;margin:0 0 12px 0;transition:all .2s;text-align:left}
.notice-content .objectives-btn:hover{background:linear-gradient(135deg,#047857 0%,#065f46 100%);transform:translateY(-2px);box-shadow:0 4px 12px rgba(5,150,105,0.4)}
.notice-content .objectives-content{display:none;background:linear-gradient(135deg,#065f46 0%,#047857 100%);border:2px solid #10b981;border-radius:12px;padding:20px;margin:0 0 20px 0}
.notice-content .objectives-content.active{display:block}
.notice-content .objectives-content h2{color:#6ee7b7;margin-top:0;border:none;padding:0}
.notice-content .objectives-content ul{color:#d1fae5}
.notice-content .warning-btn{display:block;width:100%;padding:16px 24px;background:linear-gradient(135deg,#dc2626 0%,#b91c1c 100%);color:white;border:2px solid #ef4444;border-radius:10px;font-size:15px;font-weight:700;cursor:pointer;margin:0 0 12px 0;transition:all .2s;text-align:left}
.notice-content .warning-btn:hover{background:linear-gradient(135deg,#b91c1c 0%,#991b1b 100%);transform:translateY(-2px);box-shadow:0 4px 12px rgba(220,38,38,0.4)}
.notice-content .warning-content{display:none;background:linear-gradient(135deg,#7f1d1d 0%,#991b1b 100%);border:2px solid #dc2626;border-radius:12px;padding:20px;margin:0 0 20px 0}
.notice-content .warning-content.active{display:block}
.notice-content .warning-content h3{color:#fecaca;margin-top:0}
.notice-content .checklist-btn{display:block;width:100%;padding:16px 24px;background:#059669;color:white;border:none;border-radius:10px;font-size:15px;font-weight:700;cursor:pointer;margin:0 0 12px 0;transition:all .2s;text-align:left}
.notice-content .checklist-btn:hover{background:#047857;transform:translateY(-2px);box-shadow:0 4px 12px rgba(5,150,105,0.4)}
.notice-content .checklist-content{display:none;background:#0f172a;border:2px solid #059669;border-radius:12px;padding:20px;margin:0 0 20px 0}
.notice-content .checklist-content.active{display:block}
.notice-content .example-row{display:flex;align-items:flex-start;gap:16px;margin:16px 0}
.notice-content .example-row p{flex:1;margin:0}
.notice-content .example-btn{display:inline-block;padding:8px 16px;background:#f59e0b;color:white;border:none;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;transition:all .2s;white-space:nowrap;flex-shrink:0}
.notice-content .example-btn:hover{background:#d97706}
.notice-content .example-box{display:none;background:#0f172a;border:2px solid #f59e0b;border-radius:12px;padding:20px;margin:12px 0}
.notice-content .example-box.active{display:block}
.notice-content .xxxx-demo{color:#ef4444;font-weight:700}
.notice-content .alt-demo{background:radial-gradient(ellipse at center,rgba(255,255,255,0.12) 0%,rgba(255,255,255,0.05) 50%,transparent 70%);padding:1px 4px;border-radius:3px;box-shadow:0 0 8px rgba(255,255,255,0.18),0 0 14px rgba(255,255,255,0.1)}
[data-theme="fence"] .notice-content .alt-demo,[data-theme="wake"] .notice-content .alt-demo,[data-theme="aspect"] .notice-content .alt-demo,[data-theme="mono"] .notice-content .alt-demo,[data-theme="cyber"] .notice-content .alt-demo,[data-theme="sunset"] .notice-content .alt-demo,[data-theme="paper"] .notice-content .alt-demo,[data-theme="sober"] .notice-content .alt-demo,[data-theme="pastel"] .notice-content .alt-demo,[data-theme="neonpink"] .notice-content .alt-demo,[data-theme="matrix"] .notice-content .alt-demo,[data-theme="aurora"] .notice-content .alt-demo,[data-theme="median"] .notice-content .alt-demo,[data-theme="clinical"] .notice-content .alt-demo{background:linear-gradient(135deg,rgba(250,204,21,0.25) 0%,rgba(234,179,8,0.35) 50%,rgba(250,204,21,0.25) 100%);box-shadow:0 0 8px rgba(234,179,8,0.3),0 0 14px rgba(234,179,8,0.15)}
.notice-content .del-demo{color:#ef4444;font-weight:600}
@keyframes slideIn{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes slideInLeft{from{transform:translateX(-400px);opacity:0}to{transform:translateX(0);opacity:1}}
</style>
</head>
<body>
<div class="container">
<div class="sidebar">
<div class="sidebar-header">
<div class="sidebar-title">ðŸ“‹ SÃ©lection</div>
</div>
<button class="notice-btn-full" onclick="openModal('noticeMenuModal')">âš ï¸ Notice et mise en garde</button>
<button id="generateTop" class="generate-btn" disabled>ðŸ”„ GÃ©nÃ©rer la Conclusion</button>
<div class="search-container">
<input type="text" id="motifSearch" class="search-input" placeholder="ðŸ” Rechercher un motif..." oninput="searchMotifs(this.value)" onkeydown="handleMotifSearchKeydown(event)">
<div id="searchResults" class="search-results"></div>
</div>
<div class="selection-zone">
<div class="motif-selection-main" style="display:none" id="mainSelectionBox">
<div class="motif-selection-title">â­ Motif Principal</div>
<div id="mainSelectionText"></div>
</div>
<div class="motif-selection-secondary" style="display:none" id="secondarySelectionBox">
<div class="motif-selection-title">ðŸ“Ž Motifs Secondaires</div>
<div id="secondarySelectionText"></div>
</div>
<div class="section-title" style="margin-top:12px">CatÃ©gories</div>
<div class="categories-grid" id="categoriesGrid"></div>
<div class="motifs-zone" id="motifsZone">
<div class="motifs-zone-header">
<span class="motifs-zone-title" id="motifsZoneTitle">ðŸ“‚ CatÃ©gorie</span>
<span class="motifs-zone-close" onclick="closeMotifsZone()">âœ•</span>
</div>
<div class="motifs-zone-content" id="motifsZoneContent"></div>
</div>
</div>
<button id="generateBottom" class="generate-btn" disabled>ðŸ”„ GÃ©nÃ©rer la Conclusion</button>
<button class="reset-btn" onclick="resetAll()">ðŸ”„ Recommencer</button>
<div id="apiStatus" class="api-status disconnected">âŒ DÃ©connectÃ©</div>
</div>
<div id="resultContainer">
<div class="empty-state">
<div style="font-size:64px;margin-bottom:20px">ðŸ“</div>
<h3>Aucune conclusion gÃ©nÃ©rÃ©e</h3>
<p>SÃ©lectionnez un motif principal et cliquez sur "GÃ©nÃ©rer"</p>
</div>
</div>
</div>

<div id="modeSelectionModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<span>Choisissez le type de document</span>
<span class="modal-close" onclick="closeModal('modeSelectionModal')">Ã—</span>
</div>
<div class="mode-selection">
<div class="mode-btn" onclick="selectMode('examen')">
<div class="mode-btn-icon">ðŸ”</div>
<div>EXAMEN TYPE</div>
</div>
<div class="mode-btn" onclick="selectMode('conclusion')">
<div class="mode-btn-icon">ðŸŽ‰</div>
<div>CONCLUSION TYPE</div>
</div>
<div class="mode-btn" onclick="selectMode('examen_conclusion')">
<div class="mode-btn-icon">ðŸŽ‰+ðŸ”</div>
<div>EXAMEN + CONCLUSION</div>
</div>
<div class="mode-btn memo-btn" onclick="openMemo()">
<div class="mode-btn-icon">ðŸ“</div>
<div>MEMO</div>
</div>
</div>
</div>
</div>

<div id="memoModal" class="modal">
<div class="modal-memo">
<div class="modal-header">
<span>ðŸ“ MEMO : <span id="memoMotifName"></span></span>
<button class="memo-close" onclick="closeModal('memoModal')">Ã—</button>
</div>
<div id="memoContent" class="memo-content"></div>
</div>
</div>

<div id="xxxxModal" class="modal"></div>
<div id="xxxxPopup" class="xxxx-popup"></div>
<div id="xxxxPopup2" class="xxxx-popup"></div>
<div id="xxxxPopup3" class="xxxx-popup"></div>
<div id="xxxxModal2" class="modal"></div>
<div id="alternativeModal" class="modal"></div>
<div id="bulleModal" class="modal"></div>
<div id="bullePopupOrdo" class="bulle-popup-ordo"></div>
<div id="alternativesModal" class="modal"></div>
<div id="diagnosticChoiceModal" class="modal"></div>
<div id="modifyModulesModal" class="modal"></div>
<div id="motifGroupModal" class="modal"></div>
<div id="altDropdown" class="alt-dropdown"></div>
<div id="xxxxModalInAlt" class="xxxx-alt-modal"></div>
<div id="ordoModal" class="modal"></div>
<div id="allOrdosModal" class="modal"></div>

<div id="noticeMenuModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<span>â„¹ï¸ Notice et informations</span>
<span class="modal-close" onclick="closeModal('noticeMenuModal')">Ã—</span>
</div>
<div class="notice-menu">
<div class="notice-menu-btn" onclick="closeModal('noticeMenuModal');openModal('objectifsModal')">
<div class="icon">âš ï¸</div>
<div class="title">Objectifs et mise en garde<br><small style="color:#f59e0b">Ã€ lire impÃ©rativement</small></div>
</div>
<div class="notice-menu-btn" onclick="closeModal('noticeMenuModal');openModal('manuelModal')">
<div class="icon">ðŸ“–</div>
<div class="title">Manuel d'utilisation</div>
</div>
</div>
</div>
</div>

<div id="objectifsModal" class="modal">
<div class="modal-content large">
<div class="modal-header">
<span>âš ï¸ Objectifs et mise en garde</span>
<span class="modal-close" onclick="closeModal('objectifsModal')">Ã—</span>
</div>
<div class="notice-content">

<button class="objectives-btn" onclick="toggleExample('objectifsContent')">ðŸŽ¯ Objectifs</button>
<div id="objectifsContent" class="objectives-content">
<ul>
<li><strong>AccÃ©lÃ©rer la prise en charge</strong> en fusionnant les comptes rendus types correspondant Ã  un ou plusieurs motifs sÃ©lectionnÃ©s, afin de gÃ©nÃ©rer rapidement une base de rÃ©daction (examen clinique + conclusion) prÃªte Ã  Ãªtre personnalisÃ©e.</li>
<li><strong>Servir de checklist</strong>, comme dans l'aÃ©ronautique, pour ne rien oublier dans l'examen clinique, les prescriptions et la conclusion.</li>
<li><strong>RÃ©duire le risque d'omissions</strong> face Ã  un motif qui peut paraÃ®tre banal, afin de ne pas passer Ã  cÃ´tÃ© d'une situation potentiellement grave.</li>
<li><strong>Aider Ã  produire une conclusion de sortie claire</strong> et comprÃ©hensible pour le patient, avec de vrais conseils et des consignes de reconsultation pertinentes et adaptÃ©es.</li>
<li><strong>Avoir un intÃ©rÃªt pÃ©dagogique</strong>, en guidant l'utilisateur via un grand nombre d'informations cliquables et de mÃ©mo thÃ©rapeutique.</li>
</ul>
</div>

<button class="warning-btn" onclick="toggleExample('warningContent')">ðŸš¨ MISE EN GARDE : Ã€ LIRE IMPÃ‰RATIVEMENT !</button>
<div id="warningContent" class="warning-content">
<p><strong>RÃ¨gle principale : ne noter que ce qui a Ã©tÃ© rÃ©ellement recherchÃ© et constatÃ©.</strong></p>
<p>L'objectif de cette application n'est pas de faire du copier-coller. Elle doit Ãªtre utilisÃ©e comme une check-list mÃ©dicale, Ã  la maniÃ¨re d'un pilote d'avion avant de dÃ©coller. <strong>Il est dangereux et interdit de documenter des informations qui n'ont pas Ã©tÃ© recherchÃ©es Ã  l'examen clinique (ou non vÃ©rifiÃ©es).</strong> Cela met en danger le patient et engage votre responsabilitÃ©.</p>
<ul>
<li><strong>Aide Ã  la rÃ©daction, pas Ã  la dÃ©cision</strong> : l'application propose une trame de compte rendu. Elle ne remplace pas le raisonnement clinique et la rÃ©flexion.</li>
<li><strong>Chaque patient est unique</strong> : le texte doit Ãªtre adaptÃ© au contexte, aux constantes, aux antÃ©cÃ©dents, aux traitements, aux rÃ©sultats d'examens et Ã  l'Ã©volutionâ€¦</li>
<li><strong>Relecture obligatoire</strong> de l'ensemble des informations : vÃ©rifiez la cohÃ©rence du texte final (nÃ©gations, latÃ©ralitÃ©, chronologie, valeurs chiffrÃ©es, allergies, traitements, diagnostics Ã©voquÃ©s/exclus).</li>
<li><strong>Ne pas laisser des Ã©lÃ©ments par dÃ©faut</strong> : supprimez tout ce qui ne correspond pas au patient et complÃ©tez systÃ©matiquement les champs <span class="xxxx-demo">XXXX</span>.</li>
<li><strong>Prescriptions</strong> : toute ordonnance gÃ©nÃ©rÃ©e doit Ãªtre contrÃ´lÃ©e (indication, dose, durÃ©e, interactions, insuffisance rÃ©nale/hÃ©patique, grossesse/allaitement, allergies, contre-indications).</li>
<li><strong>Conseils et reconsultation</strong> : les conseils et consignes doivent Ãªtre personnalisÃ©s et adaptÃ©s au risque (signes d'alerte, dÃ©lais, modalitÃ©s de suivi).</li>
<li><strong>ResponsabilitÃ©</strong> : le praticien reste entiÃ¨rement responsable du compte rendu final, des prescriptions et des dÃ©cisions mÃ©dicales.</li>
<li><strong>ConfidentialitÃ©</strong> : n'insÃ©rez pas de donnÃ©es identifiantes inutiles. Respectez les rÃ¨gles de confidentialitÃ© et de sÃ©curitÃ©.</li>
</ul>
</div>

<button class="checklist-btn" onclick="toggleExample('checklistContent')">âœˆï¸ Pourquoi faire le choix d'une dÃ©marche check-list ?</button>
<div id="checklistContent" class="checklist-content">
<p>Nous avons choisi d'assumer pleinement une dÃ©marche "check-list", inspirÃ©e de ce qui se fait dans les domaines Ã  haut niveau d'exigence en sÃ©curitÃ© comme l'aÃ©ronautique. En mÃ©decine d'urgence, la difficultÃ© n'est pas seulement de connaÃ®tre les diagnostics ou les traitements, mais surtout de <strong>rester fiable dans un environnement oÃ¹ tout va vite</strong> : fatigue, interruptions, afflux, stress, informations incomplÃ¨tes, dÃ©lais de biologie/imagerie, changement d'Ã©quipeâ€¦</p>
<p>Dans ces conditions, mÃªme un clinicien expÃ©rimentÃ© peut oublier un item important, omettre un document, ou rÃ©diger une conclusion trop pauvre, alors que le motif initial semblait banal.</p>
<p>L'idÃ©e de l'application est simple : <strong>fournir une trame structurÃ©e qui sert de garde-fou contre les oublis</strong>. Elle ne cherche pas Ã  "faire Ã  la place" du mÃ©decin, ni Ã  imposer une conduite Ã  tenir. Elle aide Ã  balayer les points clÃ©s : ce qu'il faut vÃ©rifier Ã  l'examen, ce qu'il faut envisager comme signaux d'alarme, ce qu'il faut documenter, et surtout ce que le patient doit comprendre en sortant (conseils, traitement, surveillance, signes de gravitÃ©, et consignes de reconsultation adaptÃ©es).</p>
<p>L'objectif final est que le patient quitte le service avec un document clair, correctement Ã©crit, utile, et cohÃ©rent avec ce qui a Ã©tÃ© rÃ©ellement fait et retrouvÃ©.</p>

<p>Cette approche a un coÃ»t, et il faut l'Ã©noncer clairement : une check-list "large" propose parfois trop d'Ã©lÃ©ments. Si l'utilisateur ne relit pas, ne supprime pas, ou laisse un item par dÃ©faut, on peut se retrouver avec des absurditÃ©s ou des phrases inappropriÃ©es.</p>

<div class="example-row">
<p>L'exemple typique est une formulation clinique qui n'a aucun sens dans le contexte, comme Ã©crire "testicule en place" chez une petite fille. C'est trÃ¨s mal vu, parce que cela donne l'impression d'un compte rendu copiÃ©-collÃ© sans rÃ©flexion, et cela dÃ©crÃ©dibilise le document. Mais surtout, cela peut devenir dangereux si des informations non vÃ©rifiÃ©es sont affirmÃ©es.</p>
<button class="example-btn" onclick="toggleExample('exampleBox1')">ðŸ“Œ Voir un exemple concret</button>
</div>

<div id="exampleBox1" class="example-box">
<p><strong>Exemple :</strong> Imaginons un patient qui consulte pour une asthÃ©nie et une faiblesse des jambes. Le compte rendu type propose, parmi les items, une ligne du genre "ROT conservÃ©s".</p>
<p>Si l'utilisateur laisse cette phrase <strong>sans avoir rÃ©ellement testÃ© les ROT</strong>, le compte rendu affirme alors un Ã©lÃ©ment clinique majeurâ€¦ qui n'a pas Ã©tÃ© vÃ©rifiÃ©.</p>
<p>Or, dans un tableau compatible avec un <strong>syndrome de Guillain-BarrÃ©</strong>, l'abolition des ROT est un signe majeur. Ã‰crire "ROT conservÃ©s" Ã  tort peut :</p>
<ul>
<li>rassurer Ã  tort (patient renvoyÃ© avec une conclusion banalisÃ©e),</li>
<li>retarder la reconnaissance d'un Guillain-BarrÃ© dÃ©butant,</li>
<li>et faire perdre du temps alors que l'Ã©volution peut Ãªtre rapide.</li>
</ul>
<p>C'est typiquement le genre de situation oÃ¹ une phrase "standard" laissÃ©e par dÃ©faut devient dangereuse : elle transforme une check-list (Ã  vÃ©rifier) en affirmation clinique (Ã  tort). Le bon usage, au contraire, est de considÃ©rer ces items comme un rappel : <em>"ai-je bien testÃ© les ROT ?"</em> puis de ne documenter le rÃ©sultat que si l'examen a Ã©tÃ© fait.</p>
</div>

<p>C'est pourquoi la <strong>rÃ¨gle non nÃ©gociable</strong> de la dÃ©marche est la suivante : <strong>on ne doit noter que ce qui a Ã©tÃ© rÃ©ellement recherchÃ© et constatÃ©</strong>. L'application n'est pas un outil de copier-coller. Elle est un outil de vÃ©rification et de rÃ©daction guidÃ©e.</p>
<p>Conserver dans le compte rendu final une information qui n'a pas Ã©tÃ© recherchÃ©e Ã  l'examen clinique, ou une nÃ©gation non vÃ©rifiÃ©e, met potentiellement le patient en danger et engage directement la responsabilitÃ© du praticien. La trame est lÃ  pour aider Ã  penser "ai-je vÃ©rifiÃ© ceci ?", pas pour affirmer "c'est fait" si cela n'a pas Ã©tÃ© fait.</p>

<div class="info-box">
<h3>ðŸ’¡ La logique</h3>
<p>Autrement dit, la logique est : mieux vaut proposer une liste de points Ã  considÃ©rer, quitte Ã  ce que certains soient supprimÃ©s, plutÃ´t que de ne pas les proposer et risquer de les oublier.</p>
<p>C'est une balance bÃ©nÃ©ficeâ€“risque assumÃ©e : on prÃ©fÃ¨re accepter la possibilitÃ© de quelques erreurs d'inattention dans le brouillon (qui doivent Ãªtre corrigÃ©es au maximum Ã  la relecture) plutÃ´t que de courir le risque d'oublier un symptÃ´me clÃ©, un point d'examen, une contre-indication, un document, ou une consigne de reconsultation essentielle. Dans une activitÃ© oÃ¹ l'enjeu est parfois de ne pas passer Ã  cÃ´tÃ© d'une situation grave derriÃ¨re un motif a priori simple, l'oubli est un risque majeur.</p>
</div>

<p>Cette dÃ©marche implique donc une <strong>responsabilitÃ© active de l'utilisateur</strong> : relire, corriger, personnaliser, supprimer. Le texte gÃ©nÃ©rÃ© est un point de dÃ©part, pas une fin. Il faut adapter au patient rÃ©el : son Ã¢ge, son sexe, ses antÃ©cÃ©dents, ses traitements (anticoagulants, immunosuppresseursâ€¦), son contexte (grossesse, pÃ©diatrie), ses constantes, ses rÃ©sultats de biologie et d'imagerie, et l'Ã©volution clinique. La rÃ©daction doit rester fidÃ¨le Ã  la rÃ©alitÃ© : ce qui a Ã©tÃ© examinÃ©, ce qui a Ã©tÃ© retrouvÃ©, ce qui n'a pas pu Ãªtre Ã©valuÃ©, ce qui a motivÃ© la dÃ©cision, et ce qui a Ã©tÃ© expliquÃ© au patient.</p>

<p>Enfin, cette dÃ©marche a aussi une <strong>dimension pÃ©dagogique</strong>. Le grand nombre d'Ã©lÃ©ments cliquables, d'options et de formulations alternatives a Ã©tÃ© pensÃ© pour guider sans enfermer : explorer des propositions, se rappeler des points importants, comparer des formulations, et structurer une conclusion de sortie utile.</p>

<p><strong>L'ambition n'est pas d'uniformiser les prises en charge, mais d'aider Ã  produire des comptes rendus plus fiables, plus complets, et plus sÃ»rs, en limitant les oublis â€” tout en rappelant que l'outil n'a de valeur que s'il est utilisÃ© comme une check-list, avec une relecture rigoureuse, et avec le respect absolu de la rÃ¨gle : ne jamais documenter ce qui n'a pas Ã©tÃ© recherchÃ©.</strong></p>
</div>
</div>
</div>
</div>

<div id="manuelModal" class="modal">
<div class="modal-content large">
<div class="modal-header">
<span>ðŸ“– Manuel d'utilisation</span>
<span class="modal-close" onclick="closeModal('manuelModal')">Ã—</span>
</div>
<div class="notice-content">
<h2>ðŸ“‹ Notice â€” Fonctionnement & prÃ©cautions d'utilisation</h2>
<p>Cette application aide Ã  gÃ©nÃ©rer un examen clinique et une conclusion Ã  partir d'un ou plusieurs motifs.</p>

<h3>1. SÃ©lection des motifs</h3>
<ul>
<li>SÃ©lectionnez un <strong>motif principal</strong> et un ou plusieurs <strong>motifs secondaires</strong></li>
<li>L'application propose au choix :
<ul>
<li>Un examen clinique type</li>
<li>Une conclusion</li>
<li>Les deux combinÃ©s</li>
</ul>
</li>
<li><strong>Adaptez systÃ©matiquement</strong> le contenu au patient, Ã  l'examen rÃ©el, aux examens complÃ©mentaires et au contexte.</li>
</ul>

<h3>2. Interaction avec le texte</h3>
<ul>
<li><span class="xxxx-demo">XXXX</span> : Zone Ã  complÃ©ter</li>
<li><span class="alt-demo">Texte lumineux</span> : ouvre plusieurs propositions souvent antagonistes (examen normal â†” Examen anormal)</li>
<li><span class="del-demo">Texte en rouge</span> : Ã©lÃ©ments spÃ©cifiques Ã  certaines catÃ©gories de patients notÃ©s en rouge pour ne pas oublier de les supprimer si non adaptÃ© (ex. enfant, grossesse, anticoagulants, immunodÃ©pressionâ€¦) âžœ Ã€ conserver uniquement si cela s'applique au patient</li>
</ul>

<h3>3. Esprit "checklist" : pourquoi c'est utile</h3>
<p>Chaque patient est unique. L'intÃ©rÃªt de l'application est de rÃ©duire le risque d'oubli en situation d'urgence, notamment :</p>
<ul>
<li>ne pas oublier un item d'examen important,</li>
<li>ne pas omettre une prÃ©caution ou une contre-indication dans une ordonnance,</li>
<li>ne pas passer Ã  cÃ´tÃ© d'un diagnostic grave derriÃ¨re un motif apparemment simple,</li>
<li>faire sortir le patient avec une conclusion claire et correctement rÃ©digÃ©e, comprenant de vrais conseils et des consignes de reconsultation adaptÃ©es.</li>
</ul>

<div class="warning-box">
<h3>âš ï¸ Avertissements indispensables</h3>
<ul>
<li><strong>Ne remplace pas le raisonnement clinique</strong> : le contenu gÃ©nÃ©rÃ© est une aide Ã  la rÃ©daction et Ã  la vÃ©rification. Il ne remplace ni l'examen clinique, ni l'interrogatoire, ni l'Ã©valuation mÃ©dicale, ni les protocoles locaux.</li>
<li><strong>Validation obligatoire</strong> : relisez et validez chaque phrase avant de finaliser (nÃ©gations, latÃ©ralitÃ©, constantes, chronologie, traitements, allergies, comorbiditÃ©s, rÃ©sultats d'examens).</li>
<li><strong>Personnalisation impÃ©rative</strong> : supprimez tout ce qui ne correspond pas au patient et complÃ©tez les champs <span class="xxxx-demo">XXXX</span>.</li>
<li><strong>ResponsabilitÃ©</strong> : le praticien reste entiÃ¨rement responsable du compte rendu final et des dÃ©cisions associÃ©es.</li>
</ul>
</div>
</div>
</div>
</div>

<div class="floating-actions" style="display:none" id="floatingActions">
<button class="floating-btn copy-hdm" onclick="copyHDM()" title="Copier l'Histoire de la Maladie">ðŸ“</button>
<button class="floating-btn copy-examen" onclick="copyExamen()" title="Copier l'Examen Clinique">ðŸ”</button>
<button class="floating-btn copy-conclusion" onclick="copyConclusion()" title="Copier la Conclusion">ðŸŽ‰</button>
<button class="floating-btn open-memo" onclick="openMemoFromFloating()" title="Ouvrir les MÃ©mos">ðŸ’¡</button>
<button class="floating-btn theme-btn" onclick="openThemeModal()" title="Changer le thÃ¨me">ðŸŽ¨</button>
<button class="floating-btn calc-btn" onclick="openCalculator()" title="Calculatrice">ðŸ§®</button>
<button class="floating-btn regenerate" onclick="resetAll()" title="Recommencer">ðŸ”„</button>
</div>

<button class="theme-btn-fixed" onclick="openThemeModal()" title="Changer le thÃ¨me">ðŸŽ¨</button>

<div id="themeModal" class="modal">
<div class="modal-content theme-modal-content">
<div class="modal-header">
<span>ðŸŽ¨ Choisir un thÃ¨me</span>
<span class="modal-close" onclick="closeModal('themeModal')">Ã—</span>
</div>
<div class="theme-grid">
<div class="theme-option" onclick="setTheme('default')" data-theme="default">
<div class="theme-preview theme-preview-default">
<div class="tp-sidebar"></div>
<div class="tp-content"></div>
</div>
<span>Bioluminescent</span>
</div>
<div class="theme-option" onclick="setTheme('sober')" data-theme="sober">
<div class="theme-preview theme-preview-sober">
<div class="tp-sidebar"></div>
<div class="tp-content"></div>
</div>
<span>Sobre</span>
</div>
<div class="theme-option" onclick="setTheme('red')" data-theme="red">
<div class="theme-preview theme-preview-red">
<div class="tp-sidebar"></div>
<div class="tp-content"></div>
</div>
<span>NÃ©on Rouge</span>
</div>
<div class="theme-option" onclick="setTheme('violet')" data-theme="violet">
<div class="theme-preview theme-preview-violet">
<div class="tp-sidebar"></div>
<div class="tp-content"></div>
</div>
<span>NÃ©on Violet</span>
</div>
<div class="theme-option" onclick="setTheme('orange')" data-theme="orange">
<div class="theme-preview theme-preview-orange">
<div class="tp-sidebar"></div>
<div class="tp-content"></div>
</div>
<span>NÃ©on Orange</span>
</div>
<div class="theme-option" onclick="setTheme('green')" data-theme="green">
<div class="theme-preview theme-preview-green">
<div class="tp-sidebar"></div>
<div class="tp-content"></div>
</div>
<span>Vert & Jaune</span>
</div>
<div class="theme-option" onclick="setTheme('pastel')" data-theme="pastel">
<div class="theme-preview theme-preview-pastel">
<div class="tp-sidebar"></div>
<div class="tp-content"></div>
</div>
<span>Pastel</span>
</div>
<div class="theme-option" onclick="setTheme('classic')" data-theme="classic">
<div class="theme-preview theme-preview-classic">
<div class="tp-sidebar"></div>
<div class="tp-content"></div>
</div>
<span>Classique</span>
</div>
<div class="theme-option" onclick="setTheme('ocean')" data-theme="ocean">
<div class="theme-preview theme-preview-ocean">
<div class="tp-sidebar"></div>
<div class="tp-content"></div>
</div>
<span>OcÃ©an</span>
</div>
<div class="theme-option" onclick="setTheme('midnight')" data-theme="midnight">
<div class="theme-preview theme-preview-midnight">
<div class="tp-sidebar"></div>
<div class="tp-content"></div>
</div>
<span>Minuit</span>
</div>
<div class="theme-option" onclick="setTheme('nebula')" data-theme="nebula">
<div class="theme-preview theme-preview-nebula">
<div class="tp-sidebar"></div>
<div class="tp-content"></div>
</div>
<span>NÃ©buleuse</span>
</div>
<div class="theme-option" onclick="setTheme('violet2')" data-theme="violet2">
<div class="theme-preview theme-preview-violet2">
<div class="tp-sidebar"></div>
<div class="tp-content"></div>
</div>
<span>Violet II</span>
</div>
<div class="theme-option" onclick="setTheme('median')" data-theme="median">
<div class="theme-preview theme-preview-median">
<div class="tp-sidebar"></div>
<div class="tp-content"></div>
</div>
<span>MÃ©dian</span>
</div>
<div class="theme-option" onclick="setTheme('paper')" data-theme="paper">
<div class="theme-preview theme-preview-paper">
<div class="tp-sidebar"></div>
<div class="tp-content"></div>
</div>
<span>Papier</span>
</div>
<div class="theme-option" onclick="setTheme('fence')" data-theme="fence">
<div class="theme-preview theme-preview-fence">
<div class="tp-sidebar"></div>
<div class="tp-content"></div>
</div>
<span>Palissade</span>
</div>
<div class="theme-option" onclick="setTheme('wake')" data-theme="wake">
<div class="theme-preview theme-preview-wake">
<div class="tp-sidebar"></div>
<div class="tp-content"></div>
</div>
<span>Sillage</span>
</div>
<div class="theme-option" onclick="setTheme('aspect')" data-theme="aspect">
<div class="theme-preview theme-preview-aspect">
<div class="tp-sidebar"></div>
<div class="tp-content"></div>
</div>
<span>Aspect</span>
</div>
<div class="theme-option" onclick="setTheme('mono')" data-theme="mono">
<div class="theme-preview theme-preview-mono">
<div class="tp-sidebar"></div>
<div class="tp-content"></div>
</div>
<span>Monochrome</span>
</div>
<div class="theme-option" onclick="setTheme('cyber')" data-theme="cyber">
<div class="theme-preview theme-preview-cyber">
<div class="tp-sidebar"></div>
<div class="tp-content"></div>
</div>
<span>Cyber</span>
</div>
<div class="theme-option" onclick="setTheme('neonpink')" data-theme="neonpink">
<div class="theme-preview theme-preview-neonpink">
<div class="tp-sidebar"></div>
<div class="tp-content"></div>
</div>
<span>NÃ©on Rose</span>
</div>
<div class="theme-option" onclick="setTheme('matrix')" data-theme="matrix">
<div class="theme-preview theme-preview-matrix">
<div class="tp-sidebar"></div>
<div class="tp-content"></div>
</div>
<span>Matrix</span>
</div>
<div class="theme-option" onclick="setTheme('aurora')" data-theme="aurora">
<div class="theme-preview theme-preview-aurora">
<div class="tp-sidebar"></div>
<div class="tp-content"></div>
</div>
<span>Aurore</span>
</div>
<div class="theme-option" onclick="setTheme('sunset')" data-theme="sunset">
<div class="theme-preview theme-preview-sunset">
<div class="tp-sidebar"></div>
<div class="tp-content"></div>
</div>
<span>CrÃ©puscule</span>
</div>
<div class="theme-option" onclick="setTheme('clinical')" data-theme="clinical">
<div class="theme-preview theme-preview-clinical">
<div class="tp-sidebar"></div>
<div class="tp-content"></div>
</div>
<span>Clinique</span>
</div>
</div>
</div>
</div>

<div id="calculatorModal" class="modal">
<div class="modal-content calculator-modal">
<div class="modal-header">
<span>ðŸ§® Calculatrice MÃ©dicale</span>
<span class="modal-close" onclick="closeModal('calculatorModal')">Ã—</span>
</div>
<div class="calculator-container">
<div class="calc-display">
<input type="text" id="calcDisplay" readonly value="0">
</div>
<div class="calc-buttons">
<button class="calc-btn calc-clear" onclick="calcClear()">C</button>
<button class="calc-btn calc-op" onclick="calcBackspace()">âŒ«</button>
<button class="calc-btn calc-op" onclick="calcInput('%')">%</button>
<button class="calc-btn calc-op" onclick="calcInput('/')">Ã·</button>
<button class="calc-btn" onclick="calcInput('7')">7</button>
<button class="calc-btn" onclick="calcInput('8')">8</button>
<button class="calc-btn" onclick="calcInput('9')">9</button>
<button class="calc-btn calc-op" onclick="calcInput('*')">Ã—</button>
<button class="calc-btn" onclick="calcInput('4')">4</button>
<button class="calc-btn" onclick="calcInput('5')">5</button>
<button class="calc-btn" onclick="calcInput('6')">6</button>
<button class="calc-btn calc-op" onclick="calcInput('-')">âˆ’</button>
<button class="calc-btn" onclick="calcInput('1')">1</button>
<button class="calc-btn" onclick="calcInput('2')">2</button>
<button class="calc-btn" onclick="calcInput('3')">3</button>
<button class="calc-btn calc-op" onclick="calcInput('+')">+</button>
<button class="calc-btn calc-zero" onclick="calcInput('0')">0</button>
<button class="calc-btn" onclick="calcInput('.')">.</button>
<button class="calc-btn calc-equals" onclick="calcEquals()">=</button>
</div>
<div class="calc-medical">
<div class="calc-medical-title">âš•ï¸ Calculs MÃ©dicaux</div>
<div class="calc-medical-grid">
<button class="calc-med-btn" onclick="calcIMC()">IMC</button>
<button class="calc-med-btn" onclick="calcClearanceCreat()">Cl. CrÃ©at</button>
<button class="calc-med-btn" onclick="calcSurfaceCorp()">Surface Corp.</button>
<button class="calc-med-btn" onclick="calcDosePoids()">Dose/Poids</button>
<button class="calc-med-btn" onclick="calcQTc()">QTc</button>
<button class="calc-med-btn" onclick="calcPertePoids()">% Perte Poids</button>
<button class="calc-med-btn" onclick="calcDoseParPrise()">Dose/Prise</button>
<button class="calc-med-btn" onclick="calcBesoinsHydriques()">Besoins Hydr.</button>
</div>
</div>
</div>
</div>
</div>

<script>
function toggleExample(id){
const box=document.getElementById(id);
if(box)box.classList.toggle('active');
}
</script>

<script>
const API_URL='https://conclusions-medicales-api-1oa1.onrender.com';
let state={categories:[],motifPrincipal:null,motifsSecondaires:[],conclusion:null,conduiteLines:[],allOrdonnances:[],currentMode:null,currentBulles:[],allMotifs:[],ordonnancesFusionnees:[]};

document.addEventListener('DOMContentLoaded',()=>{
checkAPI();
loadCategories();
document.getElementById('generateTop').onclick=showModeSelection;
document.getElementById('generateBottom').onclick=showModeSelection;

// Fermer les rÃ©sultats de recherche quand on clique ailleurs
document.addEventListener('click',(e)=>{
const searchContainer=document.querySelector('.search-container');
if(searchContainer&&!searchContainer.contains(e.target)){
document.getElementById('searchResults').classList.remove('active');
}
});
});

async function checkAPI(){
try{
const r=await fetch(`${API_URL}/health`);
const d=await r.json();
const s=document.getElementById('apiStatus');
if(d.status==='healthy'){
s.className='api-status connected';
s.textContent='âœ… ConnectÃ©';
}
}catch(e){console.error('Erreur API:',e);}
}

async function loadCategories(){
try{
const r=await fetch(`${API_URL}/categories`);
const data=await r.json();
// Gestion des 2 formats possibles: tableau direct OU objet {categories: [...]}
let categories;
if(Array.isArray(data)){
categories=data;
}else if(data && Array.isArray(data.categories)){
categories=data.categories;
}else{
console.error('âŒ Format de donnÃ©es incorrect:',data);
state.categories=[];
toast('âš ï¸ Format de donnÃ©es incorrect','error');
return;
}
state.categories=categories;
console.log('âœ… CatÃ©gories chargÃ©es:',state.categories.length,'catÃ©gories');
renderCategories();
loadAllMotifsForSearch();
}catch(e){
console.error('âŒ Erreur catÃ©gories:',e);
state.categories=[];
toast('âš ï¸ Impossible de charger les catÃ©gories','error');
}
}

function renderCategories(){
// Protection : vÃ©rifier que categories est un tableau
if(!Array.isArray(state.categories)){
console.error('âŒ state.categories n\'est pas un tableau:',state.categories);
state.categories=[];
return;
}

const html=state.categories.map(cat=>`
<button class="category-btn" data-table="${cat.table_name}" onclick="toggleCategory('${cat.table_name}','${cat.nom}',this)">
${cat.nom}
</button>
`).join('');

document.getElementById('categoriesGrid').innerHTML=html;
}

// Cache pour les motifs
const motifsCache={};
let currentOpenCategory=null;

async function toggleCategory(tableName,nomCategorie,btnElement){
const zone=document.getElementById('motifsZone');
const content=document.getElementById('motifsZoneContent');
const title=document.getElementById('motifsZoneTitle');

// Si on clique sur la mÃªme catÃ©gorie dÃ©jÃ  ouverte, on ferme
if(currentOpenCategory===tableName && zone.classList.contains('active')){
closeMotifsZone();
return;
}

// DÃ©sactiver tous les boutons et activer celui cliquÃ©
document.querySelectorAll('.category-btn').forEach(btn=>btn.classList.remove('active'));
btnElement.classList.add('active');

// Mettre Ã  jour le titre
title.textContent=`ðŸ“‚ ${nomCategorie}`;

// Afficher la zone avec loading
zone.classList.add('active');
content.innerHTML='<p style="grid-column:span 2;text-align:center;color:var(--text-secondary);padding:20px">â³ Chargement...</p>';

currentOpenCategory=tableName;

// VÃ©rifier le cache
if(motifsCache[tableName]){
renderMotifsInZone(motifsCache[tableName],tableName);
return;
}

// Charger les motifs
try{
const r=await fetch(`${API_URL}/motifs/${tableName}`);
const data=await r.json();

let motifs;
if(Array.isArray(data)){
motifs=data;
}else if(data && Array.isArray(data.motifs)){
motifs=data.motifs;
}else{
console.error('âŒ Format motifs incorrect:',data);
motifs=[];
}

// Mettre en cache
motifsCache[tableName]=motifs;
renderMotifsInZone(motifs,tableName);
}catch(e){
console.error('âŒ Erreur motifs:',e);
content.innerHTML='<p style="grid-column:span 2;text-align:center;color:#ef4444;padding:20px">âŒ Erreur de chargement</p>';
}
}

function renderMotifsInZone(motifs,tableName){
const content=document.getElementById('motifsZoneContent');

if(motifs.length===0){
content.innerHTML='<p style="grid-column:span 2;text-align:center;color:var(--text-secondary);padding:20px">Aucun motif disponible</p>';
return;
}

// Parser et regrouper les motifs par prÃ©fixe [Groupe]
const groupedMotifs = {};
const ungroupedMotifs = [];

// Fonction de normalisation pour la clÃ© de groupe
function normalizeGroupKey(str) {
return str.trim()
.toLowerCase()
.normalize('NFD')
.replace(/[\u0300-\u036f]/g, '') // Supprimer accents
.replace(/\s+/g, ' '); // Normaliser espaces multiples
}

motifs.forEach(motif => {
// Nettoyer le nom du motif (remplacer retours Ã  la ligne par espaces)
const cleanedName = motif.nom_motif.replace(/[\r\n]+/g, ' ').replace(/\s+/g, ' ').trim();
const match = cleanedName.match(/^\[([^\]]+)\]\s*(.+)$/);
if (match) {
const groupNameRaw = match[1].trim();
const groupNameKey = normalizeGroupKey(groupNameRaw);
const subName = match[2].trim();

if (!groupedMotifs[groupNameKey]) {
groupedMotifs[groupNameKey] = {
displayName: groupNameRaw,
motifs: []
};
}
groupedMotifs[groupNameKey].motifs.push({
...motif,
cleanedName: cleanedName,
groupName: groupedMotifs[groupNameKey].displayName,
subName: subName
});
} else {
// Ajouter le nom nettoyÃ© aussi pour les motifs non groupÃ©s
ungroupedMotifs.push({
...motif,
cleanedName: cleanedName
});
}
});

console.log('ðŸ“ Groupes trouvÃ©s:', Object.entries(groupedMotifs).map(([k, v]) => `${v.displayName} (${v.motifs.length})`));

// Construire la liste finale : groupes + motifs non groupÃ©s
const finalList = [];

// Ajouter les groupes
Object.entries(groupedMotifs).forEach(([groupKey, groupData]) => {
if (groupData.motifs.length === 1) {
// Un seul motif dans le groupe, l'afficher avec son subName (sans les crochets)
finalList.push({
type: 'single',
motif: groupData.motifs[0],
displayName: groupData.motifs[0].subName
});
} else {
// Plusieurs motifs, crÃ©er un groupe
finalList.push({
type: 'group',
groupName: groupData.displayName,
motifs: groupData.motifs,
displayName: groupData.displayName
});
}
});

// Ajouter les motifs non groupÃ©s
ungroupedMotifs.forEach(motif => {
finalList.push({
type: 'single',
motif: motif,
displayName: motif.cleanedName || motif.nom_motif
});
});

// Trier par nom d'affichage
finalList.sort((a, b) => a.displayName.localeCompare(b.displayName, 'fr', {sensitivity: 'base'}));

// GÃ©nÃ©rer le HTML
content.innerHTML = finalList.map(item => {
if (item.type === 'group') {
// Bouton de groupe avec indicateur
const groupData = encodeURIComponent(JSON.stringify(item.motifs.map(m => ({
id: m.id,
nom_motif: m.nom_motif,
subName: m.subName
}))));
// VÃ©rifier si un motif du groupe est sÃ©lectionnÃ©
let groupClass = 'motif-btn motif-group';
let selectedInfo = '';
const selectedInGroup = item.motifs.find(m => 
(state.motifPrincipal && state.motifPrincipal.id === m.id && state.motifPrincipal.table === tableName)
);
const secondaryInGroup = item.motifs.find(m => 
state.motifsSecondaires.some(s => s.id === m.id && s.table === tableName)
);
if (selectedInGroup) {
groupClass += ' principal';
selectedInfo = ` (${selectedInGroup.subName})`;
} else if (secondaryInGroup) {
groupClass += ' secondaire';
selectedInfo = ` (${secondaryInGroup.subName})`;
}
return `<button class="${groupClass}" onclick="openMotifGroupModal('${tableName}', '${item.groupName.replace(/'/g, "\\'")}', this)" data-group-motifs="${groupData}">${item.groupName}<span class="group-count">${item.motifs.length}</span>${selectedInfo}</button>`;
} else {
// Bouton simple - utiliser subName si disponible, sinon cleanedName
const motif = item.motif;
const displayText = motif.subName || motif.cleanedName || motif.nom_motif;
const safeName = (motif.cleanedName || motif.nom_motif).replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/\n/g, ' ').replace(/\r/g, '');
let extraClass = '';
if (state.motifPrincipal && state.motifPrincipal.id === motif.id && state.motifPrincipal.table === tableName) {
extraClass = ' principal';
} else if (state.motifsSecondaires.some(m => m.id === motif.id && m.table === tableName)) {
extraClass = ' secondaire';
}
return `<button class="motif-btn${extraClass}" onclick="selectMotif('${tableName}','${motif.id}','${safeName}',this)">${displayText}</button>`;
}
}).join('');
}

// Ouvrir le modal de sÃ©lection d'un groupe de motifs
function openMotifGroupModal(tableName, groupName, btnElement) {
const groupData = JSON.parse(decodeURIComponent(btnElement.getAttribute('data-group-motifs')));

const modalHtml = `
<div class="modal-content motif-group-modal">
<div class="modal-header">
<span>${groupName}</span>
<span class="modal-close" onclick="closeModal('motifGroupModal')">Ã—</span>
</div>
<div class="motif-group-list">
${groupData.map((motif, idx) => {
let itemClass = 'motif-group-item';
if (state.motifPrincipal && state.motifPrincipal.id === motif.id) {
itemClass += ' selected-principal';
} else if (state.motifsSecondaires.some(m => m.id === motif.id)) {
itemClass += ' selected-secondary';
}
// Utiliser l'index pour Ã©viter les problÃ¨mes d'Ã©chappement
return `<div class="${itemClass}" onclick="selectMotifFromGroupByIndex('${tableName}', ${idx}, this)" data-motif-id="${motif.id}" data-motif-name="${encodeURIComponent(motif.nom_motif)}">
<span class="motif-group-item-name">${motif.subName}</span>
<span class="motif-group-item-action">SÃ©lectionner</span>
</div>`;
}).join('')}
</div>
</div>
`;

document.getElementById('motifGroupModal').innerHTML = modalHtml;
document.getElementById('motifGroupModal').classList.add('active');
}

// SÃ©lectionner un motif depuis le modal de groupe par index
function selectMotifFromGroupByIndex(tableName, idx, element) {
const motifId = element.getAttribute('data-motif-id');
const motifName = decodeURIComponent(element.getAttribute('data-motif-name'));
closeModal('motifGroupModal');
const btn = document.querySelector(`.motif-btn[onclick*="'${motifId}'"]`);
selectMotif(tableName, motifId, motifName, btn);
}

function closeMotifsZone(){
document.getElementById('motifsZone').classList.remove('active');
document.querySelectorAll('.category-btn').forEach(btn=>btn.classList.remove('active'));
currentOpenCategory=null;
}

function updateSelectionDisplay(){
if(state.motifPrincipal){
document.getElementById('mainSelectionBox').style.display='block';
document.getElementById('mainSelectionText').innerHTML=`<div class="selected-motif-item principal-item">${state.motifPrincipal.nom} <span onclick="removeMotifPrincipal()" style="cursor:pointer;margin-left:8px">âœ•</span></div>`;
}else{
document.getElementById('mainSelectionBox').style.display='none';
}

if(state.motifsSecondaires.length>0){
document.getElementById('secondarySelectionBox').style.display='block';
document.getElementById('secondarySelectionText').innerHTML=state.motifsSecondaires.map((m,i)=>`<div class="selected-motif-item" style="margin-bottom:4px">â€¢ ${m.nom} <span onclick="removeMotifSecondaire(${i})" style="cursor:pointer;margin-left:8px;color:#ef4444">âœ•</span></div>`).join('');
}else{
document.getElementById('secondarySelectionBox').style.display='none';
}
}

function removeMotifPrincipal(){
// Retirer le style du bouton
document.querySelectorAll('.motif-btn.principal').forEach(btn=>btn.classList.remove('principal'));
const tableName = state.motifPrincipal ? state.motifPrincipal.table : null;
state.motifPrincipal=null;
document.getElementById('generateTop').disabled=true;
document.getElementById('generateBottom').disabled=true;
updateSelectionDisplay();
updateSearchResultsSelection();
// Re-render pour mettre Ã  jour les groupes
if(tableName && motifsCache[tableName]){
renderMotifsInZone(motifsCache[tableName], tableName);
}
toast('âœ— Motif principal retirÃ©');
}

function removeMotifSecondaire(index){
const removed=state.motifsSecondaires.splice(index,1)[0];
// Retirer le style du bouton
document.querySelectorAll('.motif-btn.secondaire').forEach(btn=>{
if(btn.textContent===removed.nom)btn.classList.remove('secondaire');
});
updateSelectionDisplay();
updateSearchResultsSelection();
// Re-render pour mettre Ã  jour les groupes
if(removed && removed.table && motifsCache[removed.table]){
renderMotifsInZone(motifsCache[removed.table], removed.table);
}
toast('âœ— Motif secondaire retirÃ©');
}

function selectMotif(tableName,motifId,nomMotif,btnElement){
// VÃ©rifier si ce motif est dÃ©jÃ  sÃ©lectionnÃ©
const isPrincipal=state.motifPrincipal&&state.motifPrincipal.id===motifId;
const isSecondaire=state.motifsSecondaires.some(m=>m.id===motifId);

if(isPrincipal){
// DÃ©sÃ©lectionner le motif principal
if(btnElement)btnElement.classList.remove('principal');
state.motifPrincipal=null;
document.getElementById('generateTop').disabled=true;
document.getElementById('generateBottom').disabled=true;
toast('âœ— Motif principal retirÃ©');
}else if(isSecondaire){
// DÃ©sÃ©lectionner un motif secondaire
if(btnElement)btnElement.classList.remove('secondaire');
state.motifsSecondaires=state.motifsSecondaires.filter(m=>m.id!==motifId);
toast('âœ— Motif secondaire retirÃ©');
}else{
// Nouveau motif Ã  ajouter
if(!state.motifPrincipal){
// Pas de motif principal, celui-ci devient le principal
document.querySelectorAll('.motif-btn.principal').forEach(btn=>btn.classList.remove('principal'));
state.motifPrincipal={table:tableName,id:motifId,nom:nomMotif};
if(btnElement)btnElement.classList.add('principal');
document.getElementById('generateTop').disabled=false;
document.getElementById('generateBottom').disabled=false;
toast(`â­ Motif principal: ${nomMotif}`);
}else{
// DÃ©jÃ  un principal, celui-ci devient secondaire
if(btnElement)btnElement.classList.add('secondaire');
state.motifsSecondaires.push({table:tableName,id:motifId,nom:nomMotif});
toast(`ðŸ“Ž Secondaire: ${nomMotif}`);
}
}
updateSelectionDisplay();
updateSearchResultsSelection();
// Re-render la zone des motifs si elle est ouverte (pour mettre Ã  jour les groupes)
if(currentOpenCategory && motifsCache[tableName]){
renderMotifsInZone(motifsCache[tableName], tableName);
}
}

// Charger tous les motifs pour la recherche
async function loadAllMotifsForSearch(){
state.allMotifs=[];
for(const cat of state.categories){
try{
const r=await fetch(`${API_URL}/motifs/${cat.table_name}`);
if(r.ok){
const motifs=await r.json();
motifs.forEach(m=>{
state.allMotifs.push({
id:m.id,
nom:m.nom_motif,
table:cat.table_name,
categorie:cat.nom
});
});
}
}catch(e){console.error('Erreur chargement motifs:',e);}
}
// Trier par ordre alphabÃ©tique
state.allMotifs.sort((a,b)=>a.nom.localeCompare(b.nom,'fr',{sensitivity:'base'}));
console.log('âœ… Motifs chargÃ©s pour recherche:',state.allMotifs.length);
}

// Rechercher les motifs
function searchMotifs(query){
const resultsDiv=document.getElementById('searchResults');
const searchInput=document.getElementById('motifSearch');

if(!query||query.length<2){
resultsDiv.classList.remove('active');
return;
}

const queryLower=query.toLowerCase();
const filtered=state.allMotifs.filter(m=>
m.nom.toLowerCase().includes(queryLower)||
m.categorie.toLowerCase().includes(queryLower)
).slice(0,15);

if(filtered.length===0){
resultsDiv.innerHTML='<div class="search-result-item" style="color:#94a3b8;cursor:default">Aucun motif trouvÃ©</div>';
resultsDiv.classList.add('active');
return;
}

resultsDiv.innerHTML=filtered.map(m=>{
const isPrincipal=state.motifPrincipal&&state.motifPrincipal.id===m.id;
const isSecondary=state.motifsSecondaires.some(s=>s.id===m.id);
const selectedClass=isPrincipal?'selected-principal':isSecondary?'selected-secondary':'';
return `<div class="search-result-item ${selectedClass}" onclick="selectMotifFromSearch('${m.table}','${m.id}','${m.nom.replace(/'/g,"\\'")}','${m.categorie}')">
<div class="search-result-motif">${m.nom}${isPrincipal?' â­':isSecondary?' âœ“':''}</div>
<div class="search-result-category">${m.categorie}</div>
</div>`;
}).join('');
resultsDiv.classList.add('active');
}

// GÃ©rer la touche EntrÃ©e dans la recherche de motifs
let justSelectedFromSearch=false; // Flag pour bloquer le listener global

function handleMotifSearchKeydown(event){
if(event.key==='Enter'){
event.preventDefault();
event.stopPropagation();
const resultsDiv=document.getElementById('searchResults');
const searchInput=document.getElementById('motifSearch');
if(resultsDiv&&resultsDiv.classList.contains('active')){
// Compter les rÃ©sultats cliquables (pas le message "Aucun motif trouvÃ©")
const items=resultsDiv.querySelectorAll('.search-result-item[onclick]');
if(items.length===1){
// VÃ©rifier si ce motif est dÃ©jÃ  sÃ©lectionnÃ©
const isAlreadySelected=items[0].classList.contains('selected-principal')||items[0].classList.contains('selected-secondary');
if(isAlreadySelected){
// Motif dÃ©jÃ  sÃ©lectionnÃ© -> quitter la barre de recherche
justSelectedFromSearch=true;
searchInput.blur();
resultsDiv.classList.remove('active');
setTimeout(()=>{justSelectedFromSearch=false;},100);
}else{
// Un seul rÃ©sultat non sÃ©lectionnÃ© -> le sÃ©lectionner puis quitter
justSelectedFromSearch=true;
items[0].click();
searchInput.blur();
resultsDiv.classList.remove('active');
setTimeout(()=>{justSelectedFromSearch=false;},100);
}
}
}
}
}

// SÃ©lectionner un motif depuis la recherche
function selectMotifFromSearch(tableName,motifId,nomMotif,categorie){
// Si pas de motif principal, c'est le principal
if(!state.motifPrincipal){
state.motifPrincipal={table:tableName,id:motifId,nom:nomMotif};
document.getElementById('generateTop').disabled=false;
document.getElementById('generateBottom').disabled=false;
toast(`â­ Motif principal: ${nomMotif}`);
}else if(state.motifPrincipal.id===motifId){
// Clic sur le principal dÃ©jÃ  sÃ©lectionnÃ© -> le dÃ©sÃ©lectionner
state.motifPrincipal=null;
document.getElementById('generateTop').disabled=true;
document.getElementById('generateBottom').disabled=true;
toast('âœ— Motif principal retirÃ©');
}else{
// VÃ©rifier si c'est dÃ©jÃ  un secondaire
const idx=state.motifsSecondaires.findIndex(m=>m.id===motifId);
if(idx>=0){
state.motifsSecondaires.splice(idx,1);
toast(`âœ— RetirÃ©: ${nomMotif}`);
}else{
state.motifsSecondaires.push({table:tableName,id:motifId,nom:nomMotif});
toast(`âœ“ Secondaire: ${nomMotif}`);
}
}
updateSelectionDisplay();
updateSearchResultsSelection();
updateMotifButtonsSelection();
}

// Mettre Ã  jour l'affichage des sÃ©lections dans les rÃ©sultats de recherche
function updateSearchResultsSelection(){
const query=document.getElementById('motifSearch').value;
if(query&&query.length>=2){
searchMotifs(query);
}
}

// Mettre Ã  jour les boutons dans les listes de catÃ©gories
function updateMotifButtonsSelection(){
document.querySelectorAll('.motif-btn').forEach(btn=>{
btn.classList.remove('principal','secondaire');
});
if(state.motifPrincipal){
const principalBtns=document.querySelectorAll(`.motif-btn[onclick*="'${state.motifPrincipal.id}'"]`);
principalBtns.forEach(btn=>btn.classList.add('principal'));
}
state.motifsSecondaires.forEach(m=>{
const secBtns=document.querySelectorAll(`.motif-btn[onclick*="'${m.id}'"]`);
secBtns.forEach(btn=>btn.classList.add('secondaire'));
});
}

function showModeSelection(){
if(!state.motifPrincipal){
toast('âš ï¸ SÃ©lectionnez un motif principal','error');
return;
}
document.getElementById('modeSelectionModal').classList.add('active');
}

// Ouvrir le mÃ©mo du motif principal
async function openMemo(){
closeModal('modeSelectionModal');
if(!state.motifPrincipal){
toast('âš ï¸ SÃ©lectionnez un motif principal','error');
return;
}

// Collecter tous les motifs (principal + secondaires)
const tousLesMotifs=[
{table:state.motifPrincipal.table,id:state.motifPrincipal.id,nom:state.motifPrincipal.nom},
...state.motifsSecondaires.map(m=>({table:m.table,id:m.id,nom:m.nom}))
];

toast('â³ Chargement des mÃ©mos...');

// RÃ©cupÃ©rer tous les mÃ©mos en parallÃ¨le
const memosPromises=tousLesMotifs.map(async(motif)=>{
try{
const r=await fetch(`${API_URL}/memo/${motif.table}/${motif.id}`);
if(!r.ok)throw new Error('MÃ©mo non disponible');
const data=await r.json();
return {nom:motif.nom,memo:data.memo||'Aucun mÃ©mo disponible pour ce motif.'};
}catch(e){
return {nom:motif.nom,memo:'Aucun mÃ©mo disponible pour ce motif.\n\nLe mÃ©mo sera ajoutÃ© prochainement.'};
}
});

const memos=await Promise.all(memosPromises);

// GÃ©nÃ©rer le HTML selon le nombre de mÃ©mos
if(memos.length===1){
document.getElementById('memoMotifName').textContent=memos[0].nom;
document.getElementById('memoContent').innerHTML=`<div class="memo-single">${memos[0].memo}</div>`;
}else{
document.getElementById('memoMotifName').textContent=`${memos.length} motifs`;
const gridCols=memos.length<=2?memos.length:memos.length<=4?2:3;
document.getElementById('memoContent').innerHTML=`
<div class="memo-grid" style="grid-template-columns:repeat(${gridCols},1fr)">
${memos.map((m,i)=>`
<div class="memo-column ${i===0?'memo-principal':'memo-secondaire'}">
<div class="memo-column-header">${i===0?'â­':''} ${escapeHtml(m.nom)}</div>
<div class="memo-column-content">${m.memo}</div>
</div>
`).join('')}
</div>`;
}

document.getElementById('memoModal').classList.add('active');

// Rendre tous les liens cliquables (ouvrent dans un nouvel onglet)
document.querySelectorAll('#memoContent a').forEach(link=>{
link.setAttribute('target','_blank');
link.setAttribute('rel','noopener noreferrer');
});

// ExÃ©cuter les scripts contenus dans le HTML du mÃ©mo
const scripts=document.querySelectorAll('#memoContent script');
scripts.forEach(oldScript=>{
const newScript=document.createElement('script');
if(oldScript.src){
newScript.src=oldScript.src;
}else{
newScript.textContent=oldScript.textContent;
}
oldScript.parentNode.replaceChild(newScript,oldScript);
});

// Initialiser les accordÃ©ons prÃ©sents dans le mÃ©mo
initMemoAccordions();
}

// Fonction pour initialiser les accordÃ©ons dans les mÃ©mos
function initMemoAccordions(){
const accordionHeaders=document.querySelectorAll('#memoContent .accordion-header');
accordionHeaders.forEach(header=>{
// Supprimer les anciens event listeners en clonant l'Ã©lÃ©ment
const newHeader=header.cloneNode(true);
header.parentNode.replaceChild(newHeader,header);
// Ajouter le nouvel event listener
newHeader.addEventListener('click',function(e){
e.preventDefault();
e.stopPropagation();
const content=this.nextElementSibling;
const isActive=this.classList.contains('active');
// Fermer tous les accordÃ©ons du mÃªme niveau
const parent=this.closest('.accordion-item')?.parentNode||document.getElementById('memoContent');
parent.querySelectorAll('.accordion-header').forEach(h=>{
h.classList.remove('active');
if(h.nextElementSibling)h.nextElementSibling.classList.remove('active');
});
// Ouvrir celui cliquÃ© si il Ã©tait fermÃ©
if(!isActive){
this.classList.add('active');
if(content)content.classList.add('active');
}
});
});
}

// Ouvrir les mÃ©mos depuis le bouton flottant (sans affecter le contenu actuel)
function openMemoFromFloating(){
if(!state.motifPrincipal){
toast('âš ï¸ Aucun motif sÃ©lectionnÃ©','error');
return;
}
openMemo();
}

function escapeHtml(text){
const div=document.createElement('div');
div.textContent=text;
return div.innerHTML;
}

// Copier le contenu du mÃ©mo
function copyMemo(){
const memoContent=document.getElementById('memoContent').textContent;
copyText(memoContent);
}

async function selectMode(mode){
state.currentMode=mode;
closeModal('modeSelectionModal');
await generateConclusion(mode);
}

async function generateConclusion(mode){
if(!state.motifPrincipal){
toast('âš ï¸ SÃ©lectionnez un motif principal','error');
return;
}

toast('â³ GÃ©nÃ©ration...');

try{
const r=await fetch(`${API_URL}/fusion`,{
method:'POST',
headers:{'Content-Type':'application/json'},
body:JSON.stringify({
table_principale:state.motifPrincipal.table,
motif_principal_id:state.motifPrincipal.id,
motifs_secondaires:state.motifsSecondaires,
mode:mode
})
});

if(!r.ok){
const errorText=await r.text();
console.error('Erreur API:',errorText);
throw new Error('Erreur API');
}

state.conclusion=await r.json();
console.log('Conclusion reÃ§ue:',state.conclusion);
renderConclusion(mode);
toast('âœ… GÃ©nÃ©rÃ© !');
document.getElementById('floatingActions').style.display='flex';
}catch(e){
toast('âŒ Erreur: '+e.message,'error');
console.error('Erreur complÃ¨te:',e);
}
}

function renderBullesHtml(bulles){
if(!bulles||!Array.isArray(bulles)||bulles.length===0)return'';
let html='';
const seenTitles=new Set(); // DÃ©duplication locale au module
bulles.forEach((bulle,idx)=>{
if(bulle&&bulle.titre){
// VÃ©rifier si une bulle avec le mÃªme titre existe dÃ©jÃ  dans CE module
if(!seenTitles.has(bulle.titre)){
seenTitles.add(bulle.titre);
const globalIdx=state.currentBulles.length;
state.currentBulles.push(bulle);
html+=`<button class="bulle-btn" onclick="showBulleByIndex(${globalIdx})" data-title="${bulle.titre.replace(/"/g,'&quot;')}">ðŸ’¡</button>`;
}
// Si elle existe dÃ©jÃ  dans ce module, on ne l'ajoute pas
}
});
return html?`<div class="bulles-container">${html}</div>`:'';
}

// Version HDM des bulles (mÃªme taille que les boutons alternatifs HDM)
function renderBullesHtmlHDM(bulles){
if(!bulles||!Array.isArray(bulles)||bulles.length===0)return'';
let html='';
const seenTitles=new Set();
bulles.forEach((bulle,idx)=>{
if(bulle&&bulle.titre){
if(!seenTitles.has(bulle.titre)){
seenTitles.add(bulle.titre);
const globalIdx=state.currentBulles.length;
state.currentBulles.push(bulle);
html+=`<button class="bulle-btn-hdm" onclick="showBulleByIndex(${globalIdx})" data-title="${bulle.titre.replace(/"/g,'&quot;')}">ðŸ’¡</button>`;
}
}
});
return html;
}

function renderConclusion(mode){
if(mode==='examen_conclusion'){
renderSplitView();
}else{
renderSingleView(mode);
}
}

function renderSingleView(mode){
let html='';
state.currentBulles=[];

if(!state.conclusion||!state.conclusion.modules){
toast('âŒ DonnÃ©es invalides','error');
return;
}

let modulesToRender=state.conclusion.modules;

// Pour le mode conclusion, s'assurer que tous les modules standards sont prÃ©sents
if(mode==='conclusion'){
const standardConclusionModules=[
{type:'diagnostic',icon:'ðŸ”',titre:'Diagnostic'},
{type:'signes_gravite',icon:'âš ï¸',titre:'Signes de gravitÃ©'},
{type:'soins_urgences',icon:'ðŸ¥',titre:'Soins aux urgences'},
{type:'conduite_tenir',icon:'ðŸ“‹',titre:'Conduite Ã  tenir'},
{type:'conseils',icon:'ðŸ’¡',titre:'Conseils'},
{type:'suivi',icon:'ðŸ”„',titre:'Suivi'},
{type:'consignes_reconsultation',icon:'âš ï¸',titre:'Consignes de reconsultation'}
];

modulesToRender=modulesToRender.filter(m=>!m.type.startsWith('examen_')&&m.type!=='hdm');

standardConclusionModules.forEach(stdModule=>{
if(!modulesToRender.find(m=>m.type===stdModule.type)){
modulesToRender.push({
type:stdModule.type,
icon:stdModule.icon,
titre:stdModule.titre,
lignes:[],
bulles:[]
});
}
});

modulesToRender.sort((a,b)=>{
const orderA=standardConclusionModules.findIndex(s=>s.type===a.type);
const orderB=standardConclusionModules.findIndex(s=>s.type===b.type);
return (orderA===-1?999:orderA)-(orderB===-1?999:orderB);
});
}

modulesToRender.forEach((module,moduleIdx)=>{
let content='';

if(module.type==='conduite_tenir'){
// Extraire le texte de chaque ligne (nouvelle structure avec elements)
state.conduiteLines=(module.lignes||[]).map((ligne,i)=>{
let text='';
if(ligne.elements&&Array.isArray(ligne.elements)){
text=ligne.elements.map(e=>e.texte||'').join('');
}else{
text=ligne.texte||'';
}
return{
id:Date.now()+i,
text:text,
proposition:ligne.proposition,
alternative:ligne.alternative,
commentaire:ligne.commentaire,
deletable:ligne.deletable
};
});
content=renderConduiteATenir();
}else if(module.type==='hdm'){
// HDM avec 4 sections
content=renderHDM(module);
}else{
// Chaque ligne a maintenant ses Ã©lÃ©ments groupÃ©s
content=(module.lignes||[]).map(ligne=>renderLigneComplete(ligne)).filter(h=>h).join('');
}

const bullesHtml=renderBullesHtml(module.bulles);

const copyBtn=mode==='examen'||module.type==='hdm'||module.type.startsWith('examen_')?
`<button class="module-copy-btn" onclick="copyModule('${module.type}')" title="Copier">ðŸ“‹</button>`:'';
// Ne pas afficher le bouton d'alternatives sur le module HDM global (les boutons sont sur chaque section)
const altBtn=module.type==='hdm'?'':`<button class="module-alt-btn" onclick="openAlternativesModal('${module.type}')" title="Alternatives" data-module-alt="${module.type}">ðŸ”„</button>`;
const deleteBtn=`<button class="module-delete-btn" onclick="deleteModule(this)" title="Supprimer">âœ•</button>`;

const isEditable=module.type!=='conduite_tenir';

html+=`
<div class="module" data-module-type="${module.type}">
<div class="module-header">
<span class="module-title"><span class="icon">${module.icon||''}</span> ${module.titre||''}</span>
<div class="module-buttons">
${altBtn}
${copyBtn}
${deleteBtn}
</div>
${bullesHtml}
</div>
<div class="module-content" data-module-content="${module.type}" contenteditable="${isEditable}">
${content}
</div>
${module.type==='conduite_tenir'?renderOrdonnancesSection():''}
</div>
`;
});

// Ajouter le module de note pour le mode examen
if(mode==='examen'){
html+=`
<div class="module module-note" data-module-type="note_examen">
<div class="module-header">
<span class="module-title"><span class="icon">ðŸ“</span> Ajouter une note ou un examen</span>
<div class="module-buttons">
<label class="copy-checkbox" title="Inclure dans la copie de l'examen">
<input type="checkbox" id="includeNoteCheckbox" checked>
<span>Copier avec l'examen</span>
</label>
</div>
</div>
<div class="module-content module-note-content" data-module-content="note_examen" contenteditable="true" placeholder="Saisissez ici une note ou un examen complÃ©mentaire..."></div>
</div>
`;
}

if(state.conclusion.codes_cim&&state.conclusion.codes_cim.length>0){
html+=`
<div class="codes-section">
<h3>ðŸ—‚ï¸ Suggestion CIM-10</h3>
${state.conclusion.codes_cim.map(code=>`
<div class="code-item"><strong>${code.code||''}</strong> : ${code.libelle||''}</div>
`).join('')}
</div>
`;
}

document.getElementById('resultContainer').innerHTML=html;
// Charger les alternatives pour le motif principal
loadAlternatives();
}

function renderHDM(module){
if(!module.sections||!Array.isArray(module.sections))return'';

// Mapping des titres vers les types de modules pour les alternatives
const sectionTypeMapping={
'Histoire de la maladie : Motif':'hdm_motif',
'Histoire de la maladie : Signes associÃ©s':'hdm_signes_associes',
'Histoire de la maladie : Contexte':'hdm_contexte',
'Histoire de la maladie : Soins antÃ©rieurs':'hdm_soins_anterieurs'
};

return module.sections.map(section=>{
// Ne pas afficher si pas de lignes
if(!section.lignes||section.lignes.length===0)return'';

// Chaque ligne a maintenant ses Ã©lÃ©ments groupÃ©s
const lignesHtml=section.lignes.map(ligne=>renderLigneComplete(ligne)).filter(h=>h).join('');

// Ne pas afficher la section si pas de contenu
if(!lignesHtml)return'';

// DÃ©terminer le type de module pour cette section
const sectionType=sectionTypeMapping[section.titre]||'';
const altBtn=sectionType?`<button class="module-alt-btn hdm-section-alt" onclick="openAlternativesModal('${sectionType}')" title="Alternatives" data-module-alt="${sectionType}">ðŸ”„</button>`:'';

// Rendre les bulles de la section si elles existent (style HDM)
const bullesHtml=renderBullesHtmlHDM(section.bulles);

return `
<div class="hdm-section" data-section-type="${sectionType}">
<div class="hdm-section-header">
<div class="hdm-section-title">${section.titre||''}</div>
<div class="hdm-section-buttons">
${bullesHtml}
${altBtn}
</div>
</div>
<div class="hdm-section-content" data-module-content="${sectionType}">
${lignesHtml}
</div>
</div>
`;
}).filter(s=>s).join('');
}

function renderSplitView(){
state.currentBulles=[];

if(!state.conclusion||!state.conclusion.modules){
toast('âŒ DonnÃ©es invalides','error');
return;
}

const examenModules=state.conclusion.modules.filter(m=>
m.type==='hdm'||m.type.startsWith('examen_')
);
let conclusionModules=state.conclusion.modules.filter(m=>
!m.type.startsWith('examen_')&&m.type!=='hdm'
);

// Liste des modules de conclusion standards avec leurs icÃ´nes et titres
const standardConclusionModules=[
{type:'diagnostic',icon:'ðŸ”',titre:'Diagnostic'},
{type:'signes_gravite',icon:'âš ï¸',titre:'Signes de gravitÃ©'},
{type:'soins_urgences',icon:'ðŸ¥',titre:'Soins aux urgences'},
{type:'conduite_tenir',icon:'ðŸ“‹',titre:'Conduite Ã  tenir'},
{type:'conseils',icon:'ðŸ’¡',titre:'Conseils'},
{type:'suivi',icon:'ðŸ”„',titre:'Suivi'},
{type:'consignes_reconsultation',icon:'âš ï¸',titre:'Consignes de reconsultation'}
];

// S'assurer que tous les modules standards sont prÃ©sents
standardConclusionModules.forEach(stdModule=>{
if(!conclusionModules.find(m=>m.type===stdModule.type)){
conclusionModules.push({
type:stdModule.type,
icon:stdModule.icon,
titre:stdModule.titre,
lignes:[],
bulles:[]
});
}
});

// Trier les modules dans l'ordre standard
conclusionModules.sort((a,b)=>{
const orderA=standardConclusionModules.findIndex(s=>s.type===a.type);
const orderB=standardConclusionModules.findIndex(s=>s.type===b.type);
return (orderA===-1?999:orderA)-(orderB===-1?999:orderB);
});

let examenHtml='';
examenModules.forEach(module=>{
let content='';
if(module.type==='hdm'){
content=renderHDM(module);
}else{
// Chaque ligne a maintenant ses Ã©lÃ©ments groupÃ©s
content=(module.lignes||[]).map(ligne=>renderLigneComplete(ligne)).filter(h=>h).join('');
}

const bullesHtml=renderBullesHtml(module.bulles);
const copyBtn=`<button class="module-copy-btn" onclick="copyModule('${module.type}')" title="Copier">ðŸ“‹</button>`;
// Ne pas afficher le bouton d'alternatives sur le module HDM global (les boutons sont sur chaque section)
const altBtn=module.type==='hdm'?'':`<button class="module-alt-btn" onclick="openAlternativesModal('${module.type}')" title="Alternatives" data-module-alt="${module.type}">ðŸ”„</button>`;
const deleteBtn=`<button class="module-delete-btn" onclick="deleteModule(this)" title="Supprimer">âœ•</button>`;

const isEditable=true;

examenHtml+=`
<div class="module" data-module-type="${module.type}">
<div class="module-header">
<span class="module-title"><span class="icon">${module.icon||''}</span> ${module.titre||''}</span>
<div class="module-buttons">
${altBtn}
${copyBtn}
${deleteBtn}
</div>
${bullesHtml}
</div>
<div class="module-content" data-module-content="${module.type}" contenteditable="${isEditable}">
${content}
</div>
</div>
`;
});

// Ajouter le module de note/examen supplÃ©mentaire
examenHtml+=`
<div class="module module-note" data-module-type="note_examen">
<div class="module-header">
<span class="module-title"><span class="icon">ðŸ“</span> Ajouter une note ou un examen</span>
<div class="module-buttons">
<label class="copy-checkbox" title="Inclure dans la copie de l'examen">
<input type="checkbox" id="includeNoteCheckbox" checked>
<span>Copier avec l'examen</span>
</label>
</div>
</div>
<div class="module-content module-note-content" data-module-content="note_examen" contenteditable="true" placeholder="Saisissez ici une note ou un examen complÃ©mentaire..."></div>
</div>
`;

let conclusionHtml='';
conclusionModules.forEach(module=>{
let content='';

if(module.type==='conduite_tenir'){
// Extraire le texte de chaque ligne (nouvelle structure avec elements)
state.conduiteLines=(module.lignes||[]).map((ligne,i)=>{
let text='';
if(ligne.elements&&Array.isArray(ligne.elements)){
text=ligne.elements.map(e=>e.texte||'').join('');
}else{
text=ligne.texte||'';
}
return{
id:Date.now()+i,
text:text,
proposition:ligne.proposition,
alternative:ligne.alternative,
commentaire:ligne.commentaire,
deletable:ligne.deletable
};
});
content=renderConduiteATenir();
}else{
// Chaque ligne a maintenant ses Ã©lÃ©ments groupÃ©s
content=(module.lignes||[]).map(ligne=>renderLigneComplete(ligne)).filter(h=>h).join('');
}

const bullesHtml=renderBullesHtml(module.bulles);
const altBtn=`<button class="module-alt-btn" onclick="openAlternativesModal('${module.type}')" title="Alternatives" data-module-alt="${module.type}">ðŸ”„</button>`;
const deleteBtn=`<button class="module-delete-btn" onclick="deleteModule(this)" title="Supprimer">âœ•</button>`;

conclusionHtml+=`
<div class="module" data-module-type="${module.type}">
<div class="module-header">
<span class="module-title"><span class="icon">${module.icon||''}</span> ${module.titre||''}</span>
<div class="module-buttons">
${altBtn}
${deleteBtn}
</div>
${bullesHtml}
</div>
<div class="module-content" data-module-content="${module.type}" contenteditable="${module.type!=='conduite_tenir'}">
${content}
</div>
${module.type==='conduite_tenir'?renderOrdonnancesSection():''}
</div>
`;
});

if(state.conclusion.codes_cim&&state.conclusion.codes_cim.length>0){
conclusionHtml+=`
<div class="codes-section">
<h3>ðŸ—‚ï¸ Suggestion CIM-10</h3>
${state.conclusion.codes_cim.map(code=>`
<div class="code-item"><strong>${code.code||''}</strong> : ${code.libelle||''}</div>
`).join('')}
</div>
`;
}

const splitHtml=`
<div class="split-view">
<div class="split-panel split-panel-examen">
<div class="split-header">
<span class="split-title">ðŸ” EXAMEN TYPE</span>
<div class="split-header-actions">
<button class="modify-modules-btn" onclick="openModifyAllModulesModal('examen')" title="Ajouter ou modifier les modules">ðŸ”„ Modifier les modules</button>
<button class="copy-btn" onclick="copyExamen()" title="Copier l'examen">ðŸ“‹</button>
</div>
</div>
<div id="examenContent">${examenHtml}</div>
</div>
<div class="split-panel split-panel-conclusion">
<div class="split-header">
<span class="split-title">ðŸŽ‰ CONCLUSION TYPE</span>
<div class="split-header-actions">
<button class="modify-modules-btn" onclick="openModifyAllModulesModal('conclusion')" title="Ajouter ou modifier les modules">ðŸ”„ Modifier les modules</button>
<button class="copy-btn" onclick="copyConclusion()" title="Copier la conclusion">ðŸ“‹</button>
</div>
</div>
<div id="conclusionContent">${conclusionHtml}</div>
</div>
</div>
`;

document.getElementById('resultContainer').innerHTML=splitHtml;
// Charger les alternatives pour le motif principal
loadAlternatives();
}

function renderLigne(ligne){
if(!ligne)return'';

let texte=ligne.texte||'';

// GÃ©rer les diffÃ©rents types de marqueurs INLINE
if(ligne.commentaire){
if(!texte)return'';
return `<span class="comment">${parseOrdonnanceText(texte)}</span>`;
}

if(ligne.deletable){
if(!texte)return'';
const id='del-'+Date.now()+Math.random();
return `<span class="deletable" id="${id}" onclick="deleteText('${id}')">${parseOrdonnanceText(texte)}</span>`;
}

// XXXX avec propositions venant du backend
if(texte==='XXXX'){
const props=ligne.proposition&&ligne.proposition.suggestions?ligne.proposition.suggestions:[];
const propsEncoded=encodeURIComponent(JSON.stringify(props));
return `<span class="xxxx" data-props="${propsEncoded}" onclick="openXXXXModal(this)">XXXX</span>`;
}

if(ligne.alternative&&ligne.alternative.alternatives&&ligne.alternative.alternatives.length>0){
const alts=ligne.alternative.alternatives;
if(alts.length<=1){
return parseOrdonnanceText(alts[0]||'');
}
const altsJson=JSON.stringify(alts).replace(/'/g,'&#39;');
return `<span class="alt-container"><span class="alt-text">${parseOrdonnanceText(alts[0])}</span><span class="alt-trigger" data-alts='${altsJson}' onclick="openAltDropdown(event, this)"></span></span>`;
}

// Parser le texte brut s'il contient des marqueurs @@
if(texte.includes('@@')){
return parseTextWithMarkers(texte);
}

// Filtrer les rÃ©sidus orphelins PROPOSITION : ... FINI (ne devrait plus arriver avec le backend corrigÃ©)
if(/PROPOSITION\s*:/i.test(texte)&&/FINI/i.test(texte)){
return'';
}

// Texte normal avec support markdown et sauts de ligne
if(!texte)return'';
return parseOrdonnanceText(texte);
}

// Parser le texte des ordonnances avec support HTML, JavaScript, markdown et sauts de ligne
function parseOrdonnanceText(text){
if(!text)return'';

// Supprimer les hints {{}} du texte affichÃ©
text=removeHintText(text);

// Convertir les \n littÃ©raux en vrais sauts de ligne
text=text.replace(/\\n/g,'\n');

// Si le texte contient du HTML (balises), le retourner tel quel
if(/<[a-z][\s\S]*>/i.test(text)){
// C'est du HTML, on le retourne directement avec juste les sauts de ligne convertis
return text.replace(/\n/g,'<br>');
}

// Si pas de formatage spÃ©cial, retourner le texte avec juste les sauts de ligne
if(!text.includes('**')&&!text.includes('*')&&!text.includes('_')&&!text.includes('`')&&!text.includes('\n')){
return text;
}

// Appliquer le markdown de base
let html=text
// Gras et italique
.replace(/\*\*\*(.+?)\*\*\*/g,'<strong><em>$1</em></strong>')
.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
.replace(/\*(.+?)\*/g,'<em>$1</em>')
.replace(/___(.+?)___/g,'<strong><em>$1</em></strong>')
.replace(/__(.+?)__/g,'<strong>$1</strong>')
.replace(/_(.+?)_/g,'<em>$1</em>')
// Code inline
.replace(/`([^`]+)`/g,'<code style="background:#e2e8f0;padding:1px 4px;border-radius:3px;font-family:monospace;font-size:12px">$1</code>')
// Sauts de ligne
.replace(/\n/g,'<br>');

return html;
}

// ExÃ©cuter les scripts dans un conteneur aprÃ¨s injection HTML
function executeScriptsIn(container){
if(!container)return;
const scripts=container.querySelectorAll('script');
scripts.forEach(oldScript=>{
const newScript=document.createElement('script');
Array.from(oldScript.attributes).forEach(attr=>{
newScript.setAttribute(attr.name,attr.value);
});
newScript.textContent=oldScript.textContent;
oldScript.parentNode.replaceChild(newScript,oldScript);
});
}

// Fonction simple pour remplacer XXXX par un span cliquable
function renderXXXXSimple(text){
if(!text)return text;

// Les hints {{}} seront supprimÃ©s du texte affichÃ© final mais gardÃ©s dans les propositions
if(!text.includes('XXXX')){
// Pas de XXXX, juste supprimer les hints du texte
return removeHintText(text);
}

// Utiliser des placeholders pour Ã©viter le double remplacement
const placeholderText='\u0000TXT\u0000';
const placeholderWithProps='\u0000PROPS\u0000';
let propsStore=[];

// Format 1: XXXX %% prop1 / prop2 %% - capturer tout entre %% et %% (GARDER les hints dans les props)
text=text.replace(/XXXX\s*%%([\s\S]*?)%%/g, function(match, propsStr){
const props=propsStr.split('/').map(p=>p.trim()).filter(p=>p);
// Utiliser encodeURIComponent pour Ã©viter les problÃ¨mes de caractÃ¨res spÃ©ciaux
const propsEncoded=encodeURIComponent(JSON.stringify(props));
propsStore.push(propsEncoded);
return placeholderWithProps+(propsStore.length-1)+placeholderWithProps;
});

// Format 2: XXXX PROPOSITION : prop1 ; prop2 FINI (sÃ©parateur ; uniquement) (GARDER les hints dans les props)
text=text.replace(/XXXX\s+PROPOSITION\s*:\s*(.+?)\s+FINI/gi, function(match, propsStr){
// Splitter par ; en ignorant ceux Ã  l'intÃ©rieur de %% ... %%
const props=splitIgnoringPercent(propsStr);
const propsEncoded=encodeURIComponent(JSON.stringify(props));
propsStore.push(propsEncoded);
return placeholderWithProps+(propsStore.length-1)+placeholderWithProps;
});

// XXXX simples (sans propositions)
text=text.replace(/XXXX/g,placeholderText);

// Supprimer les hints du texte affichÃ© (pas des propositions qui sont dans propsStore)
text=removeHintText(text);

// Restaurer les XXXX simples
text=text.split(placeholderText).join('<span class="xxxx" onclick="openXXXXModal(this)">XXXX</span>');

// Restaurer les XXXX avec props
for(let i=0;i<propsStore.length;i++){
text=text.replace(placeholderWithProps+i+placeholderWithProps,`<span class="xxxx" data-props="${propsStore[i]}" onclick="openXXXXModal(this)">XXXX</span>`);
}

return text;
}

// Fonction pour formater le texte hint {{texte}} en span gris italique
function formatHintText(text){
if(!text)return text;
return text.replace(/\{\{([^}]+)\}\}/g,'<span class="hint-text">$1</span>');
}

// Fonction pour supprimer le texte hint {{texte}} de la valeur
function removeHintText(text){
if(!text)return text;
return text.replace(/\s*\{\{[^}]+\}\}/g,'').trim();
}

// Fonction pour rÃ©cupÃ©rer le texte d'un Ã©lÃ©ment sans les hints
function getCleanTextContent(element){
if(!element)return'';
const clone=element.cloneNode(true);
clone.querySelectorAll('.hint-text').forEach(span=>span.remove());
return clone.textContent.trim();
}

// Fonction pour parser les XXXX avec propositions inline %% prop1 / prop2 %% dans les chips
function parseXXXXForChips(text){
if(!text||!text.includes('XXXX'))return text;
// Utiliser des placeholders pour Ã©viter le double remplacement
const marker='\u0000CHIP\u0000';
const funcMarker='\u0000FUNC\u0000';
// Remplacer d'abord le nom de fonction pour le protÃ©ger
const funcName='open'+funcMarker+'ModalForChip';
// Format: XXXX %% prop1 / prop2 / prop3 %% - capturer tout entre %% et %%
text=text.replace(/XXXX\s*%%([\s\S]*?)%%/g,(match,propsStr)=>{
const props=propsStr.split('/').map(p=>p.trim()).filter(p=>p);
// Utiliser encodeURIComponent pour Ã©viter les problÃ¨mes de caractÃ¨res spÃ©ciaux
const propsEncoded=encodeURIComponent(JSON.stringify(props));
return `<span class="xxxx-in-chip" data-props="${propsEncoded}" onclick="event.stopPropagation();${funcName}(this)">${marker}</span>`;
});
// Remplacer les XXXX simples
text=text.replace(/XXXX/g,`<span class="xxxx-in-chip" onclick="event.stopPropagation();${funcName}(this)">${marker}</span>`);
// Restaurer les placeholders
return text.split(marker).join('XXXX').split(funcMarker).join('XXXX');
}

// Version pour afficher les chips dans popup 1 (texte propre + XXXX cliquable)
function parseXXXXForChips2(text){
if(!text)return text;

// Si le texte contient XXXX %% ... %%, afficher juste le texte avant + XXXX cliquable
// Exemple: "A la bite XXXX %% options %%" -> "A la bite XXXX" (avec XXXX cliquable)
if(text.includes('%%')){
// Extraire le texte avant le premier %%
const beforePercent=text.split('%%')[0].trim();
// VÃ©rifier si Ã§a contient XXXX
if(beforePercent.includes('XXXX')){
// Remplacer XXXX par un span cliquable
return beforePercent.replace(/XXXX/g,'<span class="xxxx-in-chip" onclick="event.stopPropagation();openXXXXPopup2ForProp(this)">XXXX</span>');
}
return beforePercent;
}

// Si pas de %%, juste remplacer les XXXX par des spans cliquables
if(text.includes('XXXX')){
return text.replace(/XXXX/g,'<span class="xxxx-in-chip" onclick="event.stopPropagation();openXXXXPopup2ForProp(this)">XXXX</span>');
}

return text;
}

// Fonction pour splitter par ; en ignorant ceux Ã  l'intÃ©rieur de %% ... %%
function splitIgnoringPercent(text){
if(!text)return[];
const result=[];
let current='';
let insidePercent=false;
for(let i=0;i<text.length;i++){
const char=text[i];
const nextChar=text[i+1]||'';
// DÃ©tecter entrÃ©e/sortie de %%
if(char==='%'&&nextChar==='%'){
insidePercent=!insidePercent;
current+=char;
i++;// Sauter le deuxiÃ¨me %
current+='%';
continue;
}
// Si on trouve un ; hors de %%
if(char===';'&&!insidePercent){
if(current.trim())result.push(current.trim());
current='';
}else{
current+=char;
}
}
if(current.trim())result.push(current.trim());
return result;
}

// Fonction pour splitter les alternatives en ignorant les / Ã  l'intÃ©rieur de %% %%
function splitAlternatives(text){
if(!text)return[];
const result=[];
let current='';
let insidePercent=false;
for(let i=0;i<text.length;i++){
const char=text[i];
const nextChar=text[i+1]||'';
// DÃ©tecter entrÃ©e/sortie de %%
if(char==='%'&&nextChar==='%'){
insidePercent=!insidePercent;
current+=char;
i++;// Sauter le deuxiÃ¨me %
current+='%';
continue;
}
// Si on trouve un / hors de %%
if(char==='/'&&!insidePercent){
if(current.trim())result.push(current.trim());
current='';
}else{
current+=char;
}
}
if(current.trim())result.push(current.trim());
return result;
}

// Fonction pour parser le texte avec marqueurs @@ et /
function parseTextWithMarkers(texte){
// Format: "texte avant @@ alt1 / alt2 / alt3 @@ texte aprÃ¨s"
// Le @@ dÃ©limite la zone d'alternatives

// Chercher le pattern @@ ... @@
const regex=/@@\s*(.+?)\s*@@/g;
let result='';
let lastIndex=0;
let match;

while((match=regex.exec(texte))!==null){
// Ajouter le texte avant le @@
let beforeText=texte.substring(lastIndex,match.index);
result+=renderXXXXSimple(beforeText);

// Parser les alternatives entre @@ (en protÃ©geant les / dans %% %%)
const altText=match[1];
const alternatives=splitAlternatives(altText);

if(alternatives.length<=1){
// Pas d'alternatives, juste du texte
let displayText=alternatives[0]||altText;
result+=renderXXXXSimple(displayText);
}else{
// Plusieurs alternatives: afficher la premiÃ¨re avec triangle rouge
const firstOption=alternatives[0];
const altsJson=JSON.stringify(alternatives).replace(/'/g,'&#39;');
let displayText=renderXXXXSimple(firstOption);
result+=`<span class="alt-container"><span class="alt-text">${displayText}</span><span class="alt-trigger" data-alts='${altsJson}' onclick="openAltDropdown(event, this)"></span></span>`;
}

lastIndex=regex.lastIndex;
}

// Ajouter le texte aprÃ¨s le dernier @@
let afterText=texte.substring(lastIndex);
result+=renderXXXXSimple(afterText);

return result;
}

// Fonction pour fusionner les Ã©lÃ©ments XXXX avec leur PROPOSITION : ... FINI suivant
function fusionnerXXXXProposition(elements){
if(!elements||elements.length<2)return elements||[];
const result=[];
let i=0;
while(i<elements.length){
const elem=elements[i];
const txt=(elem.texte||'').trim();
// VÃ©rifie si cet Ã©lÃ©ment finit par XXXX ou est juste XXXX
if(/XXXX\s*$/.test(txt)){
// Cherche si le suivant est une PROPOSITION : ... FINI
if(i+1<elements.length){
const nextTxt=(elements[i+1].texte||'').trim();
if(/^PROPOSITION\s*:/i.test(nextTxt)&&/FINI\s*$/i.test(nextTxt)){
// Fusionner les deux
result.push({...elem,texte:elem.texte+' '+elements[i+1].texte});
i+=2;
continue;
}
}
}
result.push(elem);
i++;
}
return result;
}

// Nouvelle fonction pour rendre une ligne complÃ¨te avec ses Ã©lÃ©ments groupÃ©s
function renderLigneComplete(ligne){
if(!ligne)return'';

// Nouvelle structure : ligne.elements est un tableau d'Ã©lÃ©ments
if(ligne.elements&&Array.isArray(ligne.elements)){
// PRÃ‰-TRAITEMENT: Fusionner les Ã©lÃ©ments XXXX avec PROPOSITION : ... FINI
const elements=fusionnerXXXXProposition(ligne.elements);

// Chercher si un Ã©lÃ©ment a des alternatives
const altIndex=elements.findIndex(elem=>
elem.alternative&&elem.alternative.alternatives&&elem.alternative.alternatives.length>0
);

if(altIndex!==-1){
const altElement=elements[altIndex];
const alts=altElement.alternative.alternatives;

// Joindre toutes les alternatives pour dÃ©tecter les rÃ©sidus (en minuscules pour comparaison)
const allAltsText=alts.join(' ').toLowerCase();

let resultHtml='';

// Texte AVANT l'alternative
for(let i=0;i<altIndex;i++){
const elem=elements[i];
if(elem.commentaire){
resultHtml+=`<span class="comment">${elem.texte||''}</span>`;
}else{
let txt=elem.texte||'';
if(txt.trim()==='/'||txt.trim()===''||txt.trim()==='@@')continue;
// RÃ©sidu si contient / ou @@
if(txt.includes('/')||txt.includes('@@'))continue;
// RÃ©sidu si texte trÃ¨s court (1-2 caractÃ¨res) comme "Ã ", "h", etc.
if(txt.trim().length<=2)continue;
// RÃ©sidu si le texte est contenu dans une des alternatives (insensible Ã  la casse)
if(allAltsText.includes(txt.trim().toLowerCase())&&txt.trim().length>1)continue;
// RÃ©sidu PROPOSITION orphelin (sans XXXX)
if(/PROPOSITION\s*:/i.test(txt)&&/FINI/i.test(txt)&&!txt.includes('XXXX'))continue;
txt=renderXXXXSimple(txt);
resultHtml+=txt;
}
}

// L'alternative elle-mÃªme
if(alts.length<=1){
let displayText=alts[0]||'';
displayText=renderXXXXSimple(displayText);
resultHtml+=displayText;
}else{
const firstOption=alts[0];
const altsJson=JSON.stringify(alts).replace(/'/g,'&#39;');
let displayText=renderXXXXSimple(firstOption);
resultHtml+=`<span class="alt-container"><span class="alt-text">${displayText}</span><span class="alt-trigger" data-alts='${altsJson}' onclick="openAltDropdown(event, this)"></span></span>`;
}

// Texte APRÃˆS l'alternative
for(let i=altIndex+1;i<elements.length;i++){
const elem=elements[i];
if(elem.commentaire){
resultHtml+=`<span class="comment">${elem.texte||''}</span>`;
}else{
let txt=elem.texte||'';
if(txt.trim()==='/'||txt.trim()===''||txt.trim()==='@@')continue;
// RÃ©sidu si contient / ou @@
if(txt.includes('/')||txt.includes('@@'))continue;
// RÃ©sidu si texte trÃ¨s court (1-2 caractÃ¨res) comme "Ã ", "h", etc.
if(txt.trim().length<=2)continue;
// RÃ©sidu si le texte est contenu dans une des alternatives (insensible Ã  la casse)
if(allAltsText.includes(txt.trim().toLowerCase())&&txt.trim().length>1)continue;
// RÃ©sidu PROPOSITION orphelin
if(/PROPOSITION\s*:/i.test(txt)&&/FINI/i.test(txt)&&!txt.includes('XXXX'))continue;
txt=renderXXXXSimple(txt);
resultHtml+=txt;
}
}

return resultHtml?`<div class="module-line">${resultHtml}</div>`:'';
}

// Sinon, rendre chaque Ã©lÃ©ment normalement
const html=elements.map(elem=>renderLigne(elem)).join('');
return html?`<div class="module-line">${html}</div>`:'';
}

// Ancienne structure de compatibilitÃ© : ligne directe
const html=renderLigne(ligne);
return html?`<div class="module-line">${html}</div>`:'';
}

function deleteText(elementId){
const element=document.getElementById(elementId);
if(element){
element.remove();
toast('âœ“ Texte supprimÃ©');
}
}

function renderConduiteATenir(){
return state.conduiteLines.map((line,idx)=>{
let text=line.text||'';
// Utiliser la fonction de parsing complÃ¨te pour XXXX et @@
text=parseTextForAlternativeDisplay(text);
return `
<div class="conduite-line" data-line-idx="${idx}">
<div class="conduite-number">${idx+1}</div>
<div class="conduite-text">${text}</div>
<div class="conduite-actions">
<button class="action-icon action-up" onclick="moveLineUp(${idx})">â†‘</button>
<button class="action-icon action-down" onclick="moveLineDown(${idx})">â†“</button>
<button class="action-icon action-delete" onclick="deleteLine(${idx})">ðŸ—‘</button>
</div>
</div>
`;
}).join('')+`
<div class="conduite-add-line">
<input type="text" id="newConduiteLineInput" class="conduite-input" placeholder="âž• Ajouter une ligne..." onkeypress="if(event.key==='Enter')addNewConduiteLine()">
<button class="conduite-add-btn" onclick="addNewConduiteLine()">âœ“ Ajouter</button>
</div>
`;
}

function moveLineUp(idx){
if(idx===0)return;
[state.conduiteLines[idx],state.conduiteLines[idx-1]]=[state.conduiteLines[idx-1],state.conduiteLines[idx]];

// Re-render uniquement le module conduite
const conduiteModule=document.querySelector('[data-module-type="conduite_tenir"] .module-content');
if(conduiteModule){
conduiteModule.innerHTML=renderConduiteATenir();
}
}

function moveLineDown(idx){
if(idx===state.conduiteLines.length-1)return;
[state.conduiteLines[idx],state.conduiteLines[idx+1]]=[state.conduiteLines[idx+1],state.conduiteLines[idx]];

// Re-render uniquement le module conduite
const conduiteModule=document.querySelector('[data-module-type="conduite_tenir"] .module-content');
if(conduiteModule){
conduiteModule.innerHTML=renderConduiteATenir();
}
}

function deleteLine(idx){
if(idx<0||idx>=state.conduiteLines.length)return;
state.conduiteLines.splice(idx,1);

// Re-render uniquement le module conduite
const conduiteModule=document.querySelector('[data-module-type="conduite_tenir"] .module-content');
if(conduiteModule){
conduiteModule.innerHTML=renderConduiteATenir();
}

toast('âœ“ Ligne supprimÃ©e');
}

function updateConduiteLineText(idx,newText){
if(idx>=0&&idx<state.conduiteLines.length){
state.conduiteLines[idx].text=newText.trim();
}
}

function addNewConduiteLine(){
const input=document.getElementById('newConduiteLineInput');
const text=input.value.trim();

if(!text){
toast('âš ï¸ Entrez du texte','error');
return;
}

// Ajouter la nouvelle ligne
state.conduiteLines.push({
id:Date.now(),
text:text,
proposition:null,
alternative:null,
commentaire:null,
deletable:false
});

// Re-render
const conduiteModule=document.querySelector('[data-module-type="conduite_tenir"] .module-content');
if(conduiteModule){
conduiteModule.innerHTML=renderConduiteATenir();
}

// RÃ©initialiser l'input
input.value='';
toast('âœ“ Ligne ajoutÃ©e');
}

function renderOrdonnancesSection(){
if(!state.conclusion.ordonnances||state.conclusion.ordonnances.length===0)return'';

// Fonction pour dÃ©terminer l'icÃ´ne selon le titre
function getOrdoIcon(titre){
const t=(titre||'').toLowerCase();
if(t.includes('fiche')||t.includes('consigne'))return'ðŸ“';
if(t.includes('ide')||t.includes('infirmier'))return'ðŸ’‰';
if(t.includes('imagerie')||t.includes('radio')||t.includes('scanner')||t.includes('irm')||t.includes('Ã©cho'))return'ðŸ©»';
if(t.includes('biologie')||t.includes('bilan')||t.includes('prise de sang'))return'ðŸ§ª';
if(t.includes('soin')||t.includes('pansement')||t.includes('local'))return'ðŸ©¹';
return'ðŸ’Š';
}

// Fonction pour vÃ©rifier si c'est une fiche de consigne
function isFicheConsigne(titre){
const t=(titre||'').toLowerCase();
return t.includes('fiche')||t.includes('consigne');
}

// Fusionner les ordonnances avec le mÃªme titre (sauf fiches de consignes)
const fusionMap=new Map();
const fichesConsignes=[];
const ordonnancesFusionnees=[];

state.conclusion.ordonnances.forEach((ordo,idx)=>{
const titre=ordo.titre||'Ordonnance';
if(isFicheConsigne(titre)){
// Les fiches de consignes ne sont pas fusionnÃ©es
fichesConsignes.push({...ordo, originalIdx:idx, motifs:[ordo.motif||'']});
}else{
// Fusionner les ordonnances avec le mÃªme titre
if(fusionMap.has(titre)){
const existing=fusionMap.get(titre);
// Fusionner les lignes
existing.lignes=[...existing.lignes, ...(ordo.lignes||[])];
// Fusionner les bulles
existing.bulles=[...existing.bulles, ...(ordo.bulles||[])];
// Ajouter le motif
if(ordo.motif&&!existing.motifs.includes(ordo.motif)){
existing.motifs.push(ordo.motif);
}
}else{
fusionMap.set(titre, {
titre:titre,
lignes:[...(ordo.lignes||[])],
bulles:[...(ordo.bulles||[])],
motifs:[ordo.motif||''],
originalIdx:idx
});
}
}
});

// Convertir la map en tableau
fusionMap.forEach(ordo=>ordonnancesFusionnees.push(ordo));

// Stocker les ordonnances fusionnÃ©es dans state pour showOrdonnance
state.ordonnancesFusionnees=[...ordonnancesFusionnees, ...fichesConsignes];

// GÃ©nÃ©rer les boutons
let buttonsHtml='';

// Bouton "Toutes les ordonnances" en premier (jaune)
buttonsHtml+=`<button class="ordo-btn all" onclick="loadAllOrdonnances()" data-title="Toutes les ordonnances">ðŸ›Ÿ</button>`;

// Ordonnances fusionnÃ©es
ordonnancesFusionnees.forEach((ordo,i)=>{
const icon=getOrdoIcon(ordo.titre);
buttonsHtml+=`<button class="ordo-btn" onclick="showOrdonnanceFusionnee(${i})" data-title="${(ordo.titre||'Ordonnance').replace(/"/g,'&quot;')}">${icon}</button>`;
});

// Fiches de consignes (non fusionnÃ©es)
fichesConsignes.forEach((fiche,i)=>{
const idx=ordonnancesFusionnees.length+i;
buttonsHtml+=`<button class="ordo-btn fiche" onclick="showOrdonnanceFusionnee(${idx})" data-title="Fiche: ${(fiche.titre||'Consigne').replace(/"/g,'&quot;')}">ðŸ“</button>`;
});

return`
<div class="ordonnances-section">
${buttonsHtml}
</div>
`;
}

function showOrdonnanceFusionnee(idx){
const ordo=state.ordonnancesFusionnees[idx];
if(!ordo)return;

// VÃ©rifier si c'est une fiche de consigne (pas de checkboxes)
const isFiche=(ordo.titre||'').toLowerCase().includes('fiche')||(ordo.titre||'').toLowerCase().includes('consigne');

// Chaque ligne a maintenant ses Ã©lÃ©ments groupÃ©s
const content=(ordo.lignes||[]).map((ligne,lineIdx)=>{
const lineHtml=renderLigneComplete(ligne);
if(!lineHtml)return'';

// Pour les ordonnances (pas les fiches), ajouter une checkbox si la ligne commence par -
if(!isFiche){
const lineText=extractLigneText(ligne);
if(lineText.trim().startsWith('-')){
return`<div class="ordo-line-checkbox">
<input type="checkbox" checked id="ordoLine${lineIdx}" data-line-idx="${lineIdx}">
<label for="ordoLine${lineIdx}">${lineHtml}</label>
</div>`;
}
}
return`<div class="ordo-line">${lineHtml}</div>`;
}).filter(h=>h).join('');

// Rendre les bulles de l'ordonnance
let bullesHtml='';
if(ordo.bulles&&ordo.bulles.length>0){
const startIdx=state.currentBulles.length;
ordo.bulles.forEach((bulle,i)=>{
state.currentBulles.push(bulle);
});
bullesHtml=`<div class="ordo-bulles-container">
${ordo.bulles.map((bulle,i)=>`<button class="bulle-btn" onclick="showBulleByIndex(${startIdx+i}, event)" data-title="${(bulle.titre||'Info').replace(/"/g,'&quot;')}">ðŸ’¡</button>`).join('')}
</div>`;
}

document.getElementById('ordoModal').innerHTML=`
<div class="modal-content modal-ordo-detail">
<div class="modal-header">
<span>ðŸ“‹ ${ordo.titre||'Ordonnance'}</span>
${bullesHtml}
<span class="modal-close" onclick="closeModal('ordoModal')">Ã—</span>
</div>
<div id="ordoContent" contenteditable="true">${content}</div>
<div class="modal-buttons">
<button class="modal-btn modal-btn-secondary" onclick="closeModal('ordoModal')">Fermer</button>
<button class="modal-btn modal-btn-primary" onclick="copyOrdonnanceFusionnee(${idx})">ðŸ“‹ Copier</button>
</div>
</div>
`;
document.getElementById('ordoModal').classList.add('active');

// ExÃ©cuter les scripts JS dans le contenu de l'ordonnance
executeScriptsIn(document.getElementById('ordoContent'));
}

function copyOrdonnanceFusionnee(idx){
const ordoContent=document.getElementById('ordoContent');
if(!ordoContent)return;

// Collecter le texte des lignes cochÃ©es seulement
const lines=[];
ordoContent.querySelectorAll('.ordo-line-checkbox, .ordo-line').forEach(lineEl=>{
const checkbox=lineEl.querySelector('input[type="checkbox"]');
// Si pas de checkbox ou checkbox cochÃ©e
if(!checkbox||checkbox.checked){
const clone=lineEl.cloneNode(true);
clone.querySelectorAll('.comment, script, input').forEach(el=>el.remove());
// Remplacer les <br> par des sauts de ligne
clone.innerHTML=clone.innerHTML.replace(/<br\s*\/?>/gi,'\n');
clone.innerHTML=clone.innerHTML.replace(/<\/div>/gi,'\n');
let text=clone.innerText||clone.textContent||'';
text=text.trim();
if(text)lines.push(text);
}
});

const finalText=lines.join('\n').replace(/\n{3,}/g,'\n\n').trim();
if(finalText){
copyText(finalText);
}else{
toast('Aucune ligne sÃ©lectionnÃ©e','error');
}
}

function copyOrdonnance(idx){
// Lire depuis le DOM du modal (pour prendre en compte les modifications)
const ordoContent=document.getElementById('ordoContent');
if(ordoContent){
const clone=ordoContent.cloneNode(true);
// Supprimer les commentaires et les scripts
clone.querySelectorAll('.comment, script').forEach(el=>el.remove());

// Fonction pour extraire le texte brut en prÃ©servant les sauts de ligne et tabulations
let text='';

// Remplacer les <br> par des sauts de ligne
clone.innerHTML=clone.innerHTML.replace(/<br\s*\/?>/gi,'\n');

// Remplacer les </div> par des sauts de ligne
clone.innerHTML=clone.innerHTML.replace(/<\/div>/gi,'\n');

// Extraire le texte
text=clone.innerText||clone.textContent||'';

// Nettoyer les lignes vides multiples mais garder les simples
text=text.replace(/\n{3,}/g,'\n\n');

// Supprimer les espaces en dÃ©but et fin mais garder les tabulations internes
text=text.trim();

if(text){
copyText(text);
return;
}
}

// Fallback sur les donnÃ©es de state
const ordo=state.conclusion.ordonnances[idx];
if(!ordo||!ordo.lignes)return;
const text=ordo.lignes.map(ligne=>{
if(ligne.elements&&Array.isArray(ligne.elements)){
return ligne.elements.filter(e=>!e.commentaire).map(e=>{
let t=e.texte||'';
// PrÃ©server les \n littÃ©raux
t=t.replace(/\\n/g,'\n');
return t;
}).join('');
}
let t=ligne.texte||'';
t=t.replace(/\\n/g,'\n');
return t;
}).filter(t=>t).join('\n');
copyText(text);
}

async function loadAllOrdonnances(){
// Si dÃ©jÃ  chargÃ©, afficher directement
if(state.allOrdonnances&&state.allOrdonnances.length>0){
renderAllOrdonnances();
return;
}

toast('â³ Chargement des ordonnances...');
state.allOrdonnances=[];

try{
// Charger toutes les catÃ©gories en parallÃ¨le
const catPromises=state.categories.map(async(cat)=>{
try{
const mr=await fetch(`${API_URL}/motifs/${cat.table_name}`);
if(!mr.ok)return[];
const motifs=await mr.json();
return motifs.map(m=>({cat,motif:m}));
}catch(e){return[];}
});

const allMotifs=(await Promise.all(catPromises)).flat();

// Charger les ordonnances par batch de 10 en parallÃ¨le
const batchSize=10;
for(let i=0;i<allMotifs.length;i+=batchSize){
const batch=allMotifs.slice(i,i+batchSize);
const batchPromises=batch.map(async({cat,motif})=>{
try{
const fr=await fetch(`${API_URL}/fusion`,{
method:'POST',
headers:{'Content-Type':'application/json'},
body:JSON.stringify({
table_principale:cat.table_name,
motif_principal_id:motif.id,
motifs_secondaires:[],
mode:'conclusion'
})
});
if(!fr.ok)return[];
const fd=await fr.json();
if(fd.ordonnances&&Array.isArray(fd.ordonnances)){
return fd.ordonnances.map(ordo=>({
categorie:cat.nom,
motif:motif.nom_motif,
ordonnance:ordo
}));
}
return[];
}catch(e){return[];}
});

const batchResults=await Promise.all(batchPromises);
state.allOrdonnances.push(...batchResults.flat());

// Afficher progressivement
if(i===0||state.allOrdonnances.length>0){
renderAllOrdonnances();
}
}

if(state.allOrdonnances.length===0){
toast('âŒ Aucune ordonnance trouvÃ©e','error');
return;
}

renderAllOrdonnances();
toast(`âœ… ${state.allOrdonnances.length} ordonnances chargÃ©es`);
}catch(e){
toast('âŒ Erreur: '+e.message,'error');
console.error('Erreur loadAllOrdonnances:',e);
}
}

function renderAllOrdonnances(){
const categories=[...new Set(state.allOrdonnances.map(o=>o.categorie))];

document.getElementById('allOrdosModal').innerHTML=`
<div class="modal-content modal-ordos">
<div class="modal-header modal-header-ordos">
<span>ðŸ“‹ Toutes les Ordonnances (${state.allOrdonnances.length})</span>
<span class="modal-close" onclick="closeModal('allOrdosModal')">Ã—</span>
</div>
<div class="ordo-search-container">
<input type="text" id="ordoSearchInput" class="ordo-search-input" placeholder="ðŸ” Rechercher une ordonnance..." oninput="filterAllOrdonnances()">
</div>
<div class="ordo-filters">
<div class="ordo-filter">
<label>ðŸ“ CatÃ©gorie</label>
<select id="catFilter" onchange="filterAllOrdonnances()">
<option value="">Toutes les catÃ©gories</option>
${categories.map(c=>`<option value="${c}">${c}</option>`).join('')}
</select>
</div>
<div class="ordo-filter">
<label>ðŸ“Œ Motif</label>
<select id="motifFilter" onchange="filterAllOrdonnances()">
<option value="">Tous les motifs</option>
</select>
</div>
</div>
<div id="ordosCount" class="ordos-count"></div>
<div id="ordosList" class="ordos-list"></div>
</div>
`;

filterAllOrdonnances();
document.getElementById('allOrdosModal').classList.add('active');
setTimeout(()=>document.getElementById('ordoSearchInput').focus(),100);
}

function filterAllOrdonnances(){
const catFilter=document.getElementById('catFilter').value;
const motifFilter=document.getElementById('motifFilter').value;
const searchQuery=(document.getElementById('ordoSearchInput')?.value||'').toLowerCase().trim();

let filtered=state.allOrdonnances;

// Filtre par catÃ©gorie
if(catFilter){
filtered=filtered.filter(o=>o.categorie===catFilter);
const motifs=[...new Set(filtered.map(o=>o.motif))];
document.getElementById('motifFilter').innerHTML=
'<option value="">Tous les motifs</option>'+
motifs.map(m=>`<option value="${m}"${m===motifFilter?' selected':''}>${m}</option>`).join('');
}else{
document.getElementById('motifFilter').innerHTML='<option value="">Tous les motifs</option>';
}

// Filtre par motif
if(motifFilter)filtered=filtered.filter(o=>o.motif===motifFilter);

// Filtre par recherche textuelle
if(searchQuery){
filtered=filtered.filter(o=>{
const titre=(o.ordonnance.titre||'').toLowerCase();
const motif=o.motif.toLowerCase();
const cat=o.categorie.toLowerCase();
return titre.includes(searchQuery)||motif.includes(searchQuery)||cat.includes(searchQuery);
});
}

// Afficher le compteur
document.getElementById('ordosCount').innerHTML=`<span>${filtered.length} ordonnance${filtered.length>1?'s':''} trouvÃ©e${filtered.length>1?'s':''}</span>`;

// Grouper par catÃ©gorie pour un meilleur affichage
const grouped={};
filtered.forEach((item,idx)=>{
if(!grouped[item.categorie])grouped[item.categorie]=[];
grouped[item.categorie].push({...item,globalIdx:state.allOrdonnances.indexOf(item)});
});

let html='';
Object.keys(grouped).sort().forEach(cat=>{
html+=`<div class="ordo-category-group">
<div class="ordo-category-title">${cat}</div>
<div class="ordo-category-items">
${grouped[cat].map(item=>`
<div class="ordo-item" onclick="openOrdonnanceFromList(${item.globalIdx})">
<div class="ordo-item-icon">ðŸ’Š</div>
<div class="ordo-item-content">
<div class="ordo-item-title">${item.ordonnance.titre||'Ordonnance'}</div>
<div class="ordo-item-motif">${item.motif}</div>
</div>
<div class="ordo-item-arrow">â€º</div>
</div>
`).join('')}
</div>
</div>`;
});

document.getElementById('ordosList').innerHTML=html||'<div class="ordo-empty">Aucune ordonnance trouvÃ©e</div>';
}

function openOrdonnanceFromList(globalIdx){
const item=state.allOrdonnances[globalIdx];
if(!item||!item.ordonnance)return;

const content=(item.ordonnance.lignes||[]).map(ligne=>{
if(!ligne||!ligne.texte)return'';
return renderLigne(ligne);
}).join('');

closeModal('allOrdosModal');

const textToCopy=(item.ordonnance.lignes||[]).filter(l=>!l.commentaire).map(l=>l.texte||'').join('\n').replace(/'/g,"\\'");

// Rendre les bulles de l'ordonnance
let bullesHtml='';
if(item.ordonnance.bulles&&item.ordonnance.bulles.length>0){
const startIdx=state.currentBulles.length;
item.ordonnance.bulles.forEach((bulle,i)=>{
state.currentBulles.push(bulle);
});
bullesHtml=`<div class="ordo-bulles-container">
${item.ordonnance.bulles.map((bulle,i)=>`<button class="bulle-btn" onclick="showBulleByIndex(${startIdx+i}, event)" data-title="${(bulle.titre||'Info').replace(/"/g,'&quot;')}">ðŸ’¡</button>`).join('')}
</div>`;
}

document.getElementById('ordoModal').innerHTML=`
<div class="modal-content modal-ordo-detail">
<div class="modal-header">
<span>ðŸ“‹ ${item.ordonnance.titre||'Ordonnance'}</span>
${bullesHtml}
<span class="modal-close" onclick="closeModal('ordoModal')">Ã—</span>
</div>
<div id="ordoContent" contenteditable="true">${content}</div>
<div class="modal-buttons">
<button class="modal-btn modal-btn-secondary" onclick="closeModal('ordoModal')">Fermer</button>
<button class="modal-btn modal-btn-primary" onclick="copyText('${textToCopy}')">ðŸ“‹ Copier</button>
</div>
</div>
`;
document.getElementById('ordoModal').classList.add('active');

// ExÃ©cuter les scripts JS dans le contenu de l'ordonnance
executeScriptsIn(document.getElementById('ordoContent'));
}

// Parser Markdown simple pour les bulles d'informations
function parseMarkdown(text){
if(!text)return'';

// Si le texte contient dÃ©jÃ  des balises HTML, le retourner tel quel (avec parsing Markdown minimal)
if(/<[a-z][\s\S]*>/i.test(text)){
// Le contenu est dÃ©jÃ  du HTML, on applique juste quelques transformations Markdown de base
let html=text
// Gras et italique (qui peuvent Ãªtre mÃ©langÃ©s avec du HTML)
.replace(/\*\*\*(.+?)\*\*\*/g,'<strong><em>$1</em></strong>')
.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
.replace(/\*(.+?)\*/g,'<em>$1</em>')
// Sauts de ligne simples (hors balises)
.replace(/\n(?!<)/g,'<br>');
return html;
}

// Sinon, parser le Markdown normalement
let html=text
// Ã‰chapper les caractÃ¨res HTML dangereux sauf les balises qu'on va crÃ©er
.replace(/&/g,'&amp;')
.replace(/</g,'&lt;')
.replace(/>/g,'&gt;')
// Titres
.replace(/^### (.+)$/gm,'<h4>$1</h4>')
.replace(/^## (.+)$/gm,'<h3>$1</h3>')
.replace(/^# (.+)$/gm,'<h2>$1</h2>')
// Gras et italique
.replace(/\*\*\*(.+?)\*\*\*/g,'<strong><em>$1</em></strong>')
.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
.replace(/\*(.+?)\*/g,'<em>$1</em>')
.replace(/___(.+?)___/g,'<strong><em>$1</em></strong>')
.replace(/__(.+?)__/g,'<strong>$1</strong>')
.replace(/_(.+?)_/g,'<em>$1</em>')
// Code inline
.replace(/`([^`]+)`/g,'<code style="background:#e2e8f0;padding:2px 6px;border-radius:4px;font-family:monospace;font-size:12px">$1</code>')
// Liens
.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" style="color:#0ea5e9;text-decoration:underline">$1</a>')
// Listes Ã  puces
.replace(/^[\-\*] (.+)$/gm,'<li>$1</li>')
// Listes numÃ©rotÃ©es
.replace(/^\d+\. (.+)$/gm,'<li>$1</li>')
// Lignes horizontales
.replace(/^---$/gm,'<hr style="border:none;border-top:1px solid #cbd5e1;margin:16px 0">')
// Sauts de ligne doubles â†’ paragraphes
.replace(/\n\n/g,'</p><p>')
// Sauts de ligne simples
.replace(/\n/g,'<br>');

// Wrapper les li consÃ©cutifs dans des ul
html=html.replace(/(<li>.*?<\/li>)(\s*<br>)?(<li>)/g,'$1$3');
html=html.replace(/(<li>.*?<\/li>)+/g,'<ul style="margin:12px 0 12px 20px">$&</ul>');

return'<p>'+html+'</p>';
}

function showBulleByIndex(idx, event){
const bulle=state.currentBulles[idx];
if(!bulle){
console.error('Bulle non trouvÃ©e:',idx);
return;
}

// VÃ©rifier si le contenu est du HTML brut (commence par < ou contient des balises)
const contenu=bulle.contenu||'';
const isRawHtml=contenu.trim().startsWith('<')||/<[a-z][\s\S]*>/i.test(contenu);

// Si c'est du HTML brut, l'utiliser directement, sinon parser le Markdown
const contenuHtml=isRawHtml?contenu:parseMarkdown(contenu);

// Si appelÃ© depuis une ordonnance (event existe), afficher une popup positionnÃ©e
if(event && event.target){
event.stopPropagation();
const btn=event.target;
const rect=btn.getBoundingClientRect();

const popup=document.getElementById('bullePopupOrdo');
popup.innerHTML=`
<div class="bulle-popup-header" onclick="event.stopPropagation()">
<span>ðŸ’¡ ${bulle.titre||'Info'}</span>
<span class="bulle-popup-close" onclick="closeBullePopupOrdo()">Ã—</span>
</div>
<div class="bulle-popup-content" onclick="event.stopPropagation()">${contenuHtml}</div>
`;
// Fermer au clic sur la popup
popup.onclick=function(){closeBullePopupOrdo();};

// Positionner sous le bouton
popup.style.top=(rect.bottom + 8)+'px';
popup.style.left=(rect.left - 160 + rect.width/2)+'px'; // Centrer sous le bouton

// VÃ©rifier si dÃ©passe Ã  droite
popup.classList.add('active');
const popupRect=popup.getBoundingClientRect();
if(popupRect.right > window.innerWidth - 20){
popup.style.left=(window.innerWidth - popupRect.width - 20)+'px';
}
if(popupRect.left < 20){
popup.style.left='20px';
}
// VÃ©rifier si dÃ©passe en bas
if(popupRect.bottom > window.innerHeight - 20){
popup.style.top=(rect.top - popupRect.height - 8)+'px';
}

// ExÃ©cuter les scripts JS dans le contenu
executeScriptsIn(popup.querySelector('.bulle-popup-content'));
return;
}

// Sinon, afficher le modal classique
document.getElementById('bulleModal').innerHTML=`
<div class="modal-content modal-bulle" onclick="event.stopPropagation()">
<div class="modal-header">
<span>ðŸ’¡ ${bulle.titre||'Info'}</span>
<span class="modal-close" onclick="closeModal('bulleModal')">Ã—</span>
</div>
<div class="bulle-content">${contenuHtml}</div>
</div>
`;

// ExÃ©cuter les scripts JS dans le contenu
executeScriptsIn(document.querySelector('#bulleModal .bulle-content'));

document.getElementById('bulleModal').classList.add('active');
document.getElementById('bulleModal').onclick=function(e){if(e.target===this)closeModal('bulleModal');};
}

function closeBullePopupOrdo(){
document.getElementById('bullePopupOrdo').classList.remove('active');
}

function openXXXXModal(element){
element.id='xxxx-'+Date.now();

// Fermer si dÃ©jÃ  ouvert
closeXXXXPopup();

// Stocker l'Ã©lÃ©ment courant globalement
currentXXXXElement=element;

let propositions=[];
try{
const propsAttr=element.getAttribute('data-props');
if(propsAttr){
// DÃ©coder avec decodeURIComponent car encodÃ© avec encodeURIComponent
propositions=JSON.parse(decodeURIComponent(propsAttr));
}
}catch(e){
console.error('Erreur parse props:',e);
}

// DÃ©tecter le contexte en regardant le texte AVANT et APRÃˆS le XXXX
const prevSibling=element.previousSibling;
const nextSibling=element.nextSibling;

const textBefore=prevSibling?prevSibling.textContent||'':'';
const textAfter=nextSibling?nextSibling.textContent||'':'';

// Date : prÃ©cÃ©dÃ© de "le " isolÃ© (pas "abdominale", "normale", etc.)
const isDate=/(?:^|\s)le\s*$/i.test(textBefore);
// Heure : h doit Ãªtre seul (suivi d'espace, ponctuation ou fin) - pas "habituellement", "hola"
const isTime=/^\s*h(?:\s|$|[,;:.!?)])/i.test(textAfter);

// Stocker si on doit supprimer le h aprÃ¨s validation
element.setAttribute('data-remove-h',isTime?'true':'false');

// GÃ©nÃ©rer le calendrier (15 derniers jours + sÃ©lecteur d'heure)
let dateOptionsHtml='';
if(isDate){
const now=new Date();
const joursSemaine=['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'];
const mois=['Janvier','FÃ©vrier','Mars','Avril','Mai','Juin','Juillet','AoÃ»t','Septembre','Octobre','Novembre','DÃ©cembre'];

// GÃ©nÃ©rer les 21 derniers jours pour avoir 3 semaines
let calendarDays='';
for(let i=20;i>=0;i--){
const d=new Date(now);
d.setDate(d.getDate()-i);
const day=String(d.getDate()).padStart(2,'0');
const month=String(d.getMonth()+1).padStart(2,'0');
const dayName=joursSemaine[d.getDay()];
const isToday=i===0;
const dateValue=`${day}/${month}`;
calendarDays+=`<div class="xxxx-popup-cal-day${isToday?' today':''}" data-date="${dateValue}">
<div style="font-size:9px;color:var(--text-secondary)">${dayName}</div>
<b>${d.getDate()}</b>
</div>`;
}

// GÃ©nÃ©rer les crÃ©neaux horaires
let timeSlots='';
const times=['06h','07h','08h','09h','10h','11h','12h','13h','14h','15h','16h','17h','18h','19h','20h','21h','22h','23h'];
times.forEach(t=>{
timeSlots+=`<div class="xxxx-popup-time-slot" data-time="${t}">${t}</div>`;
});

dateOptionsHtml=`
<div class="xxxx-popup-calendar">
<div class="xxxx-popup-cal-header">ðŸ“… ${mois[now.getMonth()]} ${now.getFullYear()}</div>
<div class="xxxx-popup-cal-grid">${calendarDays}</div>
<div class="xxxx-popup-cal-header" style="margin-top:8px">â° Heure (optionnel)</div>
<div class="xxxx-popup-time-grid">${timeSlots}</div>
</div>`;
}

// GÃ©nÃ©rer les options d'heure seule
let timeOptionsHtml='';
if(isTime&&!isDate){
const times=['00h00','01h00','02h00','03h00','04h00','05h00','06h00','07h00','08h00','09h00','10h00','11h00','12h00','13h00','14h00','15h00','16h00','17h00','18h00','19h00','20h00','21h00','22h00','23h00'];
let timeSlots='';
times.forEach(t=>{
timeSlots+=`<div class="xxxx-popup-time-slot" data-time="${t}">${t}</div>`;
});
timeOptionsHtml=`
<div class="xxxx-popup-calendar">
<div class="xxxx-popup-cal-header">â° SÃ©lectionner l'heure</div>
<div class="xxxx-popup-time-grid">${timeSlots}</div>
</div>`;
}

// CrÃ©er les chips
const chipsHtml=propositions&&propositions.length>0?`
<div class="xxxx-popup-chips">
${propositions.map(p=>{
const displayText=formatHintText(parseXXXXForChips2(p||''));
const cleanValue=removeHintText((p||'').replace(/\s*%%[^%]+%%/g,'').replace(/XXXX/g,'').trim());
// data-value = texte nettoyÃ© (pour l'input), data-raw = texte brut (pour popup2)
return `<div class="xxxx-popup-chip" data-value="${cleanValue.replace(/"/g,'&quot;')}" data-raw="${(p||'').replace(/"/g,'&quot;')}">${displayText}</div>`;
}).join('')}
</div>
`:'';

const popup=document.getElementById('xxxxPopup');
const validateFn=isDate?'validateXXXXWithTimePopup':'validateXXXXPopup';

popup.innerHTML=`
<div class="xxxx-popup-content${isDate?' popup-large':''}">
<div class="xxxx-popup-header">
<span>ComplÃ©ter${isDate?' (Date)':isTime?' (Heure)':''}</span>
<span class="xxxx-popup-close" onclick="closeXXXXPopup()">Ã—</span>
</div>
${dateOptionsHtml}
${timeOptionsHtml}
${chipsHtml}
<input type="text" id="xxxxPopupInput" class="xxxx-popup-input" placeholder="${isDate?'JJ/MM':isTime?'HHhMM':'Entrez...'}">
<div class="xxxx-popup-buttons">
<button class="xxxx-popup-btn xxxx-popup-btn-cancel" onclick="closeXXXXPopup()">Annuler</button>
<button class="xxxx-popup-btn xxxx-popup-btn-validate" onclick="${validateFn}('${element.id}')">âœ“ Valider</button>
</div>
</div>
`;

// Ajouter les event listeners sur les chips
popup.querySelectorAll('.xxxx-popup-chip').forEach(chip=>{
chip.addEventListener('click',function(e){
e.stopPropagation();
this.classList.toggle('selected');
const selectedChips=popup.querySelectorAll('.xxxx-popup-chip.selected');
const values=Array.from(selectedChips).map(c=>c.getAttribute('data-value'));
document.getElementById('xxxxPopupInput').value=values.join(', ');
});
});

// Ajouter les event listeners sur les jours du calendrier
popup.querySelectorAll('.xxxx-popup-cal-day').forEach(day=>{
day.addEventListener('click',function(e){
e.stopPropagation();
popup.querySelectorAll('.xxxx-popup-cal-day').forEach(d=>d.classList.remove('selected'));
this.classList.add('selected');
selectedCalendarDate=this.getAttribute('data-date');
updateXXXXPopupInput();
});
});

// Ajouter les event listeners sur les heures
popup.querySelectorAll('.xxxx-popup-time-slot').forEach(slot=>{
slot.addEventListener('click',function(e){
e.stopPropagation();
popup.querySelectorAll('.xxxx-popup-time-slot').forEach(s=>s.classList.remove('selected'));
this.classList.add('selected');
selectedTimeSlot=this.getAttribute('data-time');
updateXXXXPopupInput();
});
});

// Positionner la pop-up Ã  droite du XXXX
const elementRect=element.getBoundingClientRect();
popup.style.position='fixed';
popup.style.left=(elementRect.right+10)+'px';
popup.style.top=elementRect.top+'px';
popup.style.transform='none';

// RÃ©initialiser les sÃ©lections
selectedCalendarDate=null;
selectedTimeSlot=null;

popup.classList.add('active');

// VÃ©rifier si dÃ©passe Ã  droite
const popupRect=popup.getBoundingClientRect();
if(popupRect.right>window.innerWidth-20){
popup.style.left=(elementRect.left-popupRect.width-10)+'px';
}
// VÃ©rifier si dÃ©passe en bas
const popupRect2=popup.getBoundingClientRect();
if(popupRect2.bottom>window.innerHeight-20){
popup.style.top=(window.innerHeight-popupRect2.height-20)+'px';
}

// Ajouter les listeners clavier
popup.addEventListener('keydown',function handler(e){
if(e.key==='Enter'){
e.preventDefault();
e.stopPropagation();
if(isDate){
validateXXXXWithTimePopup(element.id);
}else{
validateXXXXPopup(element.id);
}
}
if(e.key==='Escape'){
e.stopPropagation();
closeXXXXPopup();
}
});

setTimeout(()=>document.getElementById('xxxxPopupInput').focus(),50);
}

// Mettre Ã  jour l'input de la pop-up avec date/heure
function updateXXXXPopupInput(){
const input=document.getElementById('xxxxPopupInput');
if(!input)return;
let value='';
if(selectedCalendarDate){
value=selectedCalendarDate;
if(selectedTimeSlot){
value+=' Ã  '+selectedTimeSlot;
}
}else if(selectedTimeSlot){
value=selectedTimeSlot;
}
input.value=value;
}

// Fermer la pop-up XXXX
function closeXXXXPopup(){
const popup=document.getElementById('xxxxPopup');
if(popup){
popup.classList.remove('active');
popup.innerHTML='';
}
// Fermer aussi la popup2 si ouverte
closeXXXXPopup2();
currentXXXXElement=null;
}

// Valider le XXXX depuis la pop-up
function validateXXXXPopup(elementId){
const input=document.getElementById('xxxxPopupInput');
const value=input.value.trim();
if(!value){
closeXXXXPopup();
return;
}

// Utiliser currentXXXXElement pour Ã©viter les bugs de rÃ©fÃ©rence
const element=currentXXXXElement||document.getElementById(elementId);
if(!element)return;

// Garder une rÃ©fÃ©rence au conteneur parent avant modification
const parentContainer=element.closest('#ordoContent')||element.closest('.module-content')||element.parentElement;

// VÃ©rifier si on doit supprimer le h aprÃ¨s
const removeH=element.getAttribute('data-remove-h')==='true';
if(removeH){
const nextSibling=element.nextSibling;
if(nextSibling&&nextSibling.nodeType===Node.TEXT_NODE){
nextSibling.textContent=nextSibling.textContent.replace(/^\s*h/i,'');
}
}

element.textContent=value;
element.classList.remove('xxxx');
element.classList.add('xxxx-filled');
element.removeAttribute('onclick');

currentXXXXElement=null;
closeXXXXPopup();

// Ouvrir automatiquement le prochain XXXX non rempli
setTimeout(()=>openNextXXXX(parentContainer),100);
}

// Fonction pour ouvrir le prochain XXXX non rempli
function openNextXXXX(container){
if(!container)return;
const nextXXXX=container.querySelector('.xxxx:not(.xxxx-filled)');
if(nextXXXX&&nextXXXX.onclick){
nextXXXX.click();
}
}

// Valider le XXXX avec date/heure depuis la pop-up
function validateXXXXWithTimePopup(elementId){
const input=document.getElementById('xxxxPopupInput');
let value=input.value.trim();

if(!value&&!selectedCalendarDate){
closeXXXXPopup();
return;
}

if(!value&&selectedCalendarDate){
value=selectedCalendarDate;
if(selectedTimeSlot){
value+=' Ã  '+selectedTimeSlot;
}
}

// Utiliser currentXXXXElement pour Ã©viter les bugs de rÃ©fÃ©rence
const element=currentXXXXElement||document.getElementById(elementId);
if(!element)return;

// Garder une rÃ©fÃ©rence au conteneur parent avant modification
const parentContainer=element.closest('#ordoContent')||element.closest('.module-content')||element.parentElement;

// Si on a inclus l'heure, supprimer le " Ã  XXXX h" qui suit
if(selectedTimeSlot){
let nextNode=element.nextSibling;
// Chercher " Ã  " suivi d'un XXXX suivi de " h"
if(nextNode&&nextNode.nodeType===Node.TEXT_NODE&&/\s*Ã \s*$/.test(nextNode.textContent)){
const xxxxAfter=nextNode.nextSibling;
if(xxxxAfter&&xxxxAfter.classList&&xxxxAfter.classList.contains('xxxx')){
const textAfterXXXX=xxxxAfter.nextSibling;
if(textAfterXXXX&&textAfterXXXX.nodeType===Node.TEXT_NODE&&/^\s*h/i.test(textAfterXXXX.textContent)){
// Supprimer " Ã  ", le XXXX, et le " h"
nextNode.textContent=nextNode.textContent.replace(/\s*Ã \s*$/,'');
textAfterXXXX.textContent=textAfterXXXX.textContent.replace(/^\s*h/i,'');
xxxxAfter.remove();
}
}
}
}

element.textContent=value;
element.classList.remove('xxxx');
element.classList.add('xxxx-filled');
element.removeAttribute('onclick');

currentXXXXElement=null;
closeXXXXPopup();

// Ouvrir automatiquement le prochain XXXX non rempli
setTimeout(()=>openNextXXXX(parentContainer),100);
}

// Fonction pour sÃ©lectionner un chip de proposition (sÃ©lection multiple)
function selectPropositionChip(chip){
// Toggle la sÃ©lection du chip
chip.classList.toggle('selected');

// RÃ©cupÃ©rer tous les chips sÃ©lectionnÃ©s
const selectedChips=chip.closest('.proposition-chips').querySelectorAll('.chip.selected');
const values=Array.from(selectedChips).map(c=>c.getAttribute('data-value'));

// Mettre Ã  jour l'input avec les valeurs sÃ©parÃ©es par " + "
document.getElementById('xxxxInput').value=values.join(', ');
document.getElementById('xxxxInput').focus();
}

// Variables pour le calendrier
let selectedCalendarDate=null;
let selectedTimeSlot=null;
let currentDateElementId=null;
let currentXXXXElement=null;

// Fonction pour sÃ©lectionner une date dans le calendrier
function selectCalendarDate(dateValue,dayEl){
// DÃ©sÃ©lectionner l'ancienne date
document.querySelectorAll('.calendar-day.selected').forEach(d=>d.classList.remove('selected'));
// SÃ©lectionner la nouvelle
dayEl.classList.add('selected');
selectedCalendarDate=dateValue;
// Mettre Ã  jour l'input
updateDateTimeInput();
}

// Fonction pour sÃ©lectionner un crÃ©neau horaire
function selectTimeSlot(timeValue,slotEl){
// DÃ©sÃ©lectionner l'ancien
document.querySelectorAll('.time-slot.selected').forEach(s=>s.classList.remove('selected'));
// SÃ©lectionner le nouveau
slotEl.classList.add('selected');
selectedTimeSlot=timeValue;
// Mettre Ã  jour l'input
updateDateTimeInput();
}

// SÃ©lectionner une heure (cas oÃ¹ l'heure est seule, sans date)
function selectTimeSlotOnly(timeValue){
// DÃ©sÃ©lectionner l'ancien
document.querySelectorAll('.time-slot.selected').forEach(s=>s.classList.remove('selected'));
// SÃ©lectionner le nouveau
event.target.classList.add('selected');
// Mettre Ã  jour l'input directement
document.getElementById('xxxxInput').value=timeValue;
document.getElementById('xxxxInput').focus();
}

// SÃ©lectionner une heure pour modal 2
function selectTimeSlotOnly2(timeValue){
document.querySelectorAll('#xxxxModal2 .time-slot.selected').forEach(s=>s.classList.remove('selected'));
event.target.classList.add('selected');
document.getElementById('xxxxInput2').value=timeValue;
document.getElementById('xxxxInput2').focus();
}

// Mettre Ã  jour l'input avec date et Ã©ventuellement l'heure
function updateDateTimeInput(){
const input=document.getElementById('xxxxInput');
if(selectedCalendarDate){
input.value=selectedCalendarDate;
input.focus();
}
}

// Fonction pour valider et remplir automatiquement le XXXX d'heure suivant
function validateXXXXWithTime(elementId){
const value=document.getElementById('xxxxInput').value.trim();
if(value){
const element=document.getElementById(elementId);
if(element){
// Remplacer le texte
element.textContent=value;
element.classList.remove('xxxx');
element.style.background='transparent';
element.style.boxShadow='none';
element.style.color='inherit';
element.style.fontWeight='inherit';
element.onclick=null;

// Chercher le prochain XXXX qui est suivi de "h"
let nextElement=element.nextSibling;
while(nextElement){
if(nextElement.nodeType===Node.TEXT_NODE){
nextElement=nextElement.nextSibling;
continue;
}
if(nextElement.classList&&nextElement.classList.contains('xxxx')){
// VÃ©rifier si c'est un champ d'heure (suivi de h)
const afterNext=nextElement.nextSibling;
if(afterNext&&/^\s*h/i.test(afterNext.textContent||'')){
if(selectedTimeSlot){
// Une heure a Ã©tÃ© sÃ©lectionnÃ©e, remplir le champ
nextElement.textContent=selectedTimeSlot;
nextElement.classList.remove('xxxx');
nextElement.style.background='transparent';
nextElement.style.boxShadow='none';
nextElement.style.color='inherit';
nextElement.style.fontWeight='inherit';
nextElement.onclick=null;
// Supprimer le "h" qui suit
if(afterNext.nodeType===Node.TEXT_NODE){
afterNext.textContent=afterNext.textContent.replace(/^\s*h\s*/,'');
}
}else{
// Pas d'heure sÃ©lectionnÃ©e, supprimer "XXXX h" (en gardant l'espace avant Ã©ventuel)
// Supprimer le texte " Ã  " qui prÃ©cÃ¨de le XXXX s'il existe
let prevText=nextElement.previousSibling;
if(prevText&&prevText.nodeType===Node.TEXT_NODE){
prevText.textContent=prevText.textContent.replace(/\s*Ã \s*$/,'');
}
// Supprimer le "h" qui suit
if(afterNext.nodeType===Node.TEXT_NODE){
afterNext.textContent=afterNext.textContent.replace(/^\s*h\s*/,'');
}
// Supprimer le XXXX lui-mÃªme
nextElement.remove();
}
break;
}
}
nextElement=nextElement.nextSibling;
}
element.removeAttribute('data-props');
element.removeAttribute('data-remove-h');
}
}
// RÃ©initialiser les sÃ©lections
selectedCalendarDate=null;
selectedTimeSlot=null;
closeModal('xxxxModal');
}

// Variable pour stocker le chip actuel pour XXXX dans propositions
let currentPropChipForXXXX=null;
let currentXXXXSpanInChip=null;

// Variables pour la 3Ã¨me popup
let currentPropChipForXXXX3=null;
let currentXXXXSpanInChip3=null;

// Fonction pour parser un chip et rendre les XXXX cliquables pour la 3Ã¨me popup
// Format: XXXX â‚¬â‚¬ option1 + option2 + option3 â‚¬â‚¬
function parseChipForXXXX3(text){
if(!text)return text;

// Utiliser des placeholders uniques
let result=text;
const placeholders=[];

// Parser XXXX â‚¬â‚¬ opt1 + opt2 â‚¬â‚¬ (propositions niveau 3, sÃ©parateur +)
result=result.replace(/XXXX\s*â‚¬â‚¬\s*([^â‚¬]+)\s*â‚¬â‚¬/g, function(match, props){
const options=props.split('+').map(s=>s.trim()).filter(s=>s);
const propsEncoded=encodeURIComponent(JSON.stringify(options));
const idx=placeholders.length;
placeholders.push(propsEncoded);
return '###PH'+idx+'###';
});

// Parser XXXX simples restants (sans propositions)
result=result.replace(/XXXX/g, function(){
const idx=placeholders.length;
placeholders.push(encodeURIComponent('[]'));
return '###PH'+idx+'###';
});

// Remplacer les placeholders par le HTML
result=result.replace(/###PH(\d+)###/g, function(match, idx){
const propsEncoded=placeholders[parseInt(idx)];
return '<span class="xxxx-in-chip3" data-props3="'+propsEncoded+'" onclick="event.stopPropagation();openXXXXPopup3ForProp(this)">XXXX</span>';
});

return result;
}

// Pop-up XXXX secondaire pour les propositions (positionnÃ©e Ã  cÃ´tÃ© de la premiÃ¨re)
function openXXXXPopup2ForProp(xxxxSpan){
currentPropChipForXXXX=xxxxSpan.closest('.xxxx-popup-chip')||xxxxSpan.closest('.chip');
currentXXXXSpanInChip=xxxxSpan;

// RÃ©cupÃ©rer les propositions depuis le chip parent (data-raw contient le texte brut avec %%)
let propositions=[];
if(currentPropChipForXXXX){
const chipText=currentPropChipForXXXX.getAttribute('data-raw')||currentPropChipForXXXX.getAttribute('data-value')||'';
// Extraire le contenu entre %% et %%
const match=chipText.match(/%%\s*([^%]+)\s*%%/);
if(match&&match[1]){
// Splitter par / pour obtenir les propositions niveau 2
propositions=match[1].split('/').map(s=>s.trim()).filter(s=>s);
}
}

const popup2=document.getElementById('xxxxPopup2');

// CrÃ©er le HTML de base
popup2.innerHTML=`
<div class="xxxx-popup-content">
<div class="xxxx-popup-header">
<span>ComplÃ©ter</span>
<span class="xxxx-popup-close" onclick="closeXXXXPopup2()">Ã—</span>
</div>
<div class="xxxx-popup-chips" id="popup2ChipsContainer"></div>
<input type="text" id="xxxxPopup2Input" class="xxxx-popup-input" placeholder="Entrez...">
<div class="xxxx-popup-buttons">
<button class="xxxx-popup-btn xxxx-popup-btn-cancel" onclick="closeXXXXPopup2()">Annuler</button>
<button class="xxxx-popup-btn xxxx-popup-btn-validate" onclick="validateXXXXPopup2()">âœ“ Valider</button>
</div>
</div>
`;

// Ajouter les chips avec DOM manipulation
const chipsContainer=document.getElementById('popup2ChipsContainer');
if(propositions&&propositions.length>0){
propositions.forEach(p=>{
const chip=document.createElement('div');
chip.className='xxxx-popup-chip';
chip.setAttribute('data-value',removeHintText(p||''));

// Parser le contenu pour les XXXX de niveau 3, puis formater les hints
const parsed=formatHintText(parseChipForXXXX3(p||''));
chip.innerHTML=parsed;

// Event listener pour sÃ©lectionner le chip
chip.addEventListener('click',function(e){
if(e.target.classList.contains('xxxx-in-chip3'))return;
e.stopPropagation();
chipsContainer.querySelectorAll('.xxxx-popup-chip').forEach(c=>c.classList.remove('selected'));
this.classList.add('selected');
document.getElementById('xxxxPopup2Input').value=this.getAttribute('data-value');
});

chipsContainer.appendChild(chip);
});
}else{
chipsContainer.style.display='none';
}

// Positionner Ã  cÃ´tÃ© de la premiÃ¨re pop-up
const popup1=document.getElementById('xxxxPopup');
const popup1Rect=popup1.getBoundingClientRect();

popup2.style.position='fixed';
popup2.style.left=(popup1Rect.right+10)+'px';
popup2.style.top=popup1Rect.top+'px';
popup2.style.transform='none';

popup2.classList.add('active');

// VÃ©rifier si dÃ©passe Ã  droite
const popup2Rect=popup2.getBoundingClientRect();
if(popup2Rect.right>window.innerWidth-20){
popup2.style.left=popup1Rect.left+'px';
popup2.style.top=(popup1Rect.bottom+10)+'px';
}

// VÃ©rifier si dÃ©passe en bas
const popup2Rect2=popup2.getBoundingClientRect();
if(popup2Rect2.bottom>window.innerHeight-20){
popup2.style.top=(window.innerHeight-popup2Rect2.height-20)+'px';
}

setTimeout(()=>document.getElementById('xxxxPopup2Input').focus(),50);
}

// Fermer la pop-up XXXX 2
function closeXXXXPopup2(){
const popup2=document.getElementById('xxxxPopup2');
if(popup2){
popup2.classList.remove('active');
popup2.innerHTML='';
}
currentXXXXSpanInChip=null;
}

// Valider le XXXX dans la pop-up 2
function validateXXXXPopup2(){
const value=document.getElementById('xxxxPopup2Input').value.trim();
if(value&&currentPropChipForXXXX&&currentXXXXSpanInChip){
// Remplacer le span XXXX par la valeur dans l'affichage
currentXXXXSpanInChip.textContent=value;
currentXXXXSpanInChip.classList.remove('xxxx-in-chip');
currentXXXXSpanInChip.classList.add('xxxx-filled-chip');
currentXXXXSpanInChip.removeAttribute('onclick');

// Mettre Ã  jour data-value avec le contenu textuel complet du chip (sans les hints)
const newValue=getCleanTextContent(currentPropChipForXXXX);
currentPropChipForXXXX.setAttribute('data-value',newValue);

// NOUVEAU: SÃ©lectionner automatiquement le chip parent (popup1)
const popup1=document.getElementById('xxxxPopup');
if(popup1){
// Ajouter Ã  la sÃ©lection (ne pas dÃ©sÃ©lectionner les autres car popup1 est multi-select)
currentPropChipForXXXX.classList.add('selected');
// Mettre Ã  jour l'input principal avec toutes les valeurs sÃ©lectionnÃ©es
const selectedChips=popup1.querySelectorAll('.xxxx-popup-chip.selected');
const values=Array.from(selectedChips).map(c=>c.getAttribute('data-value'));
document.getElementById('xxxxPopupInput').value=values.join(', ');
}
}
closeXXXXPopup2();
}

// ========== 3Ã¨me POPUP XXXX ==========

// Ouvrir la 3Ã¨me popup pour les XXXX dans les propositions de la 2Ã¨me popup ou du modal @@
function openXXXXPopup3ForProp(xxxxSpan){
// Le parent peut Ãªtre .xxxx-popup-chip (popup2) ou .xxxx-alt-chip (modal @@)
currentPropChipForXXXX3=xxxxSpan.closest('.xxxx-popup-chip')||xxxxSpan.closest('.xxxx-alt-chip');
currentXXXXSpanInChip3=xxxxSpan;

// RÃ©cupÃ©rer les propositions si elles existent (format %% opt1 / opt2 %%)
let propositions=[];
try{
const propsAttr=xxxxSpan.getAttribute('data-props3');
if(propsAttr){
propositions=JSON.parse(decodeURIComponent(propsAttr));
}
}catch(e){
console.error('Erreur parse props3:',e);
}

// GÃ©nÃ©rer les chips de propositions
const chipsHtml=propositions&&propositions.length>0?`
<div class="xxxx-popup-chips">
${propositions.map(p=>`<div class="xxxx-popup-chip" data-value="${removeHintText(p||'').replace(/"/g,'&quot;')}">${formatHintText(p||'')}</div>`).join('')}
</div>
`:'';

const popup3=document.getElementById('xxxxPopup3');
popup3.innerHTML=`
<div class="xxxx-popup-content">
<div class="xxxx-popup-header">
<span>ComplÃ©ter</span>
<span class="xxxx-popup-close" onclick="closeXXXXPopup3()">Ã—</span>
</div>
${chipsHtml}
<input type="text" id="xxxxPopup3Input" class="xxxx-popup-input" placeholder="Entrez...">
<div class="xxxx-popup-buttons">
<button class="xxxx-popup-btn xxxx-popup-btn-cancel" onclick="closeXXXXPopup3()">Annuler</button>
<button class="xxxx-popup-btn xxxx-popup-btn-validate" onclick="validateXXXXPopup3()">âœ“ Valider</button>
</div>
</div>
`;

// Ajouter les event listeners sur les chips
popup3.querySelectorAll('.xxxx-popup-chip').forEach(chip=>{
chip.addEventListener('click',function(e){
e.stopPropagation();
popup3.querySelectorAll('.xxxx-popup-chip').forEach(c=>c.classList.remove('selected'));
this.classList.add('selected');
document.getElementById('xxxxPopup3Input').value=this.getAttribute('data-value');
});
});

// DÃ©terminer la source (popup2 ou modal @@)
const popup2=document.getElementById('xxxxPopup2');
const modalAlt=document.getElementById('xxxxModalInAlt');
let sourceRect;

if(popup2&&popup2.classList.contains('active')){
sourceRect=popup2.getBoundingClientRect();
}else if(modalAlt&&modalAlt.classList.contains('active')){
const content=modalAlt.querySelector('.xxxx-alt-modal-content');
sourceRect=content?content.getBoundingClientRect():modalAlt.getBoundingClientRect();
}else{
// Fallback sur le span lui-mÃªme
sourceRect=xxxxSpan.getBoundingClientRect();
}

popup3.style.position='fixed';
popup3.style.left=(sourceRect.right+10)+'px';
popup3.style.top=sourceRect.top+'px';
popup3.style.transform='none';

popup3.classList.add('active');

// VÃ©rifier si dÃ©passe Ã  droite
const popup3Rect=popup3.getBoundingClientRect();
if(popup3Rect.right>window.innerWidth-20){
// Positionner en dessous
popup3.style.left=sourceRect.left+'px';
popup3.style.top=(sourceRect.bottom+10)+'px';
}

// VÃ©rifier si dÃ©passe en bas
const popup3Rect2=popup3.getBoundingClientRect();
if(popup3Rect2.bottom>window.innerHeight-20){
popup3.style.top=(window.innerHeight-popup3Rect2.height-20)+'px';
}

setTimeout(()=>document.getElementById('xxxxPopup3Input').focus(),50);
}

// Fermer la 3Ã¨me popup
function closeXXXXPopup3(){
const popup3=document.getElementById('xxxxPopup3');
if(popup3){
popup3.classList.remove('active');
popup3.innerHTML='';
}
currentPropChipForXXXX3=null;
currentXXXXSpanInChip3=null;
}

// Valider la 3Ã¨me popup
function validateXXXXPopup3(){
const value=document.getElementById('xxxxPopup3Input').value.trim();
if(value&&currentPropChipForXXXX3&&currentXXXXSpanInChip3){
// VÃ©rifier si c'est un chip du modal @@ (encodÃ© avec encodeURIComponent)
const isAltChip=currentPropChipForXXXX3.classList.contains('xxxx-alt-chip');

// Remplacer le span XXXX par la valeur visuellement
currentXXXXSpanInChip3.textContent=value;
currentXXXXSpanInChip3.classList.remove('xxxx-in-chip3');
currentXXXXSpanInChip3.classList.add('xxxx-filled-chip3');
currentXXXXSpanInChip3.removeAttribute('onclick');

// Mettre Ã  jour data-value avec le contenu textuel du chip (sans les hints)
let newValue=getCleanTextContent(currentPropChipForXXXX3);
if(isAltChip){
newValue=encodeURIComponent(newValue);
}
currentPropChipForXXXX3.setAttribute('data-value',newValue);

// SÃ©lectionner automatiquement le chip parent (popup2 ou modal @@)
// DÃ©sÃ©lectionner les autres chips du mÃªme conteneur
const container=currentPropChipForXXXX3.closest('.xxxx-popup-chips')||currentPropChipForXXXX3.closest('.xxxx-alt-modal-chips');
if(container){
container.querySelectorAll('.xxxx-popup-chip, .xxxx-alt-chip').forEach(c=>c.classList.remove('selected'));
}
// SÃ©lectionner ce chip
currentPropChipForXXXX3.classList.add('selected');

// Mettre Ã  jour l'input correspondant avec la valeur mise Ã  jour
const inputValue=isAltChip?decodeURIComponent(newValue):newValue;
const input2=document.getElementById('xxxxPopup2Input');
const inputAlt=document.getElementById('xxxxAltInput');
if(input2){
input2.value=inputValue;
}
if(inputAlt){
inputAlt.value=inputValue;
}
}
closeXXXXPopup3();
}

// ========== FIN 3Ã¨me POPUP XXXX ==========

// Modal XXXX secondaire pour les propositions (gardÃ© pour compatibilitÃ©)
function openXXXXModal2ForProp(xxxxSpan){
currentPropChipForXXXX=xxxxSpan.closest('.chip');

// RÃ©cupÃ©rer les propositions si elles existent
let propositions=[];
try{
const propsAttr=xxxxSpan.getAttribute('data-props');
if(propsAttr){
// DÃ©coder avec decodeURIComponent car encodÃ© avec encodeURIComponent
propositions=JSON.parse(decodeURIComponent(propsAttr));
}
}catch(e){
console.error('Erreur parse props:',e);
}

// DÃ©tecter le contexte en regardant le texte AVANT et APRÃˆS le XXXX dans le chip
const prevSibling=xxxxSpan.previousSibling;
const nextSibling=xxxxSpan.nextSibling;

const textBefore=prevSibling?prevSibling.textContent||'':'';
const textAfter=nextSibling?nextSibling.textContent||'':'';

// Date : prÃ©cÃ©dÃ© de "le " isolÃ© (pas "abdominale", "normale", etc.)
const isDate=/(?:^|\s)le\s*$/i.test(textBefore);
// Heure : h doit Ãªtre seul (suivi d'espace, ponctuation ou fin) - pas "habituellement", "hola"
const isTime=/^\s*h(?:\s|$|[,;:.!?)])/i.test(textAfter);

// GÃ©nÃ©rer les chips de propositions
const propsChipsHtml=propositions&&propositions.length>0?`
<div class="proposition-chips">
${propositions.map(p=>`<div class="chip" onclick="selectPropChipForXXXX2(this)" data-value="${(p||'').replace(/"/g,'&quot;')}">${p}</div>`).join('')}
</div>
`:'';

// GÃ©nÃ©rer les options date/heure
let dateTimeHtml='';
if(isDate){
const dates=[];
const now=new Date();
for(let i=0;i<15;i++){
const d=new Date(now);
d.setDate(d.getDate()-i);
dates.push(`${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}`);
}
dateTimeHtml=`<div class="datetime-picker"><label>Date :</label><select id="dateSelect2" onchange="document.getElementById('xxxxInput2').value=this.value"><option value="">Choisir...</option>${dates.map(d=>`<option value="${d}">${d}</option>`).join('')}</select></div>`;
}
if(isTime){
const now=new Date();
const times=['00h00','00h30','01h00','01h30','02h00','02h30','03h00','03h30','04h00','04h30','05h00','05h30','06h00','06h30','07h00','07h30','08h00','08h30','09h00','09h30','10h00','10h30','11h00','11h30','12h00','12h30','13h00','13h30','14h00','14h30','15h00','15h30','16h00','16h30','17h00','17h30','18h00','18h30','19h00','19h30','20h00','20h30','21h00','21h30','22h00','22h30','23h00','23h30'];
const currentHour=now.getHours();
const currentMin=now.getMinutes();
const currentTimeStr=String(currentHour).padStart(2,'0')+'h'+(currentMin>=30?'30':'00');
let timeSlots='';
times.forEach(t=>{
const isCurrent=t===currentTimeStr;
timeSlots+=`<div class="time-slot${isCurrent?' current':''}" onclick="selectTimeSlotOnly2('${t}')">${t}</div>`;
});
dateTimeHtml=`
<div class="calendar-container">
<div class="calendar-header">â° SÃ©lectionner l'heure</div>
<div class="time-picker-grid">
${timeSlots}
</div>
</div>`;
}

document.getElementById('xxxxModal2').innerHTML=`
<div class="modal-content">
<div class="modal-header">
<span>Remplir le champ${isDate?' (Date)':isTime?' (Heure)':''}</span>
<span class="modal-close" onclick="closeModal('xxxxModal2')">Ã—</span>
</div>
${propsChipsHtml}
${dateTimeHtml}
<input type="text" id="xxxxInput2" class="modal-input" placeholder="${isDate?'JJ/MM':isTime?'HHhMM':'Entrez...'}" onkeypress="if(event.key==='Enter')validateXXXX2ForProp()">
<div class="modal-buttons">
<button class="modal-btn modal-btn-secondary" onclick="closeModal('xxxxModal2')">Annuler</button>
<button class="modal-btn modal-btn-primary" onclick="validateXXXX2ForProp()">âœ“ Valider</button>
</div>
</div>
`;
document.getElementById('xxxxModal2').classList.add('active');
setTimeout(()=>document.getElementById('xxxxInput2').focus(),100);
}

// SÃ©lectionner une proposition pour XXXX dans les chips (modal 2)
function selectPropChipForXXXX2(chip){
const value=chip.getAttribute('data-value');
document.getElementById('xxxxInput2').value=value;
chip.closest('.proposition-chips').querySelectorAll('.chip').forEach(c=>c.classList.remove('selected'));
chip.classList.add('selected');
}

function validateXXXX2ForProp(){
const value=document.getElementById('xxxxInput2').value.trim();
if(value&&currentPropChipForXXXX){
// Mettre Ã  jour la data-value du chip
let chipValue=currentPropChipForXXXX.getAttribute('data-value');
chipValue=chipValue.replace('XXXX',value);
currentPropChipForXXXX.setAttribute('data-value',chipValue);

// Mettre Ã  jour l'affichage du chip (remplacer le premier xxxx-in-chip)
const xxxxSpans=currentPropChipForXXXX.querySelectorAll('.xxxx-in-chip');
if(xxxxSpans.length>0){
xxxxSpans[0].outerHTML=value;
}

// Mettre Ã  jour l'input
const mainInput=document.getElementById('xxxxInput');
if(mainInput&&mainInput.value.includes('XXXX')){
mainInput.value=mainInput.value.replace('XXXX',value);
}
}
currentPropChipForXXXX=null;
closeModal('xxxxModal2');
}

function fillXXXX(elementId,value){
document.getElementById('xxxxInput').value=value;
}

function validateXXXX(elementId){
const value=document.getElementById('xxxxInput').value.trim();
if(value){
const element=document.getElementById(elementId);
if(element){
// VÃ©rifier si on doit supprimer le "h" qui suit (pour les heures)
const removeH=element.getAttribute('data-remove-h')==='true';
if(removeH){
const nextSibling=element.nextSibling;
if(nextSibling&&nextSibling.nodeType===Node.TEXT_NODE){
// Supprimer le "h" ou " h" au dÃ©but du texte suivant
nextSibling.textContent=nextSibling.textContent.replace(/^\s*h\s*/,'');
}
}

// VÃ©rifier si la valeur contient des XXXX
if(value.includes('XXXX')){
// CrÃ©er le HTML avec des spans cliquables pour chaque XXXX
const parts=value.split(/(XXXX)/g);
element.innerHTML=parts.map(part=>{
if(part==='XXXX'){
return `<span class="xxxx" onclick="openXXXXModal(this)">XXXX</span>`;
}
return part;
}).join('');
element.classList.remove('xxxx');
element.style.background='transparent';
element.style.border='none';
element.style.color='inherit';
element.style.fontWeight='inherit';
element.onclick=null;
}else{
element.textContent=value;
element.classList.remove('xxxx');
element.style.background='transparent';
element.style.border='none';
element.style.color='inherit';
element.style.fontWeight='inherit';
element.onclick=null;
}
element.removeAttribute('data-props');
element.removeAttribute('data-remove-h');
}
}
closeModal('xxxxModal');
}

// Variable pour stocker le trigger actuel
let currentAltTrigger=null;

// Fermer le dropdown quand on clique ailleurs
document.addEventListener('click',function(e){
const dropdown=document.getElementById('altDropdown');
const xxxxModal=document.getElementById('xxxxModalInAlt');
const xxxxPopup=document.getElementById('xxxxPopup');
// Ne pas fermer si le modal XXXX est ouvert
if(xxxxModal&&xxxxModal.classList.contains('active'))return;
// Ne pas fermer si la pop-up XXXX principale est ouverte
if(xxxxPopup&&xxxxPopup.classList.contains('active'))return;
if(dropdown&&dropdown.classList.contains('active')){
if(!dropdown.contains(e.target)&&!e.target.classList.contains('alt-trigger')){
closeAltDropdown();
}
}
});

// Fermer le dropdown sur resize (mais pas sur scroll interne)
window.addEventListener('resize',closeAltDropdown);

// GÃ©rer le scroll - fermer seulement si scroll en dehors du dropdown
document.addEventListener('scroll',function(e){
const dropdown=document.getElementById('altDropdown');
const xxxxModal=document.getElementById('xxxxModalInAlt');
const xxxxPopup=document.getElementById('xxxxPopup');
if(dropdown&&dropdown.classList.contains('active')){
// Ne pas fermer si le scroll vient du dropdown lui-mÃªme ou de la liste
if(dropdown.contains(e.target))return;
// Ne pas fermer si le modal XXXX est ouvert
if(xxxxModal&&xxxxModal.classList.contains('active'))return;
// Ne pas fermer si la pop-up XXXX principale est ouverte
if(xxxxPopup&&xxxxPopup.classList.contains('active'))return;
closeAltDropdown();
}
},true);

// Fermer le modal XXXX quand on clique ailleurs
document.addEventListener('click',function(e){
const xxxxModal=document.getElementById('xxxxModalInAlt');
if(xxxxModal&&xxxxModal.classList.contains('active')){
const isInModal=xxxxModal.contains(e.target);
const isXXXX=e.target.classList.contains('xxxx-in-alt');
const isChip=e.target.classList.contains('xxxx-alt-chip');
if(!isInModal&&!isXXXX&&!isChip){
closeXXXXInAltModal();
}
}
});

// Fermer la popup de bulle ordonnance quand on clique ailleurs
document.addEventListener('click',function(e){
const bullePopup=document.getElementById('bullePopupOrdo');
if(bullePopup&&bullePopup.classList.contains('active')){
if(!bullePopup.contains(e.target)&&!e.target.classList.contains('bulle-btn')){
closeBullePopupOrdo();
}
}
});

// Listener global pour la touche Escape - ferme les popups
document.addEventListener('keydown',function(e){
if(e.key==='Escape'){
const xxxxPopup3=document.getElementById('xxxxPopup3');
const xxxxPopup2=document.getElementById('xxxxPopup2');
const xxxxPopup=document.getElementById('xxxxPopup');
const xxxxModal=document.getElementById('xxxxModalInAlt');
const dropdown=document.getElementById('altDropdown');
const bullePopup=document.getElementById('bullePopupOrdo');
// Fermer la popup de bulle ordonnance si ouverte
if(bullePopup&&bullePopup.classList.contains('active')){
e.stopPropagation();
closeBullePopupOrdo();
}
// Fermer d'abord la pop-up XXXX 3 si ouverte
else if(xxxxPopup3&&xxxxPopup3.classList.contains('active')){
e.stopPropagation();
closeXXXXPopup3();
}
// Fermer la pop-up XXXX 2 si ouverte
else if(xxxxPopup2&&xxxxPopup2.classList.contains('active')){
e.stopPropagation();
closeXXXXPopup2();
}
// Puis la pop-up XXXX principale si ouverte
else if(xxxxPopup&&xxxxPopup.classList.contains('active')){
e.stopPropagation();
closeXXXXPopup();
}
// Puis le modal XXXX dans alt s'il est ouvert
else if(xxxxModal&&xxxxModal.classList.contains('active')){
e.stopPropagation();
closeXXXXInAltModal();
}
// Sinon fermer le dropdown
else if(dropdown&&dropdown.classList.contains('active')){
e.stopPropagation();
closeAltDropdown();
}
}
});

// Fermer la pop-up XXXX quand on clique ailleurs
document.addEventListener('click',function(e){
const xxxxPopup3=document.getElementById('xxxxPopup3');
const xxxxPopup2=document.getElementById('xxxxPopup2');
const xxxxPopup=document.getElementById('xxxxPopup');
// D'abord vÃ©rifier popup3
if(xxxxPopup3&&xxxxPopup3.classList.contains('active')){
const isInPopup3=xxxxPopup3.contains(e.target);
const isXXXXInChip3=e.target.classList.contains('xxxx-in-chip3');
if(!isInPopup3&&!isXXXXInChip3){
closeXXXXPopup3();
return;
}
}
// Puis vÃ©rifier popup2
if(xxxxPopup2&&xxxxPopup2.classList.contains('active')){
const isInPopup2=xxxxPopup2.contains(e.target);
const isXXXXInChip=e.target.classList.contains('xxxx-in-chip');
const isXXXXInChip3=e.target.classList.contains('xxxx-in-chip3');
const isInPopup3=xxxxPopup3&&xxxxPopup3.contains(e.target);
if(!isInPopup2&&!isXXXXInChip&&!isXXXXInChip3&&!isInPopup3){
closeXXXXPopup2();
return;
}
}
// Puis vÃ©rifier popup1
if(xxxxPopup&&xxxxPopup.classList.contains('active')){
const isInPopup=xxxxPopup.contains(e.target);
const isXXXX=e.target.classList.contains('xxxx');
const isInPopup2=xxxxPopup2&&xxxxPopup2.contains(e.target);
const isInPopup3=xxxxPopup3&&xxxxPopup3.contains(e.target);
if(!isInPopup&&!isXXXX&&!isInPopup2&&!isInPopup3){
closeXXXXPopup();
}
}
});

// Fermer le dropdown
function closeAltDropdown(){
const dropdown=document.getElementById('altDropdown');
if(dropdown){
dropdown.classList.remove('active');
dropdown.innerHTML='';
}
currentAltTrigger=null;
}

// Rendre les XXXX cliquables dans le dropdown des alternatives
function renderXXXXForAltDropdown(text, containerId, altIdx){
if(!text)return '';
let result=text;

// Format 1: XXXX %% prop1 / prop2 %%
result=result.replace(/XXXX\s*%%([^%]+)%%/g, function(match, props){
const suggestions=props.split('/').map(s=>s.trim()).filter(s=>s);
const propsEncoded=encodeURIComponent(JSON.stringify(suggestions));
return `<span class="xxxx-in-alt" data-props="${propsEncoded}" data-container-id="${containerId}" data-alt-idx="${altIdx}">XXXX</span>`;
});

// Format 2: XXXX PROPOSITION : prop1 / prop2 / prop3 FINI
result=result.replace(/XXXX\s+PROPOSITION\s*:\s*(.+?)\s+FINI/gi, function(match, props){
const suggestions=props.split(/[\/;]/).map(s=>s.trim()).filter(s=>s);
const propsEncoded=encodeURIComponent(JSON.stringify(suggestions));
return `<span class="xxxx-in-alt" data-props="${propsEncoded}" data-container-id="${containerId}" data-alt-idx="${altIdx}">XXXX</span>`;
});

// Format 3: XXXX simples (sans propositions)
result=result.replace(/XXXX(?!\s*%%|\s+PROPOSITION)/gi, function(){
return `<span class="xxxx-in-alt" data-props="${encodeURIComponent('[]')}" data-container-id="${containerId}" data-alt-idx="${altIdx}">XXXX</span>`;
});

return result;
}

// Variable pour stocker le XXXX actuel dans le dropdown
let currentXXXXInAlt=null;
let selectedAltDate=null;
let selectedAltTime=null;

// Ouvrir le modal XXXX depuis le dropdown des alternatives
function openXXXXInAltDropdown(event, element){
event.stopPropagation();
currentXXXXInAlt=element;
selectedAltDate=null;
selectedAltTime=null;

let suggestions=[];
try{
const propsAttr=element.getAttribute('data-props');
if(propsAttr){
suggestions=JSON.parse(decodeURIComponent(propsAttr));
}
}catch(e){
console.error('Erreur parse props:',e);
}

// DÃ©tecter le contexte date/heure
const prevSibling=element.previousSibling;
const nextSibling=element.nextSibling;
const textBefore=prevSibling?prevSibling.textContent||'':'';
const textAfter=nextSibling?nextSibling.textContent||'':'';

const isDate=/(?:^|\s)le\s*$/i.test(textBefore);
// isTime: h doit Ãªtre seul (suivi d'espace, ponctuation ou fin) - pas "habituellement", "hola"
const isTime=/^\s*h(?:\s|$|[,;:.!?)])/i.test(textAfter);

// Stocker si on doit supprimer le h aprÃ¨s validation
element.setAttribute('data-remove-h',isTime?'true':'false');

const modal=document.getElementById('xxxxModalInAlt');

// GÃ©nÃ©rer le calendrier si date
let dateHtml='';
if(isDate){
const now=new Date();
const joursSemaine=['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'];
const mois=['Janvier','FÃ©vrier','Mars','Avril','Mai','Juin','Juillet','AoÃ»t','Septembre','Octobre','Novembre','DÃ©cembre'];

let calendarDays='';
for(let i=14;i>=0;i--){
const d=new Date(now);
d.setDate(d.getDate()-i);
const day=String(d.getDate()).padStart(2,'0');
const month=String(d.getMonth()+1).padStart(2,'0');
const dayName=joursSemaine[d.getDay()];
const isToday=i===0;
const dateValue=`${day}/${month}`;
calendarDays+=`<div class="xxxx-alt-cal-day${isToday?' today':''}" data-date="${dateValue}">${dayName}<br><b>${d.getDate()}</b></div>`;
}

let timeSlots='';
const times=['06h','07h','08h','09h','10h','11h','12h','13h','14h','15h','16h','17h','18h','19h','20h','21h','22h','23h'];
times.forEach(t=>{
timeSlots+=`<div class="xxxx-alt-time-slot" data-time="${t}">${t}</div>`;
});

dateHtml=`
<div class="xxxx-alt-calendar">
<div class="xxxx-alt-cal-header">ðŸ“… ${mois[now.getMonth()]} ${now.getFullYear()}</div>
<div class="xxxx-alt-cal-grid">${calendarDays}</div>
<div class="xxxx-alt-cal-header" style="margin-top:8px">â° Heure (optionnel)</div>
<div class="xxxx-alt-time-grid">${timeSlots}</div>
</div>`;
}

// GÃ©nÃ©rer le sÃ©lecteur d'heure si heure seule
let timeHtml='';
if(isTime&&!isDate){
const times=['00h00','01h00','02h00','03h00','04h00','05h00','06h00','07h00','08h00','09h00','10h00','11h00','12h00','13h00','14h00','15h00','16h00','17h00','18h00','19h00','20h00','21h00','22h00','23h00'];
let timeSlots='';
times.forEach(t=>{
timeSlots+=`<div class="xxxx-alt-time-slot" data-time="${t}">${t}</div>`;
});
timeHtml=`
<div class="xxxx-alt-calendar">
<div class="xxxx-alt-cal-header">â° SÃ©lectionner l'heure</div>
<div class="xxxx-alt-time-grid">${timeSlots}</div>
</div>`;
}

// CrÃ©er les chips pour les propositions avec XXXX imbriquÃ©s
let chipsHtml='';
if(suggestions&&suggestions.length>0){
chipsHtml=`<div class="xxxx-alt-chips">
${suggestions.map((s,idx)=>{
const parsed=formatHintText(parseChipForXXXX3(s||''));
return `<div class="xxxx-alt-chip" data-value="${encodeURIComponent(removeHintText(s||''))}">${parsed}</div>`;
}).join('')}
</div>`;
}

modal.innerHTML=`
<div class="xxxx-alt-modal-content${isDate?' modal-large':''}">
<div class="xxxx-alt-modal-header">
<span>ComplÃ©ter XXXX${isDate?' (Date)':isTime?' (Heure)':''}</span>
<span class="xxxx-alt-modal-close" onclick="closeXXXXInAltModal()">Ã—</span>
</div>
${dateHtml}
${timeHtml}
${chipsHtml}
<input type="text" class="xxxx-alt-input" id="xxxxAltInput" placeholder="${isDate?'JJ/MM':isTime?'HHhMM':'Saisir une valeur...'}">
<button class="xxxx-alt-validate">âœ“ Valider</button>
</div>
`;

// Ajouter les event listeners sur les chips - SÃ‰LECTION MULTIPLE
modal.querySelectorAll('.xxxx-alt-chip').forEach(chip=>{
chip.addEventListener('click',function(e){
// Ne pas rÃ©agir si on clique sur un XXXX interne
if(e.target.classList.contains('xxxx-in-chip3'))return;
e.stopPropagation();
e.preventDefault();
// Toggle la sÃ©lection du chip
this.classList.toggle('selected');
// Mettre Ã  jour l'input avec toutes les valeurs sÃ©lectionnÃ©es
updateXXXXAltInputFromChips();
});
});

// Ajouter un event listener sur le bouton Valider
const validateBtn=modal.querySelector('.xxxx-alt-validate');
if(validateBtn){
validateBtn.addEventListener('click',function(e){
e.stopPropagation();
e.preventDefault();
validateXXXXInAlt();
});
}

// Ajouter les event listeners sur les jours du calendrier
modal.querySelectorAll('.xxxx-alt-cal-day').forEach(day=>{
day.addEventListener('click',function(e){
e.stopPropagation();
modal.querySelectorAll('.xxxx-alt-cal-day').forEach(d=>d.classList.remove('selected'));
this.classList.add('selected');
selectedAltDate=this.getAttribute('data-date');
updateAltDateTimeInput();
});
});

// Ajouter les event listeners sur les heures
modal.querySelectorAll('.xxxx-alt-time-slot').forEach(slot=>{
slot.addEventListener('click',function(e){
e.stopPropagation();
modal.querySelectorAll('.xxxx-alt-time-slot').forEach(s=>s.classList.remove('selected'));
this.classList.add('selected');
selectedAltTime=this.getAttribute('data-time');
updateAltDateTimeInput();
});
});

// Positionner - aligner le haut du modal avec le haut du dropdown
const dropdownRect=document.getElementById('altDropdown').getBoundingClientRect();
modal.style.position='fixed';
modal.style.left=(dropdownRect.right+10)+'px';
modal.style.top=dropdownRect.top+'px';
modal.style.transform='none';

modal.classList.add('active');

// VÃ©rifier si dÃ©passe Ã  droite de l'Ã©cran -> ouvrir en bas alignÃ© Ã  gauche
const modalRect=modal.getBoundingClientRect();
if(modalRect.right>window.innerWidth-20){
modal.style.left=dropdownRect.left+'px';
modal.style.top=(dropdownRect.bottom+10)+'px';
}
// VÃ©rifier si dÃ©passe en bas
const modalRect2=modal.getBoundingClientRect();
if(modalRect2.bottom>window.innerHeight-20){
modal.style.top=(window.innerHeight-modalRect2.height-20)+'px';
}

setTimeout(()=>document.getElementById('xxxxAltInput').focus(),50);

// Ajouter un listener pour la touche EntrÃ©e sur tout le modal
modal.addEventListener('keydown',function(e){
if(e.key==='Enter'){
e.preventDefault();
e.stopPropagation();
validateXXXXInAlt();
}
if(e.key==='Escape'){
e.stopPropagation();
closeXXXXInAltModal();
}
});
}

// Mettre Ã  jour l'input avec la date/heure sÃ©lectionnÃ©e
function updateAltDateTimeInput(){
const input=document.getElementById('xxxxAltInput');
if(!input)return;
let value='';
if(selectedAltDate){
value=selectedAltDate;
if(selectedAltTime){
value+=' Ã  '+selectedAltTime;
}
}else if(selectedAltTime){
value=selectedAltTime;
}
input.value=value;
}

// Fermer le modal XXXX dans alt
function closeXXXXInAltModal(){
const modal=document.getElementById('xxxxModalInAlt');
if(modal){
modal.classList.remove('active');
}
currentXXXXInAlt=null;
}

// SÃ©lectionner une proposition XXXX dans alt
// Mettre Ã  jour l'input avec les chips sÃ©lectionnÃ©s (sÃ©lection multiple)
function updateXXXXAltInputFromChips(){
const modal=document.getElementById('xxxxModalInAlt');
if(!modal)return;
const selectedChips=modal.querySelectorAll('.xxxx-alt-chip.selected');
const values=Array.from(selectedChips).map(chip=>decodeURIComponent(chip.getAttribute('data-value')));
const input=document.getElementById('xxxxAltInput');
if(input){
input.value=values.join(', ');
}
}

function selectXXXXInAlt(value){
if(!currentXXXXInAlt)return;

// Garder une rÃ©fÃ©rence avant de modifier
const xxxxElement=currentXXXXInAlt;
const item=xxxxElement.closest('.alt-dropdown-item');

// VÃ©rifier si on doit supprimer le h aprÃ¨s
const removeH=xxxxElement.getAttribute('data-remove-h')==='true';
if(removeH){
// Supprimer le h qui suit dans le texte
const nextSibling=xxxxElement.nextSibling;
if(nextSibling&&nextSibling.nodeType===Node.TEXT_NODE){
nextSibling.textContent=nextSibling.textContent.replace(/^\s*h/i,'');
}
}

// Remplacer le XXXX par la valeur
xxxxElement.textContent=value;
xxxxElement.classList.remove('xxxx-in-alt');
xxxxElement.classList.add('xxxx-filled');

// Mettre Ã  jour la valeur de l'alternative dans le data-alt-value
if(item){
// DÃ©coder, modifier, rÃ©-encoder
let altValue=decodeURIComponent(item.getAttribute('data-alt-value')||'');
// Remplacer le premier XXXX (avec propositions dans les deux formats ou sans) par la valeur
altValue=altValue.replace(/XXXX\s*%%[^%]+%%|XXXX\s+PROPOSITION\s*:.+?FINI|XXXX/i, value);
// Si removeH, supprimer aussi le h dans altValue
if(removeH){
altValue=altValue.replace(new RegExp(value.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+'\\s*h','i'), value);
}
item.setAttribute('data-alt-value', encodeURIComponent(altValue));

// AUTO-SÃ‰LECTIONNER l'alternative quand un XXXX est rempli
if(!item.classList.contains('selected')){
item.classList.add('selected');
}

// Mettre Ã  jour l'input avec les valeurs sÃ©lectionnÃ©es
const dropdown=document.getElementById('altDropdown');
updateAltDropdownInput(dropdown);
}

closeXXXXInAltModal();
}

// Valider le XXXX avec texte personnalisÃ© ou sÃ©lection multiple
function validateXXXXInAlt(){
const input=document.getElementById('xxxxAltInput');
if(!input){
closeXXXXInAltModal();
return;
}
const value=input.value.trim();
if(value && currentXXXXInAlt){
selectXXXXInAlt(value);
}else{
closeXXXXInAltModal();
}
}

// Ouvrir le dropdown des alternatives
function openAltDropdown(event, triggerElement){
event.stopPropagation();

// Fermer si dÃ©jÃ  ouvert sur le mÃªme trigger
if(currentAltTrigger===triggerElement){
closeAltDropdown();
return;
}

currentAltTrigger=triggerElement;
const container=triggerElement.closest('.alt-container');
const textElement=container.querySelector('.alt-text');

// GÃ©nÃ©rer un ID unique pour le container
container.id='altc-'+Date.now();

let alternatives=[];
try{
const altsAttr=triggerElement.getAttribute('data-alts');
if(altsAttr){
alternatives=JSON.parse(altsAttr);
}
}catch(e){
console.error('Erreur parse alternatives:',e);
}

// Afficher uniquement les alternatives APRÃˆS la premiÃ¨re
const autresAlternatives=alternatives.slice(1);

const dropdown=document.getElementById('altDropdown');

// CrÃ©er le contenu du dropdown - d'abord sans les XXXX rendus
let itemsHtml='';
if(autresAlternatives.length>0){
itemsHtml=`<div class="alt-dropdown-list">` + autresAlternatives.map((alt,idx)=>{
// Encoder l'alternative pour data-alt-value (sans les hints)
const cleanAlt=removeHintText(alt||'');
const encodedAlt=encodeURIComponent(cleanAlt);
// Nettoyer le texte pour l'affichage (retirer les marqueurs de propositions) et formater les hints
let displayText=(alt||'')
.replace(/XXXX\s*%%([^%]+)%%/g,'XXXX')
.replace(/XXXX\s+PROPOSITION\s*:.+?FINI/gi,'XXXX')
.replace(/%%[^%]+%%/g,'')
.trim();
displayText=formatHintText(displayText);
return `<div class="alt-dropdown-item" data-alt-value="${encodedAlt}" data-alt-original="${encodeURIComponent(alt||'')}" data-container-id="${container.id}" data-alt-idx="${idx}"><span class="alt-item-text">${displayText}</span></div>`;
}).join('') + `</div>`;
}

dropdown.innerHTML=`
<div style="font-size:11px;color:var(--text-secondary);margin-bottom:8px;font-weight:600;">Choisir une ou plusieurs alternatives :</div>
${itemsHtml}
<input type="text" class="alt-dropdown-input" id="altDropdownInput" placeholder="Ou saisir...">
<button class="alt-dropdown-validate" onclick="validateAltDropdown('${container.id}')">âœ“ Valider</button>
`;

// Maintenant, remplacer les XXXX dans chaque item par des Ã©lÃ©ments cliquables
dropdown.querySelectorAll('.alt-dropdown-item').forEach(item=>{
const textSpan=item.querySelector('.alt-item-text');
const originalAlt=decodeURIComponent(item.getAttribute('data-alt-original'));
const altIdx=item.getAttribute('data-alt-idx');

// Extraire les propositions du texte original
const xxxxMatches=[];

// Format 1: XXXX %% props %%
let tempText=originalAlt;
tempText.replace(/XXXX\s*%%([^%]+)%%/g, function(match, props, offset){
const suggestions=props.split('/').map(s=>s.trim()).filter(s=>s);
xxxxMatches.push({offset, suggestions});
return match;
});

// Format 2: XXXX PROPOSITION : props FINI
tempText.replace(/XXXX\s+PROPOSITION\s*:\s*(.+?)\s+FINI/gi, function(match, props, offset){
const suggestions=props.split(/[\/;]/).map(s=>s.trim()).filter(s=>s);
xxxxMatches.push({offset, suggestions});
return match;
});

// Si on a des XXXX, les rendre cliquables
if(textSpan.textContent.includes('XXXX')){
const html=textSpan.textContent.replace(/XXXX/g, function(){
const match=xxxxMatches.shift()||{suggestions:[]};
const propsEncoded=encodeURIComponent(JSON.stringify(match.suggestions));
return `<span class="xxxx-in-alt" data-props="${propsEncoded}" data-container-id="${container.id}" data-alt-idx="${altIdx}">XXXX</span>`;
});
textSpan.innerHTML=html;
}
});

// Ajouter les event listeners sur les XXXX
dropdown.querySelectorAll('.xxxx-in-alt').forEach(xxxx=>{
xxxx.addEventListener('click',function(e){
e.stopPropagation();
openXXXXInAltDropdown(e, this);
});
});

// Ajouter les event listeners sur les items pour sÃ©lection multiple
dropdown.querySelectorAll('.alt-dropdown-item').forEach(item=>{
item.addEventListener('click',function(e){
// Si on a cliquÃ© sur un XXXX, ne pas toggler la sÃ©lection
if(e.target.classList.contains('xxxx-in-alt')){
return;
}
// Toggle la sÃ©lection
this.classList.toggle('selected');
// Mettre Ã  jour l'input avec les valeurs sÃ©lectionnÃ©es
updateAltDropdownInput(dropdown);
});
});

// EmpÃªcher le scroll de propager vers la page
const dropdownList=dropdown.querySelector('.alt-dropdown-list');
if(dropdownList){
dropdownList.addEventListener('wheel',function(e){
const atTop=this.scrollTop===0;
const atBottom=this.scrollHeight-this.scrollTop===this.clientHeight;
if((e.deltaY<0&&atTop)||(e.deltaY>0&&atBottom)){
e.preventDefault();
}
},{passive:false});
}

// Positionner le dropdown Ã  droite du trigger, alignÃ© avec le haut de la ligne
const triggerRect=triggerElement.getBoundingClientRect();
// Trouver la ligne parente pour aligner le haut
const lineElement=triggerElement.closest('.ligne-content')||triggerElement.closest('div')||triggerElement.parentElement;
const lineRect=lineElement?lineElement.getBoundingClientRect():triggerRect;

dropdown.style.position='fixed';
dropdown.style.left=(triggerRect.right+10)+'px';
dropdown.style.top=lineRect.top+'px';
dropdown.style.transform='none';

// VÃ©rifier si le dropdown dÃ©passe Ã  droite
dropdown.classList.add('active');
const dropdownRect=dropdown.getBoundingClientRect();
if(dropdownRect.right>window.innerWidth-20){
// Afficher Ã  gauche du trigger
dropdown.style.left=(triggerRect.left-dropdownRect.width-10)+'px';
}
// VÃ©rifier si dÃ©passe en bas
if(dropdownRect.bottom>window.innerHeight-20){
dropdown.style.top=(window.innerHeight-dropdownRect.height-20)+'px';
}

setTimeout(()=>document.getElementById('altDropdownInput').focus(),50);

// Ajouter un listener pour la touche EntrÃ©e sur tout le dropdown
dropdown.addEventListener('keydown',function(e){
if(e.key==='Enter'){
e.preventDefault();
e.stopPropagation();
validateAltDropdown(container.id);
}
if(e.key==='Escape'){
e.stopPropagation();
closeAltDropdown();
}
});
}

// Mettre Ã  jour l'input avec les valeurs sÃ©lectionnÃ©es
function updateAltDropdownInput(dropdown){
const selectedItems=dropdown.querySelectorAll('.alt-dropdown-item.selected');
const values=Array.from(selectedItems).map(item=>{
// RÃ©cupÃ©rer le texte original dÃ©codÃ©
let text=decodeURIComponent(item.getAttribute('data-alt-value')||'');
// Remplacer les XXXX par les valeurs remplies
item.querySelectorAll('.xxxx-filled').forEach(filled=>{
text=text.replace(/XXXX\s*%%[^%]+%%|XXXX\s+PROPOSITION\s*:.+?FINI|XXXX/i, filled.textContent);
});
// Nettoyer les marqueurs restants
text=text.replace(/%%[^%]+%%/g,'').replace(/PROPOSITION\s*:.+?FINI/gi,'').trim();
return text;
});
document.getElementById('altDropdownInput').value=values.join(', ');
}

// SÃ©lectionner une option du dropdown (pour sÃ©lection simple - gardÃ©e pour compatibilitÃ©)
function selectAltOption(containerId, value){
const container=document.getElementById(containerId);
if(!container)return;

const textElement=container.querySelector('.alt-text');
const triggerElement=container.querySelector('.alt-trigger');

// Mettre Ã  jour le texte affichÃ©
textElement.innerHTML=renderXXXXSimple(value);

// Mettre Ã  jour les data-alts pour mettre la nouvelle valeur en premier
let alternatives=[];
try{
alternatives=JSON.parse(triggerElement.getAttribute('data-alts'));
}catch(e){}

// RÃ©organiser: mettre la valeur sÃ©lectionnÃ©e en premier
const newAlts=[value,...alternatives.filter(a=>a!==value)];
triggerElement.setAttribute('data-alts',JSON.stringify(newAlts).replace(/'/g,'&#39;'));

closeAltDropdown();
}

// Valider avec texte personnalisÃ© ou sÃ©lections multiples
function validateAltDropdown(containerId){
const input=document.getElementById('altDropdownInput');
let value=input.value.trim();

// Si l'input est vide, rÃ©cupÃ©rer les valeurs des items sÃ©lectionnÃ©s
if(!value){
const dropdown=document.getElementById('altDropdown');
const selectedItems=dropdown.querySelectorAll('.alt-dropdown-item.selected');
if(selectedItems.length>0){
const values=Array.from(selectedItems).map(item=>{
// DÃ©coder la valeur
let text=decodeURIComponent(item.getAttribute('data-alt-value')||'');
// Remplacer les XXXX par les valeurs remplies
item.querySelectorAll('.xxxx-filled').forEach(filled=>{
text=text.replace(/XXXX\s*%%[^%]+%%|XXXX\s+PROPOSITION\s*:.+?FINI|XXXX/i, filled.textContent);
});
// Nettoyer les marqueurs restants
text=text.replace(/%%[^%]+%%/g,'').replace(/PROPOSITION\s*:.+?FINI/gi,'').trim();
return text;
});
value=values.join(', ');
}
}
if(!value){
closeAltDropdown();
return;
}

const container=document.getElementById(containerId);
if(!container)return;

const textElement=container.querySelector('.alt-text');
const triggerElement=container.querySelector('.alt-trigger');

// Mettre Ã  jour avec le texte personnalisÃ©
textElement.textContent=value;

// On peut supprimer le trigger ou le garder
// Ici on le garde mais on met Ã  jour les alternatives
let alternatives=[];
try{
alternatives=JSON.parse(triggerElement.getAttribute('data-alts'));
}catch(e){}

const newAlts=[value,...alternatives];
triggerElement.setAttribute('data-alts',JSON.stringify(newAlts).replace(/'/g,'&#39;'));

closeAltDropdown();
}

function openAlternativeModal(element){
element.id='alt-'+Date.now();

let alternatives=[];
try{
const altsAttr=element.getAttribute('data-alts');
if(altsAttr){
alternatives=JSON.parse(altsAttr);
}
}catch(e){
console.error('Erreur parse alternatives:',e);
}

// Afficher uniquement les alternatives APRÃˆS la premiÃ¨re (qui est dÃ©jÃ  affichÃ©e)
const autresAlternatives=alternatives.slice(1);

// CrÃ©er les chips avec XXXX cliquables directement (avec support des propositions %% %%)
const chipsHtml=autresAlternatives&&autresAlternatives.length>0?`
<div class="proposition-chips">
${autresAlternatives.map((a,idx)=>{
const safeValue=(a||'').replace(/'/g,"\\'");
// Parser les XXXX avec leurs propositions inline %% prop1 / prop2 %%
const displayText=parseXXXXForChips(a||'');
// Pour data-value, enlever les %% %% mais garder XXXX
const cleanValue=(a||'').replace(/\s*%%[^%]+%%/g,'');
return `<div class="chip" data-value="${cleanValue.replace(/"/g,'&quot;')}" data-element-id="${element.id}" onclick="selectAlternativeChip(this)">${displayText}</div>`;
}).join('')}
</div>
`:'';

document.getElementById('alternativeModal').innerHTML=`
<div class="modal-content">
<div class="modal-header">
<span>Choisir une alternative</span>
<span class="modal-close" onclick="closeModal('alternativeModal')">Ã—</span>
</div>
${chipsHtml}
<input type="text" id="alternativeInput" class="modal-input" placeholder="Ou entrez votre texte..." onkeypress="if(event.key==='Enter')validateAlternative('${element.id}')">
<div class="modal-buttons">
<button class="modal-btn modal-btn-secondary" onclick="closeModal('alternativeModal')">Annuler</button>
<button class="modal-btn modal-btn-primary" onclick="validateAlternative('${element.id}')">âœ“ Valider</button>
</div>
</div>
`;
document.getElementById('alternativeModal').classList.add('active');
setTimeout(()=>document.getElementById('alternativeInput').focus(),100);
}

// Fonction pour sÃ©lectionner un chip d'alternative
function selectAlternativeChip(chip){
// Toggle la sÃ©lection du chip
chip.classList.toggle('selected');

// RÃ©cupÃ©rer tous les chips sÃ©lectionnÃ©s
const selectedChips=chip.closest('.proposition-chips').querySelectorAll('.chip.selected');
const values=Array.from(selectedChips).map(c=>c.getAttribute('data-value'));

// Mettre Ã  jour l'input avec les valeurs sÃ©parÃ©es par " + "
document.getElementById('alternativeInput').value=values.join(', ');
}

// Variable pour stocker le chip actuel
let currentChipForXXXX=null;

// Modal XXXX pour les chips d'alternatives
function openXXXXModalForChip(xxxxSpan){
currentChipForXXXX=xxxxSpan.closest('.chip');

// RÃ©cupÃ©rer les propositions si elles existent
let propositions=[];
try{
const propsAttr=xxxxSpan.getAttribute('data-props');
if(propsAttr){
// DÃ©coder avec decodeURIComponent car encodÃ© avec encodeURIComponent
propositions=JSON.parse(decodeURIComponent(propsAttr));
}
}catch(e){
console.error('Erreur parse props:',e);
}

// DÃ©tecter le contexte en regardant le texte AVANT et APRÃˆS le XXXX dans le chip
const prevSibling=xxxxSpan.previousSibling;
const nextSibling=xxxxSpan.nextSibling;

const textBefore=prevSibling?prevSibling.textContent||'':'';
const textAfter=nextSibling?nextSibling.textContent||'':'';

// Date : prÃ©cÃ©dÃ© de "le " isolÃ© (pas "abdominale", "normale", etc.)
const isDate=/(?:^|\s)le\s*$/i.test(textBefore);
// Heure : h doit Ãªtre seul (suivi d'espace, ponctuation ou fin) - pas "habituellement", "hola"
const isTime=/^\s*h(?:\s|$|[,;:.!?)])/i.test(textAfter);

// GÃ©nÃ©rer les chips de propositions
const propsChipsHtml=propositions&&propositions.length>0?`
<div class="proposition-chips">
${propositions.map(p=>`<div class="chip" onclick="selectPropChipForXXXX(this)" data-value="${(p||'').replace(/"/g,'&quot;')}">${p}</div>`).join('')}
</div>
`:'';

// GÃ©nÃ©rer les options date/heure
let dateTimeHtml='';
if(isDate){
const dates=[];
const now=new Date();
for(let i=0;i<15;i++){
const d=new Date(now);
d.setDate(d.getDate()-i);
dates.push(`${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}`);
}
dateTimeHtml=`<div class="datetime-picker"><label>Date :</label><select id="dateSelect2" onchange="document.getElementById('xxxxInput2').value=this.value"><option value="">Choisir...</option>${dates.map(d=>`<option value="${d}">${d}</option>`).join('')}</select></div>`;
}
if(isTime){
const now=new Date();
const times=['00h00','00h30','01h00','01h30','02h00','02h30','03h00','03h30','04h00','04h30','05h00','05h30','06h00','06h30','07h00','07h30','08h00','08h30','09h00','09h30','10h00','10h30','11h00','11h30','12h00','12h30','13h00','13h30','14h00','14h30','15h00','15h30','16h00','16h30','17h00','17h30','18h00','18h30','19h00','19h30','20h00','20h30','21h00','21h30','22h00','22h30','23h00','23h30'];
const currentHour=now.getHours();
const currentMin=now.getMinutes();
const currentTimeStr=String(currentHour).padStart(2,'0')+'h'+(currentMin>=30?'30':'00');
let timeSlots='';
times.forEach(t=>{
const isCurrent=t===currentTimeStr;
timeSlots+=`<div class="time-slot${isCurrent?' current':''}" onclick="selectTimeSlotOnly2('${t}')">${t}</div>`;
});
dateTimeHtml=`
<div class="calendar-container">
<div class="calendar-header">â° SÃ©lectionner l'heure</div>
<div class="time-picker-grid">
${timeSlots}
</div>
</div>`;
}

document.getElementById('xxxxModal2').innerHTML=`
<div class="modal-content">
<div class="modal-header">
<span>Remplir le champ${isDate?' (Date)':isTime?' (Heure)':''}</span>
<span class="modal-close" onclick="closeModal('xxxxModal2')">Ã—</span>
</div>
${propsChipsHtml}
${dateTimeHtml}
<input type="text" id="xxxxInput2" class="modal-input" placeholder="${isDate?'JJ/MM':isTime?'HHhMM':'Entrez...'}" onkeypress="if(event.key==='Enter')validateXXXXForChip()">
<div class="modal-buttons">
<button class="modal-btn modal-btn-secondary" onclick="closeModal('xxxxModal2')">Annuler</button>
<button class="modal-btn modal-btn-primary" onclick="validateXXXXForChip()">âœ“ Valider</button>
</div>
</div>
`;
document.getElementById('xxxxModal2').classList.add('active');
setTimeout(()=>document.getElementById('xxxxInput2').focus(),100);
}

// SÃ©lectionner une proposition pour XXXX dans les chips
function selectPropChipForXXXX(chip){
const value=chip.getAttribute('data-value');
document.getElementById('xxxxInput2').value=value;
// Highlight le chip sÃ©lectionnÃ©
chip.closest('.proposition-chips').querySelectorAll('.chip').forEach(c=>c.classList.remove('selected'));
chip.classList.add('selected');
}

function validateXXXXForChip(){
const value=document.getElementById('xxxxInput2').value.trim();
if(value&&currentChipForXXXX){
// Mettre Ã  jour la data-value du chip
let chipValue=currentChipForXXXX.getAttribute('data-value');
chipValue=chipValue.replace('XXXX',value);
currentChipForXXXX.setAttribute('data-value',chipValue);

// Mettre Ã  jour l'affichage du chip (remplacer le premier xxxx-in-chip)
const xxxxSpans=currentChipForXXXX.querySelectorAll('.xxxx-in-chip');
if(xxxxSpans.length>0){
xxxxSpans[0].outerHTML=value;
}

// Mettre Ã  jour l'input
const altInput=document.getElementById('alternativeInput');
if(altInput&&altInput.value.includes('XXXX')){
altInput.value=altInput.value.replace('XXXX',value);
}
}
currentChipForXXXX=null;
closeModal('xxxxModal2');
}

function fillAlternative(elementId,value){
// Remplir le champ input
document.getElementById('alternativeInput').value=value;
// Directement valider et remplacer dans l'Ã©lÃ©ment
const element=document.getElementById(elementId);
if(element){
// Si la valeur contient des XXXX, les rendre cliquables
if(value.includes('XXXX')){
element.innerHTML=value.replace(/XXXX/g,'<span class="xxxx" onclick="openXXXXModal(this)">XXXX</span>');
}else{
element.textContent=value;
}
element.classList.remove('alternative');
element.style.background='transparent';
element.style.boxShadow='none';
element.style.animation='none';
element.style.color='inherit';
element.style.fontWeight='inherit';
element.onclick=null;
element.removeAttribute('data-alts');
}
closeModal('alternativeModal');
}

function validateAlternative(elementId){
const value=document.getElementById('alternativeInput').value.trim();
if(value){
const element=document.getElementById(elementId);
if(element){
// Si la valeur contient des XXXX, les rendre cliquables
if(value.includes('XXXX')){
element.innerHTML=value.replace(/XXXX/g,'<span class="xxxx" onclick="openXXXXModal(this)">XXXX</span>');
}else{
element.textContent=value;
}
element.classList.remove('alternative');
element.style.background='transparent';
element.style.boxShadow='none';
element.style.animation='none';
element.style.color='inherit';
element.style.fontWeight='inherit';
element.onclick=null;
element.removeAttribute('data-alts');
}
}
closeModal('alternativeModal');
}

function openModal(modalId){
document.getElementById(modalId).classList.add('active');
}

function closeModal(modalId){
document.getElementById(modalId).classList.remove('active');
}

function copyText(text){
navigator.clipboard.writeText(text);
toast('âœ… CopiÃ© !');
}

function deleteModule(btn){
const module=btn.closest('.module');
if(module){
// Animation de suppression
module.style.transition='all 0.3s';
module.style.opacity='0';
module.style.transform='translateX(-20px)';
setTimeout(()=>{
module.remove();
showToast('ðŸ—‘ï¸ Module supprimÃ©');
},300);
}
}

function copyModule(moduleType){
if(!state.conclusion||!state.conclusion.modules)return;

const module=state.conclusion.modules.find(m=>m.type===moduleType);
if(!module)return;

let text='';

if(module.type==='hdm'){
// Pour HDM : rÃ©cupÃ©rer depuis le DOM sans les titres de sections
const hdmDiv=document.querySelector(`[data-module-content="hdm"]`);
if(hdmDiv){
const sections=hdmDiv.querySelectorAll('.hdm-section-content');
text=Array.from(sections).map(section=>{
const clone=section.cloneNode(true);
clone.querySelectorAll('.comment').forEach(el=>el.remove());
return cleanTextFromDOM(clone);
}).filter(s=>s).join('\n\n');
}
}else{
// Pour les autres modules : rÃ©cupÃ©rer depuis le DOM
const moduleDiv=document.querySelector(`[data-module-content="${moduleType}"]`);
if(moduleDiv){
const clone=moduleDiv.cloneNode(true);
clone.querySelectorAll('.comment').forEach(el=>el.remove());
clone.querySelectorAll('.conduite-number').forEach(el=>el.remove());
clone.querySelectorAll('.conduite-actions').forEach(el=>el.remove());
clone.querySelectorAll('.conduite-add-line').forEach(el=>el.remove());
text=cleanTextFromDOM(clone);
}
}

copyText(text.trim());
}

function copyHDM(){
if(!state.conclusion||!state.conclusion.modules)return;

const hdmModule=state.conclusion.modules.find(m=>m.type==='hdm');
if(!hdmModule)return;

let text='';

const hdmDiv=document.querySelector(`[data-module-content="hdm"]`);
if(hdmDiv){
const sections=hdmDiv.querySelectorAll('.hdm-section-content');
text=Array.from(sections).map(section=>{
const clone=section.cloneNode(true);
clone.querySelectorAll('.comment').forEach(el=>el.remove());
return cleanTextFromDOM(clone);
}).filter(s=>s).join('\n\n');
}

copyText(text.trim());
}

function copyExamen(){
if(!state.conclusion||!state.conclusion.modules)return;

const examenModules=state.conclusion.modules.filter(m=>
m.type.startsWith('examen_')
);

let text='';
let addedModules=0;

examenModules.forEach((module)=>{
// VÃ©rifier si le module existe encore dans le DOM
const moduleContainer=document.querySelector(`[data-module-type="${module.type}"]`);
if(!moduleContainer)return; // Module supprimÃ©, on l'ignore

const moduleDiv=document.querySelector(`[data-module-content="${module.type}"]`);
let moduleText='';
if(moduleDiv){
const clone=moduleDiv.cloneNode(true);
clone.querySelectorAll('.comment').forEach(el=>el.remove());
moduleText=cleanTextFromDOM(clone).trim();
}

// Ne copier que si le contenu n'est pas vide
if(moduleText){
if(addedModules>0)text+='\n\n';
const titre=module.titre?module.titre.replace(/^[^a-zA-ZÃ€-Ã¿]+/,'').trim():'';
if(titre)text+=titre.toUpperCase()+'\n';
text+=moduleText;
addedModules++;
}
});

// Ajouter le module de note si checkbox cochÃ©e et contenu non vide
const includeNote=document.getElementById('includeNoteCheckbox');
const noteContent=document.querySelector('[data-module-content="note_examen"]');
if(includeNote&&includeNote.checked&&noteContent){
const noteText=(noteContent.innerText||noteContent.textContent||'').trim();
if(noteText){
if(addedModules>0)text+='\n\n';
text+=noteText;
}
}

copyText(text.trim());
}

function copyConclusion(){
if(!state.conclusion)return;

// Liste des types de modules de conclusion dans l'ordre
const conclusionTypes=['diagnostic','signes_gravite','soins_urgences','conduite_tenir','conseils','suivi','consignes_reconsultation'];

let text='';
let addedModules=0;

conclusionTypes.forEach((moduleType)=>{
// VÃ©rifier si le module existe dans le DOM
const moduleContainer=document.querySelector(`[data-module-type="${moduleType}"]`);
if(!moduleContainer)return;

// Extraire le texte depuis le DOM
const moduleDiv=document.querySelector(`[data-module-content="${moduleType}"]`);
let moduleText='';
if(moduleDiv){
const clone=moduleDiv.cloneNode(true);
clone.querySelectorAll('.comment').forEach(el=>el.remove());
clone.querySelectorAll('.conduite-number').forEach(el=>el.remove());
clone.querySelectorAll('.conduite-actions').forEach(el=>el.remove());
clone.querySelectorAll('.conduite-add-line').forEach(el=>el.remove());
moduleText=cleanTextFromDOM(clone).trim();
}

// Ne copier que si le contenu n'est pas vide
if(moduleText){
if(addedModules>0)text+='\n\n';

// Modules sans titre : diagnostic et signes_gravite
const modulesWithoutTitle=['diagnostic','signes_gravite'];
const showTitle=!modulesWithoutTitle.includes(moduleType);

// RÃ©cupÃ©rer le titre depuis le DOM
if(showTitle){
const titleEl=moduleContainer.querySelector('.module-title');
if(titleEl){
let titre=titleEl.textContent.replace(/^[^a-zA-ZÃ€-Ã¿]+/,'').trim();
if(titre)text+=titre.toUpperCase()+'\n';
}
}

text+=moduleText;
addedModules++;
}
});

copyText(text.trim());
}

// Fonction utilitaire pour nettoyer et extraire le texte du DOM
function cleanTextFromDOM(element){
// Parcourir les lignes du module pour prÃ©server les retours Ã  la ligne
const lines=[];

// Chercher les lignes de module
const moduleLines=element.querySelectorAll('.module-line');
if(moduleLines.length>0){
moduleLines.forEach(line=>{
const clone=line.cloneNode(true);
clone.querySelectorAll('.comment').forEach(el=>el.remove());
const text=(clone.innerText||clone.textContent||'').trim();
if(text)lines.push(text);
});
return lines.join('\n');
}

// Chercher les lignes de conduite
const conduiteLines=element.querySelectorAll('.conduite-line');
if(conduiteLines.length>0){
conduiteLines.forEach(line=>{
const textSpan=line.querySelector('.conduite-text');
if(textSpan){
const clone=textSpan.cloneNode(true);
clone.querySelectorAll('.comment').forEach(el=>el.remove());
const text=(clone.innerText||clone.textContent||'').trim();
if(text)lines.push(text);
}
});
return lines.join('\n');
}

// Chercher les divs enfants directs (pour contenteditable modifiÃ©)
const childDivs=element.querySelectorAll(':scope > div');
if(childDivs.length>0){
childDivs.forEach(div=>{
const clone=div.cloneNode(true);
clone.querySelectorAll('.comment').forEach(el=>el.remove());
const text=(clone.innerText||clone.textContent||'').trim();
if(text)lines.push(text);
});
if(lines.length>0)return lines.join('\n');
}

// Fallback : sÃ©parer par les <br> ou les retours Ã  la ligne
let html=element.innerHTML||'';
// Remplacer les <br> par des marqueurs de ligne
html=html.replace(/<br\s*\/?>/gi,'\n');
// Remplacer les </div><div> par des retours Ã  la ligne
html=html.replace(/<\/div>\s*<div/gi,'\n<div');
// CrÃ©er un Ã©lÃ©ment temporaire pour extraire le texte
const temp=document.createElement('div');
temp.innerHTML=html;
// Supprimer les commentaires
temp.querySelectorAll('.comment').forEach(el=>el.remove());
let text=temp.innerText||temp.textContent||'';
text=text.split('\n').map(line=>line.trim()).filter(line=>line!=='').join('\n');

return text.trim();
}

function extractLigneText(ligne){
if(!ligne)return'';
// Pour les lignes avec elements (structure standard)
if(ligne.elements&&Array.isArray(ligne.elements)){
return ligne.elements.filter(e=>!e.commentaire).map(e=>e.texte||'').join('').trim();
}
// Pour les conduiteLines qui utilisent .text
if(ligne.text)return ligne.text.trim();
// Pour les lignes simples avec .texte
if(ligne.texte)return ligne.texte.trim();
return'';
}

function copyAll(){
if(!state.conclusion)return;
let text='';
let addedExamenModules=0;

// Copier l'examen
const examenModules=state.conclusion.modules.filter(m=>
m.type==='hdm'||m.type.startsWith('examen_')
);

examenModules.forEach((module)=>{
// VÃ©rifier si le module existe encore dans le DOM
const moduleContainer=document.querySelector(`[data-module-type="${module.type}"]`);
if(!moduleContainer)return; // Module supprimÃ©, on l'ignore

if(module.type==='hdm'){
const hdmDiv=document.querySelector(`[data-module-content="hdm"]`);
if(hdmDiv){
const sections=hdmDiv.querySelectorAll('.hdm-section-content');
const sectionsText=Array.from(sections).map(section=>{
const clone=section.cloneNode(true);
clone.querySelectorAll('.comment').forEach(el=>el.remove());
return cleanTextFromDOM(clone);
}).filter(s=>s.trim()).join('\n\n');
if(sectionsText.trim()){
if(addedExamenModules>0)text+='\n\n';
text+=sectionsText;
addedExamenModules++;
}
}
}else{
const moduleDiv=document.querySelector(`[data-module-content="${module.type}"]`);
let moduleText='';
if(moduleDiv){
const clone=moduleDiv.cloneNode(true);
clone.querySelectorAll('.comment').forEach(el=>el.remove());
moduleText=cleanTextFromDOM(clone).trim();
}
if(moduleText){
if(addedExamenModules>0)text+='\n\n';
const titre=module.titre?module.titre.replace(/^[^a-zA-ZÃ€-Ã¿]+/,'').trim():'';
if(titre)text+=titre.toUpperCase()+'\n';
text+=moduleText;
addedExamenModules++;
}
}
});

// Ajouter le module de note si checkbox cochÃ©e et contenu non vide
const includeNote=document.getElementById('includeNoteCheckbox');
const noteContent=document.querySelector('[data-module-content="note_examen"]');
if(includeNote&&includeNote.checked&&noteContent){
const noteText=(noteContent.innerText||noteContent.textContent||'').trim();
if(noteText){
if(addedExamenModules>0)text+='\n\n';
text+=noteText;
}
}

text+='\n\n---\n\n';

// Copier la conclusion - parcourir les types de modules dans l'ordre
const conclusionTypes=['diagnostic','signes_gravite','soins_urgences','conduite_tenir','conseils','suivi','consignes_reconsultation'];
const modulesWithoutTitle=['diagnostic','signes_gravite'];
let addedConclusionModules=0;

conclusionTypes.forEach((moduleType)=>{
// VÃ©rifier si le module existe dans le DOM
const moduleContainer=document.querySelector(`[data-module-type="${moduleType}"]`);
if(!moduleContainer)return;

const moduleDiv=document.querySelector(`[data-module-content="${moduleType}"]`);
let moduleText='';
if(moduleDiv){
const clone=moduleDiv.cloneNode(true);
clone.querySelectorAll('.comment').forEach(el=>el.remove());
clone.querySelectorAll('.conduite-number').forEach(el=>el.remove());
clone.querySelectorAll('.conduite-actions').forEach(el=>el.remove());
clone.querySelectorAll('.conduite-add-line').forEach(el=>el.remove());
moduleText=cleanTextFromDOM(clone).trim();
}

if(moduleText){
if(addedConclusionModules>0)text+='\n\n';
const showTitle=!modulesWithoutTitle.includes(moduleType);
if(showTitle){
const titleEl=moduleContainer.querySelector('.module-title');
if(titleEl){
let titre=titleEl.textContent.replace(/^[^a-zA-ZÃ€-Ã¿]+/,'').trim();
if(titre)text+=titre.toUpperCase()+'\n';
}
}
text+=moduleText;
addedConclusionModules++;
}
});

copyText(text.trim());
}

function openThemeModal(){
const currentTheme=document.documentElement.getAttribute('data-theme')||'default';
document.querySelectorAll('.theme-option').forEach(opt=>{
opt.classList.toggle('active',opt.getAttribute('data-theme')===currentTheme);
});
document.getElementById('themeModal').classList.add('active');
}

function setTheme(theme){
if(theme==='default'){
document.documentElement.removeAttribute('data-theme');
}else{
document.documentElement.setAttribute('data-theme',theme);
}
localStorage.setItem('medicalAppTheme',theme);
document.querySelectorAll('.theme-option').forEach(opt=>{
opt.classList.toggle('active',opt.getAttribute('data-theme')===theme);
});
closeModal('themeModal');
toast('âœ… ThÃ¨me appliquÃ©');
}

function loadSavedTheme(){
const savedTheme=localStorage.getItem('medicalAppTheme');
if(savedTheme&&savedTheme!=='default'){
document.documentElement.setAttribute('data-theme',savedTheme);
}
}

loadSavedTheme();

// ============================================================
// CALCULATRICE MÃ‰DICALE
// ============================================================

let calcValue = '0';

function openCalculator() {
    calcValue = '0';
    document.getElementById('calcDisplay').value = '0';
    document.getElementById('calculatorModal').classList.add('active');
}

function calcInput(val) {
    if (calcValue === '0' && val !== '.') {
        calcValue = val;
    } else {
        calcValue += val;
    }
    document.getElementById('calcDisplay').value = calcValue;
}

function calcClear() {
    calcValue = '0';
    document.getElementById('calcDisplay').value = '0';
}

function calcBackspace() {
    if (calcValue.length > 1) {
        calcValue = calcValue.slice(0, -1);
    } else {
        calcValue = '0';
    }
    document.getElementById('calcDisplay').value = calcValue;
}

function calcEquals() {
    try {
        const result = eval(calcValue.replace(/Ã—/g, '*').replace(/Ã·/g, '/').replace(/âˆ’/g, '-'));
        calcValue = String(Math.round(result * 1000000) / 1000000);
        document.getElementById('calcDisplay').value = calcValue;
    } catch (e) {
        document.getElementById('calcDisplay').value = 'Erreur';
        calcValue = '0';
    }
}

function calcIMC() {
    const poids = prompt('Poids (kg):');
    const taille = prompt('Taille (cm):');
    if (poids && taille) {
        const tailleM = parseFloat(taille) / 100;
        const imc = parseFloat(poids) / (tailleM * tailleM);
        let interpretation = '';
        if (imc < 18.5) interpretation = 'Insuffisance pondÃ©rale';
        else if (imc < 25) interpretation = 'Poids normal';
        else if (imc < 30) interpretation = 'Surpoids';
        else if (imc < 35) interpretation = 'ObÃ©sitÃ© modÃ©rÃ©e';
        else if (imc < 40) interpretation = 'ObÃ©sitÃ© sÃ©vÃ¨re';
        else interpretation = 'ObÃ©sitÃ© morbide';
        calcValue = imc.toFixed(2);
        document.getElementById('calcDisplay').value = calcValue;
        toast(`IMC: ${calcValue} kg/mÂ² (${interpretation})`);
    }
}

function calcClearanceCreat() {
    const age = prompt('Ã‚ge (annÃ©es):');
    const poids = prompt('Poids (kg):');
    const creat = prompt('CrÃ©atinine (Âµmol/L):');
    const sexe = prompt('Sexe (H/F):');
    if (age && poids && creat && sexe) {
        const k = sexe.toUpperCase() === 'F' ? 1.04 : 1.23;
        const cl = ((140 - parseFloat(age)) * parseFloat(poids) * k) / parseFloat(creat);
        calcValue = cl.toFixed(1);
        document.getElementById('calcDisplay').value = calcValue;
        let interpretation = '';
        if (cl >= 90) interpretation = 'Fonction rÃ©nale normale';
        else if (cl >= 60) interpretation = 'IRC lÃ©gÃ¨re';
        else if (cl >= 30) interpretation = 'IRC modÃ©rÃ©e';
        else if (cl >= 15) interpretation = 'IRC sÃ©vÃ¨re';
        else interpretation = 'IRC terminale';
        toast(`Clairance: ${calcValue} mL/min (${interpretation})`);
    }
}

function calcSurfaceCorp() {
    const poids = prompt('Poids (kg):');
    const taille = prompt('Taille (cm):');
    if (poids && taille) {
        // Formule de Mosteller
        const sc = Math.sqrt((parseFloat(poids) * parseFloat(taille)) / 3600);
        calcValue = sc.toFixed(2);
        document.getElementById('calcDisplay').value = calcValue;
        toast(`Surface corporelle: ${calcValue} mÂ²`);
    }
}

// Toggle une section de calcul (gardÃ© pour compatibilitÃ©)
function toggleCalcSection(sectionId) {
    const section = document.getElementById(sectionId);
    if (section) {
        section.closest('.calc-section').classList.toggle('open');
    }
}

// QTc avec prompts
function calcQTc() {
    const unite = prompt('UnitÃ© du QT mesurÃ© :\n1 = mm (Ã  25mm/s)\n2 = ms (millisecondes)\n3 = s (secondes)');
    if (!unite) return;
    
    let qtLabel = '';
    if (unite === '1') qtLabel = 'QT en mm (Ã  25mm/s):';
    else if (unite === '2') qtLabel = 'QT en ms:';
    else if (unite === '3') qtLabel = 'QT en secondes:';
    else { toast('UnitÃ© non reconnue', 'error'); return; }
    
    const qtInput = prompt(qtLabel);
    const fc = prompt('FrÃ©quence cardiaque (bpm):');
    
    if (qtInput && fc) {
        let qtMs;
        const qtVal = parseFloat(qtInput);
        const fcVal = parseFloat(fc);
        
        if (unite === '1') qtMs = (qtVal / 25) * 1000;
        else if (unite === '2') qtMs = qtVal;
        else if (unite === '3') qtMs = qtVal * 1000;
        
        const rr = 60 / fcVal;
        const qtc = qtMs / Math.sqrt(rr);
        
        calcValue = Math.round(qtc).toString();
        document.getElementById('calcDisplay').value = calcValue;
        
        let interpretation = '';
        if (qtc < 350) interpretation = 'QT court';
        else if (qtc <= 440) interpretation = 'Normal';
        else if (qtc <= 460) interpretation = 'Limite (F) / AllongÃ© (H)';
        else if (qtc <= 500) interpretation = 'AllongÃ©';
        else interpretation = 'âš ï¸ TrÃ¨s allongÃ© (risque TdP)';
        
        toast(`QTc (Bazett): ${calcValue} ms - ${interpretation}`);
    }
}

// Dose par prise avec prompts
function calcDoseParPrise() {
    const poids = prompt('Poids (kg):');
    const poso = prompt('Posologie (mg/kg/jour):');
    const nbPrises = prompt('Nombre de prises par jour:');
    
    if (poids && poso && nbPrises) {
        const p = parseFloat(poids);
        const ps = parseFloat(poso);
        const nb = parseFloat(nbPrises);
        
        if (p <= 0 || ps <= 0 || nb <= 0) {
            toast('Valeurs invalides', 'error');
            return;
        }
        
        const doseJournaliere = p * ps;
        const doseParPrise = doseJournaliere / nb;
        
        calcValue = doseParPrise.toFixed(1);
        document.getElementById('calcDisplay').value = calcValue;
        
        toast(`Dose/prise: ${calcValue} mg (Total: ${doseJournaliere.toFixed(1)} mg/j)`);
    }
}

// Besoins hydriques mÃ©thode 4-2-1 avec prompt
function calcBesoinsHydriques() {
    const poids = prompt('Poids (kg):');
    
    if (poids) {
        const p = parseFloat(poids);
        if (p <= 0) {
            toast('Poids invalide', 'error');
            return;
        }
        
        let besoinHoraire = 0;
        if (p <= 10) {
            besoinHoraire = p * 4;
        } else if (p <= 20) {
            besoinHoraire = 40 + (p - 10) * 2;
        } else {
            besoinHoraire = 40 + 20 + (p - 20) * 1;
        }
        
        const besoinJournalier = besoinHoraire * 24;
        
        calcValue = besoinHoraire.toFixed(0);
        document.getElementById('calcDisplay').value = calcValue;
        
        toast(`Besoins: ${calcValue} mL/h (${besoinJournalier.toFixed(0)} mL/24h)`);
    }
}

function calcPertePoids() {
    const poidsInitial = prompt('Poids initial (kg):');
    const poidsActuel = prompt('Poids actuel (kg):');
    
    if (poidsInitial && poidsActuel) {
        const initial = parseFloat(poidsInitial);
        const actuel = parseFloat(poidsActuel);
        const perte = initial - actuel;
        const pourcentage = (perte / initial) * 100;
        
        calcValue = pourcentage.toFixed(1);
        document.getElementById('calcDisplay').value = calcValue;
        
        let interpretation = '';
        if (pourcentage < 0) interpretation = 'Prise de poids';
        else if (pourcentage < 5) interpretation = 'Perte lÃ©gÃ¨re';
        else if (pourcentage < 10) interpretation = 'Perte modÃ©rÃ©e';
        else interpretation = 'âš ï¸ Perte sÃ©vÃ¨re';
        
        toast(`Perte: ${perte.toFixed(1)} kg (${calcValue}%) - ${interpretation}`);
    }
}

// ============================================================
// GESTION DES ALTERNATIVES DE MODULES
// ============================================================

// Cache pour stocker les alternatives chargÃ©es
let alternativesCache = null;
let pendingDiagnosticAlt = null;

// Charger les alternatives depuis l'API
async function loadAlternatives() {
    if (alternativesCache) return alternativesCache;
    if (!state.motifPrincipal) return {};
    
    try {
        const url = `${API_URL}/alternatives/${state.motifPrincipal.table}/${state.motifPrincipal.id}`;
        console.log('ðŸ”„ Chargement alternatives:', url);
        const r = await fetch(url);
        const data = await r.json();
        alternativesCache = data.alternatives || {};
        
        console.log('âœ… Alternatives reÃ§ues:', Object.keys(alternativesCache));
        console.log('ðŸ“¦ DÃ©tail:', alternativesCache);
        
        // Mettre Ã  jour les boutons qui ont des alternatives
        updateAlternativeButtons();
        
        return alternativesCache;
    } catch (e) {
        console.error('âŒ Erreur chargement alternatives:', e);
        return {};
    }
}

// Mettre Ã  jour l'apparence des boutons qui ont des alternatives
function updateAlternativeButtons() {
    document.querySelectorAll('.module-alt-btn').forEach(btn => {
        const moduleType = btn.getAttribute('data-module-alt');
        if (alternativesCache && alternativesCache[moduleType] && alternativesCache[moduleType].length > 0) {
            btn.classList.add('has-alternatives');
        } else {
            btn.classList.remove('has-alternatives');
        }
    });
}

// Ouvrir le modal des alternatives
async function openAlternativesModal(moduleType) {
    const alternatives = await loadAlternatives();
    const moduleAlts = alternatives[moduleType] || [];
    
    // Mapping des noms de modules pour l'affichage
    const moduleNames = {
        'hdm_motif': 'Histoire - Motif',
        'hdm_signes_associes': 'Histoire - Signes associÃ©s',
        'hdm_contexte': 'Histoire - Contexte',
        'hdm_soins_anterieurs': 'Histoire - Soins antÃ©rieurs',
        'examen_cardiologique': 'Examen Cardiologique',
        'examen_pneumologique': 'Examen Pneumologique',
        'examen_neurologique': 'Examen Neurologique',
        'examen_digestif': 'Examen Digestif',
        'examen_urologique': 'Examen Urologique',
        'examen_traumatologique': 'Examen Traumatologique',
        'examen_dermatologique': 'Examen Dermatologique',
        'examen_ophtalmologique': 'Examen Ophtalmologique',
        'examen_orl': 'Examen ORL',
        'diagnostic': 'Diagnostic',
        'signes_gravite': 'Signes de GravitÃ©',
        'soins_urgences': 'Soins aux Urgences',
        'conduite_tenir': 'Conduite Ã  Tenir',
        'conseils': 'Conseils',
        'suivi': 'Suivi',
        'consignes_reconsultation': 'Consignes de Reconsultation'
    };
    
    const moduleName = moduleNames[moduleType] || moduleType;
    
    let contentHtml = '';
    
    if (moduleAlts.length === 0) {
        contentHtml = `<div class="alternative-no-data">
            <p>ðŸ“­ Aucune alternative disponible pour ce module</p>
            <p style="font-size:12px;margin-top:10px">Les alternatives seront ajoutÃ©es prochainement</p>
        </div>`;
    } else {
        contentHtml = `<div class="alternatives-list">
            ${moduleAlts.map((alt, idx) => {
                const preview = alt.is_diagnostic 
                    ? (alt.modules && alt.modules.diagnostic ? alt.modules.diagnostic.substring(0, 100) + '...' : 'Diagnostic alternatif complet')
                    : (alt.texte ? alt.texte.substring(0, 100) + '...' : '');
                return `
                <div class="alternative-item" onclick="selectAlternative('${moduleType}', ${idx})">
                    <div class="alternative-item-title">${alt.titre}</div>
                    <div class="alternative-item-preview">${preview}</div>
                </div>
                `;
            }).join('')}
        </div>`;
    }
    
    document.getElementById('alternativesModal').innerHTML = `
        <div class="modal-content modal-alternatives">
            <div class="modal-header">
                <span>ðŸ”„ Alternatives - ${moduleName}</span>
                <span class="modal-close" onclick="closeModal('alternativesModal')">Ã—</span>
            </div>
            ${contentHtml}
        </div>
    `;
    
    document.getElementById('alternativesModal').classList.add('active');
}

// SÃ©lectionner une alternative
function selectAlternative(moduleType, altIndex) {
    const alternatives = alternativesCache[moduleType];
    if (!alternatives || !alternatives[altIndex]) return;
    
    const alt = alternatives[altIndex];
    
    // Fermer le modal des alternatives
    closeModal('alternativesModal');
    
    // Appliquer directement l'alternative au module (mÃªme pour diagnostic)
    if (alt.is_diagnostic && alt.modules && alt.modules[moduleType]) {
        applyAlternativeToModule(moduleType, alt.modules[moduleType]);
    } else if (alt.texte) {
        applyAlternativeToModule(moduleType, alt.texte);
    }
    
    toast(`âœ… ${moduleType.replace('_', ' ')} modifiÃ©`);
}

// Ouvrir le modal pour modifier tous les modules d'un type (examen ou conclusion)
async function openModifyAllModulesModal(type) {
    const alternatives = await loadAlternatives();
    
    // DÃ©finir les modules selon le type
    const examenModules = ['hdm_motif', 'hdm_signes_associes', 'hdm_contexte', 'hdm_soins_anterieurs', 
                           'examen_cardiologique', 'examen_pneumologique', 'examen_neurologique', 
                           'examen_digestif', 'examen_urologique', 'examen_traumatologique', 
                           'examen_dermatologique', 'examen_ophtalmologique', 'examen_orl'];
    const conclusionModules = ['diagnostic', 'signes_gravite', 'soins_urgences', 'conduite_tenir', 
                               'conseils', 'suivi', 'consignes_reconsultation'];
    
    const modulesToShow = type === 'examen' ? examenModules : conclusionModules;
    
    // Collecter toutes les alternatives et les grouper par titre
    let altsByTitle = {};
    
    modulesToShow.forEach(moduleType => {
        const moduleAlts = alternatives[moduleType] || [];
        moduleAlts.forEach(alt => {
            const titre = alt.titre;
            if (!altsByTitle[titre]) {
                altsByTitle[titre] = {
                    titre: titre,
                    modules: {}
                };
            }
            // Stocker le texte pour ce module
            if (alt.is_diagnostic && alt.modules) {
                // Alternative avec plusieurs sous-modules
                Object.assign(altsByTitle[titre].modules, alt.modules);
            } else {
                altsByTitle[titre].modules[moduleType] = alt.texte;
            }
        });
    });
    
    // Convertir en tableau
    const groupedAlts = Object.values(altsByTitle);
    
    // Stocker pour utilisation lors du clic
    window.currentGroupedAlternatives = groupedAlts;
    
    let contentHtml = '';
    
    if (groupedAlts.length === 0) {
        contentHtml = `<div class="modify-no-alts">
            <p>ðŸ“­ Aucune alternative disponible</p>
            <p style="font-size:12px;margin-top:10px;opacity:0.7">Utilisez les boutons ðŸ”„ sur chaque module</p>
        </div>`;
    } else {
        contentHtml = '<div class="modify-alts-list">';
        groupedAlts.forEach((group, idx) => {
            const moduleCount = Object.keys(group.modules).length;
            const moduleLabel = moduleCount > 1 ? `${moduleCount} modules` : '1 module';
            
            contentHtml += `
                <div class="modify-alt-item">
                    <div class="modify-alt-header">
                        <span class="modify-alt-title">${group.titre}</span>
                        <span class="modify-alt-module">${moduleLabel}</span>
                    </div>
                    <div class="modify-alt-actions">
                        <button class="modify-alt-btn modify-alt-add" onclick="applyGroupedAlternative(${idx}, 'add')">
                            âž• Ajouter
                        </button>
                        <button class="modify-alt-btn modify-alt-replace" onclick="applyGroupedAlternative(${idx}, 'replace')">
                            ðŸ”„ Remplacer
                        </button>
                    </div>
                </div>
            `;
        });
        contentHtml += '</div>';
    }
    
    document.getElementById('modifyModulesModal').innerHTML = `
        <div class="modal-content modal-modify-modules">
            <div class="modal-header">
                <span>ðŸ”„ Modifier - ${type === 'examen' ? 'Examen' : 'Conclusion'}</span>
                <span class="modal-close" onclick="closeModal('modifyModulesModal')">Ã—</span>
            </div>
            ${contentHtml}
        </div>
    `;
    
    document.getElementById('modifyModulesModal').classList.add('active');
}

// Appliquer une alternative groupÃ©e (tous les modules avec le mÃªme titre)
function applyGroupedAlternative(groupIndex, action) {
    const group = window.currentGroupedAlternatives[groupIndex];
    if (!group) return;
    
    closeModal('modifyModulesModal');
    
    let count = 0;
    for (const [moduleType, texte] of Object.entries(group.modules)) {
        if (texte) {
            if (action === 'add') {
                addTextToModule(moduleType, texte);
            } else {
                applyAlternativeToModule(moduleType, texte);
            }
            count++;
        }
    }
    
    toast(`âœ… ${count} module${count > 1 ? 's' : ''} ${action === 'add' ? 'complÃ©tÃ©' : 'remplacÃ©'}${count > 1 ? 's' : ''}`);
}

// Ajouter du texte Ã  un module (sans remplacer l'existant)
function addTextToModule(moduleType, newText) {
    const moduleContent = document.querySelector(`[data-module-content="${moduleType}"]`);
    
    if (moduleContent) {
        // SÃ©parer les lignes par .. ou \n
        const lines = newText.split(/\.\.|[\n]/).filter(l => l.trim());
        
        // Parser chaque ligne et l'ajouter
        lines.forEach(line => {
            const parsedLine = parseTextForAlternativeDisplay(line.trim());
            const newLineDiv = document.createElement('div');
            newLineDiv.className = 'module-line';
            newLineDiv.innerHTML = parsedLine;
            
            // Animation visuelle
            newLineDiv.style.transition = 'background 0.3s';
            newLineDiv.style.background = 'rgba(16, 185, 129, 0.2)';
            setTimeout(() => {
                newLineDiv.style.background = '';
            }, 500);
            
            moduleContent.appendChild(newLineDiv);
        });
    }
}

// Ancienne fonction gardÃ©e pour compatibilitÃ©
function openDiagnosticChoiceModal() {
    // Rediriger vers la nouvelle logique
    if (pendingDiagnosticAlt && pendingDiagnosticAlt.modules && pendingDiagnosticAlt.modules.diagnostic) {
        applyAlternativeToModule('diagnostic', pendingDiagnosticAlt.modules.diagnostic);
        toast('âœ… Diagnostic modifiÃ©');
    }
    pendingDiagnosticAlt = null;
}

// Appliquer le texte alternatif Ã  un module avec parsing des marqueurs
function applyAlternativeToModule(moduleType, newText) {
    // Trouver le module-content correspondant
    const moduleContent = document.querySelector(`[data-module-content="${moduleType}"]`);
    
    if (moduleContent) {
        // Remplacer le contenu
        // Pour conduite_tenir, c'est plus complexe car il y a des lignes avec des contrÃ´les
        if (moduleType === 'conduite_tenir') {
            // SÃ©parer les lignes par .. ou \n
            const lines = newText.split(/\.\.|[\n]/).filter(l => l.trim());
            state.conduiteLines = lines.map((text, i) => ({
                id: Date.now() + i,
                text: text.trim(),
                proposition: false,
                alternative: false,
                commentaire: false,
                deletable: true
            }));
            // Re-render la conduite Ã  tenir
            moduleContent.innerHTML = renderConduiteATenir();
        } else {
            // SÃ©parer les lignes par .. ou \n
            const lines = newText.split(/\.\.|[\n]/).filter(l => l.trim());
            
            // Parser chaque ligne avec les marqueurs @@ et XXXX
            const linesHtml = lines.map(line => {
                const parsedLine = parseTextForAlternativeDisplay(line.trim());
                return `<div class="module-line">${parsedLine}</div>`;
            }).join('');
            
            moduleContent.innerHTML = linesHtml;
        }
        
        // Animation visuelle pour montrer le changement
        moduleContent.style.transition = 'background 0.3s';
        moduleContent.style.background = 'rgba(139, 92, 246, 0.2)';
        setTimeout(() => {
            moduleContent.style.background = '';
        }, 500);
    }
}

// Fonction pour parser le texte avec les marqueurs @@ et XXXX (format standard)
function parseTextForAlternativeDisplay(text) {
    if (!text) return '';
    
    // Parser les alternatives @@...@@
    text = text.replace(/@@\s*([^@]+?)\s*@@/g, function(match, altsStr) {
        const alternatives = splitAlternativesSimple(altsStr);
        if (alternatives.length === 0) return match;
        if (alternatives.length === 1) {
            // Une seule option, pas de triangle
            return parseXXXXInText(alternatives[0]);
        }
        
        const firstAlt = alternatives[0];
        const altsJson = JSON.stringify(alternatives).replace(/'/g, '&#39;');
        const displayText = parseXXXXInText(firstAlt);
        
        // Utiliser le format standard avec alt-container et alt-trigger
        return `<span class="alt-container"><span class="alt-text">${displayText}</span><span class="alt-trigger" data-alts='${altsJson}' onclick="openAltDropdown(event, this)"></span></span>`;
    });
    
    // Parser les XXXX restants (hors alternatives)
    text = parseXXXXInText(text);
    
    return text;
}

// Parser les XXXX dans le texte
function parseXXXXInText(text) {
    if (!text || typeof text !== 'string') return text || '';
    
    // Utiliser des placeholders uniques pour Ã©viter les remplacements multiples
    const placeholders = [];
    let idx = 0;
    
    // Format 1: XXXX %% prop1 / prop2 %% - capturer tout entre %% et %% (GARDER les hints dans les props)
    text = text.replace(/XXXX\s*%%([\s\S]*?)%%/g, function(match, propsStr) {
        const props = propsStr.split('/').map(p => p.trim()).filter(p => p);
        const propsEncoded = encodeURIComponent(JSON.stringify(props));
        const placeholder = `###PH${idx++}###`;
        placeholders.push({placeholder, html: `<span class="xxxx" data-props="${propsEncoded}" onclick="openXXXXModal(this)">XXXX</span>`});
        return placeholder;
    });
    
    // Format 2: XXXX PROPOSITION : prop1 ; prop2 FINI (note: ; comme sÃ©parateur) (GARDER les hints dans les props)
    text = text.replace(/XXXX\s+PROPOSITION\s*:\s*(.+?)\s+FINI/gi, function(match, propsStr) {
        // Utiliser splitIgnoringPercent pour ignorer les ; Ã  l'intÃ©rieur des %%
        const props = splitIgnoringPercent(propsStr);
        const propsEncoded = encodeURIComponent(JSON.stringify(props));
        const placeholder = `###PH${idx++}###`;
        placeholders.push({placeholder, html: `<span class="xxxx" data-props="${propsEncoded}" onclick="openXXXXModal(this)">XXXX</span>`});
        return placeholder;
    });
    
    // XXXX simple sans propositions (seulement ceux pas encore traitÃ©s)
    text = text.replace(/XXXX/g, function() {
        const placeholder = `###PH${idx++}###`;
        placeholders.push({placeholder, html: `<span class="xxxx" onclick="openXXXXModal(this)">XXXX</span>`});
        return placeholder;
    });
    
    // Supprimer les hints {{}} du texte affichÃ© (pas des propositions qui sont dans placeholders)
    text = removeHintText(text);
    
    // Remplacer tous les placeholders par leur HTML
    placeholders.forEach(({placeholder, html}) => {
        text = text.split(placeholder).join(html);
    });
    
    return text;
}

// Split des alternatives simple (sans les %% %%)
function splitAlternativesSimple(text) {
    if (!text) return [];
    const result = [];
    let current = '';
    let insidePercent = false;
    for (let i = 0; i < text.length; i++) {
        const char = text[i];
        const nextChar = text[i + 1] || '';
        if (char === '%' && nextChar === '%') {
            insidePercent = !insidePercent;
            current += '%%';
            i++;
            continue;
        }
        if (char === '/' && !insidePercent) {
            if (current.trim()) result.push(current.trim());
            current = '';
        } else {
            current += char;
        }
    }
    if (current.trim()) result.push(current.trim());
    return result;
}

// Ouvrir le dropdown inline pour les alternatives
function openAltDropdownInline(containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    const altsAttr = container.getAttribute('data-alternatives');
    if (!altsAttr) return;
    
    let alternatives;
    try {
        alternatives = JSON.parse(altsAttr.replace(/&quot;/g, '"').replace(/&#39;/g, "'"));
    } catch (e) {
        console.error('Erreur parse alternatives:', e);
        return;
    }
    
    const dropdown = document.getElementById('altDropdown');
    const rect = container.getBoundingClientRect();
    
    let itemsHtml = alternatives.map((alt, idx) => {
        const displayAlt = formatHintText(parseXXXXInText(alt));
        return `<div class="alt-dropdown-item" data-container-id="${containerId}" data-alt-idx="${idx}" onclick="selectAltInline('${containerId}', ${idx})">
            <span class="alt-dropdown-check">â—‹</span>
            <span class="alt-dropdown-text">${displayAlt}</span>
        </div>`;
    }).join('');
    
    dropdown.innerHTML = `
        <div class="alt-dropdown-header">Choisir une alternative</div>
        <div class="alt-dropdown-list">${itemsHtml}</div>
    `;
    
    dropdown.style.position = 'fixed';
    dropdown.style.left = rect.left + 'px';
    dropdown.style.top = (rect.bottom + 5) + 'px';
    dropdown.classList.add('active');
    
    // VÃ©rifier si dÃ©passe
    setTimeout(() => {
        const dropdownRect = dropdown.getBoundingClientRect();
        if (dropdownRect.right > window.innerWidth - 20) {
            dropdown.style.left = (window.innerWidth - dropdownRect.width - 20) + 'px';
        }
        if (dropdownRect.bottom > window.innerHeight - 20) {
            dropdown.style.top = (rect.top - dropdownRect.height - 5) + 'px';
        }
    }, 10);
    
    currentAltTrigger = container;
}

// SÃ©lectionner une alternative inline
function selectAltInline(containerId, altIdx) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    const altsAttr = container.getAttribute('data-alternatives');
    let alternatives;
    try {
        alternatives = JSON.parse(altsAttr.replace(/&quot;/g, '"').replace(/&#39;/g, "'"));
    } catch (e) {
        return;
    }
    
    if (!alternatives[altIdx]) return;
    
    const selectedAlt = removeHintText(alternatives[altIdx]);
    const textSpan = container.querySelector('.alternative-text');
    if (textSpan) {
        textSpan.innerHTML = parseXXXXInText(selectedAlt);
    }
    
    closeAltDropdown();
}

// RÃ©initialiser le cache des alternatives lors d'un nouveau motif
function resetAlternativesCache() {
    alternativesCache = null;
    pendingDiagnosticAlt = null;
}

function resetAll(){
resetAlternativesCache();
state={categories:state.categories,motifPrincipal:null,motifsSecondaires:[],conclusion:null,conduiteLines:[],allOrdonnances:[],currentMode:null,currentBulles:[],allMotifs:state.allMotifs};
document.querySelectorAll('.category-btn,.motif-btn').forEach(btn=>btn.classList.remove('active','principal','secondaire'));
closeMotifsZone();
document.getElementById('generateTop').disabled=true;
document.getElementById('generateBottom').disabled=true;
document.getElementById('floatingActions').style.display='none';
document.getElementById('mainSelectionBox').style.display='none';
document.getElementById('secondarySelectionBox').style.display='none';
document.getElementById('motifSearch').value='';
document.getElementById('searchResults').classList.remove('active');
document.getElementById('resultContainer').innerHTML='<div class="empty-state"><div style="font-size:64px;margin-bottom:20px">ðŸ“</div><h3>Aucune conclusion gÃ©nÃ©rÃ©e</h3><p>SÃ©lectionnez un motif principal et cliquez sur "GÃ©nÃ©rer"</p></div>';
toast('ðŸ”„ RÃ©initialisÃ©');
}

function toast(message,type='info'){
const toastEl=document.createElement('div');
toastEl.className='toast';
toastEl.textContent=message;
if(type==='error')toastEl.style.borderColor='#dc2626';
document.body.appendChild(toastEl);
setTimeout(()=>toastEl.remove(),3000);
}

// Event listener global pour valider les modals XXXX avec la touche EntrÃ©e
document.addEventListener('keydown',(e)=>{
if(e.key==='Enter'){
// VÃ©rifier si la pop-up XXXX 3 est active
const xxxxPopup3=document.getElementById('xxxxPopup3');
if(xxxxPopup3&&xxxxPopup3.classList.contains('active')){
validateXXXXPopup3();
e.preventDefault();
e.stopPropagation();
return;
}
// VÃ©rifier si la pop-up XXXX 2 est active
const xxxxPopup2=document.getElementById('xxxxPopup2');
if(xxxxPopup2&&xxxxPopup2.classList.contains('active')){
validateXXXXPopup2();
e.preventDefault();
e.stopPropagation();
return;
}
// VÃ©rifier si la pop-up XXXX principale est active
const xxxxPopup=document.getElementById('xxxxPopup');
if(xxxxPopup&&xxxxPopup.classList.contains('active')){
const popupBtn=xxxxPopup.querySelector('.xxxx-popup-btn-validate');
if(popupBtn)popupBtn.click();
e.preventDefault();
e.stopPropagation();
return;
}
// VÃ©rifier si le modal XXXX dans alt dropdown est actif
const xxxxModalInAlt=document.getElementById('xxxxModalInAlt');
if(xxxxModalInAlt&&xxxxModalInAlt.classList.contains('active')){
validateXXXXInAlt();
e.preventDefault();
e.stopPropagation();
return;
}
// VÃ©rifier si le dropdown des alternatives est actif
const altDropdown=document.getElementById('altDropdown');
if(altDropdown&&altDropdown.classList.contains('active')){
// Trouver le containerId depuis un item
const item=altDropdown.querySelector('.alt-dropdown-item');
if(item){
const containerId=item.getAttribute('data-container-id');
if(containerId){
validateAltDropdown(containerId);
e.preventDefault();
e.stopPropagation();
return;
}
}
}
// VÃ©rifier si le modal xxxxModal2 est actif
const modal2=document.getElementById('xxxxModal2');
if(modal2&&modal2.classList.contains('active')){
const input2=document.getElementById('xxxxInput2');
if(input2&&input2.value.trim()){
// Trouver quel bouton de validation appeler
const validateBtn=modal2.querySelector('.modal-btn-primary');
if(validateBtn)validateBtn.click();
e.preventDefault();
return;
}
}
// VÃ©rifier si le modal xxxxModal est actif
const modal=document.getElementById('xxxxModal');
if(modal&&modal.classList.contains('active')){
const input=document.getElementById('xxxxInput');
if(input&&input.value.trim()){
const validateBtn=modal.querySelector('.modal-btn-primary');
if(validateBtn)validateBtn.click();
e.preventDefault();
return;
}
}
// VÃ©rifier si le modal alternativeModal est actif
const altModal=document.getElementById('alternativeModal');
if(altModal&&altModal.classList.contains('active')){
const altInput=document.getElementById('alternativeInput');
if(altInput&&altInput.value.trim()){
const validateBtn=altModal.querySelector('.modal-btn-primary');
if(validateBtn)validateBtn.click();
e.preventDefault();
return;
}
}
// VÃ©rifier si le modal de sÃ©lection de mode est actif
const modeModal=document.getElementById('modeSelectionModal');
if(modeModal&&modeModal.classList.contains('active')){
selectMode('examen_conclusion');
e.preventDefault();
return;
}
// Si aucun modal n'est actif et qu'un motif est sÃ©lectionnÃ©, gÃ©nÃ©rer la conclusion
const activeElement=document.activeElement;
const isInInput=activeElement&&(
activeElement.tagName==='INPUT'||
activeElement.tagName==='TEXTAREA'||
activeElement.isContentEditable||
activeElement.closest('input')||
activeElement.closest('textarea')||
activeElement.closest('[contenteditable="true"]')
);
const anyModalActive=document.querySelector('.modal.active');
// VÃ©rifier si on vient juste de sÃ©lectionner depuis la recherche
if(typeof justSelectedFromSearch!=='undefined'&&justSelectedFromSearch){
return; // Ne pas ouvrir le menu si on vient de sÃ©lectionner
}
if(!isInInput&&!anyModalActive&&state.motifPrincipal){
showModeSelection();
e.preventDefault();
return;
}
}
});

window.addEventListener('click',(e)=>{
if(e.target.classList.contains('modal'))e.target.classList.remove('active');
});
</script>
</body>
</html>
